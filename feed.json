{
  "version": "https://jsonfeed.org/version/1.1",
  "title": "ShardingCore官方文档",
  "home_page_url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/",
  "feed_url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/feed.json",
  "description": "ShardingCore官方文档",
  "author": {
    "name": "xuejiaming"
  },
  "items": [
    {
      "title": "批量操作",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/batch-operate/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/batch-operate/",
      "content_html": "<h2 id=\"批处理\"> 批处理</h2>\n<p>批处理时我们程序在运行时常用的技术,用于在大数据量时的高效性和便捷性</p>\n<h2 id=\"efcore批量处理生态\"> efcore批量处理生态</h2>\n<p>efcore有着许许多多的批处理生态，目前我们熟知的有<a href=\"https://github.com/zzzprojects/EntityFramework-Plus\" target=\"_blank\" rel=\"noopener noreferrer\"><code>Z.EntityFramework.Plus.EFCore</code></a>还有<a href=\"https://github.com/borisdj/EFCore.BulkExtensions\" target=\"_blank\" rel=\"noopener noreferrer\"><code>EFCore.BulkExtensions</code></a>等等一些列的，虽然各个框架五花八门但是在支持方面<code>sharding-cor</code>e表示我都支持</p>\n<h2 id=\"使用\"> 使用</h2>\n<div><pre><code><span><span>var</span></span> list <span>=</span> <span>new</span> <span>List<span>&lt;</span>SysUserMod<span>></span></span><span>(</span><span>)</span><span>;</span>\n            <span>///通过集合返回出对应的k-v归集通过事务开启</span>\n            <span><span>var</span></span> dbContexts <span>=</span> _defaultTableDbContext<span>.</span><span>BulkShardingEnumerable</span><span>(</span>list<span>)</span><span>;</span>\n            <span>//var dbContexts = _defaultTableDbContext.BulkShardingTableEnumerable(list); //if only sharding table</span>\n            \n           \n                    <span>foreach</span> <span>(</span><span><span>var</span></span> dataSourceMap <span>in</span> dbContexts<span>)</span>\n                    <span>{</span>\n                        <span>foreach</span> <span>(</span><span><span>var</span></span> tailMap <span>in</span> dataSourceMap<span>.</span>Value<span>)</span>\n                        <span>{</span>\n                            tailMap<span>.</span>Key<span>.</span><span>BulkInsert</span><span>(</span>tailMap<span>.</span>Value<span>.</span><span>ToList</span><span>(</span><span>)</span><span>)</span><span>;</span>\n                            <span>//tailMap.Key.BulkDelete(tailMap.Value.ToList());</span>\n                            <span>//tailMap.Key.BulkUpdate(tailMap.Value.ToList());</span>\n                        <span>}</span>\n                    <span>}</span>\n                _defaultTableDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n            <span>//or</span>\n            <span><span>var</span></span> dbContexts <span>=</span> _defaultTableDbContext<span>.</span><span>BulkShardingEnumerable</span><span>(</span>list<span>)</span><span>;</span>\n            <span>//var dbContexts = _defaultTableDbContext.BulkShardingTableEnumerable(list); //if only sharding table</span>\n            <span>using</span> <span>(</span><span><span>var</span></span> tran <span>=</span> _defaultTableDbContext<span>.</span>Database<span>.</span><span>BeginTransaction</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                    <span>foreach</span> <span>(</span><span><span>var</span></span> dataSourceMap <span>in</span> dbContexts<span>)</span>\n                    <span>{</span>\n                        <span>foreach</span> <span>(</span><span><span>var</span></span> tailMap <span>in</span> dataSourceMap<span>.</span>Value<span>)</span>\n                        <span>{</span>\n                            tailMap<span>.</span>Key<span>.</span><span>BulkInsert</span><span>(</span>tailMap<span>.</span>Value<span>.</span><span>ToList</span><span>(</span><span>)</span><span>)</span><span>;</span>\n                            <span>//tailMap.Key.BulkDelete(tailMap.Value.ToList());</span>\n                            <span>//tailMap.Key.BulkUpdate(tailMap.Value.ToList());</span>\n                        <span>}</span>\n                    <span>}</span>\n                _defaultTableDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n                tran<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br></div></div><p><code>sharding_core</code>会将本次的所有对象都进行分组对应自己的数据源和自己的所在dbcontext内</p>\n<p>如果你是按表达式来进行分表的话</p>\n<div><pre><code>\n            <span><span>var</span></span> dbContexts <span>=</span> _defaultTableDbContext<span>.</span><span>BulkShardingExpression</span><span>(</span>o<span>=></span>o<span>.</span>id<span>==</span><span>\"123\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> dbContexts <span>=</span> _defaultTableDbContext<span>.</span><span>BulkShardingTableExpression</span><span>(</span>o<span>=></span>o<span>.</span>id<span>==</span><span>\"123\"</span><span>)</span><span>;</span> <span>//if only sharding table</span>\n\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div>",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-16T06:14:19.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "高级"
      ]
    },
    {
      "title": "AbpVNext",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/abp/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/abp/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p><a href=\"https://github.com/xuejmnet/AbpVNextShardingTodoApp\" target=\"_blank\" rel=\"noopener noreferrer\">AbpVNextShardingTodoApp</a></p>\n<h2 id=\"blog\"> Blog</h2>\n<p><a href=\"https://www.cnblogs.com/xuejiaming/p/15449819.html\" target=\"_blank\" rel=\"noopener noreferrer\">Integrate With AbpVNext Blog</a></p>\n<h2 id=\"code-first\"> code first</h2>\n<p>首先abp这边使用<code>code first</code>相对比较简单,第一步我们将vs的程序启动项设置为控制台程序<code>Project.DbMigrator</code>并且在该项目下新建一个<code>IDesignTimeDbContextFactory&lt;&gt;</code>的实现类,并且将nuget控制台启动项设置为<code>Project.DbMigrator</code>,然后就可以进行愉快的code first了</p>\n",
      "date_published": "2021-11-19T03:23:20.000Z",
      "date_modified": "2022-01-18T00:05:36.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "AbpVNext集成"
      ]
    },
    {
      "title": "Code First",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/code-first/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/code-first/",
      "content_html": "<h2 id=\"介绍\"> 介绍</h2>\n<p>用过efcore的小伙伴肯定都知道code first是很久之前就一直在主打的一种编程方式,他可以让我们直接上手编程,而不需要去构建数据库,以一种先写代码后自动创建数据库的模式让开发者从数据库设计中脱离出来，更多的是快速进入到开发的一种状态。</p>\n<p>本项目<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.Migrations\" target=\"_blank\" rel=\"noopener noreferrer\">demo示例</a></p>\n<h2 id=\"安装\"> 安装</h2>\n<p>首先无论你是aspnetcore还是普通的控制台程序，我们这边需要做的是新建一个控制台程序，命名为<code>Project.Migrations</code>,如果您是分层架构，那么请对当前的控制台程序进行<code>efcore</code>所在层的类库进行引用。引用的类库如果不存在<code>sharding-core</code>也请安装上。最后安装<code>Microsoft.EntityFrameworkCore.Tools</code>请选择对应的<code>efcore</code>对应版本</p>\n<div><pre><code>dotnet <span>add</span> package Microsoft.EntityFrameworkCore.Tools\n</code></pre>\n<div><span>1</span><br></div></div><h2 id=\"开始\"> 开始</h2>\n<p>首先efcore分为以下几步\n首先我们创建几个对象分别是分表和部分表的对象，分表对象又分取模和时间分表</p>\n<h3 id=\"创建对象\"> 创建对象</h3>\n<p>如果是项目引入efcore层可以忽略</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>NoShardingTable</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>int</span></span> Age <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    \n    <span>public</span> <span>class</span> <span>ShardingWithDateTime</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>int</span></span> Age <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    \n    <span>public</span> <span>class</span> <span>ShardingWithMod</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>int</span></span> Age <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> TextStr <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> TextStr1 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> TextStr2 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div><h3 id=\"创建数据库关系\"> 创建数据库关系</h3>\n<p>如果是项目引入efcore层可以忽略</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>NoShardingTableMap</span> <span>:</span> <span><span>IEntityTypeConfiguration<span>&lt;</span>NoShardingTable<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityTypeBuilder<span>&lt;</span>NoShardingTable<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Name<span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>NoShardingTable<span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>ShardingWithDateTimeMap</span> <span>:</span> <span><span>IEntityTypeConfiguration<span>&lt;</span>ShardingWithDateTime<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityTypeBuilder<span>&lt;</span>ShardingWithDateTime<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Name<span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>ShardingWithDateTime<span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>ShardingWithModMap</span> <span>:</span> <span><span>IEntityTypeConfiguration<span>&lt;</span>ShardingWithMod<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityTypeBuilder<span>&lt;</span>ShardingWithMod<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Name<span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Name<span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>TextStr<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>.</span><span>HasDefaultValue</span><span>(</span><span>\"\"</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>TextStr1<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>.</span><span>HasDefaultValue</span><span>(</span><span>\"123\"</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>TextStr2<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>.</span><span>HasDefaultValue</span><span>(</span><span>\"123\"</span><span>)</span><span>;</span>\n            builder<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>ShardingWithMod<span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br></div></div><h3 id=\"创建dbcontext\"> 创建dbcontext</h3>\n<p>如果是项目引入efcore层可以忽略</p>\n<p>创建dbcontext并且建立关系</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>DefaultShardingTableDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span> <span>IShardingTableDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>DefaultShardingTableDbContext</span><span>(</span><span>DbContextOptions</span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n\n            modelBuilder<span>.</span><span>ApplyConfiguration</span><span>(</span><span>new</span> <span>NoShardingTableMap</span><span>(</span><span>)</span><span>)</span><span>;</span>\n            modelBuilder<span>.</span><span>ApplyConfiguration</span><span>(</span><span>new</span> <span>ShardingWithModMap</span><span>(</span><span>)</span><span>)</span><span>;</span>\n            modelBuilder<span>.</span><span>ApplyConfiguration</span><span>(</span><span>new</span> <span>ShardingWithDateTimeMap</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><h3 id=\"分表路由\"> 分表路由</h3>\n<p>如果引用的层里有对应的可以忽略</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>ShardingWithModVirtualTableRoute</span> <span>:</span> <span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>ShardingWithMod<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>ShardingWithModVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>ShardingWithMod<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>ShardingWithDateTimeVirtualTableRoute</span> <span>:</span> <span><span>AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute<span>&lt;</span>ShardingWithDateTime<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>9</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>ShardingWithDateTime<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>CreateTime<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br></div></div><h3 id=\"sqlgenerator\"> SqlGenerator</h3>\n<p>我们需要对迁移sql生成进行重写,假如我们是<code>SqlServer</code>,<code>MySql</code>亦是如此</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>ShardingSqlServerMigrationsSqlGenerator<span>&lt;</span>TShardingDbContext<span>></span></span> <span>:</span> <span><span>SqlServerMigrationsSqlGenerator</span></span> <span>where</span> <span>TShardingDbContext</span><span>:</span><span><span>DbContext</span><span>,</span><span>IShardingDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>ShardingSqlServerMigrationsSqlGenerator</span><span>(</span><span>MigrationsSqlGeneratorDependencies</span> dependencies<span>,</span> <span>IRelationalAnnotationProvider</span> migrationsAnnotations<span>)</span> <span>:</span> <span>base</span><span>(</span>dependencies<span>,</span> migrationsAnnotations<span>)</span>\n        <span>{</span>\n        <span>}</span>\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>Generate</span><span>(</span>\n            <span>MigrationOperation</span> operation<span>,</span>\n            <span>IModel</span> model<span>,</span>\n            <span>MigrationCommandListBuilder</span> builder<span>)</span>\n        <span>{</span>\n            <span>//获取老旧命令</span>\n            <span><span>var</span></span> oldCmds <span>=</span> builder<span>.</span><span>GetCommandList</span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n            <span>base</span><span>.</span><span>Generate</span><span>(</span>operation<span>,</span> model<span>,</span> builder<span>)</span><span>;</span>\n            <span>//获取新的命令</span>\n            <span><span>var</span></span> newCmds <span>=</span> builder<span>.</span><span>GetCommandList</span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n            <span>//比较判断获取增量命令</span>\n            <span><span>var</span></span> addCmds <span>=</span> newCmds<span>.</span><span>Where</span><span>(</span>x <span>=></span> <span>!</span>oldCmds<span>.</span><span>Contains</span><span>(</span>x<span>)</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n            <span>//替换增量命令下的表名为表名+后缀</span>\n            MigrationHelper<span>.</span><span><span>Generate</span><span><span>&lt;</span>TShardingDbContext<span>></span></span></span><span>(</span>operation<span>,</span> builder<span>,</span> Dependencies<span>.</span>SqlGenerationHelper<span>,</span> addCmds<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br></div></div><h3 id=\"创建设计\"> 创建设计</h3>\n<p>创建ShardingDesignTimeDbContextFactory来继承<code>IDesignTimeDbContextFactory&lt;TDbContext&gt;</code></p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>DefaultDesignTimeDbContextFactory</span><span>:</span> <span><span>IDesignTimeDbContextFactory<span>&lt;</span>DefaultShardingTableDbContext<span>></span></span></span>\n    <span>{</span> \n        <span>static</span> <span>DefaultDesignTimeDbContextFactory</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> services <span>=</span> <span>new</span> <span>ServiceCollection</span><span>(</span><span>)</span><span>;</span>\n    \n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>DefaultShardingTableDbContext<span>></span></span></span><span>(</span><span>)</span>\n            <span>.</span><span>AddEntityConfig</span><span>(</span>o <span>=></span>\n            <span>{</span>\n                o<span>.</span>CreateShardingTableOnStart <span>=</span> <span>false</span><span>;</span>\n                o<span>.</span>CreateDataBaseOnlyOnStart <span>=</span> <span>true</span><span>;</span>\n                o<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>false</span><span>;</span>\n                o<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>ShardingWithModVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                o<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>ShardingWithDateTimeVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span>\n            <span>.</span><span>AddConfig</span><span>(</span>op <span>=></span>\n            <span>{</span>\n                op<span>.</span>ConfigId <span>=</span> <span>\"c1\"</span><span>;</span>\n                op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conStr<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span>\n                        <span>.</span><span><span>ReplaceService</span><span><span>&lt;</span>IMigrationsSqlGenerator<span>,</span> ShardingSqlServerMigrationsSqlGenerator<span>&lt;</span>DefaultShardingTableDbContext<span>></span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                        <span>//.ReplaceService&lt;IMigrationsModelDiffer, RemoveForeignKeyMigrationsModelDiffer>();//如果需要移除外键可以添加这个</span>\n                <span>}</span><span>)</span><span>;</span>\n                op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>;</span>\n                op<span>.</span><span>ReplaceTableEnsureManager</span><span>(</span>sp <span>=></span> <span>new</span> <span>SqlServerTableEnsureManager<span>&lt;</span>DefaultShardingTableDbContext<span>></span></span><span>(</span><span>)</span><span>)</span><span>;</span>\n                op<span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"ds0\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBMigration;Integrated Security=True;\"</span><span>)</span><span>;</span>\n                \n            <span>}</span><span>)</span><span>.</span><span>EnsureConfig</span><span>(</span><span>)</span><span>;</span>\n            services<span>.</span><span>AddLogging</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> buildServiceProvider <span>=</span> services<span>.</span><span>BuildServiceProvider</span><span>(</span><span>)</span><span>;</span>\n            ShardingContainer<span>.</span><span>SetServices</span><span>(</span>buildServiceProvider<span>)</span><span>;</span>\n            ShardingContainer<span>.</span><span><span>GetService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>DefaultShardingTableDbContext</span> <span>CreateDbContext</span><span>(</span><span><span>string</span><span>[</span><span>]</span></span> args<span>)</span>\n        <span>{</span>\n            <span>return</span> ShardingContainer<span>.</span><span><span>GetService</span><span><span>&lt;</span>DefaultShardingTableDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br></div></div><p>简单说明一下静态构造函数里处理的事情<code>static DefaultDesignTimeDbContextFactory()</code>第一步进行了配置，并且对配置完成后进行了启动(初始化),初始化完成后可以通过<code>ShardingContainer</code>或者<code>IServiceProvider</code>进行<code>DbContext</code>的获取.</p>\n<div><p>注意</p>\n<p>如果你是一个aspnetcore的项目，那么请务必新建一个控制台程序然后引用efcore层来处理，因为默认<code>efcore-tools</code>的执行是在startup中寻找，但是发现有efcore的初始化会直接拿来使用，但是并不会执行<code>Configure</code>也就是说<code>sharding-core</code>并不会被初始化，就无法被正确处理。</p>\n</div>\n<h2 id=\"生成迁移文件\"> 生成迁移文件</h2>\n<h3 id=\"打开nuget命令\"> 打开nuget命令</h3>\n<img src=\"/sharding-core-doc/nuget.png\">\n<h3 id=\"设置启动项\"> 设置启动项</h3>\n<img src=\"/sharding-core-doc/setm.png\">\n<h3 id=\"迁移初始化命令\"> 迁移初始化命令</h3>\n<div><pre><code>PM<span>></span> Add-Migration InitSharding\n</code></pre>\n<div><span>1</span><br></div></div><p>如果控制台出现迁移文件就说明迁移成功</p>\n<h3 id=\"更新到数据库\"> 更新到数据库</h3>\n<div><pre><code>PM<span>></span> update-Database\n</code></pre>\n<div><span>1</span><br></div></div><h3 id=\"生产环境\"> 生产环境</h3>\n<div><pre><code>PM<span>></span> Script-Migration\n</code></pre>\n<div><span>1</span><br></div></div><p>如果是生产环境更多的是通过生成脚本来进行手动处理执行</p>\n<p>具体可以参考<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.Migrations\" target=\"_blank\" rel=\"noopener noreferrer\">Sample.Migrations</a></p>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2022-01-26T05:09:57.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "高级"
      ]
    },
    {
      "title": "动态追加分库",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/dynamic-data-source/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/dynamic-data-source/",
      "content_html": "<h2 id=\"动态分库已经支持但是目前还没有例子后续会增加文档和例子\"> 动态分库已经支持但是目前还没有例子后续会增加文档和例子</h2>\n",
      "date_published": "2021-12-06T09:34:16.000Z",
      "date_modified": "2021-12-16T06:31:43.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "高级"
      ]
    },
    {
      "title": "动态追加分表",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/dynamic-table/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/dynamic-table/",
      "content_html": "<h2 id=\"背景\"> 背景</h2>\n<p>很多时候我们会有一个需求就是如何针对现有的路由进行动态的处理数据和追加新表，默认sharding-core提供的按时间分表都已经提供了该技术，保证按时间分表的路由会在程序正确运行的前提下正确的动态添加分表、分库并且创建对应的分表、分库。</p>\n<h2 id=\"解析按时间分表\"> 解析按时间分表</h2>\n<h3 id=\"路由分析\"> 路由分析</h3>\n<p>我们这边为每个分表对象都需要创建一个分表路由，这个分表的虚拟路由除了告诉框架如何正确的crud外还提供了一个通用的属性就是在程序启动时会返回目前现有数据库的所有表后缀。</p>\n<div><pre><code>\n    <span>public</span> <span>abstract</span> <span>class</span> <span>AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute<span>&lt;</span>TEntity<span>></span></span> <span>:</span> <span><span>AbstractShardingTimeKeyDateTimeVirtualTableRoute<span>&lt;</span>TEntity<span>></span></span></span> <span>where</span> <span>TEntity</span> <span>:</span> <span><span>class</span></span>\n    <span>{</span>\n        <span>public</span> <span>abstract</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span><span>;</span>\n        <span>public</span> <span>override</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> <span>GetAllTails</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> beginTime <span>=</span> ShardingCoreHelper<span>.</span><span>GetCurrentMonthFirstDay</span><span>(</span><span>GetBeginTime</span><span>(</span><span>)</span><span>)</span><span>;</span>\n         \n            <span><span>var</span></span> tails<span>=</span><span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span><span>;</span>\n            <span>//提前创建表</span>\n            <span><span>var</span></span> nowTimeStamp <span>=</span>ShardingCoreHelper<span>.</span><span>GetCurrentMonthFirstDay</span><span>(</span>DateTime<span>.</span>Now<span>)</span><span>;</span>\n            <span>if</span> <span>(</span>beginTime <span>></span> nowTimeStamp<span>)</span>\n                <span>throw</span> <span>new</span> <span>ArgumentException</span><span>(</span><span>\"begin time error\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> currentTimeStamp <span>=</span> beginTime<span>;</span>\n            <span>while</span> <span>(</span>currentTimeStamp <span>&lt;=</span> nowTimeStamp<span>)</span>\n            <span>{</span>\n                <span><span>var</span></span> tail <span>=</span> <span>ShardingKeyToTail</span><span>(</span>currentTimeStamp<span>)</span><span>;</span>\n                tails<span>.</span><span>Add</span><span>(</span>tail<span>)</span><span>;</span>\n                currentTimeStamp <span>=</span> ShardingCoreHelper<span>.</span><span>GetNextMonthFirstDay</span><span>(</span>currentTimeStamp<span>)</span><span>;</span>\n            <span>}</span>\n            <span>return</span> tails<span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br></div></div><p>首先上述代码是一个简单的按时间分表按月分，这边我只列出了两个方法相对动态添加比较重要，第一个是<code>GetBeginTime</code>，这个方法要求返回一个时间这个时间用于后续的<code>GetAllTails</code>.\n我们接着来看<code>GetAllTails</code>内部是获取<code>GetBeginTime</code>值然后计算出这个之间的当前月份的第一天，然后再对当前时间进行计算算出当前时间月份的第一天，那么后续进行两个值相差的每个月就是系统中这张表按时间分表的所有后缀.\n<code>GetAllTails</code>仅在启动时被调用一次后续,用于启动时判断，后续如果需要获取可以通过<code>IVirtualTableManager&lt;TShardingDbContext&gt;</code> 获取对应的所有的表后缀<code>virtualTableManager.GetVirtualTable(entityType).GetTableAllTails()</code></p>\n<div><p>注意</p>\n<p>!!!<code>GetAllTails</code>仅在启动时被调用一次后续,用于启动时判断!!!\n!!!<code>GetAllTails</code>仅在启动时被调用一次后续,用于启动时判断!!!\n!!!<code>GetAllTails</code>仅在启动时被调用一次后续,用于启动时判断!!!</p>\n</div>\n<h3 id=\"建表的分析\"> 建表的分析</h3>\n<div><pre><code>        <span>public</span> <span>Task</span> <span>ExecuteAsync</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> virtualTableManager <span>=</span> <span>(</span>IVirtualTableManager<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IVirtualTableManager<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>EntityMetadata<span>.</span>ShardingDbContextType<span>)</span><span>)</span><span>;</span>\n            <span><span>var</span></span> virtualTable <span>=</span> virtualTableManager<span>.</span><span>GetVirtualTable</span><span>(</span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>)</span><span>;</span>\n            _logger<span>.</span><span>LogDebug</span><span>(</span><span><span>$\"get </span><span><span>{</span><span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>.</span>Name</span><span>}</span></span><span>'s virtualTable \"</span></span><span>)</span><span>;</span>\n            <span>if</span> <span>(</span>virtualTable <span>==</span> <span>null</span><span>)</span>\n            <span>{</span>\n                _logger<span>.</span><span>LogDebug</span><span>(</span><span><span>$\" </span><span><span>{</span><span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>.</span>Name</span><span>}</span></span><span>'s virtualTable  is null\"</span></span><span>)</span><span>;</span>\n                <span>return</span> Task<span>.</span>CompletedTask<span>;</span>\n            <span>}</span>\n            <span><span>var</span></span> entityMetadataManager <span>=</span> <span>(</span>IEntityMetadataManager<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IEntityMetadataManager<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>EntityMetadata<span>.</span>ShardingDbContextType<span>)</span><span>)</span><span>;</span>\n            <span><span>var</span></span> virtualDataSource <span>=</span> <span>(</span>IVirtualDataSource<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IVirtualDataSource<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>EntityMetadata<span>.</span>ShardingDbContextType<span>)</span><span>)</span><span>;</span>\n            <span><span>var</span></span> tableCreator <span>=</span> <span>(</span>IShardingTableCreator<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IShardingTableCreator<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>EntityMetadata<span>.</span>ShardingDbContextType<span>)</span><span>)</span><span>;</span>\n            <span><span>var</span></span> now <span>=</span> DateTime<span>.</span>Now<span>.</span><span>AddMinutes</span><span>(</span><span>10</span><span>)</span><span>;</span>\n            <span><span>var</span></span> tail <span>=</span> virtualTable<span>.</span><span>GetVirtualRoute</span><span>(</span><span>)</span><span>.</span><span>ShardingKeyToTail</span><span>(</span>now<span>)</span><span>;</span>\n            <span>ISet<span>&lt;</span><span>string</span><span>></span></span> dataSources <span>=</span> <span>new</span> <span>HashSet<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span><span>;</span>\n            <span>if</span> <span>(</span>entityMetadataManager<span>.</span><span>IsShardingDataSource</span><span>(</span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>)</span><span>)</span>\n            <span>{</span>\n                <span><span>var</span></span> virtualDataSourceRoute <span>=</span> virtualDataSource<span>.</span><span>GetRoute</span><span>(</span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>)</span><span>;</span>\n                <span>foreach</span> <span>(</span><span><span>var</span></span> dataSourceName <span>in</span> virtualDataSourceRoute<span>.</span><span>GetAllDataSourceNames</span><span>(</span><span>)</span><span>)</span>\n                <span>{</span>\n                    dataSources<span>.</span><span>Add</span><span>(</span>dataSourceName<span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n            <span>else</span>\n            <span>{</span>\n                dataSources<span>.</span><span>Add</span><span>(</span>virtualDataSource<span>.</span>DefaultDataSourceName<span>)</span><span>;</span>\n            <span>}</span>\n            _logger<span>.</span><span>LogInformation</span><span>(</span><span><span>$\"auto create table data source names:[</span><span><span>{</span><span><span>string</span><span>.</span><span>Join</span><span>(</span><span>\",\"</span><span>,</span> dataSources<span>)</span></span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n            <span>foreach</span> <span>(</span><span><span>var</span></span> dataSource <span>in</span> dataSources<span>)</span>\n            <span>{</span>\n                <span>try</span>\n                <span>{</span>\n                    _logger<span>.</span><span>LogInformation</span><span>(</span><span><span>$\"begin table tail:[</span><span><span>{</span><span>tail</span><span>}</span></span><span>],entity:[</span><span><span>{</span><span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>.</span>Name</span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n                    tableCreator<span>.</span><span>CreateTable</span><span>(</span>dataSource<span>,</span> <span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>,</span> tail<span>)</span><span>;</span>\n                    _logger<span>.</span><span>LogInformation</span><span>(</span><span><span>$\"succeed table tail:[</span><span><span>{</span><span>tail</span><span>}</span></span><span>],entity:[</span><span><span>{</span><span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>.</span>Name</span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n                <span>}</span>\n                <span>catch</span> <span>(</span><span>Exception</span> e<span>)</span>\n                <span>{</span>\n                    <span>//ignore</span>\n                    _logger<span>.</span><span>LogInformation</span><span>(</span><span><span>$\"warning table tail:[</span><span><span>{</span><span>tail</span><span>}</span></span><span>],entity:[</span><span><span>{</span><span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>.</span>Name</span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n                    <span>if</span> <span>(</span>ShowErrorLog<span>)</span>\n                        _logger<span>.</span><span>LogError</span><span>(</span>e<span>,</span> <span><span>$\"</span><span><span>{</span><span>dataSource</span><span>}</span></span><span> </span><span><span>{</span><span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>.</span>Name</span><span>}</span></span><span>'s create table error \"</span></span><span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n            virtualTableManager<span>.</span><span>AddPhysicTable</span><span>(</span>virtualTable<span>,</span> <span>new</span> <span>DefaultPhysicTable</span><span>(</span>virtualTable<span>,</span> tail<span>)</span><span>)</span><span>;</span>\n\n            <span>return</span> Task<span>.</span>CompletedTask<span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br></div></div><p>代码取自按月分表自动建表任务的代码，当然如果是您自己有定时作业可以完全通过泛型方法的依赖注入获取而不需要反射+强转来实现。</p>\n<p><code>IVirtualTableManager&lt;TShardingDbContext&gt;</code> 拥有动态添加物理表的功能<code>AddPhysicTable</code>,来保证程序知道目前有多少个该表的后缀</p>\n<p><code>IEntityMetadataManager&lt;TShardingDbContext&gt;</code> 用来判断对应表是否为分表还是分库</p>\n<p><code>IVirtualDataSource&lt;TShardingDbContext&gt;</code> 用来获取对应的数据源名称</p>\n<p><code>IShardingTableCreator&lt;TShardingDbContext&gt;</code>用来实现表创建</p>\n<p>**注意：**因为数据库可能已经创建了对应的表。所以后续的调用会导致表创建抛出异常，这边在无论是否创建成功后都选择将物理表添加到对应的虚拟表里面，并且<code>virtualTableManager.AddPhysicTable</code>已经做好了无法重复添加的校验</p>\n<p>**结论：**动态添加表需要满足对应表路由能够正确返回对应目前的数据库表后缀全部数目，在创建对应的数据库表外，还需要对分表对象的<code>IVirtualTable</code>进行追加物理表使框架可以明确知道有这么一张表，并且需要考虑是否需要动态分表路由逻辑，当表后缀有新的添加之后那么是否对应的路由逻辑需要改变呢，比如我们是按租户Id来分表的那么新增后不需要修改路由逻辑，如果我们是取模的那么就需要考虑这个问题,并且需要考虑数据迁移，需要注意下次启动的时候会不会将之前添加的动态表添加进来呢?<code>GetAllTails</code>会不会在下次程序启动的时候不返回本次动态添加的呢</p>\n<div><p>注意</p>\n<p>!!!框架仅提供分表分库路由不提供数据迁移,数据迁移需要手动实现!!!\n!!!框架仅提供分表分库路由不提供数据迁移,数据迁移需要手动实现!!!\n!!!框架仅提供分表分库路由不提供数据迁移,数据迁移需要手动实现!!!</p>\n</div>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-12-06T09:34:16.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "高级"
      ]
    },
    {
      "title": "链接模式",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/connection-mode/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/connection-mode/",
      "content_html": "<h2 id=\"介绍\"> 介绍</h2>\n<p>链接模式,是一种在分片下用来控制数据库链接数的，毕竟数据库链接池比较有限，所以一般需要很好的控制数据库链接数才可以让框架变得更加的稳定易用,目前<code>ShardingCore</code>采用<code>ShardingSphere</code>的链接模式并且在此基础上针对分页下的链接模式进行了更进一步的优化，大大降低了原先的内存模式下的内存使用数大大提高内存使用率,假设一次查询路由是w个库x张表,跳过y条数据获取z条数据:\n旧的链接模式:内存数目为w<em>x</em>(y+z)\n新的链接模式:内存数目为:x*(y+z)</p>\n<h2 id=\"链接模式\"> 链接模式</h2>\n<p>说了这么多这边需要针对<code>ShardingCore</code>在查询下面涉及到N表查询后带来的链接消耗是一个不容小觑的客观因素。所以这边参考<code>ShardingSphere</code>进行了类似原理的实现。就是如果查询涉及不同库那么直接并发，如果是同库的将根据用户配置的单次最大链接进行串行查询，并且动态选择使用流式聚合和内存聚合。</p>\n<p>首先我们看下<code>ShardingSphere</code>的链接模式在限制链接数的情况下是如何进行处理的\n<img src=\"/sharding-core-doc/1346660-20211207203944126-2007119993.png\" >\n针对不同的数据库采用并行执行，针对同一个数据库根据用户配置的最大连接数进行分库串行执行，并且因为需要控制链接数所以会将结果集保存在内存中，最后通过合并返回给客户端数据。\n之后我们会讲这个模式的缺点并且<code>ShardingCore</code>是如何进行优化的</p>\n<p>你可能已经蒙了这么多名称完全没有一个概念。接下来我将一一进行讲解,首先我们来看下链接模式下有哪些参数</p>\n<h2 id=\"maxqueryconnectionslimit\"> MaxQueryConnectionsLimit</h2>\n<p>最大并发链接数，就是表示单次查询<code>sharding-core</code>允许使用的dbconnection，默认会加上1就是说如果你配置了<code>MaxQueryConnectionsLimit=10</code>那么实际<code>sharding-core</code>会在同一次查询中开启11条链接最多,为什么是11不是10因为<code>sharding-core</code>会默认开启一个链接用来进行空dbconnection的使用。如果不设置本参数那么默认是cpu线程数<code>Environment.ProcessorCount</code></p>\n<h2 id=\"connectionmode\"> ConnectionMode</h2>\n<p>链接模式,可以由用户自行指定，使用内存限制,和连接数限制或者系统自行选择最优</p>\n<p>链接模式，有三个可选项，分别是：</p>\n<h3 id=\"memory-strictly\"> MEMORY_STRICTLY</h3>\n<p>内存限制模式最小化内存聚合 流式聚合 同时会有多个链接</p>\n<p>MEMORY_STRICTLY的意思是最小化内存使用率，就是非一次性获取所有数据然后采用流式聚合</p>\n<h3 id=\"connection-strictly\"> CONNECTION_STRICTLY</h3>\n<p>连接数限制模式最小化并发连接数 内存聚合 连接数会有限制</p>\n<p>CONNECTION_STRICTLY的意思是最小化连接并发数，就是单次查询并发连接数为设置的连接数<code>MaxQueryConnectionsLimit</code>。因为有限制，所以无法一直挂起多个连接，数据的合并为内存聚合采用最小化内存方式进行优化，而不是无脑使用内存聚合</p>\n<h3 id=\"system-auto\"> SYSTEM_AUTO</h3>\n<p>系统自动选择内存还是流式聚合</p>\n<p>系统自行选择会根据用户的配置采取最小化连接数，但是如果遇到分页则会根据分页策略采取内存限制，因为skip过大会导致内存爆炸</p>\n<h2 id=\"解释\"> 解释</h2>\n<h4 id=\"memory-strictly-2\"> MEMORY_STRICTLY</h4>\n<p><code>MEMORY_STRICTLY</code>内存严格模式，用户使用本属性后将会严格控制查询的聚合方式，将会采用流式聚合的迭代器模式，而不是一次性全部去除相关数据在内存中排序获取，通过用户配置的<code>MaxQueryConnectionsLimit</code>连接数来进行限制，比如<code>MaxQueryConnectionsLimit=2</code>，并且本次查询涉及到一个库3张表，因为程序只允许单次查询能并发2个链接，所以本次查询会被分成2组每组两个，其中第二组只有一个，在这种情况下第一次并发查询2条语句因为采用内存严格所以不会将数据获取到内存，第二次在进行一次查询并将迭代器返回一共组合成3个迭代器后续通过流式聚合+优先级队列进行返回所要的数据，在这种情况下程序的内存是最少的但是消耗的链接也是最大的。当用户手动选择<code>MEMORY_STRICTLY</code>后<code>MaxQueryConnectionsLimit</code>将变成并行数目. 该模式下<code>ShardingCore</code>和<code>ShardingSphere</code>的处理方式类似基本一致\n<img src=\"/sharding-core-doc/1346660-20211207162239960-682662603.png\" ></p>\n<h4 id=\"connection-strictly-2\"> CONNECTION_STRICTLY</h4>\n<p><code>CONNECTION_STRICTLY</code>连接数严格模式，用户使用本属性后将会严格控制查询后的同一个数据库下的同时查询的链接数，不会因为使用流式内存而导致迭代器一致开着，因为一个迭代器查询开着就意味着需要一个链接，如果查询需要聚合3张表那么就需要同时开着三个链接来迭代保证流式聚合。通过用户配置的<code>MaxQueryConnectionsLimit</code>连接数来进行限制，比如<code>MaxQueryConnectionsLimit=2</code>，并且本次查询涉及到一个库3张表，因为程序只允许单次查询能并发2个链接，所以本次查询会被分成2组每组两个，其中第二组只有一个，在这种情况下第一次并发查询2条语句因为采用连接数严格所以不会一直持有链接，会将链接结果进行每组进行合并然后将连接放回，合并时还是采用的流式聚合，会首先将第一组的两个链接进行查询之后将需要的结果通过流式聚合取到内存，然后第二组会自行独立查询并且从<strong>第二次开始</strong>后会将上一次迭代的内存聚合数据进行和本次查询的流式聚合分别一起聚合，保证在分页情况下内存数据量最少。因为如果每组都是用独立的内存聚合那么你有n组就会有n*(skip+take)的数目，而<code>ShardingSphere</code>采用的是更加简单的做法，就是将每组下面的各自节点都自行进行内存聚合，那么如果在skip(10).take(10)的情况下sql会被改写成各组的各个节点分别进行skip(0).take(20)的操作那么2组执行器的第一组将会有40条数据第二组将会有20条数据一共会有60条数据远远操作了我们所需要的20条。所以在这个情况下<code>ShardingCore</code>第一组内存流式聚合会返回20条数据，第二组会将第一组的20条数据和第二组的进行流式聚合内存中还是只有20条数据，虽然是连接数严格但是也做到了最小化内存单元。当用户手动选择<code>CONNECTION_STRICTLY</code>后<code>MaxQueryConnectionsLimit</code>将是正则的最小化链接数限制</p>\n<img src=\"/sharding-core-doc/1346660-20211207162221157-2012213043.png\" >\n<h4 id=\"system-auto-2\"> SYSTEM_AUTO</h4>\n<p><code>SYSTEM_AUTO</code>系统自行选择，这是一个非常帮的选择，因为在这个选择下系统会自动根据用户配置的<code>MaxQueryConnectionsLimit</code>来自行控制是采用流式聚合还是内存聚合，并且因为我们采用的是同数据库下面最小化内存相比其他的解决方案可以更加有效和高性能的来应对各种查询。仅仅只需要配置一个最大连接数限制既可以适配好连接模式。</p>\n<p>这边极力推荐大家在不清楚应该用什么模式的时候使用<code>SYSTEM_AUTO</code>并且手动配置<code>MaxQueryConnectionsLimit</code>来确定各个环境下的配置一直而不是采用默认的cpu线程数。</p>\n<p>首先我们通过每个数据库被路由到了多少张表进行计算期望用户在配置了xx后应该的并行数来进行分组,sqlCount :表示这个数据库被路由到的表数目，exceptCount :表示计算出来的应该的单次查询并行数</p>\n<div><pre><code><span>//代码本质就是向上取整</span>\n    <span><span>int</span></span> exceptCount <span>=</span>\n                Math<span>.</span><span>Max</span><span>(</span>\n                    <span>0</span> <span>==</span> sqlCount <span>%</span> maxQueryConnectionsLimit\n                        <span>?</span> sqlCount <span>/</span> maxQueryConnectionsLimit\n                        <span>:</span> sqlCount <span>/</span> maxQueryConnectionsLimit <span>+</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><p>第二次我们通过判断<code>sqlCount</code>和<code>maxQueryConnectionsLimit</code>的大小来确定链接模式的选择</p>\n<div><pre><code>\n        <span>private</span> <span>ConnectionModeEnum</span> <span>CalcConnectionMode</span><span>(</span><span><span>int</span></span> sqlCount<span>)</span>\n        <span>{</span>\n            <span>switch</span> <span>(</span>_shardingConfigOption<span>.</span>ConnectionMode<span>)</span>\n            <span>{</span>\n                <span>case</span> ConnectionModeEnum<span>.</span>MEMORY_STRICTLY<span>:</span>\n                <span>case</span> ConnectionModeEnum<span>.</span>CONNECTION_STRICTLY<span>:</span> <span>return</span> _shardingConfigOption<span>.</span>ConnectionMode<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> _shardingConfigOption<span>.</span>MaxQueryConnectionsLimit <span>&lt;</span> sqlCount\n                        <span>?</span> ConnectionModeEnum<span>.</span>CONNECTION_STRICTLY\n                        <span>:</span> ConnectionModeEnum<span>.</span>MEMORY_STRICTLY<span>;</span> <span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div><h2 id=\"比较\"> 比较</h2>\n<p>针对<code>ShardingSphere</code>的流程图我们可以看到在获取普通数据的时候是没有什么问题的,但是如果遇到分页也就是</p>\n<div><pre><code><span>select</span> <span>*</span> <span>from</span> <span>order</span> <span>limit</span> <span>10</span><span>,</span><span>10</span>\n</code></pre>\n<div><span>1</span><br></div></div><p>这种情况下会被改写成</p>\n<div><pre><code><span>select</span> <span>*</span> <span>from</span> <span>order</span> <span>limit</span> <span>0</span><span>,</span><span>20</span>\n</code></pre>\n<div><span>1</span><br></div></div><p>我们可以看到如果是<code>ShardingSphere</code>的流程模式那么在各个节点处虽然已经将连接数控制好了但是对于每个节点而言都有着20条数据，这种情况下其实是一种非常危险的，因为一旦节点过多并且limit的跳过页数过多每个节点储存的数据将会非常恐怖。</p>\n<img src=\"/sharding-core-doc/1346660-20211207211410345-1235377143.png\" >\n<p>所以针对这种情况<code>ShardingCore</code>将同库下的各个节点组的查询使用<code>StreamMerge</code>而不是<code>MemoryMerge</code>，并且会对各个节点间建立联系进行聚合保证在同一个数据库下只会有20条数据被加载到内存中，大大降低了内存的使用，提高了内存使用率。\n<img src=\"/sharding-core-doc/1346660-20211207211619902-1640309451.png\" ></p>\n<p>当然具体情况应该还需要再次进行优化并不是简单的一次优化就搞定的比如当跳过的页数过多之后其实在内存中的一部分数据也会再次进行迭代和新的迭代器比较，这个中间的性能差距可能需要不断地尝试才可以获取一个比较可靠的值</p>\n<h2 id=\"总结\"> 总结</h2>\n<p>目前已经有很多小伙伴已经在使用<code>SharidingCore</code>了并且在使用的时候也是相对比较简单的配置既可以“完美”目前她在使用的各种框架譬如:AbpVNext....基本上在继承和使用方面可以说是目前efcore生态下最最最完美的了真正做到了<code>三零</code>的框架：<code>零依赖</code>,<code>零学习成本</code>,<code>零业务代码入侵</code></p>\n",
      "date_published": "2021-12-06T09:34:10.000Z",
      "date_modified": "2021-12-15T03:42:43.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "高级"
      ]
    },
    {
      "title": "不迁移原表数据分表",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/extension-only/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/extension-only/",
      "content_html": "<p>这边十分想用<code>shardiing-core</code>实现分表,但是因为系统里面其他部分很多程序在读这个表,所以这边希望保留原表名的情况下进行分表扩展,那么恭喜你sharding-core支持</p>\n",
      "date_published": "2021-11-07T03:49:21.000Z",
      "date_modified": "2021-11-07T03:49:21.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "高级"
      ]
    },
    {
      "title": "多字段分片1",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/multi-sharding-property-1/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/multi-sharding-property-1/",
      "content_html": "<h2 id=\"背景\"> 背景</h2>\n<p>什么情况下我们应该使用多字段分片(分表分库),就是如果你的这个对象在所对应的查询中不仅仅只有分片字段支持路由，并且其他字段也支持路由那么可以针对这个字段进行分片配置</p>\n<p>举个栗子：这边我们订单量很大，所以我们选择按时间分表，每月一张表，分表字段是CreateTime，那么我们插入更新是很ok的，但是再查询方面会比较蛋疼，具体原因是我们明明是雪花id(或者顺序guid)明明主键可以解析出时间其实我们大概率也是可以得出具体表的\n那么我们应该如何处理针对订单主键的查询呢，不好意思不支持，如果我们的订单id外还有一个字段是订单号，这个订单号也是可以具体路由到具体的分表那么我们该如何通过订单号查询快速定位呢，不好意思不支持，除非你带上订单时间，对于有洁癖的程序员这将是一个灾难性的。</p>\n<p>基于上述场景sharding-core在x.3.2.x+的版本支持了多字段分表,具体实现原理就是插入，修改根据主分表字段进行处理，查询会根据主分表字段和额外分表字段进行处理取交集查询结果。\n这样可以有效的帮助我们在分布式系统里面通过id进行数据交互而不需要额外附带任何字段信息。</p>\n<h2 id=\"实现\"> 实现</h2>\n<p>我们这边假设一个场景,订单id是long的雪花id，并且创建时间是datetime的订单表，我们针对这张表进行创建时间的分表，具体是按月分表。</p>\n<h3 id=\"创建订单\"> 创建订单</h3>\n<div><pre><code><span>//订单类</span>\n    <span>public</span> <span>class</span> <span>MultiShardingOrder</span>\n    <span>{</span>\n        <span>public</span> <span><span>long</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h3 id=\"创建dbcontext\"> 创建dbcontext</h3>\n<div><pre><code>\n<span>//创建dbcontext</span>\n\n    <span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span><span>IShardingTableDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>MultiShardingOrder<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>ValueGeneratedNever</span><span>(</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Name<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>MultiShardingOrder<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// empty impl</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div><h3 id=\"创建路由\"> 创建路由</h3>\n<div><pre><code>\n<span>//创建路由</span>\n<span>public</span> <span>class</span> <span>MultiShardingOrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute<span>&lt;</span>MultiShardingOrder<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>MultiShardingOrder<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>CreateTime<span>)</span><span>;</span>\n            builder<span>.</span><span>ShardingExtraProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetExtraRouteFilter</span><span>(</span><span><span>object</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>,</span> <span><span>string</span></span> shardingPropertyName<span>)</span>\n        <span>{</span>\n            <span>switch</span> <span>(</span>shardingPropertyName<span>)</span>\n            <span>{</span>\n                <span>case</span> <span>nameof</span><span>(</span>MultiShardingOrder<span>.</span>Id<span>)</span><span>:</span> <span>return</span> <span>GetIdRouteFilter</span><span>(</span>shardingKey<span>,</span> shardingOperator<span>)</span><span>;</span>\n                <span>default</span><span>:</span> <span>throw</span> <span>new</span> <span>NotImplementedException</span><span>(</span>shardingPropertyName<span>)</span><span>;</span>\n            <span>}</span>\n        <span>}</span>\n\n        <span>private</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetIdRouteFilter</span><span>(</span><span><span>object</span></span> shardingKey<span>,</span>\n            <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n            <span>//解析雪花id 需要考虑异常情况,传入的可能不是雪花id那么可以直接返回false因为是and链接所以直接就没有结果了//return tail => false;</span>\n            <span><span>var</span></span> analyzeIdToDateTime <span>=</span> SnowflakeId<span>.</span><span>AnalyzeIdToDateTime</span><span>(</span>Convert<span>.</span><span>ToInt64</span><span>(</span>shardingKey<span>)</span><span>)</span><span>;</span>\n            <span>//当前时间的tail</span>\n            <span><span>var</span></span> t <span>=</span> <span>TimeFormatToTail</span><span>(</span>analyzeIdToDateTime<span>)</span><span>;</span>\n            <span>//因为是按月分表所以获取下个月的时间判断id是否是在灵界点创建的</span>\n            <span><span>var</span></span> nextMonthFirstDay <span>=</span> ShardingCoreHelper<span>.</span><span>GetNextMonthFirstDay</span><span>(</span>analyzeIdToDateTime<span>)</span><span>;</span>\n            <span>if</span> <span>(</span>analyzeIdToDateTime<span>.</span><span>AddSeconds</span><span>(</span><span>10</span><span>)</span> <span>></span> nextMonthFirstDay<span>)</span>\n            <span>{</span>\n                <span><span>var</span></span> nextT <span>=</span> <span>TimeFormatToTail</span><span>(</span>nextMonthFirstDay<span>)</span><span>;</span>\n\n                <span>if</span> <span>(</span>shardingOperator <span>==</span> ShardingOperatorEnum<span>.</span>Equal<span>)</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> tail <span>==</span> t<span>||</span>tail<span>==</span> nextT<span>;</span>\n                <span>}</span>\n            <span>}</span>\n            <span><span>var</span></span> currentMonthFirstDay <span>=</span> ShardingCoreHelper<span>.</span><span>GetCurrentMonthFirstDay</span><span>(</span>analyzeIdToDateTime<span>)</span><span>;</span>\n            <span>if</span> <span>(</span>analyzeIdToDateTime<span>.</span><span>AddSeconds</span><span>(</span><span>-</span><span>10</span><span>)</span> <span>&lt;</span> currentMonthFirstDay<span>)</span>\n            <span>{</span>\n                <span>//上个月tail</span>\n                <span><span>var</span></span> nextT <span>=</span> <span>TimeFormatToTail</span><span>(</span>analyzeIdToDateTime<span>.</span><span>AddSeconds</span><span>(</span><span>-</span><span>10</span><span>)</span><span>)</span><span>;</span>\n\n                <span>if</span> <span>(</span>shardingOperator <span>==</span> ShardingOperatorEnum<span>.</span>Equal<span>)</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> tail <span>==</span> t <span>||</span> tail <span>==</span> nextT<span>;</span>\n                <span>}</span>\n            <span>}</span>\n            <span>else</span>\n            <span>{</span>\n                <span>if</span> <span>(</span>shardingOperator <span>==</span> ShardingOperatorEnum<span>.</span>Equal<span>)</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>}</span>\n            <span>}</span>\n\n            <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AutoCreateTableByTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>9</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br></div></div><p>框架默认针对CreateTime的进行路由实现(前提是你是用的框架的默认路由),如果是自行实现路由还是一样需要实现<code>GetRouteToFilter(TKey shardingKey, ShardingOperatorEnum shardingOperator)</code></p>\n<p><code>ShardingExtraProperty</code>额外分表字段(仅查询生效)</p>\n<p><code>GetExtraRouteFilter(object shardingKey, ShardingOperatorEnum shardingOperator, string shardingPropertyName)</code> 如果配置了额外字段并且本次查询会使用到那么<code>sharding-core</code>会将对应的分表字段进行通过这个方法,\n默认抛出未实现路由,需要自行实现。这边我们将id雪花id进行了额外分表的处理,并且只处理了equal的方法如果你很厉害可以自行实现大于等于小于等于....</p>\n<p>这边为什么不是简单的equal呢而是需要进行这么多的判断，其实因为是这样的，针对一个对象我们可能会进行如下操作</p>\n<div><pre><code><span><span>var</span></span> entity<span>=</span><span>new</span> <span>Entity</span><span>(</span><span>)</span>\n<span>//执行这边生成出来的id是2021-11-30 23:59:59.999.999</span>\nentity<span>.</span>Id<span>=</span><span>\"xxx\"</span><span>;</span>\n<span>//执行这边生成出来的时间是2021-12-01 00:00:00.000.000</span>\nentity<span>.</span>CreateTime<span>=</span>DateTime<span>.</span>Now<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><p>那么数据是会被插入到202112这张表,但是如果你只是解析雪花id那么解析出来的是202111这张表,后续会出现数据无法命中的bug,所以这边对解析出来的时间前后进行了额外添加10秒，因为两者的赋值不一定是在一起的中间可能隔了n多的代码多以这个差距你自己实现可以是秒也可以是分</p>\n<p>如果是上述情况建议默认吧202111和202112两张表都返回,针对系统而言无非是多查询了一次,效率可以大大滴提高。</p>\n<div><pre><code>\n        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Query2</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>//查询2021-10-03 07:07:07查询202110</span>\n            <span><span>var</span></span> multiOrder <span>=</span><span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>MultiShardingOrder<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>Id<span>==</span> <span>232398109278351360</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>//查询2021-10-03或07:07:07和2021-12-05 05:05：11查询202110和202112 这边为什么是或因为他是contains,contains的话sharding-core会解析成or</span>\n            <span><span>var</span></span> longs <span>=</span> <span>new</span> <span>[</span><span>]</span><span>{</span> <span>232398109278351360</span> <span>,</span> <span>255197859283087360</span> <span>}</span><span>;</span>\n            <span><span>var</span></span> multiOrders <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>MultiShardingOrder<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> longs<span>.</span><span>Contains</span><span>(</span>o<span>.</span>Id<span>)</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> dateTime <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>11</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n            <span>//查询2021-11-21 19:43:00并且要小于2021-11-01 00:00:00查询202111并且202110(因为是小于号所以不带202111)查询出来会报错因为你既要等于202111又要小于202110</span>\n            <span>//如何不报错而是返回默认值可以通过启动配置`op.ThrowIfQueryRouteNotMatch = false;`来实现这种情况返回默认值</span>\n            <span><span>var</span></span> multiOrder404 <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>MultiShardingOrder<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>250345338962063360</span><span>&amp;&amp;</span>o<span>.</span>CreateTime<span>&lt;</span> dateTime<span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span><span>new</span>\n            <span>{</span>\n                multiOrder<span>,</span>\n                multiOrders<span>,</span>\n                multiOrder404\n            <span>}</span><span>)</span><span>;</span>\n\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div><div><p>注意</p>\n<p>！！！所有的额外解析都需要自行实现,sharding-core只提供自己的雪花id解析！！！\n！！！所有的额外解析都需要自行实现,sharding-core只提供自己的雪花id解析！！！\n！！！所有的额外解析都需要自行实现,sharding-core只提供自己的雪花id解析！！！</p>\n</div>\n",
      "date_published": "2021-12-26T13:29:18.000Z",
      "date_modified": "2021-12-29T02:58:20.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "高级"
      ]
    },
    {
      "title": "多字段分片2",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/multi-sharding-property-2/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/multi-sharding-property-2/",
      "content_html": "<h2 id=\"背景\"> 背景</h2>\n<p>直接开门见山,你有没有这种情况你需要将一批数据用时间分片来进行存储比如订单表,订单表的分片字段是订单的<code>创建时间</code>,并且id是<code>雪花id</code>，<code>订单编号</code>是带时间信息的编号,因为.net下的所有分片方案几乎都是只支持单分片字段,所以当我们不使用分片字段查询也就是订单创建时间查询的话会带来全表查询,导致性能下降,譬如我想用<code>雪花id</code>或者<code>订单编号</code>进行查询，但是带来的却是内部低效的结果,针对这种情况是否有一个好的解决方案呢,有但是需要侵入业务代码,根据雪花id或者订单编号进行解析出对应的时间然后<code>手动指定分片</code>前提是框架支持<code>手动指定</code>.基于上述原因<a href=\"https://github.com/xuejmnet/sharding-core\" target=\"_blank\" rel=\"noopener noreferrer\"><code>ShardingCore</code></a> 带来了全新版本 x.3.2.x+ 支持多字段分片路由,并且拥有很完美的实现,废话不多说我们直接开始吧！！！！！！！！！！！</p>\n<h2 id=\"原理\"> 原理</h2>\n<p>我们现在假定一个很简单的场景,依然是订单时间按月分片,查询进行如下语句</p>\n<div><pre><code>          <span>//这边演示不使用雪花id因为雪花id很难在演示中展示所以使用订单编号进行演示格式:yyyyMMddHHmmss+new Random().Next(0,10000).ToString().PadLeft(4,'0')</span>\n            <span><span>var</span></span> dateTime <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>11</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n            <span><span>var</span></span> order <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>OrderNo<span>==</span> <span>202112201900001111</span><span>&amp;&amp;</span>o<span>.</span>CreateTime<span>&lt;</span> dateTime<span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div><p>上述语句OrderNo会查询Order_202112这张表，然后时间索引会查询......Order_202108、Order_202109、Order_202110,然后两者取一个交集我们发现其实是没有结果的,这个时候应该是返回默认值null或者直接报错\n这就是一个简单的原理</p>\n<h2 id=\"直接开始\"> 直接开始</h2>\n<p>接下来我将用订单编号和创建时间来为大演示,数据库采用sqlserve(你也可以换成任意efcore支持的数据库),其中编号格式yyyyMMddHHmmss+new Random().Next(0,10000).ToString().PadLeft(4,'0'),创建时间是DateTime格式并且创建时间按月分表,这边不采用雪花id是因为雪花id的实现会根据workid和centerid的不一样而出现不一样的效果,接下来我们通过简单的5步操作实现多字段分片</p>\n<h3 id=\"添加依赖\"> 添加依赖</h3>\n<p>首先我们添加两个依赖,一个是<code>ShardingCore</code>一个<code>EFCore.SqlServer</code></p>\n<div><pre><code>//请安装最新版本目前x.3.2.x+,第一个版本号6代表efcore的版本号\nInstall-Package ShardingCore -Version <span>6.3</span>.2\n\nInstall-Package Microsoft.EntityFrameworkCore.SqlServer -Version <span>6.0</span>.1\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><p><img src=\"https://img2020.cnblogs.com/blog/1346660/202112/1346660-20211225093421886-2131126936.png\" alt=\"\" /></p>\n<p><img src=\"https://img2020.cnblogs.com/blog/1346660/202112/1346660-20211225093505145-1192048101.png\" alt=\"\" /></p>\n<h3 id=\"创建一个订单对象\"> 创建一个订单对象</h3>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>Order</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> OrderNo <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><h3 id=\"创建dbcontext\"> 创建DbContext</h3>\n<p>这边就简单的创建了一个dbcontext,并且设置了一下order如何映射到数据库,当然你可以采用attribute的方式而不是一定要fluentapi</p>\n<div><pre><code>\n    <span>/// &lt;summary></span>\n    <span>/// 如果需要支持分表必须要实现&lt;see cref=\"IShardingTableDbContext\"/></span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span>class</span> <span>DefaultDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span><span>IShardingTableDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>DefaultDbContext</span><span>(</span><span>DbContextOptions</span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>o <span>=></span>\n            <span>{</span>\n                o<span>.</span><span>HasKey</span><span>(</span>p <span>=></span> p<span>.</span>Id<span>)</span><span>;</span>\n                o<span>.</span><span>Property</span><span>(</span>p <span>=></span> p<span>.</span>OrderNo<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>;</span>\n                o<span>.</span><span>Property</span><span>(</span>p <span>=></span> p<span>.</span>Name<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>;</span>\n                o<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br></div></div><h3 id=\"创建分片路由\"> 创建分片路由</h3>\n<p>这边我们采用订单创建时间按月分表</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>OrderVirtualRoute</span> <span>:</span> <span><span>AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n    <span>{</span>\n        <span>/// &lt;summary></span>\n        <span>/// 配置主分表字段是CreateTime,额外分表字段是OrderNo</span>\n        <span>/// &lt;/summary></span>\n        <span>/// &lt;param name=\"builder\">&lt;/param></span>\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>CreateTime<span>)</span><span>;</span>\n            builder<span>.</span><span>ShardingExtraProperty</span><span>(</span>o <span>=></span> o<span>.</span>OrderNo<span>)</span><span>;</span>\n        <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// 是否要在程序运行期间自动创建每月的表</span>\n        <span>/// &lt;/summary></span>\n        <span>/// &lt;returns>&lt;/returns></span>\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AutoCreateTableByTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// 分表从何时起创建</span>\n        <span>/// &lt;/summary></span>\n        <span>/// &lt;returns>&lt;/returns></span>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>9</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// 配置额外分片路由规则</span>\n        <span>/// &lt;/summary></span>\n        <span>/// &lt;param name=\"shardingKey\">&lt;/param></span>\n        <span>/// &lt;param name=\"shardingOperator\">&lt;/param></span>\n        <span>/// &lt;param name=\"shardingPropertyName\">&lt;/param></span>\n        <span>/// &lt;returns>&lt;/returns></span>\n        <span>public</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetExtraRouteFilter</span><span>(</span><span><span>object</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>,</span> <span><span>string</span></span> shardingPropertyName<span>)</span>\n        <span>{</span>\n            <span>switch</span> <span>(</span>shardingPropertyName<span>)</span>\n            <span>{</span>\n                <span>case</span> <span>nameof</span><span>(</span>Order<span>.</span>OrderNo<span>)</span><span>:</span> <span>return</span> <span>GetOrderNoRouteFilter</span><span>(</span>shardingKey<span>,</span> shardingOperator<span>)</span><span>;</span>\n                <span>default</span><span>:</span> <span>throw</span> <span>new</span> <span>NotImplementedException</span><span>(</span>shardingPropertyName<span>)</span><span>;</span>\n            <span>}</span>\n        <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// 订单编号的路由</span>\n        <span>/// &lt;/summary></span>\n        <span>/// &lt;param name=\"shardingKey\">&lt;/param></span>\n        <span>/// &lt;param name=\"shardingOperator\">&lt;/param></span>\n        <span>/// &lt;returns>&lt;/returns></span>\n        <span>public</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetOrderNoRouteFilter</span><span>(</span><span><span>object</span></span> shardingKey<span>,</span>\n            <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n            <span>//将分表字段转成订单编号</span>\n            <span><span>var</span></span> orderNo <span>=</span> shardingKey<span>?.</span><span>ToString</span><span>(</span><span>)</span> <span>??</span> <span>string</span><span>.</span>Empty<span>;</span>\n            <span>//判断订单编号是否是我们符合的格式</span>\n            <span>if</span> <span>(</span><span>!</span><span>CheckOrderNo</span><span>(</span>orderNo<span>,</span> <span>out</span> <span><span>var</span></span> orderTime<span>)</span><span>)</span>\n            <span>{</span>\n                <span>//如果格式不一样就直接返回false那么本次查询因为是and链接的所以本次查询不会经过任何路由,可以有效的防止恶意攻击</span>\n                <span>return</span> tail <span>=></span> <span>false</span><span>;</span>\n            <span>}</span>\n\n            <span>//当前时间的tail</span>\n            <span><span>var</span></span> currentTail <span>=</span> <span>TimeFormatToTail</span><span>(</span>orderTime<span>)</span><span>;</span>\n            <span>//因为是按月分表所以获取下个月的时间判断id是否是在临界点创建的</span>\n            <span><span>var</span></span> nextMonthFirstDay <span>=</span> ShardingCoreHelper<span>.</span><span>GetNextMonthFirstDay</span><span>(</span>orderTime<span>)</span><span>;</span>\n            <span>if</span> <span>(</span>orderTime<span>.</span><span>AddSeconds</span><span>(</span><span>10</span><span>)</span> <span>></span> nextMonthFirstDay<span>)</span>\n            <span>{</span>\n                <span><span>var</span></span> nextTail <span>=</span> <span>TimeFormatToTail</span><span>(</span>nextMonthFirstDay<span>)</span><span>;</span>\n                <span>return</span> <span>DoOrderNoFilter</span><span>(</span>shardingOperator<span>,</span> orderTime<span>,</span> currentTail<span>,</span> nextTail<span>)</span><span>;</span>\n            <span>}</span>\n            <span>//因为是按月分表所以获取这个月月初的时间判断id是否是在临界点创建的</span>\n            <span>if</span> <span>(</span>orderTime<span>.</span><span>AddSeconds</span><span>(</span><span>-</span><span>10</span><span>)</span> <span>&lt;</span> ShardingCoreHelper<span>.</span><span>GetCurrentMonthFirstDay</span><span>(</span>orderTime<span>)</span><span>)</span>\n            <span>{</span>\n                <span>//上个月tail</span>\n                <span><span>var</span></span> previewTail <span>=</span> <span>TimeFormatToTail</span><span>(</span>orderTime<span>.</span><span>AddSeconds</span><span>(</span><span>-</span><span>10</span><span>)</span><span>)</span><span>;</span>\n\n                <span>return</span> <span>DoOrderNoFilter</span><span>(</span>shardingOperator<span>,</span> orderTime<span>,</span> previewTail<span>,</span> currentTail<span>)</span><span>;</span>\n            <span>}</span>\n\n            <span>return</span> <span>DoOrderNoFilter</span><span>(</span>shardingOperator<span>,</span> orderTime<span>,</span> currentTail<span>,</span> currentTail<span>)</span><span>;</span>\n\n        <span>}</span>\n\n        <span>private</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>DoOrderNoFilter</span><span>(</span><span>ShardingOperatorEnum</span> shardingOperator<span>,</span> <span>DateTime</span> shardingKey<span>,</span> <span><span>string</span></span> minTail<span>,</span> <span><span>string</span></span> maxTail<span>)</span>\n        <span>{</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>GreaterThan<span>:</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>GreaterThanOrEqual<span>:</span>\n                    <span>{</span>\n                        <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> minTail<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>>=</span> <span>0</span><span>;</span>\n                    <span>}</span>\n\n                <span>case</span> ShardingOperatorEnum<span>.</span>LessThan<span>:</span>\n                    <span>{</span>\n                        <span><span>var</span></span> currentMonth <span>=</span> ShardingCoreHelper<span>.</span><span>GetCurrentMonthFirstDay</span><span>(</span>shardingKey<span>)</span><span>;</span>\n                        <span>//处于临界值 o=>o.time &lt; [2021-01-01 00:00:00] 尾巴20210101不应该被返回</span>\n                        <span>if</span> <span>(</span>currentMonth <span>==</span> shardingKey<span>)</span>\n                            <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> maxTail<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>&lt;</span> <span>0</span><span>;</span>\n                        <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> maxTail<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>&lt;=</span> <span>0</span><span>;</span>\n                    <span>}</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>LessThanOrEqual<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> maxTail<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>&lt;=</span> <span>0</span><span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span>\n                    <span>{</span>\n                        <span><span>var</span></span> isSame <span>=</span> minTail <span>==</span> maxTail<span>;</span>\n                        <span>if</span> <span>(</span>isSame<span>)</span>\n                        <span>{</span>\n                            <span>return</span> tail <span>=></span> tail <span>==</span> minTail<span>;</span>\n                        <span>}</span>\n                        <span>else</span>\n                        <span>{</span>\n                            <span>return</span> tail <span>=></span> tail <span>==</span> minTail <span>||</span> tail <span>==</span> maxTail<span>;</span>\n                        <span>}</span>\n                    <span>}</span>\n                <span>default</span><span>:</span>\n                    <span>{</span>\n                        <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                    <span>}</span>\n            <span>}</span>\n        <span>}</span>\n\n        <span>private</span> <span><span>bool</span></span> <span>CheckOrderNo</span><span>(</span><span><span>string</span></span> orderNo<span>,</span> <span>out</span> <span>DateTime</span> orderTime<span>)</span>\n        <span>{</span>\n            <span>//yyyyMMddHHmmss+new Random().Next(0,10000).ToString().PadLeft(4,'0')</span>\n            <span>if</span> <span>(</span>orderNo<span>.</span>Length <span>==</span> <span>18</span><span>)</span>\n            <span>{</span>\n                <span>if</span> <span>(</span>DateTime<span>.</span><span>TryParseExact</span><span>(</span>orderNo<span>.</span><span>Substring</span><span>(</span><span>0</span><span>,</span> <span>14</span><span>)</span><span>,</span> <span>\"yyyyMMddHHmmss\"</span><span>,</span> CultureInfo<span>.</span>InvariantCulture<span>,</span>\n                        DateTimeStyles<span>.</span>None<span>,</span> <span>out</span> <span><span>var</span></span> parseDateTime<span>)</span><span>)</span>\n                <span>{</span>\n                    orderTime <span>=</span> parseDateTime<span>;</span>\n                    <span>return</span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n\n            orderTime <span>=</span> DateTime<span>.</span>MinValue<span>;</span>\n            <span>return</span> <span>false</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br><span>111</span><br><span>112</span><br><span>113</span><br><span>114</span><br><span>115</span><br><span>116</span><br><span>117</span><br><span>118</span><br><span>119</span><br><span>120</span><br><span>121</span><br><span>122</span><br><span>123</span><br><span>124</span><br><span>125</span><br><span>126</span><br><span>127</span><br><span>128</span><br><span>129</span><br><span>130</span><br><span>131</span><br><span>132</span><br><span>133</span><br><span>134</span><br><span>135</span><br><span>136</span><br><span>137</span><br><span>138</span><br><span>139</span><br></div></div><p>这边我来讲解一下为什么用额外字段分片需要些这么多代码呢,其实是这样的因为你是用订单创建时间<code>CreateTime</code>来进行分片的那么<code>CreateTime</code>和<code>OrderNo</code>的赋值原理上说应该在系统里面是不可能实现同一时间赋值的肯定有先后关系可能是几微妙甚至几飞秒,但是为了消除这种差异这边采用了临界点兼容算法来实现，让我们来看下一下代码</p>\n<div><pre><code><span><span>var</span></span> order<span>=</span><span>new</span> <span>Order</span><span>(</span><span>)</span>\n<span>//执行这边生成出来的id是2021-11-30 23:59:59.999.999</span>\norder<span>.</span>Id<span>=</span><span>\"xxx\"</span><span>;</span>\n<span>//business code //具体执行时间不确定,哪怕没有business code也没有办法保证两者生成的时间一致,当然如果你可以做到一致完全不需要这么复杂的编写</span>\n<span>..</span><span>..</span><span>..</span><span>..</span><span>..</span><span>..</span>\n<span>//执行这边生成出来的时间是2021-12-01 00:00:00.000.000</span>\norder<span>.</span>CreateTime<span>=</span>DateTime<span>.</span>Now<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><p>当然系统里面采用了前后添加10秒是一个比较保守的估算你可以采用前后一秒甚至几百毫秒都是ok的,具体业务具体实现,因为大部分的创建时间可能是由框架在提交后才会生成而不是new Order的时候,当然也不排除这种情况,当然如果你只需要考虑equal一种情况可以只编写equal的判断而不需要全部情况都考虑</p>\n<h3 id=\"shardingcore启动配置\"> ShardingCore启动配置</h3>\n<div><pre><code><span>ILoggerFactory</span> efLogger <span>=</span> LoggerFactory<span>.</span><span>Create</span><span>(</span>builder <span>=></span>\n<span>{</span>\n    builder<span>.</span><span>AddFilter</span><span>(</span><span>(</span>category<span>,</span> level<span>)</span> <span>=></span> category <span>==</span> DbLoggerCategory<span>.</span>Database<span>.</span>Command<span>.</span>Name <span>&amp;&amp;</span> level <span>==</span> LogLevel<span>.</span>Information<span>)</span><span>.</span><span>AddConsole</span><span>(</span><span>)</span><span>;</span>\n<span>}</span><span>)</span><span>;</span>\n<span><span>var</span></span> builder <span>=</span> WebApplication<span>.</span><span>CreateBuilder</span><span>(</span>args<span>)</span><span>;</span>\n\n<span>// Add services to the container.</span>\n\nbuilder<span>.</span>Services<span>.</span><span>AddControllers</span><span>(</span><span>)</span><span>;</span>\nbuilder<span>.</span>Services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>DefaultDbContext<span>></span></span></span><span>(</span><span>(</span>conStr<span>,</span>builder<span>)</span><span>=></span>builder\n        <span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span>\n        <span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span>\n    <span>)</span>\n    <span>.</span><span>Begin</span><span>(</span>o <span>=></span>\n    <span>{</span>\n        o<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n        o<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n    <span>}</span><span>)</span><span>.</span><span>AddShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n    <span>{</span>\n        builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n    <span>}</span><span>)</span><span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"ds0\"</span><span>,</span><span>\"Data Source=localhost;Initial Catalog=ShardingMultiProperties;Integrated Security=True;\"</span><span>)</span><span>//如果你是sqlserve只需要修改这边的链接字符串即可</span>\n    <span>.</span><span>AddShardingTableRoute</span><span>(</span>op <span>=></span>\n    <span>{</span>\n        op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n    <span>}</span><span>)</span>\n    <span>.</span><span>AddTableEnsureManager</span><span>(</span>sp<span>=></span><span>new</span> <span>SqlServerTableEnsureManager<span>&lt;</span>DefaultDbContext<span>></span></span><span>(</span><span>)</span><span>)</span><span>//告诉ShardingCore启动时有哪些表</span>\n    <span>.</span><span>End</span><span>(</span><span>)</span><span>;</span>\n\n<span><span>var</span></span> app <span>=</span> builder<span>.</span><span>Build</span><span>(</span><span>)</span><span>;</span>\n\n<span>// Configure the HTTP request pipeline.</span>\napp<span>.</span>Services<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n\napp<span>.</span><span>UseAuthorization</span><span>(</span><span>)</span><span>;</span>\n\napp<span>.</span><span>MapControllers</span><span>(</span><span>)</span><span>;</span>\n\n<span>//额外添加一些种子数据</span>\n<span>using</span> <span>(</span><span><span>var</span></span> serviceScope <span>=</span> app<span>.</span>Services<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n<span>{</span>\n    <span><span>var</span></span> defaultDbContext <span>=</span> serviceScope<span>.</span>ServiceProvider<span>.</span><span><span>GetService</span><span><span>&lt;</span>DefaultDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n    <span>if</span> <span>(</span><span>!</span>defaultDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Any</span><span>(</span><span>)</span><span>)</span>\n    <span>{</span>\n        <span><span>var</span></span> orders <span>=</span> <span>new</span> <span>List<span>&lt;</span>Order<span>></span></span><span>(</span><span>8</span><span>)</span><span>;</span>\n        <span><span>var</span></span> beginTime <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>9</span><span>,</span> <span>5</span><span>)</span><span>;</span>\n        <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>8</span><span>;</span> i<span>++</span><span>)</span>\n        <span>{</span>\n\n            <span><span>var</span></span> orderNo <span>=</span> beginTime<span>.</span><span>ToString</span><span>(</span><span>\"yyyyMMddHHmmss\"</span><span>)</span> <span>+</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>.</span><span>PadLeft</span><span>(</span><span>4</span><span>,</span> <span>'0'</span><span>)</span><span>;</span>\n            orders<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Order</span><span>(</span><span>)</span>\n            <span>{</span>\n                Id <span>=</span> Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>.</span><span>ToString</span><span>(</span><span>\"n\"</span><span>)</span><span>,</span>\n                CreateTime <span>=</span> beginTime<span>,</span>\n                Name <span>=</span> <span><span>$\"Order\"</span></span> <span>+</span> i<span>,</span>\n                OrderNo <span>=</span> orderNo\n            <span>}</span><span>)</span><span>;</span>\n            beginTime <span>=</span> beginTime<span>.</span><span>AddDays</span><span>(</span><span>1</span><span>)</span><span>;</span>\n            <span>if</span> <span>(</span>i <span>%</span> <span>2</span> <span>==</span> <span>1</span><span>)</span>\n            <span>{</span>\n                beginTime <span>=</span> beginTime<span>.</span><span>AddMonths</span><span>(</span><span>1</span><span>)</span><span>;</span>\n            <span>}</span>\n        <span>}</span>\n        defaultDbContext<span>.</span><span>AddRange</span><span>(</span>orders<span>)</span><span>;</span>\n        defaultDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n    <span>}</span>\n<span>}</span>\napp<span>.</span><span>Run</span><span>(</span><span>)</span><span>;</span>\n\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br></div></div><p>整个配置下来其实也就两个地方需要配置还是相对比较简单的,直接启动开始我们的测试模式</p>\n<h2 id=\"测试\"> 测试</h2>\n<h3 id=\"默认配置下的测试\"> 默认配置下的测试</h3>\n<div><pre><code>\n        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Test1</span><span>(</span><span>)</span>\n        <span>{</span> Console<span>.</span><span>WriteLine</span><span>(</span><span>\"--------------Query Name Begin--------------\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> order1 <span>=</span> <span>await</span> _defaultDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>Name<span>==</span><span>\"Order3\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            Console<span>.</span><span>WriteLine</span><span>(</span><span>\"--------------Query Name End--------------\"</span><span>)</span><span>;</span>\n            Console<span>.</span><span>WriteLine</span><span>(</span><span>\"--------------Query OrderNo Begin--------------\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> order2 <span>=</span> <span>await</span> _defaultDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>OrderNo<span>==</span> <span>\"202110080000000003\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            Console<span>.</span><span>WriteLine</span><span>(</span><span>\"--------------Query OrderNo End--------------\"</span><span>)</span><span>;</span>\n            Console<span>.</span><span>WriteLine</span><span>(</span><span>\"--------------Query OrderCreateTime Begin--------------\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> dateTime <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span><span>10</span><span>,</span><span>08</span><span>)</span><span>;</span>\n            <span><span>var</span></span> order4 <span>=</span> <span>await</span> _defaultDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreateTime<span>==</span> dateTime<span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            Console<span>.</span><span>WriteLine</span><span>(</span><span>\"--------------Query OrderCreateTime End--------------\"</span><span>)</span><span>;</span>\n            Console<span>.</span><span>WriteLine</span><span>(</span><span>\"--------------Query OrderNo Contains Begin--------------\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> orderNos <span>=</span> <span>new</span> <span><span>string</span><span>[</span><span>]</span></span> <span>{</span> <span>\"202110080000000003\"</span><span>,</span> <span>\"202111090000000004\"</span> <span>}</span><span>;</span>\n            <span><span>var</span></span> order5 <span>=</span> <span>await</span> _defaultDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span> orderNos<span>.</span><span>Contains</span><span>(</span>o<span>.</span>OrderNo<span>)</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n            Console<span>.</span><span>WriteLine</span><span>(</span><span>\"--------------Query OrderNo Contains End--------------\"</span><span>)</span><span>;</span>\n\n            Console<span>.</span><span>WriteLine</span><span>(</span><span>\"--------------Query OrderNo None Begin--------------\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> time <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span><span>11</span><span>,</span><span>1</span><span>)</span><span>;</span>\n            <span><span>var</span></span> order6 <span>=</span> <span>await</span> _defaultDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span> o<span>.</span>OrderNo<span>==</span> <span>\"202110080000000003\"</span><span>&amp;&amp;</span>o<span>.</span>CreateTime<span>></span> time<span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            Console<span>.</span><span>WriteLine</span><span>(</span><span>\"--------------Query OrderNo None End--------------\"</span><span>)</span><span>;</span>\n            Console<span>.</span><span>WriteLine</span><span>(</span><span>\"--------------Query OrderNo Not Check Begin--------------\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> order3 <span>=</span> <span>await</span> _defaultDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>OrderNo <span>==</span> <span>\"a02110080000000003\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            Console<span>.</span><span>WriteLine</span><span>(</span><span>\"--------------Query OrderNo Not Check End--------------\"</span><span>)</span><span>;</span>\n\n            <span>return</span> <span>Ok</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br></div></div><p>测试结果\n<img src=\"https://img2020.cnblogs.com/blog/1346660/202112/1346660-20211225121113289-352519801.png\" alt=\"\" /></p>\n<p>测试结果非常完美除了无法匹配路由的时候那么我们该如何设置呢</p>\n<h3 id=\"测试无路由返回默认值\"> 测试无路由返回默认值</h3>\n<div><pre><code>builder<span>.</span>Services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>DefaultDbContext<span>></span></span></span><span>(</span><span>..</span><span>.</span><span>)</span>\n    <span>.</span><span>Begin</span><span>(</span>o <span>=></span>\n    <span>{</span>\n<span>..</span><span>..</span>\n        o<span>.</span>ThrowIfQueryRouteNotMatch <span>=</span> <span>false</span><span>;</span><span>//配置默认不抛出异常</span>\n    <span>}</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><p>我们再次来看下测试结果\n<img src=\"https://img2020.cnblogs.com/blog/1346660/202112/1346660-20211225121237003-804623427.png\" alt=\"\" /></p>\n<p>为何我们测试是不经过数据库直接查询,原因就是在我们做各个属性分片交集的时候返回了空那么框架会选择抛出异常或者返回默认值两种选项,并且我们在编写路由的时候判断格式不正确返回<code>return tail =&gt; false;</code>直接让所有的交集都是空所以不会进行一次无意义的数据库查询</p>\n<h2 id=\"总结\"> 总结</h2>\n<p>看到这边你应该已经看到了本框架的强大之处,本框架不但可以实现多字段分片还可以实现自定义分片,而不是单单按时间分片这么简单,我完全可以设置订单从2021年后的订单按月分片,2021年前的订单按年分片,对于sharding-core而言这简直轻而易举,但是据我所知.Net下目前除了我没有任何一款框架可以做到真正的全自动分片+多字段分片,所以我们在设计框架分片的时候尽可能的将有用的信息添加到一些无意义的字段上比如Id可以有效的解决很多在大数据下发生的问题,你可以简单理解为我加了一个索引并且附带了额外列,我加了一个id并且带了分表信息在里面,也可以完全设计出一款附带分库的属性到id里面使其可以支持分表分库</p>\n",
      "image": "https://img2020.cnblogs.com/blog/1346660/202112/1346660-20211225093421886-2131126936.png",
      "date_published": "2021-12-26T13:29:18.000Z",
      "date_modified": "2021-12-29T02:58:20.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "高级"
      ]
    },
    {
      "title": "高性能分页",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/pagination/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/pagination/",
      "content_html": "<div><p>注意</p>\n<p>!!!顺序分页如果对象支持分库会先判断分库如果分库不启用那么就不启用,如果仅分表会判断是否配置分表,优先级先分库配置再分表的配置,如果本次查询分库分表对象存在单库那么也支持!!!</p>\n<p>!!!顺序分页如果对象支持分库会先判断分库如果分库不启用那么就不启用!!!</p>\n<p>!!!顺序分页如果对象支持分库会先判断分库如果分库不启用那么就不启用!!!</p>\n</div>\n<h2 id=\"介绍\"> 介绍</h2>\n<p>所谓的高性能分页是针对分表分库下的数据聚合来实现的一种分页，总所周知如果你是内存分页那么时间复杂度将是O(x*n)其中x表示：<code>子sql条数</code>,n表示需要跳过的条数，但是流式聚合的时间复杂度却是O(n)其中n表示需要跳过的条数。也就是说理论上流式聚合的性能要远高于内存聚合。</p>\n<h3 id=\"分表解决方案\"> 分表解决方案</h3>\n<table>\n<thead>\n<tr>\n<th>解决方案</th>\n<th>skip&lt;=100</th>\n<th>skip&lt;10000</th>\n<th>skip&gt;10000</th>\n<th>优点</th>\n<th>缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>内存分表</strong></td>\n<td>速度快O(n)，n=skip*分表数</td>\n<td>速度快O(n)，n=skip*分表数,内存暴涨</td>\n<td>O(n)，n=skip*分表数,内存爆炸,速度越来越慢</td>\n<td>实现简单,支持分库</td>\n<td>skip过大内存暴涨</td>\n</tr>\n<tr>\n<td><strong>union all</strong></td>\n<td>速度快</td>\n<td>速度快</td>\n<td>速度越来越慢</td>\n<td>实现简单</td>\n<td>不支持分库,不好优化,索引可能会失效</td>\n</tr>\n<tr>\n<td><strong>流式分表</strong></td>\n<td>速度快O(n)，n=skip</td>\n<td>速度快O(n)，n=skip</td>\n<td>O(n)，n=skip 速度越来越慢</td>\n<td>支持分库</td>\n<td>实现复杂,网络流量随着N增大</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"_1-内存分页\"> 1.内存分页</h4>\n<p>顾名思义就是将各个表的结果集合并到内存中进行排序后分页</p>\n<h4 id=\"_2-union-all\"> 2.union all</h4>\n<p>使用的是数据库本身的聚合操作,用过匿名表来实现和操作当前表一样无感知</p>\n<h4 id=\"_3-流式分表\"> 3.流式分表</h4>\n<p>和名字一样就是通过next来一次一次获取,和datareader类似只有在next后才可以获取到客户端</p>\n<h2 id=\"高性能分页\"> 高性能分页</h2>\n<h3 id=\"介绍-2\"> 介绍</h3>\n<p>目前sharding-core采用的是流式聚合所以普通情况下你的分页查询就是O(n)的性能代价，但是如果你是按时间来进行分表那么如果分页查询是以时间为主要排序就可以做到O(1)的分页性能。</p>\n<h3 id=\"条件\"> 条件</h3>\n<p>启用高性能分页有一个很重要的条件需要满足</p>\n<p>假设分表对象是<code>a</code>,分表有<code>a1</code>、<code>a2</code>、<code>a3</code>....<code>an</code>满足 表名后缀1、2、3、4....n的排序顺序和<code>order by a.x</code>是同向的即可。</p>\n<p>满足以下条件我们就可以说对象<code>a</code>的<code>x</code>属性满足高性能分页</p>\n<p>正序:<code>min(a1.x)</code>&lt;<code>max(a1.x)</code>&lt;<code>min(a2.x)</code>&lt;<code>max(a2.x)</code>......<code>min(an.x)</code>&lt;<code>max(an.x)</code>\n倒序:<code>min(a1.x)</code>&gt;<code>max(a1.x)</code>&gt;<code>min(a2.x)</code>&gt;<code>max(a2.x)</code>......<code>min(an.x)</code>&gt;<code>max(an.x)</code></p>\n<h3 id=\"分页配置\"> 分页配置</h3>\n<p>很显然按时间分表无疑就是这种情况下的满足者，那么该如何开启呢</p>\n<div><pre><code>    <span>public</span> <span>class</span> <span>OrderPaginationConfiguration</span><span>:</span><span><span>IPaginationConfiguration<span>&lt;</span>Order<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>PaginationBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>PaginationSequence</span><span>(</span>o <span>=></span> o<span>.</span>CreateTime<span>)</span>\n                <span>.</span><span>UseRouteComparer</span><span>(</span>Comparer<span>&lt;</span><span>string</span><span>></span><span>.</span>Default<span>)</span>\n                <span>.</span><span>UseQueryMatch</span><span>(</span>PaginationMatchEnum<span>.</span>Owner <span>|</span> PaginationMatchEnum<span>.</span>Named <span>|</span> PaginationMatchEnum<span>.</span>PrimaryMatch<span>)</span><span>.</span><span>UseAppendIfOrderNone</span><span>(</span><span>)</span><span>;</span>\n\n            builder<span>.</span><span>ConfigReverseShardingPage</span><span>(</span><span>0.5d</span><span>,</span> <span>10000L</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>我们是将订单表按订单的创建时间进行分页,所以可以得知订单分表后缀满足以上条件</p>\n<p><code>order_2019</code>,<code>order_20120</code>,<code>order_2021</code>满足<code>2019</code>&lt;<code>2020</code>&lt;<code>2021</code>且<code>min(order_2019.createTime)</code>&lt;<code>max(order_2019.createTime)</code>&lt;<code>min(order_2020.createTime)</code>&lt;<code>max(order_2020.createTime)</code>&lt;<code>min(order_2021.createTime)</code>&lt;<code>max(order_2021.createTime)</code></p>\n<h4 id=\"paginationsequence\"> PaginationSequence</h4>\n<p>表示如果分页的时候按这个字段进行排序才会启用</p>\n<p>如果你的id是雪花id那么也可以将id进行配置</p>\n<div><pre><code>    <span>public</span> <span>class</span> <span>OrderPaginationConfiguration</span><span>:</span><span><span>IPaginationConfiguration<span>&lt;</span>Order<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>PaginationBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>PaginationSequence</span><span>(</span>o <span>=></span> o<span>.</span>CreateTime<span>)</span>\n                <span>.</span><span>UseRouteComparer</span><span>(</span>Comparer<span>&lt;</span><span>string</span><span>></span><span>.</span>Default<span>)</span>\n                <span>.</span><span>UseQueryMatch</span><span>(</span>PaginationMatchEnum<span>.</span>Owner <span>|</span> PaginationMatchEnum<span>.</span>Named <span>|</span> PaginationMatchEnum<span>.</span>PrimaryMatch<span>)</span><span>.</span><span>UseAppendIfOrderNone</span><span>(</span><span>)</span><span>;</span>\n            <span>//雪花id也满足以上表达式    </span>\n            builder<span>.</span><span>PaginationSequence</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span>\n                <span>.</span><span>UseRouteComparer</span><span>(</span>Comparer<span>&lt;</span><span>string</span><span>></span><span>.</span>Default<span>)</span>\n                <span>.</span><span>UseQueryMatch</span><span>(</span>PaginationMatchEnum<span>.</span>Owner <span>|</span> PaginationMatchEnum<span>.</span>Named <span>|</span> PaginationMatchEnum<span>.</span>PrimaryMatch<span>)</span><span>;</span>\n\n            builder<span>.</span><span>ConfigReverseShardingPage</span><span>(</span><span>0.5d</span><span>,</span> <span>10000L</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div><h4 id=\"useroutecomparer\"> UseRouteComparer</h4>\n<p>表示后缀的排序顺序</p>\n<h4 id=\"usequerymatch\"> UseQueryMatch</h4>\n<p>表示我们应该用何种方式来匹配本次查询,例子中的表名只要是CreateTime是属于本次返回结果的值或者名字匹配或者order by的第一个匹配即可</p>\n<h4 id=\"useappendifordernone\"> UseAppendIfOrderNone</h4>\n<p>表示如果本次查询没有任何order by字段的时候自动将<code>CreateTime</code>作为order by的条件附加上去，并且为正序当然一般情况下肯定是手动会加上order by所以不用太在意此属性</p>\n<h4 id=\"configreverseshardingpage\"> ConfigReverseShardingPage</h4>\n<p>表示启用反向排序，当分页total大于10000以上且本次查询skip的数目超过总的total的1/2那么就会启用反向排序</p>\n<div><p>注意</p>\n<p>反向排序和顺序分页排序互斥优先级先进行顺序分页排序，当不符合顺序分页排序时才进行反向排序</p>\n</div>\n<h3 id=\"虚拟路由配置\"> 虚拟路由配置</h3>\n<div><pre><code>    <span>public</span> <span>class</span> <span>OrderVirtualRoute</span><span>:</span><span><span>AbstractSimpleShardingDayKeyDateTimeVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n    <span>{</span>\n\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> DateTime<span>.</span>Now<span>.</span>Date<span>.</span><span>AddDays</span><span>(</span><span>-</span><span>3</span><span>)</span><span>;</span>\n        <span>}</span>\n        \n        <span>/// &lt;summary></span>\n        <span>/// 返回null表示不开启</span>\n        <span>/// &lt;/summary></span>\n        <span>/// &lt;returns>&lt;/returns></span>\n        <span>public</span> <span>override</span> <span>IPaginationConfiguration<span>&lt;</span>Order<span>></span></span> <span>CreatePaginationConfiguration</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>new</span> <span>OrderPaginationConfiguration</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br></div></div><h3 id=\"如何使用\"> 如何使用</h3>\n<p>框架已经封装了一个分页的扩展</p>\n<div><pre><code>\n        <span>public</span> <span>static</span> <span>async</span> <span>Task<span>&lt;</span>ShardingPagedResult<span>&lt;</span>T<span>></span><span>></span></span> <span><span>ToShardingPageAsync</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>this</span> <span>IQueryable<span>&lt;</span>T<span>></span></span> source<span>,</span> <span><span>int</span></span> pageIndex<span>,</span> <span><span>int</span></span> pageSize<span>)</span>\n        <span>{</span>\n            <span>//设置每次获取多少页</span>\n            <span><span>var</span></span> take <span>=</span> pageSize <span>&lt;=</span> <span>0</span> <span>?</span> <span>1</span> <span>:</span> pageSize<span>;</span>\n            <span>//设置当前页码最小1</span>\n            <span><span>var</span></span> index <span>=</span> pageIndex <span>&lt;=</span> <span>0</span> <span>?</span> <span>1</span> <span>:</span> pageIndex<span>;</span>\n            <span>//需要跳过多少页</span>\n            <span><span>var</span></span> skip <span>=</span> <span>(</span>index <span>-</span> <span>1</span><span>)</span> <span>*</span> take<span>;</span>\n            <span><span>var</span></span> shardingPageManager <span>=</span> ShardingContainer<span>.</span><span><span>GetService</span><span><span>&lt;</span>IShardingPageManager<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n            <span>using</span> <span>(</span>shardingPageManager<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                <span>//获取每次总记录数</span>\n                <span><span>var</span></span> count <span>=</span> <span>await</span> source<span>.</span><span>LongCountAsync</span><span>(</span><span>)</span><span>;</span>\n                <span>if</span> <span>(</span>count <span>&lt;=</span> skip<span>)</span>\n                    <span>return</span> <span>new</span> <span>ShardingPagedResult<span>&lt;</span>T<span>></span></span><span>(</span><span>new</span> <span>List<span>&lt;</span>T<span>></span></span><span>(</span><span>0</span><span>)</span><span>,</span> count<span>)</span><span>;</span>\n                <span>//获取剩余条数</span>\n                <span><span>var</span></span> remainingCount <span>=</span> count <span>-</span> skip<span>;</span>\n                <span>//当剩余条数小于take数就取remainingCount</span>\n                <span><span>var</span></span> realTake <span>=</span> remainingCount <span>&lt;</span> <span>take <span>?</span></span> remainingCount <span>:</span> take<span>;</span>\n                <span><span>var</span></span> data <span>=</span> <span>await</span> source<span>.</span><span>Skip</span><span>(</span>skip<span>)</span><span>.</span><span>Take</span><span>(</span><span>(</span><span>int</span><span>)</span>realTake<span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n                <span>return</span> <span>new</span> <span>ShardingPagedResult<span>&lt;</span>T<span>></span></span><span>(</span>data<span>,</span> count<span>)</span><span>;</span>\n            <span>}</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br></div></div><p>你可以自行封装或使用框架的</p>\n<div><pre><code>            <span><span>var</span></span> shardingPageResult <span>=</span> <span>await</span> _defaultTableDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>OrderBy</span><span>(</span>o <span>=></span> o<span>.</span>CreateTime<span>)</span><span>.</span><span>ToShardingPageAsync</span><span>(</span>pageIndex<span>,</span> pageSize<span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br></div></div>",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-24T02:37:38.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "高级"
      ]
    },
    {
      "title": "路由表达式缓存",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/route-parse-compile-cache/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/route-parse-compile-cache/",
      "content_html": "<h2 id=\"表达式缓存失效情况\"> 表达式缓存失效情况</h2>\n<h3 id=\"可以复用表达式\"> 可以复用表达式</h3>\n<div><pre><code>\n        <span>public</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>int</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> t <span>=</span> <span>TimeFormatToTail</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>GreaterThan<span>:</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>GreaterThanOrEqual<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> t<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>>=</span> <span>0</span><span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>LessThan<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> t<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>&lt;</span> <span>0</span><span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>LessThanOrEqual<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> t<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>&lt;=</span> <span>0</span><span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div><h3 id=\"无法复用表达式\"> 无法复用表达式</h3>\n<div><pre><code>\n        <span>public</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>int</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> r <span>=</span> <span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>Next</span><span>(</span><span>1</span><span>,</span> <span>30000</span><span>)</span><span>;</span>\n            <span><span>var</span></span> t <span>=</span> <span>TimeFormatToTail</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>GreaterThan<span>:</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>GreaterThanOrEqual<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> t<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>>=</span> <span>0</span><span>&amp;&amp;</span>r<span>==</span>r<span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>LessThan<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> t<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>&lt;</span> <span>0</span> <span>&amp;&amp;</span> r <span>==</span> r<span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>LessThanOrEqual<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> t<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>&lt;=</span> <span>0</span> <span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br></div></div><p>复用表达式原理 为便利表达式各个几点针对各个节点的常量值成员变量值进行hashcode计算,因为下面的表达式<code>&gt;</code>,<code>&gt;=</code>出现了随机数所以每次结果将不一样,所以表达式将无法正确计算值。合理设计表达式返回并且利用表达式缓存可以有效提升程序性能,请勿出现上述情况下的表达式会导致表达式无法缓存并且堆积缓存区</p>\n",
      "date_published": "2021-12-03T00:36:36.000Z",
      "date_modified": "2021-12-03T01:31:09.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "高级"
      ]
    },
    {
      "title": "性能测试",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/benchmark/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/benchmark/",
      "content_html": "<h2 id=\"性能\"> 性能</h2>\n<p>以下所有数据均在开启了表达式编译缓存的情况下测试，并且电脑处于长时间未关机并且开着很多vs和idea的情况下仅供参考,所有测试都是基于ShardingCore x.3.1.63+ version</p>\n<p>以下所有数据均在<a href=\"https://github.com/xuejmnet/sharding-core/blob/main/benchmarks/ShardingCoreBenchmark/EFCoreCrud.cs\" target=\"_blank\" rel=\"noopener noreferrer\">源码中有案例</a></p>\n<p>efcore版本均为6.0 表结构为string型id的订单取模分成5张表</p>\n<p>N代表执行次数</p>\n<h3 id=\"性能损耗-sql-server-2012-data-rows-7734363-773w\"> 性能损耗 sql server 2012,data rows 7734363 =773w</h3>\n<p>// * Summary *</p>\n<p>BenchmarkDotNet=v0.13.1, OS=Windows 10.0.18363.1500 (1909/November2019Update/19H2)\nAMD Ryzen 9 3900X, 1 CPU, 24 logical and 12 physical cores\n.NET SDK=6.0.100\n[Host]     : .NET 6.0.0 (6.0.21.52210), X64 RyuJIT\nDefaultJob : .NET 6.0.0 (6.0.21.52210), X64 RyuJIT</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>N</th>\n<th style=\"text-align:right\">Mean</th>\n<th style=\"text-align:right\">Error</th>\n<th style=\"text-align:right\">StdDev</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>NoShardingIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">1.512 ms</td>\n<td style=\"text-align:right\">0.0071 ms</td>\n<td style=\"text-align:right\">0.0063 ms</td>\n</tr>\n<tr>\n<td>ShardingIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">1.567 ms</td>\n<td style=\"text-align:right\">0.0127 ms</td>\n<td style=\"text-align:right\">0.0113 ms</td>\n</tr>\n</tbody>\n</table>\n<p>针对未分片数据的查询性能,可以看出10次查询差距为0.05ms,单次查询损耗约为5微妙=0.005毫秒,损耗占比为3%,</p>\n<p>结论：efcore 原生查询和sharding-core的查询在针对未分片对象查询上性能可达原先的97%具有极高的性能</p>\n<h3 id=\"性能测试\"> 性能测试</h3>\n<h4 id=\"sql-server-2012-data-rows-7734363-773w\"> sql server 2012,data rows 7734363 =773w</h4>\n<p>// * Summary *</p>\n<p>BenchmarkDotNet=v0.13.1, OS=Windows 10.0.18363.1500 (1909/November2019Update/19H2)\nAMD Ryzen 9 3900X, 1 CPU, 24 logical and 12 physical cores\n.NET SDK=6.0.100\n[Host]     : .NET 6.0.0 (6.0.21.52210), X64 RyuJIT\nDefaultJob : .NET 6.0.0 (6.0.21.52210), X64 RyuJIT</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>N</th>\n<th style=\"text-align:right\">Mean</th>\n<th style=\"text-align:right\">Error</th>\n<th style=\"text-align:right\">StdDev</th>\n<th style=\"text-align:right\">Median</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>NoShardingIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">1.739 ms</td>\n<td style=\"text-align:right\">0.0340 ms</td>\n<td style=\"text-align:right\">0.0540 ms</td>\n<td style=\"text-align:right\">1.739 ms</td>\n</tr>\n<tr>\n<td>ShardingIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">2.373 ms</td>\n<td style=\"text-align:right\">0.0460 ms</td>\n<td style=\"text-align:right\">0.0452 ms</td>\n<td style=\"text-align:right\">2.379 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">579.584 ms</td>\n<td style=\"text-align:right\">15.7983 ms</td>\n<td style=\"text-align:right\">46.5816 ms</td>\n<td style=\"text-align:right\">564.566 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">628.567 ms</td>\n<td style=\"text-align:right\">12.5324 ms</td>\n<td style=\"text-align:right\">35.3478 ms</td>\n<td style=\"text-align:right\">615.352 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexCountAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">521.954 ms</td>\n<td style=\"text-align:right\">9.7644 ms</td>\n<td style=\"text-align:right\">18.5778 ms</td>\n<td style=\"text-align:right\">523.128 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexCountAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">622.595 ms</td>\n<td style=\"text-align:right\">11.8567 ms</td>\n<td style=\"text-align:right\">10.5107 ms</td>\n<td style=\"text-align:right\">619.452 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexLikeToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">6,352.417 ms</td>\n<td style=\"text-align:right\">123.3931 ms</td>\n<td style=\"text-align:right\">115.4220 ms</td>\n<td style=\"text-align:right\">6,360.908 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexLikeToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">6,260.610 ms</td>\n<td style=\"text-align:right\">122.6605 ms</td>\n<td style=\"text-align:right\">108.7353 ms</td>\n<td style=\"text-align:right\">6,236.577 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">491.013 ms</td>\n<td style=\"text-align:right\">4.0199 ms</td>\n<td style=\"text-align:right\">3.5635 ms</td>\n<td style=\"text-align:right\">490.473 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">620.591 ms</td>\n<td style=\"text-align:right\">6.8447 ms</td>\n<td style=\"text-align:right\">5.7156 ms</td>\n<td style=\"text-align:right\">620.634 ms</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"mysql-5-7-data-rows-7553790-755w-innerdb-buffer-size-3g\"> mysql 5.7,data rows 7553790=755w innerdb_buffer_size=3G</h4>\n<p>// * Summary *</p>\n<p>BenchmarkDotNet=v0.13.1, OS=Windows 10.0.18363.1500 (1909/November2019Update/19H2)\nAMD Ryzen 9 3900X, 1 CPU, 24 logical and 12 physical cores\n.NET SDK=6.0.100\n[Host]     : .NET 6.0.0 (6.0.21.52210), X64 RyuJIT\nDefaultJob : .NET 6.0.0 (6.0.21.52210), X64 RyuJIT</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>N</th>\n<th style=\"text-align:right\">Mean</th>\n<th style=\"text-align:right\">Error</th>\n<th style=\"text-align:right\">StdDev</th>\n<th style=\"text-align:right\">Median</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>NoShardingIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">4.911 ms</td>\n<td style=\"text-align:right\">0.0952 ms</td>\n<td style=\"text-align:right\">0.1133 ms</td>\n<td style=\"text-align:right\">4.923 ms</td>\n</tr>\n<tr>\n<td>ShardingIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">5.736 ms</td>\n<td style=\"text-align:right\">0.1139 ms</td>\n<td style=\"text-align:right\">0.3020 ms</td>\n<td style=\"text-align:right\">5.630 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">11,630.109 ms</td>\n<td style=\"text-align:right\">774.0088 ms</td>\n<td style=\"text-align:right\">2,282.1824 ms</td>\n<td style=\"text-align:right\">11,585.457 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">5,388.529 ms</td>\n<td style=\"text-align:right\">39.1442 ms</td>\n<td style=\"text-align:right\">36.6155 ms</td>\n<td style=\"text-align:right\">5,391.835 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexCountAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">14,245.844 ms</td>\n<td style=\"text-align:right\">74.1221 ms</td>\n<td style=\"text-align:right\">69.3339 ms</td>\n<td style=\"text-align:right\">14,242.815 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexCountAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">3,007.845 ms</td>\n<td style=\"text-align:right\">24.6299 ms</td>\n<td style=\"text-align:right\">23.0388 ms</td>\n<td style=\"text-align:right\">3,007.830 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexLikeToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">27,026.048 ms</td>\n<td style=\"text-align:right\">145.6814 ms</td>\n<td style=\"text-align:right\">121.6505 ms</td>\n<td style=\"text-align:right\">27,032.112 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexLikeToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">5,650.041 ms</td>\n<td style=\"text-align:right\">94.9405 ms</td>\n<td style=\"text-align:right\">88.8074 ms</td>\n<td style=\"text-align:right\">5,622.049 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">26,068.783 ms</td>\n<td style=\"text-align:right\">103.7831 ms</td>\n<td style=\"text-align:right\">97.0788 ms</td>\n<td style=\"text-align:right\">26,094.834 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">5,414.644 ms</td>\n<td style=\"text-align:right\">71.2123 ms</td>\n<td style=\"text-align:right\">59.4655 ms</td>\n<td style=\"text-align:right\">5,395.306 ms</td>\n</tr>\n</tbody>\n</table>\n<p>具体可以通过first前两次结果来计算得出结论单次查询的的损耗为0.06-0.08毫秒之间， sqlserver的各项数据在分表和未分表的情况下都几乎差不多可以得出在770w数据集情况下数据库还并未是数据瓶颈的关键，但是mysql可以看到在分表和未分表的情况下如果涉及到没有索引的全表扫描那么性能的差距将是分表后的表数目之多，测试中为5-6倍，也就是分表数目</p>\n<p><strong>如果你可以接受单次查询的损耗在0.06ms-0.08ms的那相信这款框架将会是efcore下非常完美的一款分表分库组件</strong></p>\n",
      "date_published": "2021-12-03T00:36:36.000Z",
      "date_modified": "2022-01-07T14:00:26.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "性能测试"
      ]
    },
    {
      "title": "事务",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/transaction/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/adv/transaction/",
      "content_html": "<h2 id=\"开启事务\"> 开启事务</h2>\n<div><pre><code><span>//使用方式和原生efcore一致</span>\n<span><span>var</span></span> tran <span>=</span> _defaultTableDbContext<span>.</span>Database<span>.</span><span>BeginTransaction</span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br></div></div><h2 id=\"提交事务\"> 提交事务</h2>\n<div><pre><code>tran<span>.</span><span>Commit</span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br></div></div><h2 id=\"回滚事务\"> 回滚事务</h2>\n<div><pre><code>tran<span>.</span><span>Rollback</span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br></div></div><h2 id=\"如何使用\"> 如何使用</h2>\n<div><pre><code>\n            <span>using</span> <span>(</span><span><span>var</span></span> tran <span>=</span> _defaultTableDbContext<span>.</span>Database<span>.</span><span>BeginTransaction</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                _defaultTableDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUserMod<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Insert</span><span>(</span>data<span>)</span><span>;</span>\n                _defaultTableDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n                <span><span>var</span></span> a <span>=</span> <span>0</span><span>;</span>\n                <span><span>var</span></span> b <span>=</span> <span>1</span> <span>/</span> a<span>;</span><span>//强制出错</span>\n                tran<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><p>使用方式和efcore一致，无需手动调用回滚，会在出错时自动回滚,如果是efcore普通操作需要调用<code>SaveChanges</code>，如果是三方框架直接提交的那么就不需要调用<code>SaveChanges</code></p>\n<h2 id=\"加入外部事务\"> 加入外部事务</h2>\n<div><pre><code>_defaultTableDbContext<span>.</span>Database<span>.</span><span>UseTransaction</span><span>(</span>transaction<span>)</span>\n</code></pre>\n<div><span>1</span><br></div></div><p>使用方式和efcore一致</p>\n<h2 id=\"分库下的事务\"> 分库下的事务</h2>\n<p>分库情况下使用事务需要注意一点，默认启用的是弱事务，如果出现本次操作跨库那么具体的逻辑为开启默认数据源(data source name 为default的那个)事务，之后通知现有的<code>IDataSourceDbContext</code>分别开启事务,提交的时候采用弱一致性，先提交默认的data source name的数据源事务，如果出错并且外部只有一个数据源那么就抛错，如果默认数据源事务出错就直接出错，如果非默认事务提交出错且数据源存在多个将忽略错误依次提交，手动调用rollback如果是回滚那么就是依次回滚不在抛错。仅保证业务逻辑下出错完美事务，网络原因导致的事务提交出错程序无法处理</p>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-15T08:23:36.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "高级"
      ]
    },
    {
      "title": "架构",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/deveploer/architecture/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/deveploer/architecture/",
      "content_html": "<h2 id=\"整体的架构图\"> 整体的架构图</h2>\n<p>上图可知整体架构表现为以<code>entity</code>作为核心驱动来牵引整个框架\n<img src=\"/sharding-core-doc/architecture.png\"></p>\n",
      "date_published": "2021-12-30T04:41:43.000Z",
      "date_modified": "2021-12-30T05:12:12.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "开发者文档"
      ]
    },
    {
      "title": "执行流程",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/deveploer/execute-process/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/deveploer/execute-process/",
      "content_html": "<h2 id=\"执行流程\"> 执行流程</h2>\n<p>蓝色的表示对应的处理类\n<img src=\"/sharding-core-doc/query-process.png\"></p>\n",
      "date_published": "2021-12-30T04:41:43.000Z",
      "date_modified": "2021-12-30T05:08:47.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "开发者文档"
      ]
    },
    {
      "title": "Batch Operate",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/batch-operate/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/batch-operate/",
      "content_html": "<h2 id=\"批处理\"> 批处理</h2>\n<p>批处理时我们程序在运行时常用的技术,用于在大数据量时的高效性和便捷性</p>\n<h2 id=\"efcore批量处理生态\"> efcore批量处理生态</h2>\n<p>efcore有着许许多多的批处理生态，目前我们熟知的有<a href=\"https://github.com/zzzprojects/EntityFramework-Plus\" target=\"_blank\" rel=\"noopener noreferrer\"><code>Z.EntityFramework.Plus.EFCore</code></a>还有<a href=\"https://github.com/borisdj/EFCore.BulkExtensions\" target=\"_blank\" rel=\"noopener noreferrer\"><code>EFCore.BulkExtensions</code></a>等等一些列的，虽然各个框架五花八门但是在支持方面<code>sharding-cor</code>e表示我都支持</p>\n<h2 id=\"使用\"> 使用</h2>\n<div><pre><code><span><span>var</span></span> list <span>=</span> <span>new</span> <span>List<span>&lt;</span>SysUserMod<span>></span></span><span>(</span><span>)</span><span>;</span>\n            <span>///通过集合返回出对应的k-v归集通过事务开启</span>\n            <span><span>var</span></span> dbContexts <span>=</span> _defaultTableDbContext<span>.</span><span>BulkShardingEnumerable</span><span>(</span>list<span>)</span><span>;</span>\n            <span>//var dbContexts = _defaultTableDbContext.BulkShardingTableEnumerable(list); //if only sharding table</span>\n            \n           \n                    <span>foreach</span> <span>(</span><span><span>var</span></span> dataSourceMap <span>in</span> dbContexts<span>)</span>\n                    <span>{</span>\n                        <span>foreach</span> <span>(</span><span><span>var</span></span> tailMap <span>in</span> dataSourceMap<span>.</span>Value<span>)</span>\n                        <span>{</span>\n                            tailMap<span>.</span>Key<span>.</span><span>BulkInsert</span><span>(</span>tailMap<span>.</span>Value<span>.</span><span>ToList</span><span>(</span><span>)</span><span>)</span><span>;</span>\n                            <span>//tailMap.Key.BulkDelete(tailMap.Value.ToList());</span>\n                            <span>//tailMap.Key.BulkUpdate(tailMap.Value.ToList());</span>\n                        <span>}</span>\n                    <span>}</span>\n                _defaultTableDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n            <span>//or</span>\n            <span><span>var</span></span> dbContexts <span>=</span> _defaultTableDbContext<span>.</span><span>BulkShardingEnumerable</span><span>(</span>list<span>)</span><span>;</span>\n            <span>//var dbContexts = _defaultTableDbContext.BulkShardingTableEnumerable(list); //if only sharding table</span>\n            <span>using</span> <span>(</span><span><span>var</span></span> tran <span>=</span> _defaultTableDbContext<span>.</span>Database<span>.</span><span>BeginTransaction</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                    <span>foreach</span> <span>(</span><span><span>var</span></span> dataSourceMap <span>in</span> dbContexts<span>)</span>\n                    <span>{</span>\n                        <span>foreach</span> <span>(</span><span><span>var</span></span> tailMap <span>in</span> dataSourceMap<span>.</span>Value<span>)</span>\n                        <span>{</span>\n                            tailMap<span>.</span>Key<span>.</span><span>BulkInsert</span><span>(</span>tailMap<span>.</span>Value<span>.</span><span>ToList</span><span>(</span><span>)</span><span>)</span><span>;</span>\n                            <span>//tailMap.Key.BulkDelete(tailMap.Value.ToList());</span>\n                            <span>//tailMap.Key.BulkUpdate(tailMap.Value.ToList());</span>\n                        <span>}</span>\n                    <span>}</span>\n                _defaultTableDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n                tran<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br></div></div><p><code>sharding_core</code>会将本次的所有对象都进行分组对应自己的数据源和自己的所在dbcontext内</p>\n<p>如果你是按表达式来进行分表的话</p>\n<div><pre><code>\n            <span><span>var</span></span> dbContexts <span>=</span> _defaultTableDbContext<span>.</span><span>BulkShardingExpression</span><span>(</span>o<span>=></span>o<span>.</span>id<span>==</span><span>\"123\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> dbContexts <span>=</span> _defaultTableDbContext<span>.</span><span>BulkShardingTableExpression</span><span>(</span>o<span>=></span>o<span>.</span>id<span>==</span><span>\"123\"</span><span>)</span><span>;</span> <span>//if only sharding table</span>\n\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div>",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-16T06:14:19.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "Advance"
      ]
    },
    {
      "title": "Integrate With AbpVNext",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/abp/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/abp/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p><a href=\"https://github.com/xuejmnet/AbpVNextShardingTodoApp\" target=\"_blank\" rel=\"noopener noreferrer\">AbpVNextShardingTodoApp</a></p>\n<h2 id=\"blog\"> Blog</h2>\n<p><a href=\"https://www.cnblogs.com/xuejiaming/p/15449819.html\" target=\"_blank\" rel=\"noopener noreferrer\">Integrate With AbpVNext Blog</a></p>\n",
      "date_published": "2021-11-19T03:23:20.000Z",
      "date_modified": "2021-11-19T03:23:20.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "abp"
      ]
    },
    {
      "title": "Code First",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/code-first/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/code-first/",
      "content_html": "<h2 id=\"介绍\"> 介绍</h2>\n<p>用过efcore的小伙伴肯定都知道code first是很久之前就一直在主打的一种编程方式,他可以让我们直接上手编程,而不需要去构建数据库,以一种先写代码后自动创建数据库的模式让开发者从数据库设计中脱离出来，更多的是快速进入到开发的一种状态。</p>\n<h2 id=\"安装\"> 安装</h2>\n<p>首先无论你是aspnetcore还是普通的控制台程序，我们这边需要做的是新建一个控制台程序，命名为<code>Project.Migrations</code>,如果您是分层架构，那么请对当前的控制台程序进行<code>efcore</code>所在层的类库进行引用。引用的类库如果不存在<code>sharding-core</code>也请安装上。最后安装<code>Microsoft.EntityFrameworkCore.Tools</code>请选择对应的<code>efcore</code>对应版本</p>\n<div><pre><code>dotnet <span>add</span> package Microsoft.EntityFrameworkCore.Tools\n</code></pre>\n<div><span>1</span><br></div></div><h2 id=\"开始\"> 开始</h2>\n<p>首先efcore分为以下几步\n首先我们创建几个对象分别是分表和部分表的对象，分表对象又分取模和时间分表</p>\n<h3 id=\"创建对象\"> 创建对象</h3>\n<p>如果是项目引入efcore层可以忽略</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>NoShardingTable</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>int</span></span> Age <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    \n    <span>public</span> <span>class</span> <span>ShardingWithDateTime</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>int</span></span> Age <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    \n    <span>public</span> <span>class</span> <span>ShardingWithMod</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>int</span></span> Age <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> TextStr <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> TextStr1 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> TextStr2 <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div><h3 id=\"创建数据库关系\"> 创建数据库关系</h3>\n<p>如果是项目引入efcore层可以忽略</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>NoShardingTableMap</span> <span>:</span> <span><span>IEntityTypeConfiguration<span>&lt;</span>NoShardingTable<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityTypeBuilder<span>&lt;</span>NoShardingTable<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Name<span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>NoShardingTable<span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>ShardingWithDateTimeMap</span> <span>:</span> <span><span>IEntityTypeConfiguration<span>&lt;</span>ShardingWithDateTime<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityTypeBuilder<span>&lt;</span>ShardingWithDateTime<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Name<span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>ShardingWithDateTime<span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>ShardingWithModMap</span> <span>:</span> <span><span>IEntityTypeConfiguration<span>&lt;</span>ShardingWithMod<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityTypeBuilder<span>&lt;</span>ShardingWithMod<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Name<span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Name<span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>TextStr<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>.</span><span>HasDefaultValue</span><span>(</span><span>\"\"</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>TextStr1<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>.</span><span>HasDefaultValue</span><span>(</span><span>\"123\"</span><span>)</span><span>;</span>\n            builder<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>TextStr2<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>128</span><span>)</span><span>.</span><span>HasDefaultValue</span><span>(</span><span>\"123\"</span><span>)</span><span>;</span>\n            builder<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>ShardingWithMod<span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br></div></div><h3 id=\"创建dbcontext\"> 创建dbcontext</h3>\n<p>如果是项目引入efcore层可以忽略</p>\n<p>创建dbcontext并且建立关系</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>DefaultShardingTableDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span> <span>IShardingTableDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>DefaultShardingTableDbContext</span><span>(</span><span>DbContextOptions</span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n\n            modelBuilder<span>.</span><span>ApplyConfiguration</span><span>(</span><span>new</span> <span>NoShardingTableMap</span><span>(</span><span>)</span><span>)</span><span>;</span>\n            modelBuilder<span>.</span><span>ApplyConfiguration</span><span>(</span><span>new</span> <span>ShardingWithModMap</span><span>(</span><span>)</span><span>)</span><span>;</span>\n            modelBuilder<span>.</span><span>ApplyConfiguration</span><span>(</span><span>new</span> <span>ShardingWithDateTimeMap</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><h3 id=\"分表路由\"> 分表路由</h3>\n<p>如果引用的层里有对应的可以忽略</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>ShardingWithModVirtualTableRoute</span> <span>:</span> <span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>ShardingWithMod<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>ShardingWithModVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>ShardingWithMod<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>ShardingWithDateTimeVirtualTableRoute</span> <span>:</span> <span><span>AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute<span>&lt;</span>ShardingWithDateTime<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>9</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>ShardingWithDateTime<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>CreateTime<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br></div></div><h3 id=\"sqlgenerator\"> SqlGenerator</h3>\n<p>我们需要对迁移sql生成进行重写,假如我们是<code>SqlServer</code>,<code>MySql</code>亦是如此</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>ShardingSqlServerMigrationsSqlGenerator<span>&lt;</span>TShardingDbContext<span>></span></span> <span>:</span> <span><span>SqlServerMigrationsSqlGenerator</span></span> <span>where</span> <span>TShardingDbContext</span><span>:</span><span><span>DbContext</span><span>,</span><span>IShardingDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>ShardingSqlServerMigrationsSqlGenerator</span><span>(</span><span>MigrationsSqlGeneratorDependencies</span> dependencies<span>,</span> <span>IRelationalAnnotationProvider</span> migrationsAnnotations<span>)</span> <span>:</span> <span>base</span><span>(</span>dependencies<span>,</span> migrationsAnnotations<span>)</span>\n        <span>{</span>\n        <span>}</span>\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>Generate</span><span>(</span>\n            <span>MigrationOperation</span> operation<span>,</span>\n            <span>IModel</span> model<span>,</span>\n            <span>MigrationCommandListBuilder</span> builder<span>)</span>\n        <span>{</span>\n            <span>//获取老旧命令</span>\n            <span><span>var</span></span> oldCmds <span>=</span> builder<span>.</span><span>GetCommandList</span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n            <span>base</span><span>.</span><span>Generate</span><span>(</span>operation<span>,</span> model<span>,</span> builder<span>)</span><span>;</span>\n            <span>//获取新的命令</span>\n            <span><span>var</span></span> newCmds <span>=</span> builder<span>.</span><span>GetCommandList</span><span>(</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n            <span>//比较判断获取增量命令</span>\n            <span><span>var</span></span> addCmds <span>=</span> newCmds<span>.</span><span>Where</span><span>(</span>x <span>=></span> <span>!</span>oldCmds<span>.</span><span>Contains</span><span>(</span>x<span>)</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n            <span>//替换增量命令下的表名为表名+后缀</span>\n            MigrationHelper<span>.</span><span><span>Generate</span><span><span>&lt;</span>TShardingDbContext<span>></span></span></span><span>(</span>operation<span>,</span> builder<span>,</span> Dependencies<span>.</span>SqlGenerationHelper<span>,</span> addCmds<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br></div></div><h3 id=\"创建设计\"> 创建设计</h3>\n<p>创建ShardingDesignTimeDbContextFactory来继承<code>IDesignTimeDbContextFactory&lt;TDbContext&gt;</code></p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>DefaultDesignTimeDbContextFactory</span><span>:</span> <span><span>IDesignTimeDbContextFactory<span>&lt;</span>DefaultShardingTableDbContext<span>></span></span></span>\n    <span>{</span> \n        <span>static</span> <span>DefaultDesignTimeDbContextFactory</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> services <span>=</span> <span>new</span> <span>ServiceCollection</span><span>(</span><span>)</span><span>;</span>\n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>DefaultShardingTableDbContext<span>></span></span></span><span>(</span>\n                    <span>(</span>conn<span>,</span> o<span>)</span> <span>=></span>\n                        o<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span>\n                            <span>.</span><span><span>ReplaceService</span><span><span>&lt;</span>IMigrationsSqlGenerator<span>,</span> ShardingSqlServerMigrationsSqlGenerator<span>&lt;</span>DefaultShardingTableDbContext<span>></span><span>></span></span></span><span>(</span><span>)</span>\n                <span>)</span><span>.</span><span>Begin</span><span>(</span>o <span>=></span>\n                <span>{</span>\n                    o<span>.</span>CreateShardingTableOnStart <span>=</span> <span>false</span><span>;</span>\n                    o<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>false</span><span>;</span>\n                <span>}</span><span>)</span>\n                <span>.</span><span>AddShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>)</span>\n                <span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"ds0\"</span><span>,</span>\n                    <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBMigration;Integrated Security=True;\"</span><span>)</span>\n                <span>.</span><span>AddShardingTableRoute</span><span>(</span>o <span>=></span>\n                <span>{</span>\n                    o<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>ShardingWithModVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    o<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>ShardingWithDateTimeVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>End</span><span>(</span><span>)</span><span>;</span>\n            services<span>.</span><span>AddLogging</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> buildServiceProvider <span>=</span> services<span>.</span><span>BuildServiceProvider</span><span>(</span><span>)</span><span>;</span>\n            ShardingContainer<span>.</span><span>SetServices</span><span>(</span>buildServiceProvider<span>)</span><span>;</span>\n            ShardingContainer<span>.</span><span><span>GetService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>DefaultShardingTableDbContext</span> <span>CreateDbContext</span><span>(</span><span><span>string</span><span>[</span><span>]</span></span> args<span>)</span>\n        <span>{</span>\n            <span>return</span> ShardingContainer<span>.</span><span><span>GetService</span><span><span>&lt;</span>DefaultShardingTableDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br></div></div><p>简单说明一下静态构造函数里处理的事情<code>static DefaultDesignTimeDbContextFactory()</code>第一步进行了配置，并且对配置完成后进行了启动(初始化),初始化完成后可以通过<code>ShardingContainer</code>或者<code>IServiceProvider</code>进行<code>DbContext</code>的获取.</p>\n<div><p>注意</p>\n<p>如果你是一个aspnetcore的项目，那么请务必新建一个控制台程序然后引用efcore层来处理，因为默认<code>efcore-tools</code>的执行是在startup中寻找，但是发现有efcore的初始化会直接拿来使用，但是并不会执行<code>Configure</code>也就是说<code>sharding-core</code>并不会被初始化，就无法被正确处理。</p>\n</div>\n<h2 id=\"生成迁移文件\"> 生成迁移文件</h2>\n<h3 id=\"打开nuget命令\"> 打开nuget命令</h3>\n<img src=\"/sharding-core-doc/nuget.png\">\n<h3 id=\"设置启动项\"> 设置启动项</h3>\n<img src=\"/sharding-core-doc/setm.png\">\n<h3 id=\"迁移初始化命令\"> 迁移初始化命令</h3>\n<div><pre><code>PM<span>></span> Add-Migration InitSharding\n</code></pre>\n<div><span>1</span><br></div></div><p>如果控制台出现迁移文件就说明迁移成功</p>\n<h3 id=\"更新到数据库\"> 更新到数据库</h3>\n<div><pre><code>PM<span>></span> update-Database\n</code></pre>\n<div><span>1</span><br></div></div><h3 id=\"生产环境\"> 生产环境</h3>\n<div><pre><code>PM<span>></span> Script-Migration\n</code></pre>\n<div><span>1</span><br></div></div><p>如果是生产环境更多的是通过生成脚本来进行手动处理执行</p>\n<p>具体可以参考<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.Migrations\" target=\"_blank\" rel=\"noopener noreferrer\">Sample.Migrations</a></p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2022-01-07T14:00:26.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "Advance"
      ]
    },
    {
      "title": "Dynamic Append Table",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/dynamic-table/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/dynamic-table/",
      "content_html": "<h2 id=\"背景\"> 背景</h2>\n<p>很多时候我们会有一个需求就是如何针对现有的路由进行动态的处理数据和追加新表，默认sharding-core提供的按时间分表都已经提供了该技术，保证按时间分表的路由会在程序正确运行的前提下正确的动态添加分表、分库并且创建对应的分表、分库。</p>\n<h2 id=\"解析按时间分表\"> 解析按时间分表</h2>\n<h3 id=\"路由分析\"> 路由分析</h3>\n<p>我们这边为每个分表对象都需要创建一个分表路由，这个分表的虚拟路由除了告诉框架如何正确的crud外还提供了一个通用的属性就是在程序启动时会返回目前现有数据库的所有表后缀。</p>\n<div><pre><code>\n    <span>public</span> <span>abstract</span> <span>class</span> <span>AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute<span>&lt;</span>TEntity<span>></span></span> <span>:</span> <span><span>AbstractShardingTimeKeyDateTimeVirtualTableRoute<span>&lt;</span>TEntity<span>></span></span></span> <span>where</span> <span>TEntity</span> <span>:</span> <span><span>class</span></span>\n    <span>{</span>\n        <span>public</span> <span>abstract</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span><span>;</span>\n        <span>public</span> <span>override</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> <span>GetAllTails</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> beginTime <span>=</span> ShardingCoreHelper<span>.</span><span>GetCurrentMonthFirstDay</span><span>(</span><span>GetBeginTime</span><span>(</span><span>)</span><span>)</span><span>;</span>\n         \n            <span><span>var</span></span> tails<span>=</span><span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span><span>;</span>\n            <span>//提前创建表</span>\n            <span><span>var</span></span> nowTimeStamp <span>=</span>ShardingCoreHelper<span>.</span><span>GetCurrentMonthFirstDay</span><span>(</span>DateTime<span>.</span>Now<span>)</span><span>;</span>\n            <span>if</span> <span>(</span>beginTime <span>></span> nowTimeStamp<span>)</span>\n                <span>throw</span> <span>new</span> <span>ArgumentException</span><span>(</span><span>\"begin time error\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> currentTimeStamp <span>=</span> beginTime<span>;</span>\n            <span>while</span> <span>(</span>currentTimeStamp <span>&lt;=</span> nowTimeStamp<span>)</span>\n            <span>{</span>\n                <span><span>var</span></span> tail <span>=</span> <span>ShardingKeyToTail</span><span>(</span>currentTimeStamp<span>)</span><span>;</span>\n                tails<span>.</span><span>Add</span><span>(</span>tail<span>)</span><span>;</span>\n                currentTimeStamp <span>=</span> ShardingCoreHelper<span>.</span><span>GetNextMonthFirstDay</span><span>(</span>currentTimeStamp<span>)</span><span>;</span>\n            <span>}</span>\n            <span>return</span> tails<span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br></div></div><p>首先上述代码是一个简单的按时间分表按月分，这边我只列出了两个方法相对动态添加比较重要，第一个是<code>GetBeginTime</code>，这个方法要求返回一个时间这个时间用于后续的<code>GetAllTails</code>.\n我们接着来看<code>GetAllTails</code>内部是获取<code>GetBeginTime</code>值然后计算出这个之间的当前月份的第一天，然后再对当前时间进行计算算出当前时间月份的第一天，那么后续进行两个值相差的每个月就是系统中这张表按时间分表的所有后缀.\n<code>GetAllTails</code>仅在启动时被调用一次后续,用于启动时判断，后续如果需要获取可以通过<code>IVirtualTableManager&lt;TShardingDbContext&gt;</code> 获取对应的所有的表后缀<code>virtualTableManager.GetVirtualTable(entityType).GetTableAllTails()</code></p>\n<div><p>注意</p>\n<p>!!!<code>GetAllTails</code>仅在启动时被调用一次后续,用于启动时判断!!!\n!!!<code>GetAllTails</code>仅在启动时被调用一次后续,用于启动时判断!!!\n!!!<code>GetAllTails</code>仅在启动时被调用一次后续,用于启动时判断!!!</p>\n</div>\n<h3 id=\"建表的分析\"> 建表的分析</h3>\n<div><pre><code>        <span>public</span> <span>Task</span> <span>ExecuteAsync</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> virtualTableManager <span>=</span> <span>(</span>IVirtualTableManager<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IVirtualTableManager<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>EntityMetadata<span>.</span>ShardingDbContextType<span>)</span><span>)</span><span>;</span>\n            <span><span>var</span></span> virtualTable <span>=</span> virtualTableManager<span>.</span><span>GetVirtualTable</span><span>(</span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>)</span><span>;</span>\n            _logger<span>.</span><span>LogDebug</span><span>(</span><span><span>$\"get </span><span><span>{</span><span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>.</span>Name</span><span>}</span></span><span>'s virtualTable \"</span></span><span>)</span><span>;</span>\n            <span>if</span> <span>(</span>virtualTable <span>==</span> <span>null</span><span>)</span>\n            <span>{</span>\n                _logger<span>.</span><span>LogDebug</span><span>(</span><span><span>$\" </span><span><span>{</span><span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>.</span>Name</span><span>}</span></span><span>'s virtualTable  is null\"</span></span><span>)</span><span>;</span>\n                <span>return</span> Task<span>.</span>CompletedTask<span>;</span>\n            <span>}</span>\n            <span><span>var</span></span> entityMetadataManager <span>=</span> <span>(</span>IEntityMetadataManager<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IEntityMetadataManager<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>EntityMetadata<span>.</span>ShardingDbContextType<span>)</span><span>)</span><span>;</span>\n            <span><span>var</span></span> virtualDataSource <span>=</span> <span>(</span>IVirtualDataSource<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IVirtualDataSource<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>EntityMetadata<span>.</span>ShardingDbContextType<span>)</span><span>)</span><span>;</span>\n            <span><span>var</span></span> tableCreator <span>=</span> <span>(</span>IShardingTableCreator<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IShardingTableCreator<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>EntityMetadata<span>.</span>ShardingDbContextType<span>)</span><span>)</span><span>;</span>\n            <span><span>var</span></span> now <span>=</span> DateTime<span>.</span>Now<span>.</span><span>AddMinutes</span><span>(</span><span>10</span><span>)</span><span>;</span>\n            <span><span>var</span></span> tail <span>=</span> virtualTable<span>.</span><span>GetVirtualRoute</span><span>(</span><span>)</span><span>.</span><span>ShardingKeyToTail</span><span>(</span>now<span>)</span><span>;</span>\n            <span>ISet<span>&lt;</span><span>string</span><span>></span></span> dataSources <span>=</span> <span>new</span> <span>HashSet<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span><span>;</span>\n            <span>if</span> <span>(</span>entityMetadataManager<span>.</span><span>IsShardingDataSource</span><span>(</span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>)</span><span>)</span>\n            <span>{</span>\n                <span><span>var</span></span> virtualDataSourceRoute <span>=</span> virtualDataSource<span>.</span><span>GetRoute</span><span>(</span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>)</span><span>;</span>\n                <span>foreach</span> <span>(</span><span><span>var</span></span> dataSourceName <span>in</span> virtualDataSourceRoute<span>.</span><span>GetAllDataSourceNames</span><span>(</span><span>)</span><span>)</span>\n                <span>{</span>\n                    dataSources<span>.</span><span>Add</span><span>(</span>dataSourceName<span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n            <span>else</span>\n            <span>{</span>\n                dataSources<span>.</span><span>Add</span><span>(</span>virtualDataSource<span>.</span>DefaultDataSourceName<span>)</span><span>;</span>\n            <span>}</span>\n            _logger<span>.</span><span>LogInformation</span><span>(</span><span><span>$\"auto create table data source names:[</span><span><span>{</span><span><span>string</span><span>.</span><span>Join</span><span>(</span><span>\",\"</span><span>,</span> dataSources<span>)</span></span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n            <span>foreach</span> <span>(</span><span><span>var</span></span> dataSource <span>in</span> dataSources<span>)</span>\n            <span>{</span>\n                <span>try</span>\n                <span>{</span>\n                    _logger<span>.</span><span>LogInformation</span><span>(</span><span><span>$\"begin table tail:[</span><span><span>{</span><span>tail</span><span>}</span></span><span>],entity:[</span><span><span>{</span><span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>.</span>Name</span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n                    tableCreator<span>.</span><span>CreateTable</span><span>(</span>dataSource<span>,</span> <span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>,</span> tail<span>)</span><span>;</span>\n                    _logger<span>.</span><span>LogInformation</span><span>(</span><span><span>$\"succeed table tail:[</span><span><span>{</span><span>tail</span><span>}</span></span><span>],entity:[</span><span><span>{</span><span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>.</span>Name</span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n                <span>}</span>\n                <span>catch</span> <span>(</span><span>Exception</span> e<span>)</span>\n                <span>{</span>\n                    <span>//ignore</span>\n                    _logger<span>.</span><span>LogInformation</span><span>(</span><span><span>$\"warning table tail:[</span><span><span>{</span><span>tail</span><span>}</span></span><span>],entity:[</span><span><span>{</span><span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>.</span>Name</span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n                    <span>if</span> <span>(</span>ShowErrorLog<span>)</span>\n                        _logger<span>.</span><span>LogError</span><span>(</span>e<span>,</span> <span><span>$\"</span><span><span>{</span><span>dataSource</span><span>}</span></span><span> </span><span><span>{</span><span><span>typeof</span><span>(</span><span>TEntity</span><span>)</span><span>.</span>Name</span><span>}</span></span><span>'s create table error \"</span></span><span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n            virtualTableManager<span>.</span><span>AddPhysicTable</span><span>(</span>virtualTable<span>,</span> <span>new</span> <span>DefaultPhysicTable</span><span>(</span>virtualTable<span>,</span> tail<span>)</span><span>)</span><span>;</span>\n\n            <span>return</span> Task<span>.</span>CompletedTask<span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br></div></div><p>代码取自按月分表自动建表任务的代码，当然如果是您自己有定时作业可以完全通过泛型方法的依赖注入获取而不需要反射+强转来实现。</p>\n<p><code>IVirtualTableManager&lt;TShardingDbContext&gt;</code> 拥有动态添加物理表的功能<code>AddPhysicTable</code>,来保证程序知道目前有多少个该表的后缀</p>\n<p><code>IEntityMetadataManager&lt;TShardingDbContext&gt;</code> 用来判断对应表是否为分表还是分库</p>\n<p><code>IVirtualDataSource&lt;TShardingDbContext&gt;</code> 用来获取对应的数据源名称</p>\n<p><code>IShardingTableCreator&lt;TShardingDbContext&gt;</code>用来实现表创建</p>\n<p>**注意：**因为数据库可能已经创建了对应的表。所以后续的调用会导致表创建抛出异常，这边在无论是否创建成功后都选择将物理表添加到对应的虚拟表里面，并且<code>virtualTableManager.AddPhysicTable</code>已经做好了无法重复添加的校验</p>\n<p>**结论：**动态添加表需要满足对应表路由能够正确返回对应目前的数据库表后缀全部数目，在创建对应的数据库表外，还需要对分表对象的<code>IVirtualTable</code>进行追加物理表使框架可以明确知道有这么一张表，并且需要考虑是否需要动态分表路由逻辑，当表后缀有新的添加之后那么是否对应的路由逻辑需要改变呢，比如我们是按租户Id来分表的那么新增后不需要修改路由逻辑，如果我们是取模的那么就需要考虑这个问题,并且需要考虑数据迁移，需要注意下次启动的时候会不会将之前添加的动态表添加进来呢?<code>GetAllTails</code>会不会在下次程序启动的时候不返回本次动态添加的呢</p>\n<div><p>注意</p>\n<p>!!!框架仅提供分表分库路由不提供数据迁移,数据迁移需要手动实现!!!\n!!!框架仅提供分表分库路由不提供数据迁移,数据迁移需要手动实现!!!\n!!!框架仅提供分表分库路由不提供数据迁移,数据迁移需要手动实现!!!</p>\n</div>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "Advance"
      ]
    },
    {
      "title": "Extension On Now Table",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/extension-only/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/extension-only/",
      "content_html": "<p>这边十分想用<code>shardiing-core</code>实现分表,但是因为系统里面其他部分很多程序在读这个表,所以这边希望保留原表名的情况下进行分表扩展,那么恭喜你sharding-core支持</p>\n",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "Advance"
      ]
    },
    {
      "title": "Route Parse Compile Cache",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/route-parse-compile-cache/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/route-parse-compile-cache/",
      "content_html": "<h2 id=\"表达式缓存失效情况\"> 表达式缓存失效情况</h2>\n<h3 id=\"可以复用表达式\"> 可以复用表达式</h3>\n<div><pre><code>\n        <span>public</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>int</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> t <span>=</span> <span>TimeFormatToTail</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>GreaterThan<span>:</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>GreaterThanOrEqual<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> t<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>>=</span> <span>0</span><span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>LessThan<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> t<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>&lt;</span> <span>0</span><span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>LessThanOrEqual<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> t<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>&lt;=</span> <span>0</span><span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div><h3 id=\"无法复用表达式\"> 无法复用表达式</h3>\n<div><pre><code>\n        <span>public</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>int</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> r <span>=</span> <span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>Next</span><span>(</span><span>1</span><span>,</span> <span>30000</span><span>)</span><span>;</span>\n            <span><span>var</span></span> t <span>=</span> <span>TimeFormatToTail</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>GreaterThan<span>:</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>GreaterThanOrEqual<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> t<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>>=</span> <span>0</span><span>&amp;&amp;</span>r<span>==</span>r<span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>LessThan<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> t<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>&lt;</span> <span>0</span> <span>&amp;&amp;</span> r <span>==</span> r<span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>LessThanOrEqual<span>:</span>\n                    <span>return</span> tail <span>=></span> String<span>.</span><span>Compare</span><span>(</span>tail<span>,</span> t<span>,</span> StringComparison<span>.</span>Ordinal<span>)</span> <span>&lt;=</span> <span>0</span> <span>;</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br></div></div><p>复用表达式原理 为便利表达式各个几点针对各个节点的常量值成员变量值进行hashcode计算,因为下面的表达式<code>&gt;</code>,<code>&gt;=</code>出现了随机数所以每次结果将不一样,所以表达式将无法正确计算值。合理设计表达式返回并且利用表达式缓存可以有效提升程序性能,请勿出现上述情况下的表达式会导致表达式无法缓存并且堆积缓存区</p>\n",
      "date_published": "2021-12-03T00:36:36.000Z",
      "date_modified": "2021-12-03T01:31:09.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "Adv"
      ]
    },
    {
      "title": "High Performance Page",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/pagination/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/pagination/",
      "content_html": "<h2 id=\"介绍\"> 介绍</h2>\n<p>所谓的高性能分页是针对分表分库下的数据聚合来实现的一种分页，总所周知如果你是内存分页那么时间复杂度将是O(x*n)其中x表示：<code>子sql条数</code>,n表示需要跳过的条数，但是流式聚合的时间复杂度却是O(n)其中n表示需要跳过的条数。也就是说理论上流式聚合的性能要远高于内存聚合。</p>\n<h3 id=\"分表解决方案\"> 分表解决方案</h3>\n<table>\n<thead>\n<tr>\n<th>解决方案</th>\n<th>skip&lt;=100</th>\n<th>skip&lt;10000</th>\n<th>skip&gt;10000</th>\n<th>优点</th>\n<th>缺点</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td><strong>内存分表</strong></td>\n<td>速度快O(n)，n=skip*分表数</td>\n<td>速度快O(n)，n=skip*分表数,内存暴涨</td>\n<td>O(n)，n=skip*分表数,内存爆炸,速度越来越慢</td>\n<td>实现简单,支持分库</td>\n<td>skip过大内存暴涨</td>\n</tr>\n<tr>\n<td><strong>union all</strong></td>\n<td>速度快</td>\n<td>速度快</td>\n<td>速度越来越慢</td>\n<td>实现简单</td>\n<td>不支持分库,不好优化,索引可能会失效</td>\n</tr>\n<tr>\n<td><strong>流式分表</strong></td>\n<td>速度快O(n)，n=skip</td>\n<td>速度快O(n)，n=skip</td>\n<td>O(n)，n=skip 速度越来越慢</td>\n<td>支持分库</td>\n<td>实现复杂,网络流量随着N增大</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"_1-内存分页\"> 1.内存分页</h4>\n<p>顾名思义就是将各个表的结果集合并到内存中进行排序后分页</p>\n<h4 id=\"_2-union-all\"> 2.union all</h4>\n<p>使用的是数据库本身的聚合操作,用过匿名表来实现和操作当前表一样无感知</p>\n<h4 id=\"_3-流式分表\"> 3.流式分表</h4>\n<p>和名字一样就是通过next来一次一次获取,和datareader类似只有在next后才可以获取到客户端</p>\n<h2 id=\"高性能分页\"> 高性能分页</h2>\n<h3 id=\"介绍-2\"> 介绍</h3>\n<p>目前sharding-core采用的是流式聚合所以普通情况下你的分页查询就是O(n)的性能代价，但是如果你是按时间来进行分表那么如果分页查询是以时间为主要排序就可以做到O(1)的分页性能。</p>\n<h3 id=\"条件\"> 条件</h3>\n<p>启用高性能分页有一个很重要的条件需要满足</p>\n<p>假设分表对象是<code>a</code>,分表有<code>a1</code>、<code>a2</code>、<code>a3</code>....<code>an</code>满足 表名后缀1、2、3、4....n的排序顺序和<code>order by a.x</code>是同向的即可。</p>\n<p>满足以下条件我们就可以说对象<code>a</code>的<code>x</code>属性满足高性能分页</p>\n<p>正序:<code>min(a1.x)</code>&lt;<code>max(a1.x)</code>&lt;<code>min(a2.x)</code>&lt;<code>max(a2.x)</code>......<code>min(an.x)</code>&lt;<code>max(an.x)</code>\n倒序:<code>min(a1.x)</code>&gt;<code>max(a1.x)</code>&gt;<code>min(a2.x)</code>&gt;<code>max(a2.x)</code>......<code>min(an.x)</code>&gt;<code>max(an.x)</code></p>\n<h3 id=\"分页配置\"> 分页配置</h3>\n<p>很显然按时间分表无疑就是这种情况下的满足者，那么该如何开启呢</p>\n<div><pre><code>    <span>public</span> <span>class</span> <span>OrderPaginationConfiguration</span><span>:</span><span><span>IPaginationConfiguration<span>&lt;</span>Order<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>PaginationBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>PaginationSequence</span><span>(</span>o <span>=></span> o<span>.</span>CreateTime<span>)</span>\n                <span>.</span><span>UseRouteComparer</span><span>(</span>Comparer<span>&lt;</span><span>string</span><span>></span><span>.</span>Default<span>)</span>\n                <span>.</span><span>UseQueryMatch</span><span>(</span>PaginationMatchEnum<span>.</span>Owner <span>|</span> PaginationMatchEnum<span>.</span>Named <span>|</span> PaginationMatchEnum<span>.</span>PrimaryMatch<span>)</span><span>.</span><span>UseAppendIfOrderNone</span><span>(</span><span>)</span><span>;</span>\n\n            builder<span>.</span><span>ConfigReverseShardingPage</span><span>(</span><span>0.5d</span><span>,</span> <span>10000L</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>我们是将订单表按订单的创建时间进行分页,所以可以得知订单分表后缀满足以上条件</p>\n<p><code>order_2019</code>,<code>order_20120</code>,<code>order_2021</code>满足<code>2019</code>&lt;<code>2020</code>&lt;<code>2021</code>且<code>min(order_2019.createTime)</code>&lt;<code>max(order_2019.createTime)</code>&lt;<code>min(order_2020.createTime)</code>&lt;<code>max(order_2020.createTime)</code>&lt;<code>min(order_2021.createTime)</code>&lt;<code>max(order_2021.createTime)</code></p>\n<h4 id=\"paginationsequence\"> PaginationSequence</h4>\n<p>表示如果分页的时候按这个字段进行排序才会启用</p>\n<p>如果你的id是雪花id那么也可以将id进行配置</p>\n<div><pre><code>    <span>public</span> <span>class</span> <span>OrderPaginationConfiguration</span><span>:</span><span><span>IPaginationConfiguration<span>&lt;</span>Order<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>PaginationBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>PaginationSequence</span><span>(</span>o <span>=></span> o<span>.</span>CreateTime<span>)</span>\n                <span>.</span><span>UseRouteComparer</span><span>(</span>Comparer<span>&lt;</span><span>string</span><span>></span><span>.</span>Default<span>)</span>\n                <span>.</span><span>UseQueryMatch</span><span>(</span>PaginationMatchEnum<span>.</span>Owner <span>|</span> PaginationMatchEnum<span>.</span>Named <span>|</span> PaginationMatchEnum<span>.</span>PrimaryMatch<span>)</span><span>.</span><span>UseAppendIfOrderNone</span><span>(</span><span>)</span><span>;</span>\n            <span>//雪花id也满足以上表达式    </span>\n            builder<span>.</span><span>PaginationSequence</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span>\n                <span>.</span><span>UseRouteComparer</span><span>(</span>Comparer<span>&lt;</span><span>string</span><span>></span><span>.</span>Default<span>)</span>\n                <span>.</span><span>UseQueryMatch</span><span>(</span>PaginationMatchEnum<span>.</span>Owner <span>|</span> PaginationMatchEnum<span>.</span>Named <span>|</span> PaginationMatchEnum<span>.</span>PrimaryMatch<span>)</span><span>;</span>\n\n            builder<span>.</span><span>ConfigReverseShardingPage</span><span>(</span><span>0.5d</span><span>,</span> <span>10000L</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div><h4 id=\"useroutecomparer\"> UseRouteComparer</h4>\n<p>表示后缀的排序顺序</p>\n<h4 id=\"usequerymatch\"> UseQueryMatch</h4>\n<p>表示我们应该用何种方式来匹配本次查询,例子中的表名只要是CreateTime是属于本次返回结果的值或者名字匹配或者order by的第一个匹配即可</p>\n<h4 id=\"useappendifordernone\"> UseAppendIfOrderNone</h4>\n<p>表示如果本次查询没有任何order by字段的时候自动将<code>CreateTime</code>作为order by的条件附加上去，并且为正序当然一般情况下肯定是手动会加上order by所以不用太在意此属性</p>\n<h4 id=\"configreverseshardingpage\"> ConfigReverseShardingPage</h4>\n<p>表示启用反向排序，当分页total大于10000以上且本次查询skip的数目超过总的total的1/2那么就会启用反向排序</p>\n<div><p>注意</p>\n<p>反向排序和顺序分页排序互斥优先级先进行顺序分页排序，当不符合顺序分页排序时才进行反向排序</p>\n</div>\n<h3 id=\"虚拟路由配置\"> 虚拟路由配置</h3>\n<div><pre><code>    <span>public</span> <span>class</span> <span>OrderVirtualRoute</span><span>:</span><span><span>AbstractSimpleShardingDayKeyDateTimeVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n    <span>{</span>\n\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> DateTime<span>.</span>Now<span>.</span>Date<span>.</span><span>AddDays</span><span>(</span><span>-</span><span>3</span><span>)</span><span>;</span>\n        <span>}</span>\n        \n        <span>/// &lt;summary></span>\n        <span>/// 返回null表示不开启</span>\n        <span>/// &lt;/summary></span>\n        <span>/// &lt;returns>&lt;/returns></span>\n        <span>public</span> <span>override</span> <span>IPaginationConfiguration<span>&lt;</span>Order<span>></span></span> <span>CreatePaginationConfiguration</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>new</span> <span>OrderPaginationConfiguration</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br></div></div><h3 id=\"如何使用\"> 如何使用</h3>\n<p>框架已经封装了一个分页的扩展</p>\n<div><pre><code>\n        <span>public</span> <span>static</span> <span>async</span> <span>Task<span>&lt;</span>ShardingPagedResult<span>&lt;</span>T<span>></span><span>></span></span> <span><span>ToShardingPageAsync</span><span><span>&lt;</span>T<span>></span></span></span><span>(</span><span>this</span> <span>IQueryable<span>&lt;</span>T<span>></span></span> source<span>,</span> <span><span>int</span></span> pageIndex<span>,</span> <span><span>int</span></span> pageSize<span>)</span>\n        <span>{</span>\n            <span>//设置每次获取多少页</span>\n            <span><span>var</span></span> take <span>=</span> pageSize <span>&lt;=</span> <span>0</span> <span>?</span> <span>1</span> <span>:</span> pageSize<span>;</span>\n            <span>//设置当前页码最小1</span>\n            <span><span>var</span></span> index <span>=</span> pageIndex <span>&lt;=</span> <span>0</span> <span>?</span> <span>1</span> <span>:</span> pageIndex<span>;</span>\n            <span>//需要跳过多少页</span>\n            <span><span>var</span></span> skip <span>=</span> <span>(</span>index <span>-</span> <span>1</span><span>)</span> <span>*</span> take<span>;</span>\n            <span><span>var</span></span> shardingPageManager <span>=</span> ShardingContainer<span>.</span><span><span>GetService</span><span><span>&lt;</span>IShardingPageManager<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n            <span>using</span> <span>(</span>shardingPageManager<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                <span>//获取每次总记录数</span>\n                <span><span>var</span></span> count <span>=</span> <span>await</span> source<span>.</span><span>LongCountAsync</span><span>(</span><span>)</span><span>;</span>\n                <span>if</span> <span>(</span>count <span>&lt;=</span> skip<span>)</span>\n                    <span>return</span> <span>new</span> <span>ShardingPagedResult<span>&lt;</span>T<span>></span></span><span>(</span><span>new</span> <span>List<span>&lt;</span>T<span>></span></span><span>(</span><span>0</span><span>)</span><span>,</span> count<span>)</span><span>;</span>\n                <span>//获取剩余条数</span>\n                <span><span>var</span></span> remainingCount <span>=</span> count <span>-</span> skip<span>;</span>\n                <span>//当剩余条数小于take数就取remainingCount</span>\n                <span><span>var</span></span> realTake <span>=</span> remainingCount <span>&lt;</span> <span>take <span>?</span></span> remainingCount <span>:</span> take<span>;</span>\n                <span><span>var</span></span> data <span>=</span> <span>await</span> source<span>.</span><span>Skip</span><span>(</span>skip<span>)</span><span>.</span><span>Take</span><span>(</span><span>(</span><span>int</span><span>)</span>realTake<span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n                <span>return</span> <span>new</span> <span>ShardingPagedResult<span>&lt;</span>T<span>></span></span><span>(</span>data<span>,</span> count<span>)</span><span>;</span>\n            <span>}</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br></div></div><p>你可以自行封装或使用框架的</p>\n<div><pre><code>            <span><span>var</span></span> shardingPageResult <span>=</span> <span>await</span> _defaultTableDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>OrderBy</span><span>(</span>o <span>=></span> o<span>.</span>CreateTime<span>)</span><span>.</span><span>ToShardingPageAsync</span><span>(</span>pageIndex<span>,</span> pageSize<span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br></div></div>",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-19T03:23:20.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "Advance"
      ]
    },
    {
      "title": "Transaction",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/transaction/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/adv/transaction/",
      "content_html": "<h2 id=\"开启事务\"> 开启事务</h2>\n<div><pre><code><span>//使用方式和原生efcore一致</span>\n<span><span>var</span></span> tran <span>=</span> _defaultTableDbContext<span>.</span>Database<span>.</span><span>BeginTransaction</span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br></div></div><h2 id=\"提交事务\"> 提交事务</h2>\n<div><pre><code>tran<span>.</span><span>Commit</span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br></div></div><h2 id=\"回滚事务\"> 回滚事务</h2>\n<div><pre><code>tran<span>.</span><span>Rollback</span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br></div></div><h2 id=\"如何使用\"> 如何使用</h2>\n<div><pre><code>\n            <span>using</span> <span>(</span><span><span>var</span></span> tran <span>=</span> _defaultTableDbContext<span>.</span>Database<span>.</span><span>BeginTransaction</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                _defaultTableDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUserMod<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Insert</span><span>(</span>data<span>)</span><span>;</span>\n                _defaultTableDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n                <span><span>var</span></span> a <span>=</span> <span>0</span><span>;</span>\n                <span><span>var</span></span> b <span>=</span> <span>1</span> <span>/</span> a<span>;</span><span>//强制出错</span>\n                tran<span>.</span><span>Commit</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><p>使用方式和efcore一致，无需手动调用回滚，会在出错时自动回滚,如果是efcore普通操作需要调用<code>SaveChanges</code>，如果是三方框架直接提交的那么就不需要调用<code>SaveChanges</code></p>\n<h2 id=\"加入外部事务\"> 加入外部事务</h2>\n<div><pre><code>_defaultTableDbContext<span>.</span>Database<span>.</span><span>UseTransaction</span><span>(</span>transaction<span>)</span>\n</code></pre>\n<div><span>1</span><br></div></div><p>使用方式和efcore一致</p>\n<h2 id=\"分库下的事务\"> 分库下的事务</h2>\n<p>分库情况下使用事务需要注意一点，默认启用的是弱事务，如果出现本次操作跨库那么具体的逻辑为开启默认数据源(data source name 为default的那个)事务，之后通知现有的<code>IDataSourceDbContext</code>分别开启事务,提交的时候采用弱一致性，先提交默认的data source name的数据源事务，如果出错并且外部只有一个数据源那么就抛错，如果默认数据源事务出错就直接出错，如果非默认事务提交出错且数据源存在多个将忽略错误依次提交，手动调用rollback如果是回滚那么就是依次回滚不在抛错。仅保证业务逻辑下出错完美事务，网络原因导致的事务提交出错程序无法处理</p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "Advance"
      ]
    },
    {
      "title": "性能测试",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/benchmark/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/benchmark/",
      "content_html": "<h2 id=\"性能测试\"> 性能测试</h2>\n<p>以下所有数据均在开启了表达式编译缓存的情况下测试，并且电脑处于长时间未关机并且开着很多vs和idea的情况下仅供参考,所有测试都是基于ShardingCore x.3.1.63+ version</p>\n<p>以下所有数据均在<a href=\"https://github.com/xuejmnet/sharding-core/blob/main/benchmarks/ShardingCoreBenchmark/EFCoreCrud.cs\" target=\"_blank\" rel=\"noopener noreferrer\">源码中有案例</a></p>\n<p>efcore版本均为6.0 表结构为string型id的订单取模分成5张表</p>\n<p>N代表执行次数</p>\n<h4 id=\"sql-server-2012-data-rows-7734363-773w\"> sql server 2012,data rows 7734363 =773w</h4>\n<p>// * Summary *</p>\n<p>BenchmarkDotNet=v0.13.1, OS=Windows 10.0.18363.1500 (1909/November2019Update/19H2)\nAMD Ryzen 9 3900X, 1 CPU, 24 logical and 12 physical cores\n.NET SDK=6.0.100\n[Host]     : .NET 6.0.0 (6.0.21.52210), X64 RyuJIT\nDefaultJob : .NET 6.0.0 (6.0.21.52210), X64 RyuJIT</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>N</th>\n<th style=\"text-align:right\">Mean</th>\n<th style=\"text-align:right\">Error</th>\n<th style=\"text-align:right\">StdDev</th>\n<th style=\"text-align:right\">Median</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>NoShardingFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">2.305 ms</td>\n<td style=\"text-align:right\">0.0419 ms</td>\n<td style=\"text-align:right\">0.0587 ms</td>\n<td style=\"text-align:right\">2.310 ms</td>\n</tr>\n<tr>\n<td>ShardingFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">4.200 ms</td>\n<td style=\"text-align:right\">0.0793 ms</td>\n<td style=\"text-align:right\">0.0815 ms</td>\n<td style=\"text-align:right\">4.205 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">1,521.727 ms</td>\n<td style=\"text-align:right\">11.7909 ms</td>\n<td style=\"text-align:right\">11.0292 ms</td>\n<td style=\"text-align:right\">1,519.390 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">1,841.243 ms</td>\n<td style=\"text-align:right\">36.1808 ms</td>\n<td style=\"text-align:right\">49.5247 ms</td>\n<td style=\"text-align:right\">1,826.228 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexCountAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">1,602.127 ms</td>\n<td style=\"text-align:right\">31.2448 ms</td>\n<td style=\"text-align:right\">26.0908 ms</td>\n<td style=\"text-align:right\">1,592.494 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexCountAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">1,946.878 ms</td>\n<td style=\"text-align:right\">33.9453 ms</td>\n<td style=\"text-align:right\">31.7525 ms</td>\n<td style=\"text-align:right\">1,948.952 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexFirstOrDefaultAsync0w</td>\n<td>10</td>\n<td style=\"text-align:right\">703.570 ms</td>\n<td style=\"text-align:right\">10.4157 ms</td>\n<td style=\"text-align:right\">9.2332 ms</td>\n<td style=\"text-align:right\">705.236 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexFirstOrDefaultAsync0w</td>\n<td>10</td>\n<td style=\"text-align:right\">857.718 ms</td>\n<td style=\"text-align:right\">16.4004 ms</td>\n<td style=\"text-align:right\">15.3409 ms</td>\n<td style=\"text-align:right\">858.675 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexFirstOrDefaultAsync99w</td>\n<td>10</td>\n<td style=\"text-align:right\">818.947 ms</td>\n<td style=\"text-align:right\">16.2501 ms</td>\n<td style=\"text-align:right\">24.8156 ms</td>\n<td style=\"text-align:right\">814.093 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexFirstOrDefaultAsync99w</td>\n<td>10</td>\n<td style=\"text-align:right\">957.405 ms</td>\n<td style=\"text-align:right\">15.8800 ms</td>\n<td style=\"text-align:right\">16.9915 ms</td>\n<td style=\"text-align:right\">953.739 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexLikeToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">7,247.554 ms</td>\n<td style=\"text-align:right\">140.2374 ms</td>\n<td style=\"text-align:right\">191.9586 ms</td>\n<td style=\"text-align:right\">7,292.292 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexLikeToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">7,232.702 ms</td>\n<td style=\"text-align:right\">106.7630 ms</td>\n<td style=\"text-align:right\">99.8662 ms</td>\n<td style=\"text-align:right\">7,184.900 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">815.207 ms</td>\n<td style=\"text-align:right\">14.6120 ms</td>\n<td style=\"text-align:right\">21.4181 ms</td>\n<td style=\"text-align:right\">804.195 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">948.056 ms</td>\n<td style=\"text-align:right\">7.3526 ms</td>\n<td style=\"text-align:right\">6.8776 ms</td>\n<td style=\"text-align:right\">944.511 ms</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"mysql-5-7-data-rows-7553790-755w-innerdb-buffer-size-3g\"> mysql 5.7,data rows 7553790=755w innerdb_buffer_size=3G</h4>\n<p>// * Summary *</p>\n<p>BenchmarkDotNet=v0.13.1, OS=Windows 10.0.18363.1500 (1909/November2019Update/19H2)\nAMD Ryzen 9 3900X, 1 CPU, 24 logical and 12 physical cores\n.NET SDK=6.0.100\n[Host]     : .NET 6.0.0 (6.0.21.52210), X64 RyuJIT\nDefaultJob : .NET 6.0.0 (6.0.21.52210), X64 RyuJIT</p>\n<table>\n<thead>\n<tr>\n<th>Method</th>\n<th>N</th>\n<th style=\"text-align:right\">Mean</th>\n<th style=\"text-align:right\">Error</th>\n<th style=\"text-align:right\">StdDev</th>\n<th style=\"text-align:right\">Median</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>NoShardingFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">10.092 ms</td>\n<td style=\"text-align:right\">1.6571 ms</td>\n<td style=\"text-align:right\">4.5082 ms</td>\n<td style=\"text-align:right\">8.677 ms</td>\n</tr>\n<tr>\n<td>ShardingFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">9.082 ms</td>\n<td style=\"text-align:right\">0.1810 ms</td>\n<td style=\"text-align:right\">0.3445 ms</td>\n<td style=\"text-align:right\">9.096 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">6.586 ms</td>\n<td style=\"text-align:right\">0.0795 ms</td>\n<td style=\"text-align:right\">0.0705 ms</td>\n<td style=\"text-align:right\">6.565 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexFirstOrDefaultAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">17.617 ms</td>\n<td style=\"text-align:right\">0.3345 ms</td>\n<td style=\"text-align:right\">0.3129 ms</td>\n<td style=\"text-align:right\">17.481 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexCountAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">6.498 ms</td>\n<td style=\"text-align:right\">0.1188 ms</td>\n<td style=\"text-align:right\">0.1415 ms</td>\n<td style=\"text-align:right\">6.454 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexCountAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">17.791 ms</td>\n<td style=\"text-align:right\">0.2928 ms</td>\n<td style=\"text-align:right\">0.2739 ms</td>\n<td style=\"text-align:right\">17.805 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexFirstOrDefaultAsync0w</td>\n<td>10</td>\n<td style=\"text-align:right\">3.239 ms</td>\n<td style=\"text-align:right\">0.0285 ms</td>\n<td style=\"text-align:right\">0.0267 ms</td>\n<td style=\"text-align:right\">3.231 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexFirstOrDefaultAsync0w</td>\n<td>10</td>\n<td style=\"text-align:right\">8.826 ms</td>\n<td style=\"text-align:right\">0.1719 ms</td>\n<td style=\"text-align:right\">0.1688 ms</td>\n<td style=\"text-align:right\">8.806 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexFirstOrDefaultAsync99w</td>\n<td>10</td>\n<td style=\"text-align:right\">3.260 ms</td>\n<td style=\"text-align:right\">0.0208 ms</td>\n<td style=\"text-align:right\">0.0194 ms</td>\n<td style=\"text-align:right\">3.257 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexFirstOrDefaultAsync99w</td>\n<td>10</td>\n<td style=\"text-align:right\">8.634 ms</td>\n<td style=\"text-align:right\">0.1062 ms</td>\n<td style=\"text-align:right\">0.0994 ms</td>\n<td style=\"text-align:right\">8.653 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexLikeToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">26,941.543 ms</td>\n<td style=\"text-align:right\">138.5988 ms</td>\n<td style=\"text-align:right\">129.6454 ms</td>\n<td style=\"text-align:right\">26,920.578 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexLikeToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">5,840.364 ms</td>\n<td style=\"text-align:right\">112.0434 ms</td>\n<td style=\"text-align:right\">115.0604 ms</td>\n<td style=\"text-align:right\">5,797.137 ms</td>\n</tr>\n<tr>\n<td>NoShardingNoIndexToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">25,865.136 ms</td>\n<td style=\"text-align:right\">115.6391 ms</td>\n<td style=\"text-align:right\">102.5111 ms</td>\n<td style=\"text-align:right\">25,847.258 ms</td>\n</tr>\n<tr>\n<td>ShardingNoIndexToListAsync</td>\n<td>10</td>\n<td style=\"text-align:right\">5,502.922 ms</td>\n<td style=\"text-align:right\">92.7201 ms</td>\n<td style=\"text-align:right\">86.7305 ms</td>\n<td style=\"text-align:right\">5,483.847 ms</td>\n</tr>\n</tbody>\n</table>\n<p>具体可以通过first前两次结果来计算得出结论单次查询的的损耗为0.3-0.4毫秒之间,通过数据聚合和数据路由的损耗单次在0.3ms-0.4ms,其中创建dbcontext为0.1毫秒目前没有好的优化方案,0.013毫秒左右是路由表达式解析和编译,复杂表达式可能更加耗时,剩下的0.28毫秒为数据源和表后缀的解析等操作包括实例的反射创建和数据的聚合，\nsqlserver的各项数据在分表和未分表的情况下都几乎差不多可以得出在770w数据集情况下数据库还并未是数据瓶颈的关键，但是mysql可以看到在分表和未分表的情况下如果涉及到没有索引的全表扫描那么性能的差距将是分表后的表数目之多，测试中为5-6倍，也就是分表数目</p>\n",
      "date_published": "2021-12-03T00:36:36.000Z",
      "date_modified": "2021-12-03T00:36:36.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "性能测试"
      ]
    },
    {
      "title": "Introduce",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/guide/introduce/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/guide/introduce/",
      "content_html": "<h2 id=\"important\"> Important</h2>\n<p>this is very Important if u first use <a href=\"/sharding-core-doc/en/important\">Important</a></p>\n<div><p>警告</p>\n<p>！！！Important,Important,Important！！！</p>\n<p>！！！Important,Important,Important！！！</p>\n<p>！！！Important,Important,Important！！！</p>\n</div>\n<p>ShardingCore best solution for <a href=\"https://github.com/dotnet/efcore\" target=\"_blank\" rel=\"noopener noreferrer\">efcore</a> sharding。</p>\n<div><p>注意</p>\n<ol>\n<li>this lib is efcore extension only</li>\n<li>very good this lib</li>\n<li>should manual migrate data</li>\n<li>if u framework use efcore,add sharding-core this ez,configure <code>DbContextOptionsBuilder</code>(e。g <a href=\"https://github.com/abpframework/abp\" target=\"_blank\" rel=\"noopener noreferrer\">abp vnext</a>)</li>\n</ol>\n</div>\n<h2 id=\"advantage\"> Advantage</h2>\n<ul>\n<li><strong>Code First</strong></li>\n</ul>\n<p>support efcore's code first。</p>\n<ul>\n<li><strong>customer route</strong></li>\n</ul>\n<p>support customer route sharding table and data base</p>\n<ul>\n<li><strong>default route</strong></li>\n</ul>\n<p>support more default route :int field hash code,string field hash code,long field time sharding,datetime field sharding,and support dynamic append table</p>\n<ul>\n<li><strong>any type field sharding</strong></li>\n</ul>\n<p>support any type field e.g:string,datetime,long,int...</p>\n<ul>\n<li><strong>join、group</strong></li>\n</ul>\n<p>support sharding entity join no sharding entity,sharding entity join sharding entity, group by too support</p>\n<ul>\n<li><strong>high performance page</strong></li>\n</ul>\n<p>sequence table tail support O(1) page,and support reverse page</p>\n<ul>\n<li><strong>manual route</strong></li>\n</ul>\n<p>support hint route</p>\n<ul>\n<li><strong>batch operate</strong></li>\n</ul>\n<p>support efcore batch operate extension</p>\n<ul>\n<li><strong>auto track</strong></li>\n</ul>\n<p>support efcore track</p>\n<ul>\n<li><strong>zero learning cost</strong></li>\n</ul>\n<p>use same as efcore native operation</p>\n<ul>\n<li><strong>multi data source support</strong></li>\n</ul>\n<p>support efcore2+ version sharding</p>\n<ul>\n<li><strong>multi entity properity sharding</strong></li>\n</ul>\n<p>sharding entity can set more than one property to support sharding query</p>\n<ul>\n<li><strong>dynaimc sharding database</strong></li>\n</ul>\n<p>support dynamic sharding database in application running</p>\n<ul>\n<li><strong>dynamic read write</strong></li>\n</ul>\n<p>support dynamic read write in application running</p>\n<ul>\n<li><strong>dynamic multi sharding config</strong></li>\n</ul>\n<p>support dynamic multi sharding config in application running</p>\n<p>go!  go!  go!</p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2022-02-20T06:41:00.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "Guide"
      ]
    },
    {
      "title": "自动追踪",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/guide/auto-track/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/guide/auto-track/",
      "content_html": "<p>自动追踪</p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-03T00:33:21.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "参数配置",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/guide/params-confg/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/guide/params-confg/",
      "content_html": "<h2 id=\"autotrackentity\"> AutoTrackEntity</h2>\n<p>sharding-core默认针对分表后的数据将不支持追踪,未分表的对象支持原生efcore的追踪规则,如果你的查询对象A是部分表的那么依旧符合原生使用efcore的追踪规则,针对分表对象B那么将不再支持追踪.</p>\n<h3 id=\"使用追踪\"> 使用追踪</h3>\n<p>你可以设置<code>AutoTrackEntity</code>为true</p>\n<div><pre><code>services<span>.</span><span><span>AddShardingConfigure</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>(</span>conn<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>Begin</span><span>(</span>o <span>=></span>\n                <span>{</span>\n                <span>}</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><p>那么所有的对象都将支持追踪。</p>\n<h3 id=\"不启用追踪\"> 不启用追踪</h3>\n<p><code>AutoTrackEntity</code>设置为true或者false都没什么关系,建议设置为true，因为有可能需要使用追踪</p>\n<div><pre><code> services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>DefaultShardingDbContext<span>></span></span></span><span>(</span>\n                    <span>(</span>conn<span>,</span> o<span>)</span> <span>=></span>\n                        o<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>.</span><span>UseQueryTrackingBehavior</span><span>(</span>QueryTrackingBehavior<span>.</span>NoTracking<span>)</span>\n                <span>)</span><span>.</span><span>Begin</span><span>(</span>o <span>=></span>\n                <span>{</span>\n                <span>}</span><span>)</span>\n                <span>.</span><span>AddShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseQueryTrackingBehavior</span><span>(</span>QueryTrackingBehavior<span>.</span>NoTracking<span>)</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><p>追加所有的创建<code>DbContext</code>的委托<code>.UseQueryTrackingBehavior(QueryTrackingBehavior.NoTracking)</code>那么所有的查询都将不再启用追踪除非手动调用<code>AsTracking</code></p>\n<div><p>注意</p>\n<p>因为<code>AutoTrackEntity</code>设置为false后如果不设置<code>DbContext</code>为<code>.UseQueryTrackingBehavior(QueryTrackingBehavior.NoTracking)</code>那么分表后的查询依然会走追踪只是程序无法追踪到，因为查询的原理会新创建n个<code>DbContext</code>但是这些<code>DbContext</code>进行查询的时候并没有使用<code>NoTracking</code>所以性能上还是会有一定的损失，<strong>总结就是<code>AutoTrackEntity</code>无脑设置为true</strong></p>\n</div>\n<h2 id=\"ensurecreatedwithoutshardingtable\"> EnsureCreatedWithOutShardingTable</h2>\n<p>这个属性的意思很好理解就是是否需要在启动的时候创建表，这边的创建表是除了分表的对象，其他对象都会直接创建对应的表，只有当数据库是空的前提下或者没有数据库的前提下会自动创建数据库和普通表，如果您是使用<a href=\"/adv/code-first/\">code-first</a>的那么这个值可以无视或者设置为false。</p>\n<div><p>注意</p>\n<p>!!!<strong>只有</strong>当数据库是空的前提下或者没有数据库的前提下会自动创建数据库和普通表!!!</p>\n<p>!!!<strong>只有</strong>当数据库是空的前提下或者没有数据库的前提下会自动创建数据库和普通表!!!</p>\n<p>!!!<strong>只有</strong>当数据库是空的前提下或者没有数据库的前提下会自动创建数据库和普通表!!!</p>\n</div>\n<h2 id=\"createshardingtableonstart\"> CreateShardingTableOnStart</h2>\n<p>这个熟悉的意思就是是否需要在启动的时候创建表，但是由于<code>efcore</code>并未提供关于表是否存在的判断，所以如果你将这个值设置为true,那么每次都会在启动的时候都会去执行创建表的方法，这样就会导致启动的时候如果有某些表过多那么就会导致启动速度变慢，可以再您未创建表的时候使用这个属性，创建完成后将这个属性设置为false，如果您是使用<a href=\"/sharding-core-doc/sharding-core-doc/adv/code-first/\">code-first</a>的那么这个值可以无视或者设置为false。</p>\n<h2 id=\"ignorecreatetableerror\"> IgnoreCreateTableError</h2>\n<p><code>sharding-core</code>默认会在创建表失败后输出错误信息,但是输出的信息会被log记录所以为了log不记录这些信息，可以将这个值设置为true那么如果创建失败(已经存在表)框架将不会抛出对应的错误消息，如果您是使用<a href=\"/sharding-core-doc/adv/code-first/\">code-first</a>的那么这个值可以无视或者设置为false。</p>\n<h2 id=\"parallelquerymaxthreadcount\"> ParallelQueryMaxThreadCount</h2>\n<p>并发查询最大线程数,默认cpu核心数*2，因为分表/分库后的单次查询会涉及到N张表，N&gt;=1为了保证单次查询不会导致整个系统崩溃掉，所以这边提供了这个属性，可以保证涉及到跨库或者跨表的时候查询不会创建过多的线程来执行<code>DbConnection</code></p>\n<h2 id=\"parallelquerytimeout\"> ParallelQueryTimeOut</h2>\n<p>并发查询超时时间,默认30秒,这个字段也是为了在分成多个线程查询后可能导致线程一致未返回结果，所以添加了这个字段在超时后可以取消掉现有的线程,防止无限制等待。</p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2022-01-07T14:00:26.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "读写分离",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/guide/read-write/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/guide/read-write/",
      "content_html": "",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-03T00:33:21.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "概念",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/guide/terminology/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/guide/terminology/",
      "content_html": "<p><code>sharding-core</code>框架是一款分表分库组件,一款将efcore的一个dbcontext一个对象一张表扩展成了一个dbcontext一个对象多张表对应多个dbcontext,一款基于表达式解析，具有高性能路由的分表分库框架。</p>\n<h2 id=\"全局\"> 全局</h2>\n<h3 id=\"ientitymetadatamanager\"> IEntityMetadataManager</h3>\n<p><code>IEntityMetadataManager&lt;TShardingDbContext&gt;</code>管理对象数据，将对象数据分表和分库的对象进行存储管理，可以区分对象是否分表是否分库，并且可以获取对应的对象类型元数据<code>EntityMetadata</code></p>\n<div><pre><code><span>//直接获取</span>\nShardingContainer<span>.</span><span><span>GetService</span><span><span>&lt;</span>IEntityMetadataManager<span>&lt;</span>TShardingDbContext<span>></span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n<span>//通过非泛型方法获取</span>\n<span>(</span>IEntityMetadataManager<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IEntityMetadataManager<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>shardingDbContext<span>.</span><span>GetType</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><h3 id=\"entitymetadata\"> EntityMetadata</h3>\n<p><code>EntityMetadata</code>对象类型元数据，是针对分表分库对象的数据解析后的存储，通过对象类型元数据可以获取到对象的类型和对应的<code>虚拟表名</code>(不带后缀的表名)，<code>表主键</code>，是否分表是否分库，包括分表he分库的对应字段属性信息</p>\n<div><pre><code><span>//直接获取</span>\n<span>IEntityMetadataManager</span> entityMetadataManager<span>=</span><span>..</span><span>..</span><span>.</span><span>;</span>\nentityMetadataManager<span>.</span><span>TryGet</span><span>(</span>EntityType<span>)</span><span>;</span>\nentityMetadataManager<span>.</span><span><span>TryGet</span><span><span>&lt;</span>TEntity<span>></span></span></span><span>(</span>TEntity<span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><h3 id=\"ivirtualdatasource\"> IVirtualDataSource</h3>\n<p><code>IVirtualDataSource&lt;TShardingDbContext&gt;</code>虚拟数据源，虚拟数据源用于记录当前分库拥有多少个数据源名称(拥有多少个:DataSourceName),\n整个dbcontext只有一个，可以通过依赖注入获取 .</p>\n<div><pre><code><span>//直接获取</span>\nShardingContainer<span>.</span><span><span>GetService</span><span><span>&lt;</span>IVirtualDataSource<span>&lt;</span>TShardingDbContext<span>></span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n<span>//通过非泛型方法获取</span>\n<span>(</span>IVirtualDataSource<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IVirtualDataSource<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>shardingDbContext<span>.</span><span>GetType</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><div><p>自定义标题</p>\n<p>因为<code>IVirtualDataSource&lt;TShardingDbContext&gt;</code>继承<code>IVirtualDataSource</code>，并且所有的接口都在<code>IVirtualDataSource</code>但是注入为了区分多个<code>DdbContext</code>之间所以采用泛型注入，其他接口也是同理</p>\n</div>\n<h3 id=\"datasourcename\"> DataSourceName</h3>\n<p>数据源名称，默认针对<code>ShardingCore</code>每个链接都对应其自己的数据源，都有属于自己的数据源名称和数据源的链接。无论是否分表数据源名称都会有，只不过因为仅分表状态下只链接单个数据库，所以数据源名称在整个框架下只有一个，所以如果您是分表那么数据源名称可以随便添加，因为默认的数据源名称有且只有一个。</p>\n<div><pre><code><span>//配置</span>\n <span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"ds0\"</span><span>,</span><span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBxx0;Integrated Security=True;\"</span><span>)</span>\n                <span>.</span><span>AddShardingDataSource</span><span>(</span>sp <span>=></span>\n                <span>{</span>\n                    <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span><span>\"ds1\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBxx1;Integrated Security=True;\"</span><span>}</span><span>,</span>\n                        <span>{</span><span>\"ds2\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBxx2;Integrated Security=True;\"</span><span>}</span><span>,</span>\n                    <span>}</span><span>;</span>\n                <span>}</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br></div></div><p>通过上面我们可以看到我们其实分了三个数据库分别是<code>ds0</code>,<code>ds1</code>,<code>ds2</code>,使用分表的时候需要注意，仅分表对象才会进入分表，其他所有没有分表路由的对象将全部走DefaultDataSourceName数据库。</p>\n<h3 id=\"ishardingtablecreator\"> IShardingTableCreator</h3>\n<p>分表对象创建,可以创建对应的分表指定对应的表后缀即可</p>\n<div><pre><code><span>//直接获取</span>\nShardingContainer<span>.</span><span><span>GetService</span><span><span>&lt;</span>IShardingTableCreator<span>&lt;</span>TShardingDbContext<span>></span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n<span>//通过非泛型方法获取</span>\n<span>(</span>IShardingTableCreator<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IShardingTableCreator<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>shardingDbContext<span>.</span><span>GetType</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span>\n\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><h2 id=\"分库概念\"> 分库概念</h2>\n<h3 id=\"ivirtualdatasourceroute\"> IVirtualDataSourceRoute</h3>\n<p><code>IVirtualDataSourceRoute</code>虚拟数据源路由,如果您的对象是一个分库对象，那么分库对象必须实现一个虚拟数据源路由<code>IVirtualDataSourceRoute</code>，\n虚拟数据源路由的作用是用来对分库对象进行路由，告诉框架程序应该如何对分库对象进行路由去对应的数据源里面</p>\n<div><pre><code><span>//首先获取IVirtualDataSource</span>\n<span>IVirtualDataSource</span> virtualDataSource<span>=</span><span>..</span><span>..</span><span>.</span><span>;</span>\n<span>//方法1</span>\nvirtualDataSource<span>.</span><span>GetRoute</span><span>(</span>EntityType<span>)</span><span>;</span>\n<span>//方法2</span>\nvirtualDataSource<span>.</span><span><span>GetRoute</span><span><span>&lt;</span>TEntity<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"分表\"> 分表</h2>\n<ul>\n<li>[Tail]\n尾巴、后缀物理表的后缀</li>\n<li>[TableSeparator]\n尾巴前缀虚拟表和物理表的后缀中间的字符</li>\n<li>[物理表]\n顾名思义就是数据库对应的实际表信息,表名(TableName+ TableSeparator+ Tail)比如:SysUser_2021,这边<code>SysUser</code>就是原本未分表时候的映射到数据库的物理表名称，后续的下划线<code>_</code>表示<code>TableSeparator</code>,<code>2021</code>表示后缀<code>Tail</code></li>\n</ul>\n<p>框架内部所有的分表名称规则都是按照(TableName+ TableSeparator+ Tail)来创建的</p>\n<h3 id=\"ivirtualtablemanager\"> IVirtualTableManager</h3>\n<p><code>IVirtualTableManager&lt;TShardingDbContext&gt;</code>虚拟表管理者，因为对象和数据库表之间的关系从原先的一对一变成了一对一虚拟表然后虚拟表一对多，所以我们一个对象会对应一个虚拟表，这边的所有的虚拟表全部由<code>IVirtualTableManager&lt;TShardingDbContext&gt;</code>管理</p>\n<div><pre><code>\n<span>//获取IVirtualTableManager</span>\nShardingContainer<span>.</span><span><span>GetService</span><span><span>&lt;</span>IVirtualTableManager<span>&lt;</span>TShardingDbContext<span>></span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n<span>//通过非泛型方法获取</span>\n<span>(</span>IVirtualTableManager<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IVirtualTableManager<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>shardingDbContext<span>.</span><span>GetType</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><h3 id=\"ivirtualtable\"> IVirtualTable</h3>\n<p><code>IVirtualTable</code>叫做虚拟表,原先<code>DbContext</code>对应一个<code>Entity</code>对应一张<code>Table</code>,虚拟表的出现将<code>Entity</code>和<code>Table</code>之间多了一个虚拟表的概念，就是说原先的对象是直接映射到实际表，那么因为现在实际表名称有很多张，所以一个对象对应的是虚拟表<code>IVirtualTable</code>，虚拟表内部拥有虚拟表路由<code>IVirtualTableRoute</code>，虚拟表路由会将crud的结果通过虚拟表路由，路由到对应的实际表，所以原则上你在数据库里面将看不到原表名称的实际表，除非你的分表是没有后缀的。</p>\n<div><pre><code><span>//通过虚拟表管理者</span>\n<span>IVirtualTableManager</span> virtualTableManager<span>=</span><span>..</span><span>..</span><span>;</span>\nvirtualTableManager<span>.</span><span>GetVirtualTable</span><span>(</span>EntityType<span>)</span>\nvirtualTableManager<span>.</span><span><span>GetVirtualTable</span><span><span>&lt;</span>TEntity<span>></span></span></span><span>(</span><span>)</span>\n\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><h3 id=\"ivirtualtableroute\"> IVirtualTableRoute</h3>\n<p><code>IVirtualTableRoute</code>虚拟表路由，针对对象如果我们需要对其进行分表，那么我么你必须要重写分表的路由，分表路由会告诉程序我们的这个sql执行是该如何找寻对应的实际表，而不用用户手动去指定对应的表，每一个虚拟表都会拥有一个虚拟表路由</p>\n<div><pre><code><span>//首先获取虚拟表</span>\n<span>IVirtualTable</span> virtualTable<span>=</span><span>..</span><span>.</span><span>;</span>\n<span>//通过虚拟表获取虚拟表路由</span>\nvirtualTable<span>.</span><span>GetVirtualRoute</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div>",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "快速上手",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/guide/quick-start/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/guide/quick-start/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次demo源码：<a href=\"https://github.com/xuejmnet/ShardingCoreDocDemo/tree/main/EFCoreSharding\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreSharding</a></p>\n<h2 id=\"版本\"> 版本</h2>\n<p>sharding-core 目前为止以efcore版本号作为主版本，所以您会在nuget上看到2.x,3.x,5.x的版本,如果需要请安装最新版nuget上的efcore版本对应的sharding-core版本</p>\n<div><p>注意</p>\n<p>如果nuget上的sharding-core版本不适合您目前的efcore版本并且您目前不想升级对应的efcore版本，请自行下载程序进行源码编译替换成您所需要的efcore版本</p>\n</div>\n<h2 id=\"安装和启动\"> 安装和启动</h2>\n<div><pre><code><span># 请对应安装您需要的版本</span>\nPM<span>></span> Install-Package ShardingCore\n</code></pre>\n<div><span>1</span><br><span>2</span><br></div></div><h2 id=\"使用efcore\"> 使用efcore</h2>\n<ol>\n<li>首先我们创建一个空的控制台程序</li>\n</ol>\n<div><pre><code><span># 创建一个目录用于测试</span>\n<span>mkdir</span> EFCoreSharding\n\n<span># 进入创建的目录</span>\n<span>cd</span> EFCoreSharding\n\n<span># 创建一个空的控制台程序</span>\ndotnet new console\n\n<span># 添加efcore 测试我们采用sqlserver作为测试数据库，其他数据库用法一致</span>\ndotnet <span>add</span> package Microsoft.EntityFrameworkCore.SqlServer\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><div><p>注意</p>\n<p>这边我们文档编写时控制台程序为net5.0，所以我们这边选择了efcore5的版本的最新版，具体请参考您自己的项目</p>\n</div>\n<ol start=\"2\">\n<li>创建订单对象<code>Order</code>：</li>\n</ol>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 订单表</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>Order</span>\n<span>{</span>\n    <span>/// &lt;summary></span>\n    <span>/// 订单Id</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>/// &lt;summary></span>\n    <span>/// 付款用户名</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span><span>string</span></span> Payer <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>/// &lt;summary></span>\n    <span>/// 付款金额分</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span><span>long</span></span> Money <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>/// &lt;summary></span>\n    <span>/// 创建时间</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>/// &lt;summary></span>\n    <span>/// 是否已删除</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span><span>bool</span></span> IsDelete <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br></div></div><ol start=\"3\">\n<li>创建efcore的dbcontext</li>\n</ol>\n<div><pre><code><span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>DbContext</span></span>\n<span>{</span>\n    <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span><span>:</span><span>base</span><span>(</span>options<span>)</span>\n    <span>{</span>\n        \n    <span>}</span>\n\n    <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n    <span>{</span>\n        <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n        modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>o <span>=></span>\n        <span>{</span>\n            o<span>.</span><span>HasKey</span><span>(</span>p <span>=></span> p<span>.</span>Id<span>)</span><span>;</span>\n            o<span>.</span><span>Property</span><span>(</span>p <span>=></span> p<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>40</span><span>)</span><span>.</span><span>HasComment</span><span>(</span><span>\"订单Id\"</span><span>)</span><span>;</span>\n            o<span>.</span><span>Property</span><span>(</span>p <span>=></span> p<span>.</span>Payer<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>.</span><span>HasComment</span><span>(</span><span>\"付款用户名\"</span><span>)</span><span>;</span>\n            o<span>.</span><span>Property</span><span>(</span>p <span>=></span> p<span>.</span>Money<span>)</span><span>.</span><span>HasComment</span><span>(</span><span>\"付款金额分\"</span><span>)</span><span>;</span>\n            o<span>.</span><span>Property</span><span>(</span>p <span>=></span> p<span>.</span>CreateTime<span>)</span><span>.</span><span>HasComment</span><span>(</span><span>\"创建时间\"</span><span>)</span><span>;</span>\n            o<span>.</span><span>Property</span><span>(</span>p <span>=></span> p<span>.</span>IsDelete<span>)</span><span>.</span><span>HasComment</span><span>(</span><span>\"是否已删除\"</span><span>)</span><span>;</span>\n            o<span>.</span><span>HasQueryFilter</span><span>(</span>p <span>=></span> p<span>.</span>IsDelete <span>==</span> <span>false</span><span>)</span><span>;</span>\n            o<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n        <span>}</span><span>)</span><span>;</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br></div></div><ol start=\"4\">\n<li>启动配置efcore并且插入对应的数据</li>\n</ol>\n<p>在<code>Program</code>的<code>Main</code>函数下添加如下代码</p>\n<div><pre><code><span>class</span> <span>Program</span>\n<span>{</span>\n    <span>static</span> <span><span>void</span></span> <span>Main</span><span>(</span><span><span>string</span><span>[</span><span>]</span></span> args<span>)</span>\n    <span>{</span>\n        <span>IServiceCollection</span> services <span>=</span> <span>new</span> <span>ServiceCollection</span><span>(</span><span>)</span><span>;</span>\n        services<span>.</span><span>AddLogging</span><span>(</span><span>)</span><span>;</span>\n        services<span>.</span><span><span>AddDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span>o <span>=></span> o<span>.</span><span>UseSqlServer</span><span>(</span><span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDB;Integrated Security=True;\"</span><span>)</span><span>)</span><span>;</span>\n        <span><span>var</span></span> buildServiceProvider <span>=</span> services<span>.</span><span>BuildServiceProvider</span><span>(</span><span>)</span><span>;</span>\n        <span>using</span> <span>(</span><span><span>var</span></span> scope <span>=</span> buildServiceProvider<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> myDbContext <span>=</span> scope<span>.</span>ServiceProvider<span>.</span><span><span>GetService</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n            <span>//如果不存在就创建数据库和对应的数据库表</span>\n            myDbContext<span>.</span>Database<span>.</span><span>EnsureCreated</span><span>(</span><span>)</span><span>;</span>\n\n            <span><span>var</span></span> now <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span><span>1</span><span>,</span><span>1</span><span>)</span><span>;</span>\n            <span><span>var</span></span> orders <span>=</span> Enumerable<span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span><span>10</span><span>)</span><span>.</span><span>Select</span><span>(</span><span>(</span>o<span>,</span>i<span>)</span><span>=></span><span>new</span> <span>Order</span><span>(</span><span>)</span>\n            <span>{</span>\n                Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                CreateTime <span>=</span> now<span>.</span><span>AddDays</span><span>(</span>i<span>)</span><span>,</span>\n                Payer <span>=</span> <span><span>$\"用户:</span><span><span>{</span><span>i</span><span>}</span></span><span>\"</span></span><span>,</span>\n                Money <span>=</span> i<span>*</span><span>100</span><span>,</span>\n                IsDelete <span>=</span> <span>false</span>\n            <span>}</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n            myDbContext<span>.</span><span>AddRange</span><span>(</span>orders<span>)</span><span>;</span>\n            myDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br></div></div><div><p>提示</p>\n<ol>\n<li>这边我们采用的是<code>myDbContext.Database.EnsureCreated();</code>方法可以保证第一次创建对应的表和库。</li>\n<li>并不是所有的efcore都需要按我这种写法,具体按您自己的原先的使用即可。</li>\n<li>程序运行后可以看到数据库和表被创建并且数据被插入到对应的数据库里面了。</li>\n</ol>\n</div>\n<h2 id=\"efcore升级到sharding-core\"> efcore升级到sharding-core</h2>\n<p>目前efcore的使用是单表单库的和实体对象是一对一的，我们将对此进行升级，添加sharding-core的支持，目前我们这边有两种方式可以配置<code>Order</code>支持分表分库：</p>\n<h3 id=\"添加sharding-core包\"> 添加sharding-core包</h3>\n<div><pre><code>dotnet <span>add</span> package ShardingCore\n</code></pre>\n<div><span>1</span><br></div></div><div><p>提示</p>\n<p>根据项目自己选择sharding-core 2.x/3.x/5.x......的最新版本.</p>\n</div>\n<h3 id=\"删除掉原先的数据库\"> 删除掉原先的数据库</h3>\n<p>因为目前还没有涉及到code-first的用法所以目前我们先对其进行数据库的重建</p>\n<h3 id=\"虚拟路由配置-推荐\"> 虚拟路由配置(推荐)</h3>\n<p>首先我们针对当前已有的项目进行<code>Order</code>分表的配置,路由规则订单按Id取模</p>\n<ol>\n<li>创建分表路由<code>OrderVirtualTableRoute</code></li>\n</ol>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 创建虚拟路由</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>OrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n<span>{</span>\n    <span>public</span> <span>OrderVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n    <span>{</span>\n    <span>}</span>\n\n    <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n    <span>{</span>\n        builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        builder<span>.</span><span>AutoCreateTable</span><span>(</span><span>null</span><span>)</span><span>;</span>\n        builder<span>.</span><span>TableSeparator</span><span>(</span><span>\"_\"</span><span>)</span><span>;</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><div><p>提示</p>\n<ol>\n<li><code>ShardingProperty</code>必须指定,表示具体按什么字段进行分表</li>\n<li><code>AutoCreateTable</code>可选,表示是否需要在<strong>启动</strong>的时候建表:null表示根据全局配置,true:表示需要,false:表示不需要,默认null</li>\n<li><code>TableSeparator</code>可选,表示分表后缀和虚拟表名之间的分隔连接符,默认<code>_</code></li>\n<li><code>AbstractSimpleShardingModKeyStringVirtualTableRoute&lt;Order&gt;</code>由sharding-core提供的默认取模分表规则,其中2代表分表后尾巴有两位,3表示按3取模所以后缀为:00,01,02。因为最多2位所以可以最多到99,如果需要了解更多路由<a href=\"/sharding-core-doc/pages/defaultroute\">默认路由</a></li>\n</ol>\n</div>\n<h3 id=\"接口特性配置\"> 接口特性配置</h3>\n<p>除了路由配置您还可以使用接口和特性来实现</p>\n<ol>\n<li>让订单<code>Order</code>继承<code>IShardingTable</code></li>\n</ol>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 订单表</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>Order</span><span>:</span><span><span>IShardingTable</span></span>\n<span>{</span>\n  <span>//.....</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><ol start=\"2\">\n<li>对<code>Order</code>需要分表的字段进行分表字段特性添加(仅支持一个分表字段)</li>\n</ol>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 订单表</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>Order</span><span>:</span><span><span>IShardingTable</span></span>\n<span>{</span>\n  <span>/// &lt;summary></span>\n  <span>/// 订单Id</span>\n  <span>/// &lt;/summary></span>\n  <span>[</span>ShardingTableKey<span>]</span>\n  <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n  <span>//.....</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></div></div><ol start=\"3\">\n<li>创建分表路由<code>OrderVirtualTableRoute</code></li>\n</ol>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 创建虚拟路由</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>OrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n<span>{</span>\n    <span>public</span> <span>OrderVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n    <span>{</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><div><p>提示</p>\n<ol>\n<li><code>ShardingTableKey</code>特性表示对应的属性是需要被分表的字段,如：<code>Order</code>对象通过<code>Id</code>属性来进行分表</li>\n<li>按接口+特性分表我们发现虚拟路由里面将不需要配置对应的方法<code>Configure</code></li>\n<li>推荐使用第一种路由处配置对应的分表信息</li>\n</ol>\n</div>\n<h3 id=\"配置dbcontext\"> 配置dbcontext</h3>\n<p>替换<code>MyDbContext</code>的父类</p>\n<div><pre><code><span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span><span>IShardingTableDbContext</span></span>\n<span>{</span>\n    <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span><span>:</span><span>base</span><span>(</span>options<span>)</span>\n    <span>{</span>\n        \n    <span>}</span>\n    <span>//....</span>\n    <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><div><p>提示</p>\n<ol>\n<li><code>AbstractShardingDbContext</code>是系统默认实现了<code>IShardingDbContext</code>的抽象类,你也可以自行实现</li>\n<li><code>IShardingTableDbContext</code>继承该接口的<code>DbContext</code>表示需要实现分表功能,如果您只需要分库那么可以不继承该对象</li>\n</ol>\n</div>\n<h2 id=\"启动配置\"> 启动配置</h2>\n<p>介绍完两种配置后下面我们开始对程序进行</p>\n<p>目前sharding-core支持两种配置方式,两种配置方式一样</p>\n<ol>\n<li>通过<code>services.AddShardingDbContext&lt;MyDbContext&gt;()</code>,</li>\n<li>通过在原先的配置<code>services.AddDbContext&lt;MyDbContext&gt;()</code>后追加新的配置<code>services.AddShardingConfigure&lt;MyDbContext&gt;()</code>,</li>\n</ol>\n<div><p>提示</p>\n<ol>\n<li>两种配置方式一样,第一种是对第二种的封装而已,具体使用那种都可以按自己的需要</li>\n<li>原<code>AddDbContext</code>需要添加配置<code>UseSharding&lt;MyDbContext&gt;()</code></li>\n</ol>\n</div>\n<div><pre><code><span>class</span> <span>Program</span>\n<span>{</span>\n    <span>static</span> <span><span>void</span></span> <span>Main</span><span>(</span><span><span>string</span><span>[</span><span>]</span></span> args<span>)</span>\n    <span>{</span>\n        <span>IServiceCollection</span> services <span>=</span> <span>new</span> <span>ServiceCollection</span><span>(</span><span>)</span><span>;</span>\n        services<span>.</span><span>AddLogging</span><span>(</span><span>)</span><span>;</span>\n        <span>//原来的dbcontext配置</span>\n        services<span>.</span><span><span>AddDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span>o <span>=></span>\n            o<span>.</span><span>UseSqlServer</span><span>(</span><span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDB;Integrated Security=True;\"</span><span>)</span>\n                <span>.</span><span><span>UseSharding</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>//需要添加</span>\n            <span>)</span><span>;</span>\n        <span>//额外添加分片配置</span>\n        services<span>.</span><span><span>AddShardingConfigure</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>(</span>conn<span>,</span> builder<span>)</span> <span>=></span>\n            <span>{</span>\n                builder<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>.</span><span>Begin</span><span>(</span>o <span>=></span>\n            <span>{</span>\n                o<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                o<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n            <span>}</span><span>)</span><span>.</span><span>AddShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n            <span>{</span>\n                builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>.</span><span>AddDefaultDataSource</span><span>(</span>Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>.</span><span>ToString</span><span>(</span><span>\"n\"</span><span>)</span><span>,</span>\n                <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDB;Integrated Security=True;\"</span><span>)</span>\n            <span>.</span><span>AddShardingTableRoute</span><span>(</span>op <span>=></span>\n            <span>{</span>\n                op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>.</span><span>End</span><span>(</span><span>)</span><span>;</span>\n\n        <span><span>var</span></span> buildServiceProvider <span>=</span> services<span>.</span><span>BuildServiceProvider</span><span>(</span><span>)</span><span>;</span>\n        <span>//启动必备</span>\n        buildServiceProvider<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n        <span>using</span> <span>(</span><span><span>var</span></span> scope <span>=</span> buildServiceProvider<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> myDbContext <span>=</span> scope<span>.</span>ServiceProvider<span>.</span><span><span>GetService</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n            <span>//如果不存在就创建数据库和对应的数据库表</span>\n            <span>//myDbContext.Database.EnsureCreated();//注释掉不然会创建虚拟表，虚拟表其实没什么用</span>\n\n            <span><span>var</span></span> now <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span><span>1</span><span>,</span><span>1</span><span>)</span><span>;</span>\n            <span><span>var</span></span> orders <span>=</span> Enumerable<span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span><span>10</span><span>)</span><span>.</span><span>Select</span><span>(</span><span>(</span>o<span>,</span>i<span>)</span><span>=></span><span>new</span> <span>Order</span><span>(</span><span>)</span>\n            <span>{</span>\n                Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                CreateTime <span>=</span> now<span>.</span><span>AddDays</span><span>(</span>i<span>)</span><span>,</span>\n                Payer <span>=</span> <span><span>$\"用户:</span><span><span>{</span><span>i</span><span>}</span></span><span>\"</span></span><span>,</span>\n                Money <span>=</span> i<span>*</span><span>100</span><span>,</span>\n                IsDelete <span>=</span> <span>false</span>\n            <span>}</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n            myDbContext<span>.</span><span>AddRange</span><span>(</span>orders<span>)</span><span>;</span>\n            myDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br></div></div><p>启动项目后我们可以看到程序会自动创建数据库和表结构，并且会按照我们设定的规则进行取模插入,并且逻辑表名<code>Order</code>将不会存在于数据库</p>\n<div><p>警告</p>\n<p>！！！如果您使用第二种配置,那么请对<code>services.AddDbContext&lt;MyDbContext&gt;()</code>配置内部使用的数据库连接字符串和后续的<code>AddDefaultDataSource</code>中添加的字符串一致不然会导致无法使用事务。</p>\n<p>！！！如果您使用第二种配置,那么请对<code>services.AddDbContext&lt;MyDbContext&gt;()</code>配置内部使用的数据库连接字符串和后续的<code>AddDefaultDataSource</code>中添加的字符串一致不然会导致无法使用事务。</p>\n<p>！！！如果您使用第二种配置,那么请对<code>services.AddDbContext&lt;MyDbContext&gt;()</code>配置内部使用的数据库连接字符串和后续的<code>AddDefaultDataSource</code>中添加的字符串一致不然会导致无法使用事务。</p>\n</div>\n<div><p>提示</p>\n<ol>\n<li>如果程序无法启动请确保一下几点，确认是否已经注入原生的efcore的DbContext,并且在原生的后续对DbContextOptions进行了<code>UseSharding&lt;MyDbContext&gt;()</code>配置</li>\n<li>是否配置了额外分片<code>AddShardingConfigure</code>(第一种配置可以忽略)，是否创建了通过字符串委托和链接委托</li>\n<li>default data source 的连接字符串是否和默认dbcontext创建的一致</li>\n<li>是否添加了分表路由<code>AddShardingTableRoute(op =&gt;{op.AddShardingTableRoute&lt;OrderVirtualTableRoute&gt;();})</code></li>\n<li>是否启动了分表启动器<code>buildServiceProvider.GetRequiredService&lt;IShardingBootstrapper&gt;().Start();</code></li>\n</ol>\n</div>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2022-01-07T14:00:26.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "Important",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/important/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/important/",
      "content_html": "<h2 id=\"version\"> Version</h2>\n<p><code>ShardingCore</code> version is a.b.c.d</p>\n<ul>\n<li>a:<code>EFCore</code> version</li>\n<li>b:<code>ShardingCore</code> version</li>\n<li>c:<code>ShardingCore</code> second version</li>\n<li>d:<code>ShardingCore</code> fix version</li>\n</ul>\n<h2 id=\"common-problem\"> Common Problem</h2>\n<p>current dbcontext is virtual dbcontext not real execute dbcontext，real dbcontext is in DbContextExecutor</p>\n<h2 id=\"dbcontext-constructor-problem\"> DbContext Constructor Problem</h2>\n<p>dont use ant method that will created model before.</p>\n<div><pre><code>        public DefaultShardingDbContext(DbContextOptions&lt;DefaultShardingDbContext&gt; options) : base(options)\n        {\n            //dont invoke\n            //ChangeTracker.QueryTrackingBehavior = QueryTrackingBehavior.NoTracking;\n            //Database.SetCommandTimeout(30000);\n        }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"performance-loss\"> Performance loss</h2>\n<p>query no sharding entity,<code>ShardingCore</code> slow than <code>EFCore</code> 0.005ms single query;</p>\n<h2 id=\"disadvantage\"> Disadvantage</h2>\n<ul>\n<li>use more conection in single query，but u can limit with start up options:<code>MaxQueryConnectionsLimit</code></li>\n<li>sharding entity not support include,if u want join two entities u can use join.</li>\n<li>sharding entity dont set nav properties like icollection or list</li>\n</ul>\n<h2 id=\"gethashcode\"> GetHashCode</h2>\n<p>c# <code>GetHashCode</code></p>\n<p>When we do not modify the object, we call hashcode many times to return the same integer. In the same application, if we execute it many times, the integer returned by each execution may be inconsistent\nsuggestion use <code>sharding-core</code> provider method <code>ShardingCoreHelper.GetStringHashCode(shardingKeyStr)</code></p>\n<h2 id=\"group-by\"> Group By</h2>\n<p>if use <code>group by</code> queryable will append order by while order by item is empty,if has order by item shoule use full select properties</p>\n<h2 id=\"guid\"> GUID</h2>\n<p>c# guid compare is difference with sqlserver uniqueidentifier，<code>sharding-core</code> is fix this bug,use SqlGuid to compare,but not fix <code>Nullable&lt;Guid&gt;</code> if u want fix it. example:</p>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// like this example</span>\n<span>/// &lt;/summary></span>\n<span>/// &lt;typeparam name=\"TShardingDbContext\">&lt;/typeparam></span>\n<span>public</span> <span>class</span> <span>SqlServerNullableGuidCSharpLanguageShardingComparer<span>&lt;</span>TShardingDbContext<span>></span></span><span>:</span><span><span>CSharpLanguageShardingComparer<span>&lt;</span>TShardingDbContext<span>></span></span></span> <span>where</span> <span>TShardingDbContext</span> <span>:</span> <span><span>DbContext</span><span>,</span> <span>IShardingDbContext</span></span>\n<span>{</span>\n        <span>public</span> <span>override</span> <span><span>int</span></span> <span>Compare</span><span>(</span><span>IComparable</span> x<span>,</span> <span>IComparable</span> y<span>,</span> <span><span>bool</span></span> asc<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>x <span>is</span> <span>XXType</span> xg <span>&amp;&amp;</span> y <span>is</span> <span>XXType</span> yg<span>)</span>\n            <span>{</span>\n                <span>return</span> <span>new</span> <span>XXFixedType</span><span>(</span>xg<span>)</span><span>.</span><span>SafeCompareToWith</span><span>(</span><span>new</span> <span>XXFixedType</span><span>(</span>yg<span>)</span><span>,</span> asc<span>)</span><span>;</span>\n            <span>}</span>\n            <span>return</span> <span>base</span><span>.</span><span>Compare</span><span>(</span>x<span>,</span> y<span>,</span> asc<span>)</span><span>;</span>\n        <span>}</span>\n<span>}</span>\n\n<span>//configure</span>\n<span>.</span><span>ReplaceShardingComparer</span><span>(</span>sp<span>=></span><span>new</span> <span>SqlServerNullableGuidCSharpLanguageShardingComparer<span>&lt;</span>DefaultShardingDbContext<span>></span></span><span>(</span><span>)</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><p><strong>注意:fix c# compare guid</strong></p>\n<h2 id=\"auto-increment-field\"> auto increment field</h2>\n<p>do not configure auto increment field in <code>sharding-core</code> sharding field。e.g:increment id</p>\n<h2 id=\"ensurecreated\"> EnsureCreated</h2>\n<p><code>DbContext.Database.EnsureCreated()</code> if u want use this method ,plz impl <code>IMigrationsSqlGenerator</code></p>\n<h2 id=\"sharding-with-time\"> sharding with time</h2>\n<p>if u use sharding with time field,plz read<a href=\"/sharding-core-doc/en/adv/pagination\">pagination</a></p>\n",
      "date_published": "2021-11-16T06:14:19.000Z",
      "date_modified": "2022-02-20T06:41:00.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "Important"
      ]
    },
    {
      "title": "项目主页",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/home/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/home/",
      "content_html": "<br/>\n<p align=\"center\">\n<div>\n<p><a href=\"https://www.nuget.org/packages/ShardingCore\" target=\"_blank\"><img src=\"https://img.shields.io/nuget/v/ShardingCore.svg?style=flat-square\" alt=\"nuget\"></a>\n<a href=\"https://www.nuget.org/stats/packages/ShardingCore?groupby=Version\" target=\"_blank\"><img src=\"https://img.shields.io/nuget/dt/ShardingCore.svg?style=flat-square\" alt=\"nuget\"></a>\n<a href=\"https://github.com/xuejmnet/sharding-core/blob/main/LICENSE\" target=\"_blank\"><img src=\"https://img.shields.io/badge/license-Apache 2-blue\" alt=\"license\"></a></p>\n</div>\n</p>\n<h2 id=\"🔔交流qq群\"> 🔔交流QQ群</h2>\n<div>\n<img src=\"https://cdn.jsdelivr.net/gh/xugaoyi/image_store@master/blog/QQ20210730-002949@2x.57m20hgqvog0.png\" alt=\"群号: 771630778\" style=\"width:200px;\">\n<h4 id=\"shardingcore官方qq群-771630778\"> ShardingCore官方QQ群: 771630778</h4>\n</div>\n<br/>\n<h2 id=\"许可证\"> 许可证</h2>\n<p><a href=\"https://github.com/xuejmnet/sharding-core/blob/main/LICENSE\" target=\"_blank\" rel=\"noopener noreferrer\">Apache-2.0 License</a></p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-03T00:33:21.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": []
    },
    {
      "title": "自定义布局",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/layout/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/layout/",
      "content_html": "<p>您可以使用带有 Markdown 支持的插槽来自定义页面布局。</p>\n<div><p>注意</p>\n<p>此处仅仅是一个演示，你应该自行根据需求添加样式。</p>\n\n\n</div>\n<template #page-top><p>页面顶部内容</p>\n</template><template #page-bottom><p>页面底部内容</p>\n</template><template #content-top><p>内容顶部内容</p>\n</template><template #content-bottom><p>内容底部内容</p>\n</template><template #navbar-start><p>导航栏起始内容</p>\n</template><template #navbar-center><p>导航栏中部内容</p>\n</template><template #navbar-end><p>导航栏末尾内容</p>\n</template><template #sidebar-top><p>侧边栏顶部内容</p>\n</template><template #sidebar-center><p>侧边栏中部内容</p>\n</template><template #sidebar-bottom><p>侧边栏底部内容</p>\n</template><p>更多详情，详见 <a href=\"https://vuepress-theme-hope.github.io/zh/guide/layout/custom/\" target=\"_blank\" rel=\"noopener noreferrer\">自定义布局</a>.</p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-03T00:33:21.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": []
    },
    {
      "title": "分组查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/query/group-by-query/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/query/group-by-query/",
      "content_html": "<h2 id=\"支持group\"> 支持group</h2>\n<div><pre><code>    <span><span>var</span></span> ids <span>=</span> <span>new</span><span>[</span><span>]</span> <span>{</span><span>\"200\"</span><span>,</span> <span>\"300\"</span><span>}</span><span>;</span>\n            <span><span>var</span></span> dateOfMonths <span>=</span> <span>new</span><span>[</span><span>]</span> <span>{</span><span>202111</span><span>,</span> <span>202110</span><span>}</span><span>;</span>\n            <span><span>var</span></span> <span>group</span> <span>=</span> <span>await</span> <span>(</span><span>from</span> u <span>in</span> _virtualDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUserSalary<span>></span></span></span><span>(</span><span>)</span>\n                    <span>.</span><span>Where</span><span>(</span>o <span>=></span> ids<span>.</span><span>Contains</span><span>(</span>o<span>.</span>UserId<span>)</span> <span>&amp;&amp;</span> dateOfMonths<span>.</span><span>Contains</span><span>(</span>o<span>.</span>DateOfMonth<span>)</span><span>)</span>\n                <span>group</span> u <span>by</span> <span>new</span>\n                <span>{</span>\n                    UId <span>=</span> u<span>.</span>UserId\n                <span>}</span>\n                <span>into</span> g\n                <span>select</span> <span>new</span>\n                <span>{</span>\n                    GroupUserId <span>=</span> g<span>.</span>Key<span>.</span>UId<span>,</span>\n                    Count <span>=</span> g<span>.</span><span>Count</span><span>(</span><span>)</span><span>,</span>\n                    TotalSalary <span>=</span> g<span>.</span><span>Sum</span><span>(</span>o <span>=></span> o<span>.</span>Salary<span>)</span><span>,</span>\n                    AvgSalary <span>=</span> g<span>.</span><span>Average</span><span>(</span>o <span>=></span> o<span>.</span>Salary<span>)</span><span>,</span>\n                    AvgSalaryDecimal <span>=</span> g<span>.</span><span>Average</span><span>(</span>o <span>=></span> o<span>.</span>SalaryDecimal<span>)</span><span>,</span>\n                    MinSalary <span>=</span> g<span>.</span><span>Min</span><span>(</span>o <span>=></span> o<span>.</span>Salary<span>)</span><span>,</span>\n                    MaxSalary <span>=</span> g<span>.</span><span>Max</span><span>(</span>o <span>=></span> o<span>.</span>Salary<span>)</span>\n                <span>}</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><table>\n<thead>\n<tr>\n<th>聚合函数</th>\n<th>是否支持</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Count</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>Sum</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>Max</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>Min</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>Average</td>\n<td>支持</td>\n</tr>\n</tbody>\n</table>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "查询"
      ]
    },
    {
      "title": "FirstOrDefault",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/query/first-or-default/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/query/first-or-default/",
      "content_html": "",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-03T00:33:21.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "查询"
      ]
    },
    {
      "title": "事务中查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/query/query-in-transaction/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/query/query-in-transaction/",
      "content_html": "<h2 id=\"事务中查询block\"> 事务中查询block</h2>\n<p>当我们开启事务的时候如果涉及到跨表查询,那么sharding-core的做法是这样的</p>\n<ol>\n<li>因为同一个connection不能有多个结果集并行获取(除非sqlserver开始MARS)(MultipleActive Result Set),所以sharding-core默认所有数据库都不支持MARS,这个前提下那么涉及跨表操作就需要开始多个链接来进行并行查询+内存串行聚合。所以如果开启了事务不是同一个链接session的前提下，另一个链接是无法读取到事务内的数据结果，如果出现全表扫描的情况下可能会出现死锁,所以在事务内部建议使用with(nolock)，具体做法</li>\n</ol>\n<div><pre><code></code></pre>\n<div></div></div><p><strong>注意</strong>最好的做法是尽可能的短事务,不要再事务开启后,数据增删改后未提交事务的情况下进行跨表查询，所以只要保证尽可能短的事务就可以了</p>\n",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "查询"
      ]
    },
    {
      "title": "组合查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/query/multi-entity-query/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/query/multi-entity-query/",
      "content_html": "<h2 id=\"组合查询\"> 组合查询</h2>\n<p>默认不推荐<code>include</code>，分表对象+分表、分表对象+分表对象都是在本框架内被支持的，支持的形式为join, 默认推荐join组合而不是include</p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "查询"
      ]
    },
    {
      "title": "单对象查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/query/single-entity-query/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/query/single-entity-query/",
      "content_html": "<h2 id=\"单表查询\"> 单表查询</h2>\n<p>和efcore原生查询没有任何区别,支持未分表下的所有操作</p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "查询"
      ]
    },
    {
      "title": "常见的问题",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/question/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/question/",
      "content_html": "",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-03T00:33:21.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "常见的问题"
      ]
    },
    {
      "title": "删除",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-all/delete/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-all/delete/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingAll\" target=\"_blank\" rel=\"noopener noreferrer\">SqlServerShardingAll</a></p>\n<h2 id=\"删除数据\"> 删除数据</h2>\n<p>增删改查除了查询稍微在分表+排序的情况下需要注意其实其他操作和efcore基本上一致</p>\n<p>删除也是</p>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Delete</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"9\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            _myDbContext<span>.</span><span>Remove</span><span>(</span>sysUser<span>)</span><span>;</span>\n            <span><span>var</span></span> i <span>=</span> <span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><p>控制台我们可以看到对应的执行sql</p>\n<div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      DELETE FROM <span>[</span>SysUser_00<span>]</span>\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p0<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div>",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "Project Home",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/",
      "content_html": "<br/>\n<p align=\"center\">\n<div>\n<p><a href=\"https://www.nuget.org/packages/ShardingCore\" target=\"_blank\"><img src=\"https://img.shields.io/nuget/v/ShardingCore.svg?style=flat-square\" alt=\"nuget\"></a>\n<a href=\"https://www.nuget.org/stats/packages/ShardingCore?groupby=Version\" target=\"_blank\"><img src=\"https://img.shields.io/nuget/dt/ShardingCore.svg?style=flat-square\" alt=\"nuget\"></a>\n<a href=\"https://github.com/xuejmnet/sharding-core/blob/main/LICENSE\" target=\"_blank\"><img src=\"https://img.shields.io/badge/license-Apache 2-blue\" alt=\"license\"></a></p>\n</div>\n</p>\n<h2 id=\"🔔communication-qq-group\"> 🔔Communication QQ Group</h2>\n<div>\n<img src=\"/sharding-core-doc/join-qq-group.jpg\" alt=\"group number: 771630778\" style=\"width:200px;\">\n<h4 id=\"shardingcore-qq-group-771630778\"> ShardingCore QQ Group: 771630778</h4>\n</div>\n<br/>\n<h2 id=\"license\"> License</h2>\n<p><a href=\"https://github.com/xuejmnet/sharding-core/blob/main/LICENSE\" target=\"_blank\" rel=\"noopener noreferrer\">Apache-2.0 License</a></p>\n<h2 id=\"document-theme\"> Document Theme</h2>\n<p><a href=\"https://vuepress-theme-hope.github.io/\" target=\"_blank\" rel=\"noopener noreferrer\">vuepress-theme-hope</a></p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-12-08T00:59:50.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": []
    },
    {
      "title": "查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-all/query/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-all/query/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分库的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingAll\" target=\"_blank\" rel=\"noopener noreferrer\">SqlServerShardingAll</a></p>\n<h2 id=\"单对象简单查询\"> 单对象简单查询</h2>\n<p>对<code>SysUser</code>和<code>Order</code>进行查询</p>\n<div><pre><code><span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Query</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span><span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>Id<span>==</span><span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> sysUserA1 <span>=</span><span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>Id<span>==</span><span>\"1\"</span><span>&amp;&amp;</span>o<span>.</span>Area<span>==</span><span>\"A\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> dateTime <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span><span>3</span><span>,</span><span>5</span><span>)</span><span>;</span>\n            <span><span>var</span></span> order <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>>=</span> dateTime<span>)</span><span>.</span><span>OrderBy</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> orderIdOne <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"3\"</span><span>)</span><span>;</span>\n\n\n            <span><span>var</span></span> sysUsers <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id<span>==</span><span>\"6\"</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n\n            <span>return</span> <span>Ok</span><span>(</span><span>new</span> <span><span>object</span><span>[</span><span>]</span></span>\n            <span>{</span>\n                sysUser<span>,</span>\n                order<span>,</span>\n                orderIdOne<span>,</span>\n                sysUsers\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"C\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"63\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"63\"</span><span>,</span><span>\"money\"</span><span>:</span><span>1292</span><span>,</span><span>\"area\"</span><span>:</span><span>\"C\"</span><span>,</span><span>\"orderStatus\"</span><span>:</span><span>4</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-05T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"money\"</span><span>:</span><span>2975</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"orderStatus\"</span><span>:</span><span>4</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-01-04T03:03:03\"</span><span>}</span><span>,</span><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"C\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>}</span><span>]</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>、\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>    \n      <span>..</span><span>..</span><span>..</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br></div></div><p>因为查询脚本是在太多了部分没用到索引所以会全库+全表，这边就用第一个查询来进行分析,具体你可以通过demo例子进行处理,首先我们先确定下我们是按<code>Area</code>区域进行分库的，所以在没有这个字段的时候可以明确知道程序会查询3个数据库,会打开三个链接，虽然是三个链接但是每个链接因为分表关键字Id可以索引所以只会查询每个库的自身的表，</p>\n<p>第二个查询结果可以很明显看到有了分库索引后只选择其中一个库而不是所有的库,并且因为加了分表索引，所以只会有一个表而不是所有的表</p>\n<h2 id=\"join\"> join</h2>\n<h3 id=\"分库join分库\"> 分库join分库</h3>\n<ol>\n<li>无索引</li>\n</ol>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>QueryJoin</span><span>(</span><span>)</span>\n        <span>{</span>\n           <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>3</span><span>,</span> <span>2</span><span>)</span><span>;</span>\n           <span><span>var</span></span> end <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>5</span><span>,</span> <span>9</span><span>)</span><span>;</span>\n           <span><span>var</span></span> sql1 <span>=</span> <span>from</span> user <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id <span>==</span> <span>\"6\"</span><span>)</span>\n               <span>join</span> order <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>>=</span>begin<span>&amp;&amp;</span>o<span>.</span>CreationTime<span>&lt;=</span>end<span>)</span>\n                   <span>on</span> user<span>.</span>Id equals order<span>.</span>Payer\n               <span>select</span> <span>new</span>\n               <span>{</span>\n                   user<span>.</span>Id<span>,</span>\n                   user<span>.</span>Name<span>,</span>\n                   user<span>.</span>Area<span>,</span>\n                   OrderId <span>=</span> order<span>.</span>Id<span>,</span>\n                   order<span>.</span>Payer<span>,</span>\n                   order<span>.</span>CreationTime\n               <span>}</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span><span>await</span> sql1<span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"C\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"101\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-04-12T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"106\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-04-17T03:03:03\"</span><span>}</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>17ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>24ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>21ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>22ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>16ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>17ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>17ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>61ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>64ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br><span>111</span><br><span>112</span><br><span>113</span><br><span>114</span><br><span>115</span><br><span>116</span><br><span>117</span><br><span>118</span><br><span>119</span><br><span>120</span><br><span>121</span><br><span>122</span><br><span>123</span><br><span>124</span><br><span>125</span><br><span>126</span><br><span>127</span><br><span>128</span><br><span>129</span><br><span>130</span><br><span>131</span><br><span>132</span><br><span>133</span><br><span>134</span><br><span>135</span><br><span>136</span><br><span>137</span><br><span>138</span><br><span>139</span><br><span>140</span><br><span>141</span><br><span>142</span><br><span>143</span><br><span>144</span><br><span>145</span><br><span>146</span><br><span>147</span><br><span>148</span><br><span>149</span><br><span>150</span><br><span>151</span><br><span>152</span><br><span>153</span><br><span>154</span><br><span>155</span><br><span>156</span><br><span>157</span><br><span>158</span><br><span>159</span><br><span>160</span><br><span>161</span><br><span>162</span><br><span>163</span><br><span>164</span><br><span>165</span><br><span>166</span><br><span>167</span><br><span>168</span><br><span>169</span><br><span>170</span><br><span>171</span><br><span>172</span><br><span>173</span><br><span>174</span><br><span>175</span><br><span>176</span><br><span>177</span><br><span>178</span><br><span>179</span><br><span>180</span><br></div></div><p>一共开了18个链接,无法索引数据库3个,月份3,4,5月3张表,userid 1或者 6两张表一共是3<em>3</em>2=18个链接,因为是并行的而且使用完成后马上释放所以性能还是很高的</p>\n<ol start=\"2\">\n<li>有索引<code>Area</code>就是索引</li>\n</ol>\n<div><pre><code>\n        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>QueryJoin2</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>3</span><span>,</span> <span>2</span><span>)</span><span>;</span>\n            <span><span>var</span></span> end <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>4</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n            <span><span>var</span></span> sql1 <span>=</span> <span>from</span> user <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> <span>(</span>o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id <span>==</span> <span>\"6\"</span><span>)</span><span>&amp;&amp;</span>o<span>.</span>Area<span>==</span><span>\"A\"</span><span>)</span>\n                <span>join</span> order <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>CreationTime <span>>=</span> begin <span>&amp;&amp;</span> o<span>.</span>CreationTime <span>&lt;=</span> end<span>)</span>\n                    <span>on</span> user<span>.</span>Id equals order<span>.</span>Payer\n                <span>select</span> <span>new</span>\n                <span>{</span>\n                    user<span>.</span>Id<span>,</span>\n                    user<span>.</span>Name<span>,</span>\n                    user<span>.</span>Area<span>,</span>\n                    OrderId <span>=</span> order<span>.</span>Id<span>,</span>\n                    order<span>.</span>Payer<span>,</span>\n                    order<span>.</span>CreationTime\n                <span>}</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span><span>await</span> sql1<span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"106\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-04-17T03:03:03\"</span><span>}</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>51ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>12ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>18ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>16ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>52ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>52ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br></div></div><p>因为附带了索引，所以本次查询只需要月份3张表+userid两张表+A区域的一个库所以是3<em>2</em>1=6个链接</p>\n<div><p>注意</p>\n<ol>\n<li>如果本次查询涉及<code>跨表</code>或者<code>跨库</code>并且查询附带<code>order by</code>那么order by的字段必须包含在返回结果里面.(聚合函数除外：count,any,sum......)</li>\n<li>应该尽可能避免分库join分库,如果实在需要join那么也应该尽可能指定某一张表或者分表的数目尽可能小。(因为分表后如果a1,a2 join b1,b2那么就会有2个结果相互组合,路由结果越多性能越低，会生成各自datasourcename的交集,并且对各自的库下的表join会生成笛卡尔积)</li>\n</ol>\n</div>\n<h3 id=\"查询接口支持\"> 查询接口支持</h3>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>Method</th>\n<th><a href=\"https://github.com/xuejmnet/sharding-core/blob/main/test/ShardingCore.Test50/ShardingTest.cs\" target=\"_blank\" rel=\"noopener noreferrer\">Unit Test</a></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>第一条</td>\n<td>FindAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>获取集合</td>\n<td>ToListAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>第一条</td>\n<td>FirstOrDefaultAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>最大</td>\n<td>MaxAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>最小</td>\n<td>MinAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>是否存在</td>\n<td>AnyAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>数目</td>\n<td>CountAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>数目</td>\n<td>LongCountAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>求和</td>\n<td>SumAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>平均</td>\n<td>AverageAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>包含</td>\n<td>ContainsAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>分组</td>\n<td>GroupByAsync</td>\n<td>yes</td>\n</tr>\n</tbody>\n</table>\n<div><p>注意</p>\n<p>并不是说因为你的字段值是ABC所以我们需要将数据源定义成A、B、C,这边是因为方便通用,一般原则上我们定义为ds0,ds1,ds2，至于<code>Area</code>如何转成<code>ds0</code>,<code>ds1</code>,<code>ds2</code>那么就需要你自己去实现，比如你有一个[A..Z]的数组，数组下标就是对应的<code>ds</code>后面数字那么你就可以自己实现路由，并且还可以支持大于小于等于</p>\n</div>\n",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "修改",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-all/update/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-all/update/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分库的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingAll\" target=\"_blank\" rel=\"noopener noreferrer\">SqlServerShardingAll</a></p>\n<h2 id=\"自动追踪修改\"> 自动追踪修改</h2>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Update</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            sysUser<span>.</span>Name <span>=</span> <span>\"new name\"</span><span>;</span>\n            <span><span>var</span></span> i<span>=</span><span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>13ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p1<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      UPDATE <span>[</span>SysUser_01<span>]</span> SET <span>[</span>Name<span>]</span> <span>=</span> @p0\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p1<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"非自动追踪修改\"> 非自动追踪修改</h2>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Update1</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsNoTracking</span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            sysUser<span>.</span>Name <span>=</span> <span>\"new name\"</span><span>;</span>\n            _myDbContext<span>.</span><span>Update</span><span>(</span>sysUser<span>)</span><span>;</span>\n            <span><span>var</span></span> i <span>=</span> <span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p2<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p1<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      UPDATE <span>[</span>SysUser_01<span>]</span> SET <span>[</span>Area<span>]</span> <span>=</span> @p0, <span>[</span>Name<span>]</span> <span>=</span> @p1\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p2<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><div><p>结论</p>\n<p>追踪情况下sharding-core依然可以对结果进行修改，修改的字段是被修改过后的字段</p>\n<p>非追踪情况下sharding-croe也支持查询修改，但是修改的字段是全字段</p>\n</div>\n",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "读写分离",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/read-write/configure/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/read-write/configure/",
      "content_html": "",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "初始化",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-all/init/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-all/init/",
      "content_html": "<h2 id=\"介绍\"> 介绍</h2>\n<div><p>分库分表介绍</p>\n<ol>\n<li><code>sharding-core</code>支持自定义分库,流式聚合,支持同表join,数据源并非分表的笛卡尔积而是交集,比如我分库的对象和不分库的对象join结果只会查询不分库对象对应的数据源</li>\n<li>分库下的分布式事务(支持业务逻辑导致的事务出错可以回滚),网络情况下的事务出错直接忽略除非是第一个提交的事务,第二个数据源提交的事务开始就直接忽略异常。</li>\n</ol>\n</div>\n<h2 id=\"demo\"> Demo</h2>\n<p>本次分库的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingAll\" target=\"_blank\" rel=\"noopener noreferrer\">SqlServerShardingAll</a></p>\n<h2 id=\"分表使用\"> 分表使用</h2>\n<p>先拟定一个场景目前有用户表<code>SysUser</code>和订单表<code>Order</code>，用户我们按用户区域进行分库按用户Id取模分表,订单我们按用户区域分库按订单时间分表</p>\n<p>首先创建一个空的aspnetcore web api。</p>\n<h3 id=\"安装shardingcore\"> 安装ShardingCore</h3>\n<div><pre><code><span># 请对应安装您需要的版本</span>\nPM<span>></span> Install-Package ShardingCore\n<span># 请对应数据库版本</span>\nPM<span>></span> Install-Package Microsoft.EntityFrameworkCore.SqlServer\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><h3 id=\"创建对象\"> 创建对象</h3>\n<div><pre><code>    <span>public</span> <span>enum</span> <span>OrderStatusEnum</span>\n    <span>{</span>\n        NoPay<span>=</span><span>1</span><span>,</span>\n        Paying<span>=</span><span>2</span><span>,</span>\n        Payed<span>=</span><span>3</span><span>,</span>\n        PayFail<span>=</span><span>4</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>Order</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Payer <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>long</span></span> Money <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>OrderStatusEnum</span> OrderStatus <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>DateTime</span> CreationTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>SysUser</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br></div></div><h3 id=\"创建dbcontext\"> 创建DbContext</h3>\n<p>这样我们就创建好了三张表，接下来我们创建我们的<code>DbContext</code>,因为不需要分表所以我们并不需要继承<code>IShardingTableDbContext</code>接口</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span><span>IShardingTableDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Payer<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>OrderStatus<span>)</span><span>.</span><span><span>HasConversion</span><span><span>&lt;</span><span>int</span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Name<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>SysUser<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br></div></div><div><p>自定义标题</p>\n<ol>\n<li>构造函数必须是<code>DbContextOptions&lt;MyDbContext&gt;</code>或者<code>DbContextOptions</code></li>\n<li><code>OnModelCreating</code>并不是说分表必须要这样，而是你原先efcore怎么使用就怎么使用，efcore配置对象有两种一种是<code>DbSet</code>+<code>Attribute</code>,另外一种是<code>OnModelCreating</code>+<code>ModelBuilder</code>,你可以选择你原先在用的任何一种</li>\n<li><code>AbstractShardingDbContext</code>这个对象是可以不继承的，但是如果要使用分表分库你必须实现<code>IShardingTableDbContext</code>这个接口,因为这个接口实现起来都是一样的所以默认你只需要继承<code>AbstractShardingDbContext</code>就可以了</li>\n<li><code>IShardingTableDbContext</code>这个接口在你需要支持分表的情况下需要加，如果您只是分库那么就不需要添加这个接口</li>\n</ol>\n</div>\n<h3 id=\"创建虚拟路由\"> 创建虚拟路由</h3>\n<ol>\n<li>订单表按用户区域分库,因为分库系统并没有给我提供默认的分库路由,所以需要我们自行实现,我们先假设我们的数据源为A,B,C三个数据源,\n再按订单时间分表</li>\n<li>用户按区域分库,在按用户Id取模</li>\n</ol>\n<div><pre><code>    <span>//订单分库路由</span>\n    <span>public</span> <span>class</span> <span>OrderVirtualDataSourceRoute</span> <span>:</span> <span><span>AbstractShardingOperatorVirtualDataSourceRoute<span>&lt;</span>Order<span>,</span> <span>string</span><span>></span></span></span>\n    <span>{</span>\n        <span>private</span> <span>readonly</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> _dataSources <span>=</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>\"A\"</span><span>,</span> <span>\"B\"</span><span>,</span> <span>\"C\"</span>\n        <span>}</span><span>;</span>\n        <span>protected</span> <span>override</span> <span><span>string</span></span> <span>ConvertToShardingKey</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> shardingKey<span>?.</span><span>ToString</span><span>(</span><span>)</span> <span>??</span> <span>string</span><span>.</span>Empty<span>;</span>\n        <span>}</span>\n        <span>//我们设置区域就是数据库</span>\n        <span>public</span> <span>override</span> <span><span>string</span></span> <span>ShardingKeyToDataSourceName</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> <span>ConvertToShardingKey</span><span>(</span>shardingKey<span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> <span>GetAllDataSourceNames</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> _dataSources<span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AddDataSourceName</span><span>(</span><span><span>string</span></span> dataSourceName<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>_dataSources<span>.</span><span>Any</span><span>(</span>o <span>=></span> o <span>==</span> dataSourceName<span>)</span><span>)</span>\n                <span>return</span> <span>false</span><span>;</span>\n            _dataSources<span>.</span><span>Add</span><span>(</span>dataSourceName<span>)</span><span>;</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>string</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n\n            <span><span>var</span></span> t <span>=</span> <span>ShardingKeyToDataSourceName</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                    <span>{</span>\n                        <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                    <span>}</span>\n            <span>}</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataDataSourceBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>//订单分表路由</span>\n    <span>public</span> <span>class</span> <span>OrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>CreationTime<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>//用户区域分库</span>\n    <span>public</span> <span>class</span> <span>SysUserVirtualDataSourceRoute</span> <span>:</span> <span><span>AbstractShardingOperatorVirtualDataSourceRoute<span>&lt;</span>SysUser<span>,</span> <span>string</span><span>></span></span></span>\n    <span>{</span>\n        <span>private</span> <span>readonly</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> _dataSources <span>=</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>\"A\"</span><span>,</span> <span>\"B\"</span><span>,</span> <span>\"C\"</span>\n        <span>}</span><span>;</span>\n        <span>protected</span> <span>override</span> <span><span>string</span></span> <span>ConvertToShardingKey</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> shardingKey<span>?.</span><span>ToString</span><span>(</span><span>)</span> <span>??</span> <span>string</span><span>.</span>Empty<span>;</span>\n        <span>}</span>\n        <span>//我们设置区域就是数据库</span>\n        <span>public</span> <span>override</span> <span><span>string</span></span> <span>ShardingKeyToDataSourceName</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> <span>ConvertToShardingKey</span><span>(</span>shardingKey<span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> <span>GetAllDataSourceNames</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> _dataSources<span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AddDataSourceName</span><span>(</span><span><span>string</span></span> dataSourceName<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>_dataSources<span>.</span><span>Any</span><span>(</span>o <span>=></span> o <span>==</span> dataSourceName<span>)</span><span>)</span>\n                <span>return</span> <span>false</span><span>;</span>\n            _dataSources<span>.</span><span>Add</span><span>(</span>dataSourceName<span>)</span><span>;</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>string</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n\n            <span><span>var</span></span> t <span>=</span> <span>ShardingKeyToDataSourceName</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataDataSourceBuilder<span>&lt;</span>SysUser<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>//用户Id取模</span>\n    \n    <span>public</span> <span>class</span> <span>SysUserVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>SysUser<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>SysUserVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>SysUser<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br><span>111</span><br><span>112</span><br><span>113</span><br><span>114</span><br><span>115</span><br><span>116</span><br><span>117</span><br><span>118</span><br><span>119</span><br><span>120</span><br><span>121</span><br><span>122</span><br><span>123</span><br><span>124</span><br></div></div><div><p>注意</p>\n<p>因为分库提供默认路由所以需要用户自行实现<code>AbstractShardingOperatorVirtualDataSourceRoute</code>抽象,分表有默认抽象路由但是如果无法满足需求可以自定义实现<code>AbstractShardingOperatorVirtualTableRoute</code>抽象</p>\n</div>\n<h3 id=\"startup配置\"> Startup配置</h3>\n<p><code>ConfigureServices(IServiceCollection services)</code>配置</p>\n<div><pre><code>        <span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>\n        <span>{</span>\n\n            services<span>.</span><span>AddControllers</span><span>(</span><span>)</span><span>;</span>\n            \n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>(</span>conStr<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>Begin</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    <span>//如果您使用code-first建议选择false</span>\n                    op<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                    <span>//如果您使用code-first建议修改为fsle</span>\n                    op<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"A\"</span><span>,</span>\n                    <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDataSourceDBA;Integrated Security=True;\"</span><span>)</span>\n                <span>.</span><span>AddShardingDataSource</span><span>(</span>sp <span>=></span>\n                <span>{</span>\n                    <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span>\n                            <span>\"B\"</span><span>,</span><span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDataSourceDBB;Integrated Security=True;\"</span>\n                        <span>}</span><span>,</span>\n                        <span>{</span>\n                            <span>\"C\"</span><span>,</span><span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDataSourceDBC;Integrated Security=True;\"</span>\n                        <span>}</span><span>,</span>\n                    <span>}</span><span>;</span>\n                <span>}</span><span>)</span>\n                <span>.</span><span>AddShardingDataSourceRoute</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span><span><span>AddShardingDatabaseRoute</span><span><span>&lt;</span>SysUserVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingDatabaseRoute</span><span><span>&lt;</span>OrderVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddShardingTableRoute</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>End</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br></div></div><div><p>重要</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n</div>\n<p>新建一个扩展方法用来初始化ShardingCore和初始化种子数据</p>\n<div><pre><code>   \n    <span>public</span> <span>static</span> <span>class</span> <span>StartupExtension</span>\n    <span>{</span>\n        <span>public</span> <span>static</span> <span><span>void</span></span> <span>UseShardingCore</span><span>(</span><span>this</span> <span>IApplicationBuilder</span> app<span>)</span>\n        <span>{</span>\n            app<span>.</span>ApplicationServices<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>public</span> <span>static</span> <span><span>void</span></span> <span>InitSeed</span><span>(</span><span>this</span> <span>IApplicationBuilder</span> app<span>)</span>\n        <span>{</span>\n            <span>using</span> <span>(</span><span><span>var</span></span> serviceScope <span>=</span> app<span>.</span>ApplicationServices<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                <span><span>var</span></span> myDbContext <span>=</span> serviceScope<span>.</span>ServiceProvider<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>if</span> <span>(</span><span>!</span>myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Any</span><span>(</span><span>)</span><span>)</span>\n                <span>{</span>\n                    <span><span>string</span><span>[</span><span>]</span></span> areas <span>=</span> <span>new</span> <span><span>string</span><span>[</span><span>]</span></span> <span>{</span><span>\"A\"</span><span>,</span><span>\"B\"</span><span>,</span><span>\"C\"</span> <span>}</span><span>;</span>\n                    <span>List<span>&lt;</span>SysUser<span>></span></span> users <span>=</span> <span>new</span> <span>List<span>&lt;</span>SysUser<span>></span></span><span>(</span><span>10</span><span>)</span><span>;</span>\n                    <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>100</span><span>;</span> i<span>++</span><span>)</span>\n                    <span>{</span>\n                        <span><span>var</span></span> uer<span>=</span><span>new</span> <span>SysUser</span><span>(</span><span>)</span>\n                        <span>{</span>\n                            Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                            Name <span>=</span> <span><span>$\"MyName</span><span><span>{</span><span>i</span><span>}</span></span><span>\"</span></span><span>,</span>\n                            Area <span>=</span> areas<span>[</span><span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>Next</span><span>(</span><span>0</span><span>,</span><span>3</span><span>)</span><span>]</span>\n                        <span>}</span><span>;</span>\n                        users<span>.</span><span>Add</span><span>(</span>uer<span>)</span><span>;</span>\n                    <span>}</span>\n                    <span>List<span>&lt;</span>Order<span>></span></span> orders <span>=</span> <span>new</span> <span>List<span>&lt;</span>Order<span>></span></span><span>(</span><span>300</span><span>)</span><span>;</span>\n                    <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>,</span> <span>3</span><span>,</span> <span>3</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n                    <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>300</span><span>;</span> i<span>++</span><span>)</span>\n                    <span>{</span>\n                        <span><span>var</span></span> sysUser <span>=</span> users<span>[</span>i <span>%</span> <span>100</span><span>]</span><span>;</span>\n                        <span><span>var</span></span> order <span>=</span> <span>new</span> <span>Order</span><span>(</span><span>)</span>\n                        <span>{</span>\n                            Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                            Payer <span>=</span> sysUser<span>.</span>Id<span>,</span>\n                            Money <span>=</span> <span>100</span><span>+</span><span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>Next</span><span>(</span><span>100</span><span>,</span><span>3000</span><span>)</span><span>,</span>\n                            OrderStatus <span>=</span> <span>(</span>OrderStatusEnum<span>)</span><span>(</span>i <span>%</span> <span>4</span> <span>+</span> <span>1</span><span>)</span><span>,</span>\n                            Area <span>=</span> sysUser<span>.</span>Area<span>,</span>\n                            CreationTime <span>=</span> begin<span>.</span><span>AddDays</span><span>(</span>i<span>)</span>\n                        <span>}</span><span>;</span>\n                        orders<span>.</span><span>Add</span><span>(</span>order<span>)</span><span>;</span>\n                    <span>}</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>users<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>orders<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br></div></div><p><code>Configure(IApplicationBuilder app, IWebHostEnvironment env)</code>配置</p>\n<div><pre><code>        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>env<span>.</span><span>IsDevelopment</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                app<span>.</span><span>UseDeveloperExceptionPage</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n            <span>//初始化ShardingCore</span>\n            app<span>.</span><span>UseShardingCore</span><span>(</span><span>)</span><span>;</span>\n            app<span>.</span><span>UseRouting</span><span>(</span><span>)</span><span>;</span>\n\n            app<span>.</span><span>UseAuthorization</span><span>(</span><span>)</span><span>;</span>\n\n            app<span>.</span><span>UseEndpoints</span><span>(</span>endpoints <span>=></span>\n            <span>{</span>\n                endpoints<span>.</span><span>MapControllers</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            <span>//初始化种子数据</span>\n            app<span>.</span><span>InitSeed</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><h3 id=\"efcore日志-可选\"> efcore日志(可选)</h3>\n<p>这边为了方便我们观察efcore的执行sql语句我们这边建议对efcore添加日志\n<code>Startup</code>添加静态数据</p>\n<div><pre><code>        <span>public</span> <span>static</span> <span>readonly</span> <span>ILoggerFactory</span> efLogger <span>=</span> LoggerFactory<span>.</span><span>Create</span><span>(</span>builder <span>=></span>\n        <span>{</span>\n            builder<span>.</span><span>AddFilter</span><span>(</span><span>(</span>category<span>,</span> level<span>)</span> <span>=></span> category <span>==</span> DbLoggerCategory<span>.</span>Database<span>.</span>Command<span>.</span>Name <span>&amp;&amp;</span> level <span>==</span> LogLevel<span>.</span>Information<span>)</span><span>.</span><span>AddConsole</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><p>在所有<code>builder.UseSqlServer(conStr);</code></p>\n<p>都改成<code>builder.UseSqlServer(conStr).UseLoggerFactory(efLogger);</code></p>\n<p>启动后我们将可以看到数据库和表会被自动创建，并且会将种子数据进行插入到内部供我们可以查询测试</p>\n<img src=\"/sharding-core-doc/sharding-data-source-table.png\">",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2022-01-07T14:00:26.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "删除",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-data-source/delete/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-data-source/delete/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingDataSource\" target=\"_blank\" rel=\"noopener noreferrer\">SqlServerShardingDataSource</a></p>\n<h2 id=\"删除数据\"> 删除数据</h2>\n<p>增删改查除了查询稍微在分表+排序的情况下需要注意其实其他操作和efcore基本上一致</p>\n<p>删除也是</p>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Delete</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"9\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            _myDbContext<span>.</span><span>Remove</span><span>(</span>sysUser<span>)</span><span>;</span>\n            <span><span>var</span></span> i <span>=</span> <span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><p>控制台我们可以看到对应的执行sql</p>\n<div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>12ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      DELETE FROM <span>[</span>SysUser<span>]</span>\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p0<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div>",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "初始化",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-data-source/init/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-data-source/init/",
      "content_html": "<h2 id=\"介绍\"> 介绍</h2>\n<div><p>分库介绍</p>\n<ol>\n<li><code>sharding-core</code>支持自定义分库,流式聚合,支持同表join,数据源并非分表的笛卡尔积而是交集,比如我分库的对象和不分库的对象join结果只会查询不分库对象对应的数据源</li>\n<li>分库下的分布式事务(支持业务逻辑导致的事务出错可以回滚),网络情况下的事务出错直接忽略除非是第一个提交的事务,第二个数据源提交的事务开始就直接忽略异常。</li>\n</ol>\n</div>\n<h2 id=\"demo\"> Demo</h2>\n<p>本次分库的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingDataSource\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreShardingDataSource</a></p>\n<h2 id=\"分表使用\"> 分表使用</h2>\n<p>先拟定一个场景目前有用户表<code>SysUser</code>和订单表<code>Order</code>，用户我们按用户区域进行分库，订单我们按用户区域分库</p>\n<p>首先创建一个空的aspnetcore web api。</p>\n<h3 id=\"安装shardingcore\"> 安装ShardingCore</h3>\n<div><pre><code><span># 请对应安装您需要的版本</span>\nPM<span>></span> Install-Package ShardingCore\n<span># 请对应数据库版本</span>\nPM<span>></span> Install-Package Microsoft.EntityFrameworkCore.SqlServer\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><h3 id=\"创建对象\"> 创建对象</h3>\n<div><pre><code>    <span>public</span> <span>enum</span> <span>OrderStatusEnum</span>\n    <span>{</span>\n        NoPay<span>=</span><span>1</span><span>,</span>\n        Paying<span>=</span><span>2</span><span>,</span>\n        Payed<span>=</span><span>3</span><span>,</span>\n        PayFail<span>=</span><span>4</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>Order</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Payer <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>long</span></span> Money <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>OrderStatusEnum</span> OrderStatus <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>DateTime</span> CreationTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>SysUser</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br></div></div><h3 id=\"创建dbcontext\"> 创建DbContext</h3>\n<p>这样我们就创建好了三张表，接下来我们创建我们的<code>DbContext</code>,因为不需要分表所以我们并不需要继承<code>IShardingTableDbContext</code>接口</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Payer<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>OrderStatus<span>)</span><span>.</span><span><span>HasConversion</span><span><span>&lt;</span><span>int</span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Name<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>SysUser<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br></div></div><div><p>自定义标题</p>\n<ol>\n<li>构造函数必须是<code>DbContextOptions&lt;MyDbContext&gt;</code>或者<code>DbContextOptions</code></li>\n<li><code>OnModelCreating</code>并不是说分表必须要这样，而是你原先efcore怎么使用就怎么使用，efcore配置对象有两种一种是<code>DbSet</code>+<code>Attribute</code>,另外一种是<code>OnModelCreating</code>+<code>ModelBuilder</code>,你可以选择你原先在用的任何一种</li>\n<li><code>AbstractShardingDbContext</code>这个对象是可以不继承的，但是如果要使用分表分库你必须实现<code>IShardingTableDbContext</code>这个接口,因为这个接口实现起来都是一样的所以默认你只需要继承<code>AbstractShardingDbContext</code>就可以了</li>\n</ol>\n</div>\n<h3 id=\"创建虚拟路由\"> 创建虚拟路由</h3>\n<ol>\n<li>订单表按用户区域分库,因为分库系统并没有给我提供默认的分库路由,所以需要我们自行实现,我们先假设我们的数据源为A,B,C三个数据源</li>\n</ol>\n<div><pre><code>\n    \n    <span>public</span> <span>class</span> <span>OrderVirtualDataSourceRoute</span><span>:</span><span><span>AbstractShardingOperatorVirtualDataSourceRoute<span>&lt;</span>Order<span>,</span><span>string</span><span>></span></span></span>\n    <span>{</span>\n        <span>private</span> <span>readonly</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> _dataSources<span>=</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>\"A\"</span><span>,</span> <span>\"B\"</span><span>,</span> <span>\"C\"</span>\n        <span>}</span><span>;</span>\n        <span>protected</span> <span>override</span> <span><span>string</span></span> <span>ConvertToShardingKey</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> shardingKey<span>?.</span><span>ToString</span><span>(</span><span>)</span> <span>??</span> <span>string</span><span>.</span>Empty<span>;</span>\n        <span>}</span>\n        <span>//我们设置区域就是数据库</span>\n        <span>public</span> <span>override</span> <span><span>string</span></span> <span>ShardingKeyToDataSourceName</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> <span>ConvertToShardingKey</span><span>(</span>shardingKey<span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> <span>GetAllDataSourceNames</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> _dataSources<span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AddDataSourceName</span><span>(</span><span><span>string</span></span> dataSourceName<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>_dataSources<span>.</span><span>Any</span><span>(</span>o <span>=></span> o <span>==</span> dataSourceName<span>)</span><span>)</span>\n                <span>return</span> <span>false</span><span>;</span>\n             _dataSources<span>.</span><span>Add</span><span>(</span>dataSourceName<span>)</span><span>;</span>\n             <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>string</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n\n            <span><span>var</span></span> t <span>=</span> <span>ShardingKeyToDataSourceName</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>SysUserVirtualDataSourceRoute</span> <span>:</span> <span><span>AbstractShardingOperatorVirtualDataSourceRoute<span>&lt;</span>SysUser<span>,</span> <span>string</span><span>></span></span></span>\n    <span>{</span>\n        <span>private</span> <span>readonly</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> _dataSources <span>=</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>\"A\"</span><span>,</span> <span>\"B\"</span><span>,</span> <span>\"C\"</span>\n        <span>}</span><span>;</span>\n        <span>protected</span> <span>override</span> <span><span>string</span></span> <span>ConvertToShardingKey</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> shardingKey<span>?.</span><span>ToString</span><span>(</span><span>)</span> <span>??</span> <span>string</span><span>.</span>Empty<span>;</span>\n        <span>}</span>\n        <span>//我们设置区域就是数据库</span>\n        <span>public</span> <span>override</span> <span><span>string</span></span> <span>ShardingKeyToDataSourceName</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> <span>ConvertToShardingKey</span><span>(</span>shardingKey<span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> <span>GetAllDataSourceNames</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> _dataSources<span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AddDataSourceName</span><span>(</span><span><span>string</span></span> dataSourceName<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>_dataSources<span>.</span><span>Any</span><span>(</span>o <span>=></span> o <span>==</span> dataSourceName<span>)</span><span>)</span>\n                <span>return</span> <span>false</span><span>;</span>\n            _dataSources<span>.</span><span>Add</span><span>(</span>dataSourceName<span>)</span><span>;</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>string</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n\n            <span><span>var</span></span> t <span>=</span> <span>ShardingKeyToDataSourceName</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br></div></div><div><p>注意</p>\n<p>因为分库提供默认路由所以需要用户自行实现<code>AbstractShardingOperatorVirtualDataSourceRoute</code>抽象</p>\n</div>\n<h3 id=\"startup配置\"> Startup配置</h3>\n<p><code>ConfigureServices(IServiceCollection services)</code>配置</p>\n<div><pre><code>        <span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>\n        <span>{</span>\n\n            services<span>.</span><span>AddControllers</span><span>(</span><span>)</span><span>;</span>\n            \n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>(</span>conStr<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>Begin</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    <span>//如果您使用code-first建议选择false</span>\n                    op<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                    <span>//如果您使用code-first建议修改为fsle</span>\n                    op<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"A\"</span><span>,</span>\n                    <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDataSourceDBA;Integrated Security=True;\"</span><span>)</span>\n                <span>.</span><span>AddShardingDataSource</span><span>(</span>sp<span>=></span>\n                <span>{</span>\n                    <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span>\n                            <span>\"B\"</span><span>,</span>\n                            <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDataSourceDBB;Integrated Security=True;\"</span>\n                        <span>}</span><span>,</span>\n                        <span>{</span>\n                            <span>\"C\"</span><span>,</span>\n                            <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDataSourceDBC;Integrated Security=True;\"</span>\n                        <span>}</span><span>,</span>\n                    <span>}</span><span>;</span>\n                <span>}</span><span>)</span>\n                <span>.</span><span>AddShardingDataSourceRoute</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span><span><span>AddShardingDatabaseRoute</span><span><span>&lt;</span>SysUserVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingDatabaseRoute</span><span><span>&lt;</span>OrderVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>End</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br></div></div><div><p>重要</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n</div>\n<p>新建一个扩展方法用来初始化ShardingCore和初始化种子数据</p>\n<div><pre><code>   \n    <span>public</span> <span>static</span> <span>class</span> <span>StartupExtension</span>\n    <span>{</span>\n        <span>public</span> <span>static</span> <span><span>void</span></span> <span>UseShardingCore</span><span>(</span><span>this</span> <span>IApplicationBuilder</span> app<span>)</span>\n        <span>{</span>\n            app<span>.</span>ApplicationServices<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>public</span> <span>static</span> <span><span>void</span></span> <span>InitSeed</span><span>(</span><span>this</span> <span>IApplicationBuilder</span> app<span>)</span>\n        <span>{</span>\n            <span>using</span> <span>(</span><span><span>var</span></span> serviceScope <span>=</span> app<span>.</span>ApplicationServices<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                <span><span>var</span></span> myDbContext <span>=</span> serviceScope<span>.</span>ServiceProvider<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>if</span> <span>(</span><span>!</span>myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Any</span><span>(</span><span>)</span><span>)</span>\n                <span>{</span>\n                    <span><span>string</span><span>[</span><span>]</span></span> areas <span>=</span> <span>new</span> <span><span>string</span><span>[</span><span>]</span></span> <span>{</span><span>\"A\"</span><span>,</span><span>\"B\"</span><span>,</span><span>\"C\"</span> <span>}</span><span>;</span>\n                    <span>List<span>&lt;</span>SysUser<span>></span></span> users <span>=</span> <span>new</span> <span>List<span>&lt;</span>SysUser<span>></span></span><span>(</span><span>10</span><span>)</span><span>;</span>\n                    <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>10</span><span>;</span> i<span>++</span><span>)</span>\n                    <span>{</span>\n                        <span><span>var</span></span> uer<span>=</span><span>new</span> <span>SysUser</span><span>(</span><span>)</span>\n                        <span>{</span>\n                            Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                            Name <span>=</span> <span><span>$\"MyName</span><span><span>{</span><span>i</span><span>}</span></span><span>\"</span></span><span>,</span>\n                            Area <span>=</span> areas<span>[</span>i <span>%</span> <span>3</span><span>]</span>\n                        <span>}</span><span>;</span>\n                        users<span>.</span><span>Add</span><span>(</span>uer<span>)</span><span>;</span>\n                    <span>}</span>\n                    <span>List<span>&lt;</span>Order<span>></span></span> orders <span>=</span> <span>new</span> <span>List<span>&lt;</span>Order<span>></span></span><span>(</span><span>300</span><span>)</span><span>;</span>\n                    <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>,</span> <span>3</span><span>,</span> <span>3</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n                    <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>300</span><span>;</span> i<span>++</span><span>)</span>\n                    <span>{</span>\n\n                        <span><span>var</span></span> order <span>=</span> <span>new</span> <span>Order</span><span>(</span><span>)</span>\n                        <span>{</span>\n                            Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                            Payer <span>=</span> <span><span>$\"</span><span><span>{</span><span>i <span>%</span> <span>10</span></span><span>}</span></span><span>\"</span></span><span>,</span>\n                            Money <span>=</span> <span>100</span><span>+</span><span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>Next</span><span>(</span><span>100</span><span>,</span><span>3000</span><span>)</span><span>,</span>\n                            OrderStatus <span>=</span> <span>(</span>OrderStatusEnum<span>)</span><span>(</span>i <span>%</span> <span>4</span> <span>+</span> <span>1</span><span>)</span><span>,</span>\n                            Area <span>=</span> areas<span>[</span>i <span>%</span> <span>3</span><span>]</span><span>,</span>\n                            CreationTime <span>=</span> begin<span>.</span><span>AddDays</span><span>(</span>i<span>)</span>\n                        <span>}</span><span>;</span>\n                        orders<span>.</span><span>Add</span><span>(</span>order<span>)</span><span>;</span>\n                    <span>}</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>users<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>orders<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br></div></div><p><code>Configure(IApplicationBuilder app, IWebHostEnvironment env)</code>配置</p>\n<div><pre><code>        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>env<span>.</span><span>IsDevelopment</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                app<span>.</span><span>UseDeveloperExceptionPage</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n            <span>//初始化ShardingCore</span>\n            app<span>.</span><span>UseShardingCore</span><span>(</span><span>)</span><span>;</span>\n            app<span>.</span><span>UseRouting</span><span>(</span><span>)</span><span>;</span>\n\n            app<span>.</span><span>UseAuthorization</span><span>(</span><span>)</span><span>;</span>\n\n            app<span>.</span><span>UseEndpoints</span><span>(</span>endpoints <span>=></span>\n            <span>{</span>\n                endpoints<span>.</span><span>MapControllers</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            <span>//初始化种子数据</span>\n            app<span>.</span><span>InitSeed</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><h3 id=\"efcore日志-可选\"> efcore日志(可选)</h3>\n<p>这边为了方便我们观察efcore的执行sql语句我们这边建议对efcore添加日志\n<code>Startup</code>添加静态数据</p>\n<div><pre><code>        <span>public</span> <span>static</span> <span>readonly</span> <span>ILoggerFactory</span> efLogger <span>=</span> LoggerFactory<span>.</span><span>Create</span><span>(</span>builder <span>=></span>\n        <span>{</span>\n            builder<span>.</span><span>AddFilter</span><span>(</span><span>(</span>category<span>,</span> level<span>)</span> <span>=></span> category <span>==</span> DbLoggerCategory<span>.</span>Database<span>.</span>Command<span>.</span>Name <span>&amp;&amp;</span> level <span>==</span> LogLevel<span>.</span>Information<span>)</span><span>.</span><span>AddConsole</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><p>在所有<code>builder.UseSqlServer(conStr);</code></p>\n<p>都改成<code>builder.UseSqlServer(conStr).UseLoggerFactory(efLogger);</code></p>\n<p>启动后我们将可以看到数据库和表会被自动创建，并且会将种子数据进行插入到内部供我们可以查询测试</p>\n<img src=\"/sharding-core-doc/sharding-data-source.png\">",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2022-01-07T14:00:26.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "修改",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-data-source/update/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-data-source/update/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingDataSource\" target=\"_blank\" rel=\"noopener noreferrer\">SqlServerShardingDataSource</a></p>\n<h2 id=\"自动追踪修改\"> 自动追踪修改</h2>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Update</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            sysUser<span>.</span>Name <span>=</span> <span>\"new name\"</span><span>;</span>\n            <span><span>var</span></span> i<span>=</span><span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>13ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p1<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      UPDATE <span>[</span>SysUser<span>]</span> SET <span>[</span>Name<span>]</span> <span>=</span> @p0\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p1<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"非自动追踪修改\"> 非自动追踪修改</h2>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Update1</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsNoTracking</span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            sysUser<span>.</span>Name <span>=</span> <span>\"new name\"</span><span>;</span>\n            _myDbContext<span>.</span><span>Update</span><span>(</span>sysUser<span>)</span><span>;</span>\n            <span><span>var</span></span> i <span>=</span> <span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p2<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p1<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      UPDATE <span>[</span>SysUser<span>]</span> SET <span>[</span>Area<span>]</span> <span>=</span> @p0, <span>[</span>Name<span>]</span> <span>=</span> @p1\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p2<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><div><p>结论</p>\n<p>追踪情况下sharding-core依然可以对结果进行修改，修改的字段是被修改过后的字段</p>\n<p>非追踪情况下sharding-croe也支持查询修改，但是修改的字段是全字段</p>\n</div>\n",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-data-source/query/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-data-source/query/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分库的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingDataSource\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreShardingDataSource</a></p>\n<h2 id=\"单对象简单查询\"> 单对象简单查询</h2>\n<p>对<code>SysUser</code>和<code>Order</code>进行查询</p>\n<div><pre><code><span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Query</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span><span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>Id<span>==</span><span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> dateTime <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span><span>3</span><span>,</span><span>5</span><span>)</span><span>;</span>\n            <span><span>var</span></span> order <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>>=</span> dateTime<span>)</span><span>.</span><span>OrderBy</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> orderIdOne <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"3\"</span><span>)</span><span>;</span>\n\n\n            <span><span>var</span></span> sysUsers <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id<span>==</span><span>\"6\"</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n\n            <span>return</span> <span>Ok</span><span>(</span><span>new</span> <span><span>object</span><span>[</span><span>]</span></span>\n            <span>{</span>\n                sysUser<span>,</span>\n                order<span>,</span>\n                orderIdOne<span>,</span>\n                sysUsers\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"63\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"money\"</span><span>:</span><span>1271</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderStatus\"</span><span>:</span><span>4</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-05T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"money\"</span><span>:</span><span>2484</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderStatus\"</span><span>:</span><span>4</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-01-04T03:03:03\"</span><span>}</span><span>,</span><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>}</span><span>]</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>8ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>3ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br></div></div><h2 id=\"join\"> join</h2>\n<h3 id=\"分库join分库\"> 分库join分库</h3>\n<ol>\n<li>无索引</li>\n</ol>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>QueryJoin</span><span>(</span><span>)</span>\n        <span>{</span>\n           <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>3</span><span>,</span> <span>2</span><span>)</span><span>;</span>\n           <span><span>var</span></span> end <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>4</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n           <span><span>var</span></span> sql1 <span>=</span> <span>from</span> user <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id <span>==</span> <span>\"6\"</span><span>)</span>\n               <span>join</span> order <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>>=</span>begin<span>&amp;&amp;</span>o<span>.</span>CreationTime<span>&lt;=</span>end<span>)</span>\n                   <span>on</span> user<span>.</span>Id equals order<span>.</span>Payer\n               <span>select</span> <span>new</span>\n               <span>{</span>\n                   user<span>.</span>Id<span>,</span>\n                   user<span>.</span>Name<span>,</span>\n                   user<span>.</span>Area<span>,</span>\n                   OrderId <span>=</span> order<span>.</span>Id<span>,</span>\n                   order<span>.</span>Payer<span>,</span>\n                   order<span>.</span>CreationTime\n               <span>}</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span><span>await</span> sql1<span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"61\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-03T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"71\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-13T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"81\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-23T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"91\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-04-02T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"66\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-08T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"76\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-18T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"86\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-28T03:03:03\"</span><span>}</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>3ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>3ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br></div></div><ol start=\"2\">\n<li>有索引<code>Area</code>就是索引</li>\n</ol>\n<div><pre><code>\n        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>QueryJoin2</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>3</span><span>,</span> <span>2</span><span>)</span><span>;</span>\n            <span><span>var</span></span> end <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>4</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n            <span><span>var</span></span> sql1 <span>=</span> <span>from</span> user <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> <span>(</span>o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id <span>==</span> <span>\"6\"</span><span>)</span><span>&amp;&amp;</span>o<span>.</span>Area<span>==</span><span>\"A\"</span><span>)</span>\n                <span>join</span> order <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>CreationTime <span>>=</span> begin <span>&amp;&amp;</span> o<span>.</span>CreationTime <span>&lt;=</span> end<span>)</span>\n                    <span>on</span> user<span>.</span>Id equals order<span>.</span>Payer\n                <span>select</span> <span>new</span>\n                <span>{</span>\n                    user<span>.</span>Id<span>,</span>\n                    user<span>.</span>Name<span>,</span>\n                    user<span>.</span>Area<span>,</span>\n                    OrderId <span>=</span> order<span>.</span>Id<span>,</span>\n                    order<span>.</span>Payer<span>,</span>\n                    order<span>.</span>CreationTime\n                <span>}</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span><span>await</span> sql1<span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"66\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-08T03:03:03\"</span><span>}</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>17ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br></div></div><div><p>注意</p>\n<ol>\n<li>如果本次查询涉及<code>跨表</code>或者<code>跨库</code>并且查询附带<code>order by</code>那么order by的字段必须包含在返回结果里面.(聚合函数除外：count,any,sum......)</li>\n<li>应该尽可能避免分库join分库,如果实在需要join那么也应该尽可能指定某一张表或者分表的数目尽可能小。(因为分表后如果a1,a2 join b1,b2那么就会有2个结果相互组合,路由结果越多性能越低，会生成各自datasourcename的交集(并不是和分表一样的笛卡尔积))</li>\n</ol>\n</div>\n<h3 id=\"查询接口支持\"> 查询接口支持</h3>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>Method</th>\n<th><a href=\"https://github.com/xuejmnet/sharding-core/blob/main/test/ShardingCore.Test50/ShardingTest.cs\" target=\"_blank\" rel=\"noopener noreferrer\">Unit Test</a></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>第一条</td>\n<td>FindAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>获取集合</td>\n<td>ToListAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>第一条</td>\n<td>FirstOrDefaultAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>最大</td>\n<td>MaxAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>最小</td>\n<td>MinAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>是否存在</td>\n<td>AnyAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>数目</td>\n<td>CountAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>数目</td>\n<td>LongCountAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>求和</td>\n<td>SumAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>平均</td>\n<td>AverageAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>包含</td>\n<td>ContainsAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>分组</td>\n<td>GroupByAsync</td>\n<td>yes</td>\n</tr>\n</tbody>\n</table>\n<div><p>注意</p>\n<p>并不是说因为你的字段值是ABC所以我们需要将数据源定义成A、B、C,这边是因为方便通用,一般原则上我们定义为ds0,ds1,ds2，至于<code>Area</code>如何转成<code>ds0</code>,<code>ds1</code>,<code>ds2</code>那么就需要你自己去实现，比如你有一个[A..Z]的数组，数组下标就是对应的<code>ds</code>后面数字那么你就可以自己实现路由，并且还可以支持大于小于等于</p>\n</div>\n",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "默认路由",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-route/default-route/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-route/default-route/",
      "content_html": "<h2 id=\"默认路由\"> 默认路由</h2>\n<p>分库提供了默认的路由分表则需要自己去实现,具体实现可以参考分库</p>\n<table>\n<thead>\n<tr>\n<th>抽象abstract</th>\n<th>路由规则</th>\n<th>tail</th>\n<th>索引</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>AbstractSimpleShardingModKeyIntVirtualTableRoute</td>\n<td>取模</td>\n<td>0,1,2...</td>\n<td><code>=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingModKeyStringVirtualTableRoute</td>\n<td>取模</td>\n<td>0,1,2...</td>\n<td><code>=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingDayKeyDateTimeVirtualTableRoute</td>\n<td>按时间</td>\n<td>yyyyMMdd</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingDayKeyLongVirtualTableRoute</td>\n<td>按时间戳</td>\n<td>yyyyMMdd</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingWeekKeyDateTimeVirtualTableRoute</td>\n<td>按时间</td>\n<td>yyyyMMdd_dd</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingWeekKeyLongVirtualTableRoute</td>\n<td>按时间戳</td>\n<td>yyyyMMdd_dd</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute</td>\n<td>按时间</td>\n<td>yyyyMM</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingMonthKeyLongVirtualTableRoute</td>\n<td>按时间戳</td>\n<td>yyyyMM</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingYearKeyDateTimeVirtualTableRoute</td>\n<td>按时间</td>\n<td>yyyy</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingYearKeyLongVirtualTableRoute</td>\n<td>按时间戳</td>\n<td>yyyy</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n</tbody>\n</table>\n<p>注:<code>contains</code>表示为<code>o=&gt;ids.contains(o.shardingkey)</code>\n注:使用默认的按时间分表的路由规则会让你重写一个GetBeginTime的方法这个方法必须使用静态值如:new DateTime(2021,1,1)不可以用动态值比如DateTime.Now因为每次重新启动都会调用该方法动态情况下会导致每次都不一致</p>\n<h2 id=\"索引\"> 索引</h2>\n<p>所谓的索引就是支持的表达式比如支持分表字段等于某个值，那么框架就会针对这个值进行解析出对应的数据库分表应该是哪个,并且支持组合<code>and</code>、<code>or</code>。\n默认提供的分表路由里面已经实现了所谓的路由，如果你的查询是包含对应的路由那么框架可以大大减小数据库链接的开启。有助于程序的高性能。</p>\n<p>假设我们是按id取模，那么如果你有指定的id对应值进行查询，我们就可以直接进行对分表/分库下进行数据源和表的定位，保证查询的高效。</p>\n<h3 id=\"abstractsimpleshardingmodkeyintvirtualtableroute\"> AbstractSimpleShardingModKeyIntVirtualTableRoute</h3>\n<p>该路由为简单的取模hash路由,分表字段是<code>int</code>类型,接受3个参数，第一个参数表示后缀的位数,第二位表示取模的基数，第三位是取模后缀不足的左补字符.</p>\n<p>AbstractSimpleShardingModKeyStringVirtualTableRoute(3,6,'0')那么就是<code>000</code>、<code>001</code>、<code>002</code>、<code>003</code>、<code>004</code>、<code>005</code></p>\n<h3 id=\"abstractsimpleshardingmodkeystringvirtualtableroute\"> AbstractSimpleShardingModKeyStringVirtualTableRoute</h3>\n<p>该路由为简单的取模hash路由,分表字段是<code>string</code>类型,接受3个参数，第一个参数表示后缀的位数,第二位表示取模的基数，第三位是取模后缀不足的左补字符.</p>\n<p>AbstractSimpleShardingModKeyStringVirtualTableRoute(3,6,'0')那么就是<code>000</code>、<code>001</code>、<code>002</code>、<code>003</code>、<code>004</code>、<code>005</code></p>\n<h3 id=\"abstractsimpleshardingdaykeydatetimevirtualtableroute\"> AbstractSimpleShardingDayKeyDateTimeVirtualTableRoute</h3>\n<p>该路由为简单的按天分表路由,支持分表字段是<code>DateTime</code>,分表后的后缀为<code>yyyyMMdd</code>.</p>\n<h3 id=\"abstractsimpleshardingdaykeylongvirtualtableroute\"> AbstractSimpleShardingDayKeyLongVirtualTableRoute</h3>\n<p>该路由为简单的按天分表路由,支持分表字段是<code>long</code>,分表后的后缀为<code>yyyyMMdd</code>.</p>\n<div><pre><code>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>//注意必须返回固定时间,不然每次启动时间都会变动</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>//启动自动建表</span>\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AutoCreateTableByTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>注意按天分表的路由自动建表的执行顺序为:</p>\n<ol>\n<li>每天的23:59:00分,&quot;0 59 23 * * ?&quot;</li>\n<li>每天的00:00:00分,&quot;0 0 0 * * ?&quot;</li>\n<li>每天的00:01:00分,&quot;0 1 0 * * ?&quot;</li>\n</ol>\n<p>分别会在这三个时间节点进行表的创建和数据表的动态添加,通过时间往后拨<code>IncrementMinutes</code>分钟来创建对应的表tail</p>\n<h3 id=\"abstractsimpleshardingweekkeydatetimevirtualtableroute\"> AbstractSimpleShardingWeekKeyDateTimeVirtualTableRoute</h3>\n<p>该路由为简单的按周分表路由,支持分表字段是<code>DateTime</code>,分表后的后缀为<code>yyyyMMdd_dd</code>.</p>\n<h3 id=\"abstractsimpleshardingweekkeylongvirtualtableroute\"> AbstractSimpleShardingWeekKeyLongVirtualTableRoute</h3>\n<p>该路由为简单的按周分表路由,支持分表字段是<code>long</code>,分表后的后缀为<code>yyyyMMdd_dd</code>.</p>\n<div><pre><code>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>//注意必须返回固定时间,不然每次启动时间都会变动</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>//启动自动建表</span>\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AutoCreateTableByTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>注意按周分表的路由自动建表的执行顺序为:</p>\n<ol>\n<li>每次周末的23:59:00分,&quot;0 59 23 ? * 1&quot;</li>\n<li>每次周一的00:00:00分,&quot;0 0 0 ? * 2&quot;</li>\n<li>每次周一的00:01:00分,&quot;0 1 0 ? * 2&quot;</li>\n</ol>\n<p>分别会在这三个时间节点进行表的创建和数据表的动态添加,通过时间往后拨<code>IncrementMinutes</code>分钟来创建对应的表tail</p>\n<h3 id=\"abstractsimpleshardingmonthkeydatetimevirtualtableroute\"> AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute</h3>\n<p>该路由为简单的按月分表路由,支持分表字段是<code>DateTime</code>,分表后的后缀为<code>yyyyMM</code>.</p>\n<h3 id=\"abstractsimpleshardingmonthkeylongvirtualtableroute\"> AbstractSimpleShardingMonthKeyLongVirtualTableRoute</h3>\n<p>该路由为简单的按月分表路由,支持分表字段是<code>long</code>,分表后的后缀为<code>yyyyMM</code>.</p>\n<div><pre><code>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>//注意必须返回固定时间,不然每次启动时间都会变动</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>//启动自动建表</span>\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AutoCreateTableByTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>注意按月分表的路由自动建表的执行顺序为:</p>\n<ol>\n<li>每月的28、29、30、31日的23:59:00分,&quot;0 59 23 28,29,30,31 * ?&quot;</li>\n<li>每月的1日的00:00:00分,&quot;0 0 0 1 * ?&quot;</li>\n<li>每月的1日的00:01:00分,&quot;0 1 0 1 * ?&quot;</li>\n</ol>\n<p>分别会在这三个时间节点进行表的创建和数据表的动态添加,通过时间往后拨<code>IncrementMinutes</code>分钟来创建对应的表tail</p>\n<h3 id=\"abstractsimpleshardingyearkeydatetimevirtualtableroute\"> AbstractSimpleShardingYearKeyDateTimeVirtualTableRoute</h3>\n<p>该路由为简单的按年分表路由,支持分表字段是<code>DateTime</code>,分表后的后缀为<code>yyyy</code>.</p>\n<h3 id=\"abstractsimpleshardingyearkeylongvirtualtableroute\"> AbstractSimpleShardingYearKeyLongVirtualTableRoute</h3>\n<p>该路由为简单的按年分表路由,支持分表字段是<code>long</code>,分表后的后缀为<code>yyyy</code>.</p>\n<div><pre><code>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>//注意必须返回固定时间,不然每次启动时间都会变动</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>//启动自动建表</span>\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AutoCreateTableByTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>注意按年分表的路由自动建表的执行顺序为:</p>\n<ol>\n<li>每年的31日的23:59:00分,&quot;0 59 23 31 12 ?&quot;</li>\n<li>每年的1日的00:00:00分,&quot;0 0 0 1 1 ?&quot;</li>\n<li>每年的1日的00:01:00分,&quot;0 1 0 1 1 ?&quot;</li>\n</ol>\n<p>分别会在这三个时间节点进行表的创建和数据表的动态添加,通过时间往后拨<code>IncrementMinutes</code>分钟来创建对应的表tail</p>\n<p><strong>注意：所有的定时任务都可以设置为false,并且可以使用自身的定时任务来实现动态的创建表和添加表后缀</strong></p>\n<h2 id=\"时间分表的定时信息\"> 时间分表的定时信息</h2>\n<p>为了保证可以让程序卡点发布还能正确创建对应的表信息和知道现有的表,所以存在三个节点进行创建表。\n但是可能会出现重复创建表的信息，也会出现表没创建的其他原因导致程序执行失败，所以这边对其进行了日志的过滤用户可以再使用默认的时间分表的情况下选择重写<code>ShowErrorLog</code>属性来输出任务执行时候的建表异常信息。</p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-12-15T03:42:43.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "路由"
      ]
    },
    {
      "title": "自定义路由",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-route/customer-route/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-route/customer-route/",
      "content_html": "<h2 id=\"条件在右\"> 条件在右</h2>\n<p>首先我们需要明确一个点就是where后面的条件影响了你对整体路由的一个判断<code>column</code>为分表字段，<code>value</code>为条件</p>\n<ol>\n<li>\n<p><code>column = value</code>，通过计算value可以清楚的知道我们应该查询哪张表</p>\n</li>\n<li>\n<p><code>column &gt; value</code>,在按时间分表的情况通过比较表后缀可以得知表达式<code>&gt;</code>能够过滤的表</p>\n</li>\n<li>\n<p><code>value &lt; column</code>,看着和2一样但是解析的时候确是天差地别,因为我们无法通过<code>&gt;</code>来判断,必须通过<code>&lt;</code>来判断</p>\n</li>\n<li>\n<p><code>value.contains(column)</code>,需要解析成 <code>value[0] = column or value[1] = column or value[2] = column ......</code></p>\n</li>\n</ol>\n<p>框架为了方便用户编写路由已经针对上述所有的情况进行了优化，所有的<code>column</code> 和 <code>value</code>的比较都会将<code>column</code>置于左边，将<code>value</code>置于右边，我们叫做<code>condition on right</code>，并且将所有的<code>contains</code>转换成<code>=</code>，用户可以专心编写路由</p>\n<h2 id=\"abstractshardingoperatorvirtualtableroute\"> AbstractShardingOperatorVirtualTableRoute</h2>\n<p>所有分表的路由的基类,继承这个基类可以很轻松的实现自定义路由</p>\n<h2 id=\"abstractshardingoperatorvirtualdatasourceroute\"> AbstractShardingOperatorVirtualDataSourceRoute</h2>\n<p>所有分库的路由的基类,继承这个基类可以很轻松的实现自定义路由</p>\n<h2 id=\"一致性哈希路由\"> 一致性哈希路由</h2>\n<p>一致性哈希路由的简单实现版本又叫做大数取模分段，在取模的基础上实现了添加单张表后可以将数据迁移做到最小化。\n就是在原先的哈希取模的上面进行再次分段来保证不会再增加一个基数的情况下需要大范围的迁移数据，直接上代码</p>\n<div><pre><code>            <span><span>var</span></span> stringHashCode <span>=</span> ShardingCoreHelper<span>.</span><span>GetStringHashCode</span><span>(</span><span>\"123\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> hashCode <span>=</span> stringHashCode <span>%</span> <span>10000</span><span>;</span>\n            <span>if</span> <span>(</span>hashCode <span>>=</span> <span>0</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>3000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"A\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>3001</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>6000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"B\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>6001</span> <span>&amp;&amp;</span> hashCode <span>&lt;</span> <span>10000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"C\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span>\n                <span>throw</span> <span>new</span> <span>InvalidOperationException</span><span>(</span><span><span>$\"cant calc hash route hash code:[</span><span><span>{</span><span>stringHashCode</span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><p>这应该是一个最最最简单的是个人都能看得懂的路由了，将hashcode进行取模10000，得到0-9999，将其分成[0-3000],[3001-6000],[6001-9999]三段的概率大概是3、3、4相对很平均，那么还是遇到了上面我们所说的一个问题，如果我们现在需要加一个基数呢，首先修改路由</p>\n<div><pre><code>            <span><span>var</span></span> stringHashCode <span>=</span> ShardingCoreHelper<span>.</span><span>GetStringHashCode</span><span>(</span><span>\"123\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> hashCode <span>=</span> stringHashCode <span>%</span> <span>10000</span><span>;</span>\n            <span>if</span> <span>(</span>hashCode <span>>=</span> <span>0</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>3000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"A\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>3001</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>6000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"B\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>6001</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>8000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"D\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>8001</span> <span>&amp;&amp;</span> hashCode <span>&lt;</span> <span>10000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"C\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span>\n                <span>throw</span> <span>new</span> <span>InvalidOperationException</span><span>(</span><span><span>$\"cant calc hash route hash code:[</span><span><span>{</span><span>stringHashCode</span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div><p>我们这边增加了一个基数针对[6001-9999]分段进行了数据切分，并且将[8001-9999]区间内的表后缀没变，实际上我们仅仅只需要修改五分之一的数据那么就可以完美的做到数据迁移，并且均匀分布数据,后续如果需要再次增加一台只需要针对'A'或者'B'进行2分那么就可以逐步增加基数来缓解压力，且数据迁移的数量随着基数的增加响应的需要迁移的数据百分比逐步的减少，最坏的情况是增加一倍的基数需要迁移50%的数据，相比较之前的最好情况迁移50%的数据来说十分划算，而且路由规则简单易写是个人就能写出来。</p>\n<h2 id=\"编写一致性哈希路由\"> 编写一致性哈希路由</h2>\n<p>那么我们如何在sharding-core里面编写这个路由规则呢</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>OrderHashRangeVirtualTableRoute</span><span>:</span><span><span>AbstractShardingOperatorVirtualTableRoute<span>&lt;</span>Order<span>,</span><span>string</span><span>></span></span></span>\n    <span>{</span>\n        <span>//如何将sharding key的value转换成对应的值</span>\n        <span>protected</span> <span>override</span> <span><span>string</span></span> <span>ConvertToShardingKey</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> shardingKey<span>.</span><span>ToString</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>//如何将sharding key的value转换成对应的表后缀</span>\n        <span>public</span> <span>override</span> <span><span>string</span></span> <span>ShardingKeyToTail</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> stringHashCode <span>=</span> ShardingCoreHelper<span>.</span><span>GetStringHashCode</span><span>(</span><span>ConvertToShardingKey</span><span>(</span>shardingKey<span>)</span><span>)</span><span>;</span>\n            <span><span>var</span></span> hashCode <span>=</span> stringHashCode <span>%</span> <span>10000</span><span>;</span>\n            <span>if</span> <span>(</span>hashCode <span>>=</span> <span>0</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>3000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"A\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>3001</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>6000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"B\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>6001</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>10000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"C\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span>\n                <span>throw</span> <span>new</span> <span>InvalidOperationException</span><span>(</span><span><span>$\"cant calc hash route hash code:[</span><span><span>{</span><span>stringHashCode</span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>//返回目前已经有的所有Order表后缀</span>\n        <span>public</span> <span>override</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> <span>GetAllTails</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n            <span>{</span>\n                <span>\"A\"</span><span>,</span> <span>\"B\"</span><span>,</span> <span>\"C\"</span>\n            <span>}</span><span>;</span>\n        <span>}</span>\n\n        <span>//如何过滤后缀(已经实现了condition on right)用户无需关心条件位置和如何解析条件逻辑判断，也不需要用户考虑and 还是or</span>\n        <span>protected</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>string</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n            <span>//因为hash路由仅支持等于所以仅仅只需要写等于的情况</span>\n            <span><span>var</span></span> t <span>=</span> <span>ShardingKeyToTail</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br></div></div><p><strong>具体的原理如果不清楚可以参考博客<a href=\"https://www.cnblogs.com/xuejiaming/p/15383899.html\" target=\"_blank\" rel=\"noopener noreferrer\">如何自定义路由</a></strong></p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "路由"
      ]
    },
    {
      "title": "初始化",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-table/init/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-table/init/",
      "content_html": "<h2 id=\"介绍\"> 介绍</h2>\n<div><p>分表介绍</p>\n<ol>\n<li><code>sharding-core</code>支持自定义分表,流式聚合,多表join</li>\n<li>虽然框架已经将分表封装的用户毫无感知了,但是也是需要使用者有部分分表的概念的了解</li>\n<li>我们吧表A分成A1,A2,A3这三张表,如果你在数据库里还是看到了表A那么就说明程序是不正确的,表A在分表后其实不应该存在了(大部分情况下)</li>\n<li><code>IShardingTableDbContext</code>这个接口在你需要支持分表的情况下需要加，如果您只是分库那么就不需要添加这个接口</li>\n</ol>\n</div>\n<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingTable\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreShardingTable</a></p>\n<h2 id=\"分表使用\"> 分表使用</h2>\n<p>先拟定一个场景目前有用户表<code>SysUser</code>和订单表<code>Order</code>,再添加一个<code>Setting</code>配置表，用户我们按用户id进行取模分表，订单我们按时间月进行分表,配置表我们部分表\n首先创建一个空的aspnetcore web api。</p>\n<h3 id=\"安装shardingcore\"> 安装ShardingCore</h3>\n<div><pre><code><span># 请对应安装您需要的版本</span>\nPM<span>></span> Install-Package ShardingCore\n<span># 请对应数据库版本</span>\nPM<span>></span> Install-Package Microsoft.EntityFrameworkCore.SqlServer\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><h3 id=\"创建对象\"> 创建对象</h3>\n<div><pre><code>    <span>public</span> <span>enum</span> <span>OrderStatusEnum</span>\n    <span>{</span>\n        NoPay<span>=</span><span>1</span><span>,</span>\n        Paying<span>=</span><span>2</span><span>,</span>\n        Payed<span>=</span><span>3</span><span>,</span>\n        PayFail<span>=</span><span>4</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>Order</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Payer <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>long</span></span> Money <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>OrderStatusEnum</span> OrderStatus <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>DateTime</span> CreationTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>SysUser</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> SettingCode <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>Setting</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Code <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br></div></div><h3 id=\"创建dbcontext\"> 创建DbContext</h3>\n<p>这样我们就创建好了三张表，接下来我们创建我们的<code>DbContext</code></p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span><span>IShardingTableDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Payer<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>OrderStatus<span>)</span><span>.</span><span><span>HasConversion</span><span><span>&lt;</span><span>int</span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Name<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>SettingCode<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>SysUser<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Setting<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Code<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Code<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Name<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Setting<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br></div></div><div><p>自定义标题</p>\n<ol>\n<li>构造函数必须是<code>DbContextOptions&lt;MyDbContext&gt;</code>或者<code>DbContextOptions</code></li>\n<li><code>OnModelCreating</code>并不是说分表必须要这样，而是你原先efcore怎么使用就怎么使用，efcore配置对象有两种一种是<code>DbSet</code>+<code>Attribute</code>,另外一种是<code>OnModelCreating</code>+<code>ModelBuilder</code>,你可以选择你原先在用的任何一种</li>\n<li><code>AbstractShardingDbContext</code>这个对象是可以不继承的，但是如果要使用分表分库你必须实现<code>IShardingTableDbContext</code>这个接口,因为这个接口实现起来都是一样的所以默认你只需要继承<code>AbstractShardingDbContext</code>就可以了</li>\n<li><code>IShardingTableDbContext</code>这个接口在你需要支持分表的情况下需要加，如果您只是分库那么就不需要添加这个接口</li>\n</ol>\n</div>\n<h3 id=\"创建虚拟路由\"> 创建虚拟路由</h3>\n<ol>\n<li>订单表按月分表,这边我们把订单从2021年1月份开始到现在具体</li>\n</ol>\n<div><pre><code>\n    <span>//创建时间按月分表</span>\n    <span>public</span> <span>class</span> <span>OrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>//注意一定要配置或者采用接口+标签也是可以的</span>\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>CreationTime<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>//用户Id取模3分表</span>\n    <span>public</span> <span>class</span> <span>SysUserVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>SysUser<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>SysUserVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>SysUser<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br></div></div><h3 id=\"startup配置\"> Startup配置</h3>\n<p><code>ConfigureServices(IServiceCollection services)</code>配置</p>\n<div><pre><code>        <span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>\n        <span>{</span>\n\n            services<span>.</span><span>AddControllers</span><span>(</span><span>)</span><span>;</span>\n            <span>//添加一下代码</span>\n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>(</span>conStr<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>Begin</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    <span>//如果您使用code-first建议选择false</span>\n                    op<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                    <span>//如果您使用code-first建议修改为fsle</span>\n                    op<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"ds0\"</span><span>,</span>\n                    <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingTableDB;Integrated Security=True;\"</span><span>)</span>\n                <span>.</span><span>AddShardingTableRoute</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>End</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div><div><p>重要</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n</div>\n<p>新建一个扩展方法用来初始化ShardingCore和初始化种子数据</p>\n<div><pre><code>    <span>public</span> <span>static</span> <span>class</span> <span>StartupExtension</span>\n    <span>{</span>\n        <span>public</span> <span>static</span> <span><span>void</span></span> <span>UseShardingCore</span><span>(</span><span>this</span> <span>IApplicationBuilder</span> app<span>)</span>\n        <span>{</span>\n            app<span>.</span>ApplicationServices<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>public</span> <span>static</span> <span><span>void</span></span> <span>InitSeed</span><span>(</span><span>this</span> <span>IApplicationBuilder</span> app<span>)</span>\n        <span>{</span>\n            <span>using</span> <span>(</span><span><span>var</span></span> serviceScope <span>=</span> app<span>.</span>ApplicationServices<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                <span><span>var</span></span> myDbContext <span>=</span> serviceScope<span>.</span>ServiceProvider<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>if</span> <span>(</span><span>!</span>myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Setting<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Any</span><span>(</span><span>)</span><span>)</span>\n                <span>{</span>\n                    <span>List<span>&lt;</span>Setting<span>></span></span> settings <span>=</span> <span>new</span> <span>List<span>&lt;</span>Setting<span>></span></span><span>(</span><span>3</span><span>)</span><span>;</span>\n                    settings<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Setting</span><span>(</span><span>)</span>\n                    <span>{</span>\n                        Code <span>=</span> <span>\"Admin\"</span><span>,</span>\n                        Name <span>=</span> <span>\"AdminName\"</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    settings<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Setting</span><span>(</span><span>)</span>\n                    <span>{</span>\n                        Code <span>=</span> <span>\"User\"</span><span>,</span>\n                        Name <span>=</span> <span>\"UserName\"</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    settings<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Setting</span><span>(</span><span>)</span>\n                    <span>{</span>\n                        Code <span>=</span> <span>\"SuperAdmin\"</span><span>,</span>\n                        Name <span>=</span> <span>\"SuperAdminName\"</span>\n                    <span>}</span><span>)</span><span>;</span>\n\n                    <span>List<span>&lt;</span>SysUser<span>></span></span> users <span>=</span> <span>new</span> <span>List<span>&lt;</span>SysUser<span>></span></span><span>(</span><span>10</span><span>)</span><span>;</span>\n                    <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>10</span><span>;</span> i<span>++</span><span>)</span>\n                    <span>{</span>\n                        <span><span>var</span></span> uer<span>=</span><span>new</span> <span>SysUser</span><span>(</span><span>)</span>\n                        <span>{</span>\n                            Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                            Name <span>=</span> <span><span>$\"MyName</span><span><span>{</span><span>i</span><span>}</span></span><span>\"</span></span><span>,</span>\n                            SettingCode <span>=</span> settings<span>[</span>i <span>%</span> <span>3</span><span>]</span><span>.</span>Code\n                        <span>}</span><span>;</span>\n                        users<span>.</span><span>Add</span><span>(</span>uer<span>)</span><span>;</span>\n                    <span>}</span>\n                    <span>List<span>&lt;</span>Order<span>></span></span> orders <span>=</span> <span>new</span> <span>List<span>&lt;</span>Order<span>></span></span><span>(</span><span>300</span><span>)</span><span>;</span>\n                    <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>,</span> <span>3</span><span>,</span> <span>3</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n                    <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>300</span><span>;</span> i<span>++</span><span>)</span>\n                    <span>{</span>\n\n                        <span><span>var</span></span> order <span>=</span> <span>new</span> <span>Order</span><span>(</span><span>)</span>\n                        <span>{</span>\n                            Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                            Payer <span>=</span> <span><span>$\"</span><span><span>{</span><span>i <span>%</span> <span>10</span></span><span>}</span></span><span>\"</span></span><span>,</span>\n                            Money <span>=</span> <span>100</span><span>+</span><span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>Next</span><span>(</span><span>100</span><span>,</span><span>3000</span><span>)</span><span>,</span>\n                            OrderStatus <span>=</span> <span>(</span>OrderStatusEnum<span>)</span><span>(</span>i <span>%</span> <span>4</span> <span>+</span> <span>1</span><span>)</span><span>,</span>\n                            CreationTime <span>=</span> begin<span>.</span><span>AddDays</span><span>(</span>i<span>)</span>\n                        <span>}</span><span>;</span>\n                        orders<span>.</span><span>Add</span><span>(</span>order<span>)</span><span>;</span>\n                    <span>}</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>settings<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>users<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>orders<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br></div></div><p><code>Configure(IApplicationBuilder app, IWebHostEnvironment env)</code>配置</p>\n<div><pre><code>        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>env<span>.</span><span>IsDevelopment</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                app<span>.</span><span>UseDeveloperExceptionPage</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n            <span>//初始化ShardingCore</span>\n            app<span>.</span><span>UseShardingCore</span><span>(</span><span>)</span><span>;</span>\n            app<span>.</span><span>UseRouting</span><span>(</span><span>)</span><span>;</span>\n\n            app<span>.</span><span>UseAuthorization</span><span>(</span><span>)</span><span>;</span>\n\n            app<span>.</span><span>UseEndpoints</span><span>(</span>endpoints <span>=></span>\n            <span>{</span>\n                endpoints<span>.</span><span>MapControllers</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            <span>//初始化种子数据</span>\n            app<span>.</span><span>InitSeed</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><h3 id=\"efcore日志-可选\"> efcore日志(可选)</h3>\n<p>这边为了方便我们观察efcore的执行sql语句我们这边建议对efcore添加日志</p>\n<p><code>Startup</code>添加静态数据</p>\n<div><pre><code>        <span>public</span> <span>static</span> <span>readonly</span> <span>ILoggerFactory</span> efLogger <span>=</span> LoggerFactory<span>.</span><span>Create</span><span>(</span>builder <span>=></span>\n        <span>{</span>\n            builder<span>.</span><span>AddFilter</span><span>(</span><span>(</span>category<span>,</span> level<span>)</span> <span>=></span> category <span>==</span> DbLoggerCategory<span>.</span>Database<span>.</span>Command<span>.</span>Name <span>&amp;&amp;</span> level <span>==</span> LogLevel<span>.</span>Information<span>)</span><span>.</span><span>AddConsole</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><p>在所有<code>builder.UseSqlServer(conStr);</code></p>\n<p>都改成<code>builder.UseSqlServer(conStr).UseLoggerFactory(efLogger);</code></p>\n<p>启动后我们将可以看到数据库和表会被自动创建，并且会将种子数据进行插入到内部供我们可以查询测试</p>\n<img src=\"/sharding-core-doc/sharding-table.png\">",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2022-01-07T14:00:26.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "删除",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-table/delete/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-table/delete/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingTable\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreShardingTable</a></p>\n<h2 id=\"删除数据\"> 删除数据</h2>\n<p>增删改查除了查询稍微在分表+排序的情况下需要注意其实其他操作和efcore基本上一致</p>\n<p>删除也是</p>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Delete</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"9\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            _myDbContext<span>.</span><span>Remove</span><span>(</span>sysUser<span>)</span><span>;</span>\n            <span><span>var</span></span> i <span>=</span> <span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><p>控制台我们可以看到对应的执行sql</p>\n<div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>12ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      DELETE FROM <span>[</span>SysUser<span>]</span>\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p0<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div>",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "修改",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-table/update/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-table/update/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingTable\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreShardingTable</a></p>\n<h2 id=\"自动追踪修改\"> 自动追踪修改</h2>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Update</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            sysUser<span>.</span>Name <span>=</span> <span>\"new name\"</span><span>;</span>\n            <span><span>var</span></span> i<span>=</span><span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>13ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p1<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      UPDATE <span>[</span>SysUser_01<span>]</span> SET <span>[</span>Name<span>]</span> <span>=</span> @p0\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p1<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"非自动追踪修改\"> 非自动追踪修改</h2>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Update1</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsNoTracking</span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            sysUser<span>.</span>Name <span>=</span> <span>\"new name\"</span><span>;</span>\n            _myDbContext<span>.</span><span>Update</span><span>(</span>sysUser<span>)</span><span>;</span>\n            <span><span>var</span></span> i <span>=</span> <span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>12ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p3<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p1<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p2<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      UPDATE <span>[</span>SysUser_01<span>]</span> SET <span>[</span>Area<span>]</span> <span>=</span> @p0, <span>[</span>Name<span>]</span> <span>=</span> @p1, <span>[</span>SettingCode<span>]</span> <span>=</span> @p2\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p3<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><div><p>结论</p>\n<p>追踪情况下sharding-core依然可以对结果进行修改，修改的字段是被修改过后的字段</p>\n<p>非追踪情况下sharding-croe也支持查询修改，但是修改的字段是全字段</p>\n</div>\n",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "手动路由",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-route/manual-route/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-route/manual-route/",
      "content_html": "<h2 id=\"背景\"> 背景</h2>\n<p>分表字段不一定在where条件里，但是需要进行自定表的查询,典型场景： 租户,很多时候租户Id分表,会存在于请求头或者请求体中,来确保后续的所有查询都需要走对应的分表，再比如多语言,可能我们会对语言进行分表,但是只会在请求时指定语言而不会将语言加入查询条件,甚至语言这个字段都不存在数据库中。</p>\n<h2 id=\"如何实现\"> 如何实现</h2>\n<ol>\n<li>对应后缀表启用<code>提示路由</code></li>\n</ol>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>SysUserModVirtualTableRoute</span> <span>:</span> <span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>SysUserMod<span>></span></span></span>\n    <span>{</span>\n        <span>/// &lt;summary></span>\n        <span>/// 开启提示路由</span>\n        <span>/// &lt;/summary></span>\n        <span>protected</span> <span>override</span> <span><span>bool</span></span> EnableHintRoute <span>=></span> <span>true</span><span>;</span>\n        <span>/// &lt;summary></span>\n        <span>/// 开启断言路由 如果不需要断言那么可以选择不开启提示路由[EnableHintRoute]必须开启</span>\n        <span>/// &lt;/summary></span>\n        <span>protected</span> <span>override</span> <span><span>bool</span></span> EnableAssertRoute <span>=></span> <span>true</span><span>;</span>\n\n        <span>public</span> <span>SysUserModVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n        <span>{</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><ol>\n<li>依赖注入<code>IShardingRouteManager</code>，并且开启<code>CreateScope</code>,<code>TryCreateOrAddMustTail&lt;SysUserMod&gt;(&quot;00&quot;,&quot;01&quot;)</code></li>\n</ol>\n<div><pre><code>\n        <span>private</span> <span>readonly</span> <span>DefaultShardingDbContext</span> _defaultTableDbContext<span>;</span>\n        <span>private</span> <span>readonly</span> <span>IShardingRouteManager</span> _shardingRouteManager<span>;</span>\n\n        <span>public</span> <span>ValuesController</span><span>(</span><span>DefaultShardingDbContext</span> defaultTableDbContext<span>,</span> <span>IShardingRouteManager</span> shardingRouteManager<span>)</span>\n        <span>{</span>\n            _defaultTableDbContext <span>=</span> defaultTableDbContext<span>;</span>\n            _shardingRouteManager <span>=</span> shardingRouteManager<span>;</span>\n        <span>}</span>\n\n\n            <span>using</span> <span>(</span>_shardingRouteManager<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                _shardingRouteManager<span>.</span>Current<span>.</span><span><span>TryCreateOrAddMustTail</span><span><span>&lt;</span>SysUserMod<span>></span></span></span><span>(</span><span>\"00\"</span><span>,</span><span>\"01\"</span><span>)</span><span>;</span>\n                <span>//_shardingRouteManager.Current.TryCreateOrAddHintTail&lt;SysUserMod>(\"00\", \"01\");</span>\n                <span>//_shardingRouteManager.Current.TryCreateOrAddAssertTail&lt;SysUserMod>();</span>\n\n                <span><span>var</span></span> mod00s <span>=</span> <span>await</span> _defaultTableDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUserMod<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Skip</span><span>(</span><span>10</span><span>)</span><span>.</span><span>Take</span><span>(</span><span>11</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><p>所有在<code>CreateScope</code>内部的<code>SysUserMod</code>的查询都将只会走指定的表也就是[&quot;00&quot;,&quot;01&quot;],可以针对<code>Middleware</code>,<code>ActionFilter</code>处进行使用来达到租户的模式</p>\n<h2 id=\"路由过滤器\"> 路由过滤器</h2>\n<p>假设我们对单次查询返回的路由不满意需要配置,比如如果单次查询大于10个结果那么我们只需要返回前5个,这个操作该如何实现呢，</p>\n<ol>\n<li>路由后置过滤器，通过路由的重写</li>\n</ol>\n<div><pre><code>\n        <span>protected</span> <span>override</span> <span>List<span>&lt;</span>IPhysicTable<span>></span></span> <span>AfterPhysicTableFilter</span><span>(</span><span>List<span>&lt;</span>IPhysicTable<span>></span></span> allPhysicTables<span>,</span> <span>List<span>&lt;</span>IPhysicTable<span>></span></span> filterPhysicTables<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>filterPhysicTables<span>.</span>Count <span>>=</span> <span>10</span><span>)</span>\n            <span>{</span>\n                <span>//throw new Exception ....</span>\n                <span>return</span> filterPhysicTables<span>.</span><span>Take</span><span>(</span><span>5</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n\n            <span>return</span> filterPhysicTables<span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>通过这个后置过滤我们可以轻轻松松的完成对查询的控制,但是这个是全局的等于说写了那么所有的该对象的路由都要进行这种操作,所以下面就有了第二种方式<code>断言路由</code>\n2. 断言路由,所谓的断言路由其实就是提示路由下的一种所以如果我们需要使用断言路由就要进行对<code>提示路由</code>的开启</p>\n<div><pre><code>\n        <span>/// &lt;summary></span>\n        <span>/// 开启提示路由</span>\n        <span>/// &lt;/summary></span>\n        <span>protected</span> <span>override</span> <span><span>bool</span></span> EnableHintRoute <span>=></span> <span>true</span><span>;</span>\n        <span>/// &lt;summary></span>\n        <span>/// 开启断言路由 如果不需要断言那么可以选择不开启提示路由[EnableHintRoute]必须开启</span>\n        <span>/// &lt;/summary></span>\n        <span>protected</span> <span>override</span> <span><span>bool</span></span> EnableAssertRoute <span>=></span> <span>true</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><p>如何使用断言路由，首先我们需要创建一个对应的路由断言</p>\n<div><pre><code>\n        <span>public</span> <span>class</span> <span>TestRouteAssert</span><span>:</span><span><span>ITableRouteAssert<span>&lt;</span>SysUserMod<span>></span></span></span>\n        <span>{</span>\n            <span>public</span> <span><span>void</span></span> <span>Assert</span><span>(</span><span>List<span>&lt;</span>IPhysicTable<span>></span></span> allPhysicTables<span>,</span> <span>List<span>&lt;</span>IPhysicTable<span>></span></span> resultPhysicTables<span>)</span>\n            <span>{</span>\n\n                <span>if</span> <span>(</span>resultPhysicTables<span>.</span>Count <span>>=</span> <span>10</span><span>)</span>\n                <span>{</span>\n                    <span>//throw new Exception ....</span>\n                    resultPhysicTables<span>=</span>resultPhysicTables<span>.</span><span>Take</span><span>(</span><span>5</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br></div></div><div><pre><code>\n            <span>using</span> <span>(</span>_shardingRouteManager<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                _shardingRouteManager<span>.</span>Current<span>.</span><span><span>TryCreateOrAddAssertTail</span><span><span>&lt;</span>SysUserMod<span>></span></span></span><span>(</span><span>new</span> <span>TestRouteAssert</span><span>(</span><span>)</span><span>)</span><span>;</span>\n\n                <span><span>var</span></span> mod00s <span>=</span> <span>await</span> _defaultTableDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUserMod<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Skip</span><span>(</span><span>10</span><span>)</span><span>.</span><span>Take</span><span>(</span><span>11</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><p>这样我们就做到了和全局路由过滤器一样的效果但是是可以自定义的。</p>\n<h2 id=\"musttail\"> MustTail</h2>\n<p>强制路由,使用强制路由<code>_shardingRouteManager.Current.TryCreateOrAddMustTail&lt;SysUserMod&gt;(&quot;00&quot;,&quot;01&quot;);</code>将无视断言路由和路由过滤器。</p>\n<h2 id=\"hinttail\"> HintTail</h2>\n<p>提示路由,使用方式和强制路由一样<code>_shardingRouteManager.Current.TryCreateOrAddHintTail&lt;SysUserMod&gt;(&quot;00&quot;, &quot;01&quot;);</code>区别就是强制走提示路由后还需要在进行断言路由的判断</p>\n<h2 id=\"asserttail\"> AssertTail</h2>\n<p>断言路由用来进行断言判断和筛选查询过滤结果</p>\n<div><p>路由的顺序</p>\n<ol>\n<li>开启提示路由?开启判断有强制直接走强制，没强制就判断是否有提示有提示就走提示，走完提示在判断是否开启断言，开启了就再走断言，如果都没有就走普通</li>\n<li>开启了提示路由和断言路由，并且没有强制路由和提示路由，仅仅只有断言路由那么就是先走自动过滤筛选表，然后走全局过滤，最后走断言路由</li>\n</ol>\n</div>\n<p><strong>注意具体的流程可以参考源码<a href=\"https://github.com/xuejmnet/sharding-core/blob/main/src/ShardingCore/Core/VirtualRoutes/TableRoutes/Abstractions/AbstractShardingFilterVirtualTableRoute.cs\" target=\"_blank\" rel=\"noopener noreferrer\">AbstractShardingFilterVirtualTableRoute</a> 或者<a href=\"https://github.com/xuejmnet/sharding-core/blob/main/src/ShardingCore/Core/VirtualRoutes/DataSourceRoutes/Abstractions/AbstractShardingFilterVirtualDataSourceRoute.cs\" target=\"_blank\" rel=\"noopener noreferrer\">AbstractShardingFilterVirtualDataSourceRoute</a></strong></p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "路由"
      ]
    },
    {
      "title": "幻灯片页",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/slides/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/slides/",
      "content_html": "\n<i>Not supported content</i>",
      "image": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/logo.svg",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2021-11-03T00:33:21.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": []
    },
    {
      "title": "单元测试覆盖率",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/unit-test-coverage/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/unit-test-coverage/",
      "content_html": "<img src=\"/sharding-core-doc/unit-test-coverage.png.png\">",
      "date_published": "2021-11-30T01:40:55.000Z",
      "date_modified": "2021-11-30T01:40:55.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "单元测试覆盖率"
      ]
    },
    {
      "title": "自动追踪",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/auto-track/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/auto-track/",
      "content_html": "<p>自动追踪</p>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-03T00:53:03.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "密码加密的文章",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/encrypt/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/encrypt/",
      "content_html": "<h1 id=\"密码加密的文章\"> 密码加密的文章</h1>\n<p>实际的文章内容。</p>\n<p>段落 1 文字段落 1 文字段落 1 文字段落 1 文字段落 1 文字段落 1 文字段落 1 文字段落 1 文字段落 1 文字段落 1 文字段落 1 文字段落 1 文字。</p>\n<p>段落 2 文字段落 2 文字段落 2 文字段落 2 文字段落 2 文字段落 2 文字段落 2 文字段落 2 文字段落 2 文字段落 2 文字段落 2 文字段落 2 文字段落 2 文字段落 2 文字。</p>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-03T00:53:03.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-table/query/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/en/sharding-table/query/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingTable\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreShardingTable</a></p>\n<h2 id=\"单对象简单查询\"> 单对象简单查询</h2>\n<p>对<code>SysUser</code>和<code>Order</code>进行查询</p>\n<div><pre><code><span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Query</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span><span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>Id<span>==</span><span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> dateTime <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span><span>3</span><span>,</span><span>5</span><span>)</span><span>;</span>\n            <span><span>var</span></span> order <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>>=</span> dateTime<span>)</span><span>.</span><span>OrderBy</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> orderIdOne <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"3\"</span><span>)</span><span>;</span>\n\n\n            <span><span>var</span></span> sysUsers <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id<span>==</span><span>\"6\"</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n\n            <span>return</span> <span>Ok</span><span>(</span><span>new</span> <span><span>object</span><span>[</span><span>]</span></span>\n            <span>{</span>\n                sysUser<span>,</span>\n                order<span>,</span>\n                orderIdOne<span>,</span>\n                sysUsers\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"63\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"money\"</span><span>:</span><span>2407</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderStatus\"</span><span>:</span><span>4</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-05T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"money\"</span><span>:</span><span>974</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderStatus\"</span><span>:</span><span>4</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-01-04T03:03:03\"</span><span>}</span><span>,</span><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>}</span><span>]</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>6ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202111<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>25ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>21ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>13ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202106<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>9ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202107<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>11ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202109<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>23ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202108<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>5ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>47ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202110<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202110<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202109<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202108<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202107<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202111<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202102<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202101<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202106<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br><span>111</span><br><span>112</span><br><span>113</span><br><span>114</span><br><span>115</span><br><span>116</span><br><span>117</span><br><span>118</span><br><span>119</span><br><span>120</span><br><span>121</span><br><span>122</span><br><span>123</span><br><span>124</span><br></div></div><h2 id=\"join\"> join</h2>\n<h3 id=\"分表join不分表\"> 分表join不分表</h3>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>QueryJoin1</span><span>(</span><span>)</span>\n        <span>{</span>\n           <span><span>var</span></span> sql<span>=</span> <span>from</span> user <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id <span>==</span> <span>\"6\"</span><span>)</span>\n                <span>join</span> setting <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Setting<span>></span></span></span><span>(</span><span>)</span>\n                    <span>on</span> user<span>.</span>SettingCode equals setting<span>.</span>Code\n                <span>select</span> <span>new</span>\n                <span>{</span>\n                    user<span>.</span>Id<span>,</span>\n                    user<span>.</span>Name<span>,</span>\n                    user<span>.</span>Area<span>,</span>\n                    user<span>.</span>SettingCode<span>,</span>\n                    SettingName<span>=</span>setting<span>.</span>Name<span>,</span>\n                <span>}</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>\n              <span>await</span> sql<span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"settingName\"</span><span>:</span><span>\"UserName\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"settingName\"</span><span>:</span><span>\"AdminName\"</span><span>}</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>, <span>[</span>s0<span>]</span>.<span>[</span>Name<span>]</span> AS <span>[</span>SettingName<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>[</span>Setting<span>]</span> AS <span>[</span>s0<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span> <span>=</span> <span>[</span>s0<span>]</span>.<span>[</span>Code<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>, <span>[</span>s0<span>]</span>.<span>[</span>Name<span>]</span> AS <span>[</span>SettingName<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>[</span>Setting<span>]</span> AS <span>[</span>s0<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span> <span>=</span> <span>[</span>s0<span>]</span>.<span>[</span>Code<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></div></div><h3 id=\"分表join分表\"> 分表join分表</h3>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>QueryJoin2</span><span>(</span><span>)</span>\n        <span>{</span>\n           <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>3</span><span>,</span> <span>2</span><span>)</span><span>;</span>\n           <span><span>var</span></span> end <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>4</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n           <span><span>var</span></span> sql1 <span>=</span> <span>from</span> user <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id <span>==</span> <span>\"6\"</span><span>)</span>\n               <span>join</span> order <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>>=</span>begin<span>&amp;&amp;</span>o<span>.</span>CreationTime<span>&lt;=</span>end<span>)</span>\n                   <span>on</span> user<span>.</span>Id equals order<span>.</span>Payer\n               <span>select</span> <span>new</span>\n               <span>{</span>\n                   user<span>.</span>Id<span>,</span>\n                   user<span>.</span>Name<span>,</span>\n                   user<span>.</span>Area<span>,</span>\n                   user<span>.</span>SettingCode<span>,</span>\n                   OrderId <span>=</span> order<span>.</span>Id<span>,</span>\n                   order<span>.</span>Payer<span>,</span>\n                   order<span>.</span>CreationTime\n               <span>}</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span><span>await</span> sql1<span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"61\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-03T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"71\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-13T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"81\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-23T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"91\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-04-02T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"66\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-08T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"76\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-18T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"86\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-28T03:03:03\"</span><span>}</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>21ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>54ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>12ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>20ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br></div></div><div><p>注意</p>\n<ol>\n<li>如果本次查询涉及<code>跨表</code>或者<code>跨库</code>并且查询附带<code>order by</code>那么order by的字段必须包含在返回结果里面.(聚合函数除外：count,any,sum......)</li>\n<li>应该尽可能避免分表join分表,如果实在需要join那么也应该尽可能指定某一张表或者分表的数目尽可能小。(因为分表后如果a1,a2 join b1,b2那么就会有4个结果相互组合,路由结果越多性能越低，会生成笛卡尔积)</li>\n</ol>\n</div>\n<h3 id=\"查询接口支持\"> 查询接口支持</h3>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>Method</th>\n<th><a href=\"https://github.com/xuejmnet/sharding-core/blob/main/test/ShardingCore.Test50/ShardingTest.cs\" target=\"_blank\" rel=\"noopener noreferrer\">Unit Test</a></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>第一条</td>\n<td>FindAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>获取集合</td>\n<td>ToListAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>第一条</td>\n<td>FirstOrDefaultAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>最大</td>\n<td>MaxAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>最小</td>\n<td>MinAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>是否存在</td>\n<td>AnyAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>数目</td>\n<td>CountAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>数目</td>\n<td>LongCountAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>求和</td>\n<td>SumAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>平均</td>\n<td>AverageAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>包含</td>\n<td>ContainsAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>分组</td>\n<td>GroupByAsync</td>\n<td>yes</td>\n</tr>\n</tbody>\n</table>\n",
      "date_published": "2021-11-15T09:37:06.000Z",
      "date_modified": "2021-11-15T09:37:06.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "组件禁用",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/disable/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/disable/",
      "summary": "<p>你可以通过设置页面的 Frontmatter，在页面禁用一些功能。</p>\n",
      "content_html": "<p>你可以通过设置页面的 Frontmatter，在页面禁用一些功能。</p>\n\n<p>本页面应当禁用了:</p>\n<ul>\n<li>导航栏</li>\n<li>侧边栏</li>\n<li>路径导航</li>\n<li>页面信息</li>\n<li>贡献者</li>\n<li>编辑此页链接</li>\n<li>更新时间</li>\n<li>上一篇/下一篇 链接</li>\n<li>评论</li>\n<li>页脚</li>\n<li>返回顶部按钮</li>\n</ul>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-03T00:53:03.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "Markdown 增强",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/markdown/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/markdown/",
      "summary": "<p><code>vuepress-theme-hope</code> 通过内置 <a href=\"https://vuepress-theme-hope.github.io/md-enhance\" target=\"_blank\" rel=\"noopener noreferrer\">md-enhance</a>，在 Markdown 中启用了更多的语法与新功能。</p>\n",
      "content_html": "<p><code>vuepress-theme-hope</code> 通过内置 <a href=\"https://vuepress-theme-hope.github.io/md-enhance\" target=\"_blank\" rel=\"noopener noreferrer\">md-enhance</a>，在 Markdown 中启用了更多的语法与新功能。</p>\n\n<h2 id=\"一键启用\"> 一键启用</h2>\n<p>你可以设置 <code>themeconfig.mdEnhance.enableAll</code> 启用 <a href=\"https://vuepress-theme-hope.github.io/md-enhance\" target=\"_blank\" rel=\"noopener noreferrer\">md-enhance</a> 插件的所有功能。</p>\n<div><div><br><br><div>&nbsp;</div><div>&nbsp;</div><div>&nbsp;</div><br><br><br></div><pre><code>module<span>.</span>exports <span>=</span> <span>{</span>\n  themeConfig<span>:</span> <span>{</span>\n    mdEnhance<span>:</span> <span>{</span>\n      enableAll<span>:</span> <span>true</span><span>,</span>\n    <span>}</span><span>,</span>\n  <span>}</span><span>,</span>\n<span>}</span><span>;</span>\n</code></pre><div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h2 id=\"新增的更多语法\"> 新增的更多语法</h2>\n<h3 id=\"上下角标\"> 上下角标</h3>\n<p>19<sup>th</sup> H<sub>2</sub>O</p>\n<details><summary>代码</summary>\n<div><pre><code>19^th^ H<span><span>~</span><span>2</span><span>~</span></span>O\n</code></pre>\n<div><span>1</span><br></div></div></details>\n<ul>\n<li><a href=\"https://vuepress-theme-hope.github.io/zh/guide/markdown/sup-sub/\" target=\"_blank\" rel=\"noopener noreferrer\">点击查看</a></li>\n</ul>\n<h3 id=\"自定义对齐\"> 自定义对齐</h3>\n<div>\n<p>我是居中的</p>\n</div>\n<div>\n<p>我在右对齐</p>\n</div>\n<details><summary>代码</summary>\n<div><pre><code>::: center\n\n我是居中的\n\n:::\n\n::: right\n\n我在右对齐\n\n:::\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div></details>\n<ul>\n<li><a href=\"https://vuepress-theme-hope.github.io/zh/guide/markdown/align/\" target=\"_blank\" rel=\"noopener noreferrer\">点击查看</a></li>\n</ul>\n<h3 id=\"脚注\"> 脚注</h3>\n<p>此文字有脚注<sup></sup>.</p>\n<details><summary>代码</summary>\n<div><pre><code>此文字有脚注[^first].\n\n<span><span>[</span><span>^first</span><span>]</span><span>:</span> 这是脚注内容</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div></details>\n<ul>\n<li><a href=\"https://vuepress-theme-hope.github.io/zh/guide/markdown/footnote/\" target=\"_blank\" rel=\"noopener noreferrer\">点击查看</a></li>\n</ul>\n<h3 id=\"标记\"> 标记</h3>\n<p>你可以标记 <mark>重要的内容</mark> 。</p>\n<details><summary>代码</summary>\n<div><pre><code>你可以标记 ==重要的内容== 。\n</code></pre>\n<div><span>1</span><br></div></div></details>\n<ul>\n<li><a href=\"https://vuepress-theme-hope.github.io/zh/guide/markdown/mark/\" target=\"_blank\" rel=\"noopener noreferrer\">点击查看</a></li>\n</ul>\n<h3 id=\"任务列表\"> 任务列表</h3>\n<ul>\n<li><input type=\"checkbox\" checked=\"checked\" disabled=\"disabled\" id=\"task-item-0\"><label for=\"task-item-0\"> 计划 1</label></li>\n<li><input type=\"checkbox\"  disabled=\"disabled\" id=\"task-item-1\"><label for=\"task-item-1\"> 计划 2</label></li>\n</ul>\n<details><summary>Code</summary>\n<div><pre><code><span>-</span> [x] 计划 1\n<span>-</span> [ ] 计划 2\n</code></pre>\n<div><span>1</span><br><span>2</span><br></div></div></details>\n<ul>\n<li><a href=\"https://vuepress-theme-hope.github.io/guide/markdown/tasklist/\" target=\"_blank\" rel=\"noopener noreferrer\">点击查看</a></li>\n</ul>\n<h3 id=\"流程图\"> 流程图</h3>\n<i>Not supported content</i><details><summary>代码</summary>\n<div><pre><code><span><span>```</span><span>flow</span>\n<span>cond=>condition: Process?\nprocess=>operation: Process\ne=>end: End\n\ncond(yes)->process->e\ncond(no)->e</span>\n<span>```</span></span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div></details>\n<ul>\n<li><a href=\"https://vuepress-theme-hope.github.io/zh/guide/markdown/flowchart/\" target=\"_blank\" rel=\"noopener noreferrer\">点击查看</a></li>\n</ul>\n<h2 id=\"mermaid\"> Mermaid</h2>\n<Mermaid id=\"mermaid-64a57060\" data-code=\"graph%20TD%3B%0A%20%20%20%20A--%3EB%3B%0A%20%20%20%20A--%3EC%3B%0A%20%20%20%20B--%3ED%3B%0A%20%20%20%20C--%3ED%3B%0A\"></Mermaid><details><summary>代码</summary>\n<div><pre><code><span><span>```</span><span>mermaid</span>\n<span>graph TD;\n    A-->B;\n    A-->C;\n    B-->D;\n    C-->D;</span>\n<span>```</span></span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div></details>\n<ul>\n<li><a href=\"https://vuepress-theme-hope.github.io/zh/guide/markdown/mermaid/\" target=\"_blank\" rel=\"noopener noreferrer\">点击查看</a></li>\n</ul>\n<h3 id=\"tex-语法\"> Tex 语法</h3>\n<p class='katex-block'><span><span><span><i>Not supported content</i></span><span aria-hidden=\"true\"><span><span style=\"height:2.4em;vertical-align:-0.95em;\"></span><span><span></span><span><span><span><span style=\"height:1.3714em;\"><span style=\"top:-2.314em;\"><span style=\"height:3em;\"></span><span><span style=\"margin-right:0.05556em;\">∂</span><span><span style=\"margin-right:0.03588em;\">ω</span><span><span><span><span style=\"height:0.5904em;\"><span style=\"top:-2.989em;margin-right:0.05em;\"><span style=\"height:2.7em;\"></span><span><span style=\"margin-right:0.02778em;\">r</span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span style=\"height:3em;\"></span><span style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span style=\"height:3em;\"></span><span><span><span style=\"margin-right:0.05556em;\">∂</span><span><span><span><span style=\"height:0.6644em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span style=\"height:2.7em;\"></span><span><span style=\"margin-right:0.02778em;\">r</span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span style=\"height:0.686em;\"><span></span></span></span></span></span><span></span></span><span style=\"margin-right:0.1667em;\"></span><span><span style=\"top:0em;\"><span>(</span></span><span><span></span><span><span><span><span style=\"height:1.3414em;\"><span style=\"top:-2.314em;\"><span style=\"height:3em;\"></span><span><span style=\"margin-right:0.03588em;\">ω</span></span></span><span style=\"top:-3.23em;\"><span style=\"height:3em;\"></span><span style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span style=\"height:3em;\"></span><span><span><span style=\"margin-right:0.03588em;\">y</span><span><span><span><span style=\"height:0.6644em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span style=\"height:2.7em;\"></span><span><span><span style=\"margin-right:0.03588em;\">ω</span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span style=\"height:0.686em;\"><span></span></span></span></span></span><span></span></span><span style=\"top:0em;\"><span>)</span></span></span><span style=\"margin-right:0.2778em;\"></span><span>=</span><span style=\"margin-right:0.2778em;\"></span></span><span><span style=\"height:3.0277em;vertical-align:-1.2777em;\"></span><span><span style=\"top:0em;\"><span>(</span></span><span><span></span><span><span><span><span style=\"height:1.3414em;\"><span style=\"top:-2.314em;\"><span style=\"height:3em;\"></span><span><span style=\"margin-right:0.03588em;\">ω</span></span></span><span style=\"top:-3.23em;\"><span style=\"height:3em;\"></span><span style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span style=\"height:3em;\"></span><span><span><span style=\"margin-right:0.03588em;\">y</span><span><span><span><span style=\"height:0.6644em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span style=\"height:2.7em;\"></span><span><span><span style=\"margin-right:0.03588em;\">ω</span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span style=\"height:0.686em;\"><span></span></span></span></span></span><span></span></span><span style=\"top:0em;\"><span>)</span></span></span><span style=\"margin-right:0.1667em;\"></span><span><span style=\"top:0em;\"><span>{</span></span><span>(</span><span>lo<span style=\"margin-right:0.01389em;\">g</span></span><span style=\"margin-right:0.1667em;\"></span><span style=\"margin-right:0.03588em;\">y</span><span><span>)</span><span><span><span><span style=\"height:0.7144em;\"><span style=\"top:-3.113em;margin-right:0.05em;\"><span style=\"height:2.7em;\"></span><span><span style=\"margin-right:0.02778em;\">r</span></span></span></span></span></span></span></span><span style=\"margin-right:0.2222em;\"></span><span>+</span><span style=\"margin-right:0.2222em;\"></span><span><span><span><span style=\"height:1.6514em;\"><span style=\"top:-1.8723em;margin-left:0em;\"><span style=\"height:3.05em;\"></span><span><span><span>i</span><span>=</span><span>1</span></span></span></span><span style=\"top:-3.05em;\"><span style=\"height:3.05em;\"></span><span><span>∑</span></span></span><span style=\"top:-4.3em;margin-left:0em;\"><span style=\"height:3.05em;\"></span><span><span style=\"margin-right:0.02778em;\">r</span></span></span></span><span>​</span></span><span><span style=\"height:1.2777em;\"><span></span></span></span></span></span><span style=\"margin-right:0.1667em;\"></span><span><span></span><span><span><span><span style=\"height:1.5017em;\"><span style=\"top:-2.314em;\"><span style=\"height:3em;\"></span><span><span><span style=\"margin-right:0.03588em;\">ω</span><span><span><span><span style=\"height:0.7507em;\"><span style=\"top:-2.989em;margin-right:0.05em;\"><span style=\"height:2.7em;\"></span><span><span>i</span></span></span></span></span></span></span></span></span></span><span style=\"top:-3.23em;\"><span style=\"height:3em;\"></span><span style=\"border-bottom-width:0.04em;\"></span></span><span style=\"top:-3.677em;\"><span style=\"height:3em;\"></span><span><span>(</span><span>−</span><span>1</span><span><span>)</span><span><span><span><span style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span style=\"height:2.7em;\"></span><span><span>i</span></span></span></span></span></span></span></span><span style=\"margin-right:0.02778em;\">r</span><span style=\"margin-right:0.1667em;\"></span><span>⋯</span><span style=\"margin-right:0.1667em;\"></span><span>(</span><span style=\"margin-right:0.02778em;\">r</span><span style=\"margin-right:0.2222em;\"></span><span>−</span><span style=\"margin-right:0.2222em;\"></span><span>i</span><span style=\"margin-right:0.2222em;\"></span><span>+</span><span style=\"margin-right:0.2222em;\"></span><span>1</span><span>)</span><span>(</span><span>lo<span style=\"margin-right:0.01389em;\">g</span></span><span style=\"margin-right:0.1667em;\"></span><span style=\"margin-right:0.03588em;\">y</span><span><span>)</span><span><span><span><span style=\"height:0.8247em;\"><span style=\"top:-3.063em;margin-right:0.05em;\"><span style=\"height:2.7em;\"></span><span><span><span style=\"margin-right:0.02778em;\">r</span><span>−</span><span>i</span></span></span></span></span></span></span></span></span></span></span></span><span>​</span></span><span><span style=\"height:0.686em;\"><span></span></span></span></span></span><span></span></span><span style=\"top:0em;\"><span>}</span></span></span></span></span></span></span></p>\n<details><summary>代码</summary>\n<div><pre><code>$$\n\\frac {\\partial^r} {\\partial \\omega^r} \\left(\\frac {y^{\\omega}} {\\omega}\\right)\n= \\left(\\frac {y^{\\omega}} {\\omega}\\right) \\left\\{(\\log y)^r + \\sum_{i=1}^r \\frac {(-1)^i r \\cdots (r-i+1) (\\log y)^{r-i}} {\\omega^i} \\right\\}\n$$\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div></details>\n<ul>\n<li><a href=\"https://vuepress-theme-hope.github.io/zh/guide/markdown/tex/\" target=\"_blank\" rel=\"noopener noreferrer\">点击查看</a></li>\n</ul>\n<h3 id=\"代码案例\"> 代码案例</h3>\n\n          <div\n            id=\"code-demo-5ac6bc9f\"\n           \n  \n data-title=\"%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%20Demo\"\n\n            data-code=\"%7B%22html%22%3A%22%3Ch1%3EMr.Hope%3C%2Fh1%3E%5Cn%3Cp%3E%3Cspan%20id%3D%5C%22very%5C%22%3E%E5%8D%81%E5%88%86%3C%2Fspan%3E%20%E5%B8%85%3C%2Fp%3E%5Cn%22%2C%22js%22%3A%22document.querySelector(%5C%22%23very%5C%22).addEventListener(%5C%22click%5C%22%2C%20()%20%3D%3E%20%7B%5Cn%20%20alert(%5C%22%E5%8D%81%E5%88%86%E5%B8%85%5C%22)%3B%5Cn%7D)%3B%5Cn%22%2C%22css%22%3A%22span%20%7B%5Cn%20%20color%3A%20red%3B%5Cn%7D%5Cn%22%7D\"\n          >\n              \n              <div>\n                <div>\n<div><pre><code><span><span><span>&lt;</span>h1</span><span>></span></span>Mr.Hope<span><span><span>&lt;/</span>h1</span><span>></span></span>\n<span><span><span>&lt;</span>p</span><span>></span></span><span><span><span>&lt;</span>span</span> <span>id</span><span><span>=</span><span>\"</span>very<span>\"</span></span><span>></span></span>十分<span><span><span>&lt;/</span>span</span><span>></span></span> 帅<span><span><span>&lt;/</span>p</span><span>></span></span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br></div></div><div><pre><code>document<span>.</span><span>querySelector</span><span>(</span><span>\"#very\"</span><span>)</span><span>.</span><span>addEventListener</span><span>(</span><span>\"click\"</span><span>,</span> <span>(</span><span>)</span> <span>=></span> <span>{</span>\n  <span>alert</span><span>(</span><span>\"十分帅\"</span><span>)</span><span>;</span>\n<span>}</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div><div><pre><code><span>span</span> <span>{</span>\n  <span>color</span><span>:</span> red<span>;</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div>\n            </div>\n          </div>\n          \n        </div>\n<details><summary>代码</summary>\n<div><pre><code>::: demo 一个普通 Demo\n\n<span><span>```</span><span>html</span>\n<span><span><span><span>&lt;</span>h1</span><span>></span></span>Mr.Hope<span><span><span>&lt;/</span>h1</span><span>></span></span>\n<span><span><span>&lt;</span>p</span><span>></span></span><span><span><span>&lt;</span>span</span> <span>id</span><span><span>=</span><span>\"</span>very<span>\"</span></span><span>></span></span>十分<span><span><span>&lt;/</span>span</span><span>></span></span> 帅<span><span><span>&lt;/</span>p</span><span>></span></span></span>\n<span>```</span></span>\n\n<span><span>```</span><span>js</span>\n<span>document<span>.</span><span>querySelector</span><span>(</span><span>\"#very\"</span><span>)</span><span>.</span><span>addEventListener</span><span>(</span><span>\"click\"</span><span>,</span> <span>(</span><span>)</span> <span>=></span> <span>{</span>\n  <span>alert</span><span>(</span><span>\"十分帅\"</span><span>)</span><span>;</span>\n<span>}</span><span>)</span><span>;</span></span>\n<span>```</span></span>\n\n<span><span>```</span><span>css</span>\n<span><span>span</span> <span>{</span>\n  <span>color</span><span>:</span> red<span>;</span>\n<span>}</span></span>\n<span>```</span></span>\n\n:::\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div></details>\n\n          <div\n            id=\"code-demo-693e1878\"\n           \n  data-type=\"react\"\n data-title=\"%E4%B8%80%E4%B8%AA%20React%20Demo\"\n\n            data-code=\"%7B%22js%22%3A%22export%20default%20class%20App%20extends%20React.Component%20%7B%5Cn%20%20constructor(props)%20%7B%5Cn%20%20%20%20super(props)%3B%5Cn%20%20%20%20this.state%20%3D%20%7B%20message%3A%20%5C%22%E5%8D%81%E5%88%86%E5%B8%85%5C%22%20%7D%3B%5Cn%20%20%7D%5Cn%20%20render()%20%7B%5Cn%20%20%20%20return%20(%5Cn%20%20%20%20%20%20%3Cdiv%20className%3D%5C%22box-react%5C%22%3E%5Cn%20%20%20%20%20%20%20%20Mr.Hope%20%3Cspan%3E%7Bthis.state.message%7D%3C%2Fspan%3E%5Cn%20%20%20%20%20%20%3C%2Fdiv%3E%5Cn%20%20%20%20)%3B%5Cn%20%20%7D%5Cn%7D%5Cn%22%2C%22css%22%3A%22.box-react%20span%20%7B%5Cn%20%20color%3A%20red%3B%5Cn%7D%5Cn%22%7D\"\n          >\n              \n              <div>\n                <div>\n<div><pre><code><span>export</span> <span>default</span> <span>class</span> <span>App</span> <span>extends</span> <span>React<span>.</span>Component</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>props</span><span>)</span> <span>{</span>\n    <span>super</span><span>(</span>props<span>)</span><span>;</span>\n    <span>this</span><span>.</span>state <span>=</span> <span>{</span> message<span>:</span> <span>\"十分帅\"</span> <span>}</span><span>;</span>\n  <span>}</span>\n  <span>render</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>(</span>\n      <span>&lt;</span>div className<span>=</span><span>\"box-react\"</span><span>></span>\n        Mr<span>.</span>Hope <span>&lt;</span>span<span>></span><span>{</span><span>this</span><span>.</span>state<span>.</span>message<span>}</span><span>&lt;</span><span>/</span>span<span>></span>\n      <span>&lt;</span><span>/</span>div<span>></span>\n    <span>)</span><span>;</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br></div></div><div><pre><code><span>.box-react span</span> <span>{</span>\n  <span>color</span><span>:</span> red<span>;</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div>\n            </div>\n          </div>\n          \n        </div>\n<details><summary>代码</summary>\n<div><pre><code>::: demo [react] 一个 React Demo\n\n<span><span>```</span><span>js</span>\n<span><span>export</span> <span>default</span> <span>class</span> <span>App</span> <span>extends</span> <span>React<span>.</span>Component</span> <span>{</span>\n  <span>constructor</span><span>(</span><span>props</span><span>)</span> <span>{</span>\n    <span>super</span><span>(</span>props<span>)</span><span>;</span>\n    <span>this</span><span>.</span>state <span>=</span> <span>{</span> message<span>:</span> <span>\"十分帅\"</span> <span>}</span><span>;</span>\n  <span>}</span>\n  <span>render</span><span>(</span><span>)</span> <span>{</span>\n    <span>return</span> <span>(</span>\n      <span>&lt;</span>div className<span>=</span><span>\"box-react\"</span><span>></span>\n        Mr<span>.</span>Hope <span>&lt;</span>span<span>></span><span>{</span><span>this</span><span>.</span>state<span>.</span>message<span>}</span><span>&lt;</span><span>/</span>span<span>></span>\n      <span>&lt;</span><span>/</span>div<span>></span>\n    <span>)</span><span>;</span>\n  <span>}</span>\n<span>}</span></span>\n<span>```</span></span>\n\n<span><span>```</span><span>css</span>\n<span><span>.box-react span</span> <span>{</span>\n  <span>color</span><span>:</span> red<span>;</span>\n<span>}</span></span>\n<span>```</span></span>\n\n:::\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div></details>\n\n          <div\n            id=\"code-demo-2c0b9cdb\"\n           \n  data-type=\"vue\"\n data-title=\"%E4%B8%80%E4%B8%AA%20Vue%20Demo\"\n\n            data-code=\"%7B%22vue%22%3A%22%3Ctemplate%3E%5Cn%20%20%3Cdiv%20class%3D%5C%22box%5C%22%3E%5Cn%20%20%20%20Mr.Hope%20%3Cspan%3E%7B%7B%20message%20%7D%7D%3C%2Fspan%3E%5Cn%20%20%3C%2Fdiv%3E%5Cn%3C%2Ftemplate%3E%5Cn%3Cscript%3E%5Cnexport%20default%20%7B%5Cn%20%20data%3A%20()%20%3D%3E%20(%7B%20message%3A%20%5C%22%E5%8D%81%E5%88%86%E5%B8%85%5C%22%20%7D)%2C%5Cn%7D%3B%5Cn%3C%2Fscript%3E%5Cn%3Cstyle%3E%5Cn.box%20span%20%7B%5Cn%20%20color%3A%20red%3B%5Cn%7D%5Cn%3C%2Fstyle%3E%5Cn%22%7D\"\n          >\n              \n              <div>\n                <div>\n<div><pre><code><span><span><span>&lt;</span>template</span><span>></span></span>\n  <span><span><span>&lt;</span>div</span> <span>class</span><span><span>=</span><span>\"</span>box<span>\"</span></span><span>></span></span>\n    Mr.Hope <span><span><span>&lt;</span>span</span><span>></span></span>{{ message }}<span><span><span>&lt;/</span>span</span><span>></span></span>\n  <span><span><span>&lt;/</span>div</span><span>></span></span>\n<span><span><span>&lt;/</span>template</span><span>></span></span>\n<span><span><span>&lt;</span>script</span><span>></span></span><span><span>\n<span>export</span> <span>default</span> <span>{</span>\n  <span>data</span><span>:</span> <span>(</span><span>)</span> <span>=></span> <span>(</span><span>{</span> message<span>:</span> <span>\"十分帅\"</span> <span>}</span><span>)</span><span>,</span>\n<span>}</span><span>;</span>\n</span></span><span><span><span>&lt;/</span>script</span><span>></span></span>\n<span><span><span>&lt;</span>style</span><span>></span></span><span><span>\n<span>.box span</span> <span>{</span>\n  <span>color</span><span>:</span> red<span>;</span>\n<span>}</span>\n</span></span><span><span><span>&lt;/</span>style</span><span>></span></span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div>\n            </div>\n          </div>\n          \n        </div>\n<details><summary>代码</summary>\n<div><pre><code>::: demo [vue] 一个 Vue Demo\n\n<span><span>```</span><span>vue</span>\n<span>&lt;template>\n  &lt;div>\n    Mr.Hope &lt;span>{{ message }}&lt;/span>\n  &lt;/div>\n&lt;/template>\n&lt;script>\nexport default {\n  data: () => ({ message: \"十分帅\" }),\n};\n&lt;/script>\n&lt;style>\n.box span {\n  color: red;\n}\n&lt;/style></span>\n<span>```</span></span>\n\n:::\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br></div></div></details>\n\n          <div\n            id=\"code-demo-2869b0e2\"\n           \n  \n data-title=\"%E4%B8%80%E4%B8%AA%E6%99%AE%E9%80%9A%20Demo\"\n\n            data-code=\"%7B%22md%22%3A%22%23%20%E6%A0%87%E9%A2%98%5Cn%5Cn%E5%8D%81%E5%88%86%E5%B8%85%5Cn%22%2C%22ts%22%3A%22const%20message%3A%20string%20%3D%20%5C%22Mr.Hope%5C%22%3B%5Cn%5Cndocument.querySelector(%5C%22h1%5C%22).innerHTML%20%3D%20message%3B%5Cn%22%2C%22scss%22%3A%22h1%20%7B%5Cn%20%20font-style%3A%20italic%3B%5Cn%5Cn%20%20%2B%20p%20%7B%5Cn%20%20%20%20color%3A%20red%3B%5Cn%20%20%7D%5Cn%7D%5Cn%22%7D\"\n          >\n              \n              <div>\n                <div>\n<div><pre><code><span><span>#</span> 标题</span>\n\n十分帅\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div><div><pre><code><span>const</span> message<span>:</span> <span>string</span> <span>=</span> <span>\"Mr.Hope\"</span><span>;</span>\n\ndocument<span>.</span><span>querySelector</span><span>(</span><span>\"h1\"</span><span>)</span><span>.</span>innerHTML <span>=</span> message<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div><div><pre><code><span>h1 </span><span>{</span>\n  <span>font-style</span><span>:</span> italic<span>;</span>\n\n  <span>+ p </span><span>{</span>\n    <span>color</span><span>:</span> red<span>;</span>\n  <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div>\n            </div>\n          </div>\n          \n        </div>\n<details><summary>代码</summary>\n<div><pre><code>::: demo 一个普通 Demo\n\n<span><span>```</span><span>md</span>\n<span><span><span>#</span> 标题</span>\n\n十分帅</span>\n<span>```</span></span>\n\n<span><span>```</span><span>ts</span>\n<span><span>const</span> message<span>:</span> <span>string</span> <span>=</span> <span>\"Mr.Hope\"</span><span>;</span>\n\ndocument<span>.</span><span>querySelector</span><span>(</span><span>\"h1\"</span><span>)</span><span>.</span>innerHTML <span>=</span> message<span>;</span></span>\n<span>```</span></span>\n\n<span><span>```</span><span>scss</span>\n<span><span>h1 </span><span>{</span>\n  <span>font-style</span><span>:</span> italic<span>;</span>\n\n  <span>+ p </span><span>{</span>\n    <span>color</span><span>:</span> red<span>;</span>\n  <span>}</span>\n<span>}</span></span>\n<span>```</span></span>\n\n:::\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div></details>\n<ul>\n<li><a href=\"https://vuepress-theme-hope.github.io/zh/guide/markdown/demo/\" target=\"_blank\" rel=\"noopener noreferrer\">点击查看</a></li>\n</ul>\n<h3 id=\"幻灯片\"> 幻灯片</h3>\n<i>Not supported content</i><details><summary>代码</summary>\n<div><pre><code>@slidestart\n\n<span><span>##</span> 幻灯片 1</span>\n\n一个有文字和 <span>[<span>链接</span>](<span>https://mrhope.site</span>)</span> 的段落\n\n<span>---</span>\n\n<span><span>##</span> 幻灯片 2</span>\n\n<span>-</span> 列表 1\n<span>-</span> 列表 2\n\n<span>---</span>\n\n<span><span>##</span> 幻灯片 3.1</span>\n\n<span><span>```</span><span>js</span>\n<span><span>const</span> a <span>=</span> <span>1</span><span>;</span></span>\n<span>```</span></span>\n\n--\n\n<span><span>##</span> 幻灯片 3.2</span>\n\n$$\nJ(\\theta_0,\\theta_1) = \\sum_{i=0}\n$$\n\n@slideend\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br></div></div></details>\n<ul>\n<li><a href=\"https://vuepress-theme-hope.github.io/zh/guide/markdown/presentation/\" target=\"_blank\" rel=\"noopener noreferrer\">点击查看</a></li>\n</ul>\n<h2 id=\"其他语法\"> 其他语法</h2>\n<div><p>自定义标题</p>\n<p>信息容器</p>\n</div>\n<div><p>自定义标题</p>\n<p>提示容器</p>\n</div>\n<div><p>自定义标题</p>\n<p>警告容器</p>\n</div>\n<div><p>自定义标题</p>\n<p>危险容器</p>\n</div>\n<details><summary>自定义标题</summary>\n<p>详情容器</p>\n</details>\n<details><summary>代码</summary>\n<div><pre><code>::: info 自定义标题\n\n信息容器\n\n:::\n\n::: tip 自定义标题\n\n提示容器\n\n:::\n\n::: warning 自定义标题\n\n警告容器\n\n:::\n\n::: danger 自定义标题\n\n危险容器\n\n:::\n\n::: details 自定义标题\n\n详情容器\n\n:::\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br></div></div></details>\n<hr>\n<section>\n<ol>\n<li id=\"footnote1\"><p>这是脚注内容 </p>\n</li>\n</ol>\n</section>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-03T00:53:03.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "页面配置",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/page/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/page/",
      "content_html": "<h2 id=\"页面信息\"> 页面信息</h2>\n<p>你可以在 Markdown 的 Frontmatter 中设置页面信息。</p>\n<ul>\n<li>\n<p>作者设置为 Ms.Hope。</p>\n</li>\n<li>\n<p>写作时间应为 2020 年 1 月 1 日</p>\n</li>\n<li>\n<p>分类为 “使用指南”</p>\n</li>\n<li>\n<p>标签为 “页面配置” 和 “使用指南”</p>\n</li>\n</ul>\n<h2 id=\"页面内容\"> 页面内容</h2>\n<p>你可以自由在这里书写你的 Markdown。</p>\n<div><p>提示</p>\n<ul>\n<li>\n<p>Markdown 文件夹的图片请使用相对链接 <code>./</code> 进行引用。</p>\n</li>\n<li>\n<p><code>.vuepress/public</code> 文件夹的图片，请使用绝对链接 <code>/</code> 进行引用</p>\n</li>\n</ul>\n</div>\n<p>主题包含了一个自定义徽章章可以使用:</p>\n<blockquote>\n<p>文字结尾应该有深蓝色的 徽章文字 徽章。 <i>Not supported content</i></p>\n</blockquote>\n<h2 id=\"页面结构\"> 页面结构</h2>\n<p>此页面应当包含：</p>\n<ul>\n<li>返回顶部按钮</li>\n<li>路径导航</li>\n<li>评论</li>\n<li>页脚</li>\n</ul>\n",
      "date_published": "2020-01-01T00:00:00.000Z",
      "date_modified": "2021-11-03T00:53:03.000Z",
      "authors": [
        {
          "name": "Ms.Hope"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "介绍",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/introduce/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/introduce/",
      "content_html": "<p>ShardingCore是一款易用、简单、高性能、普适性，针对<a href=\"https://github.com/dotnet/efcore\" target=\"_blank\" rel=\"noopener noreferrer\">efcore</a>生态下的分表分库的扩展解决方案,支持efcore2+的所有版本,支持efcore2+的所有数据库、支持自定义路由、动态路由、高性能分页、读写分离的一款组件,一款零依赖第三方组件的扩展，如果您熟悉efcore的使用那么对于这个组件您只需要简单配置即可零成本开始使用。</p>\n<div><p>注意</p>\n<ol>\n<li>本组件仅仅只是针对efcore的一个扩展</li>\n<li>本组件基于目前分表分库下的最新、最高性能的原理来实现，实际使用中还需要结合业务设计合理的分片方式</li>\n<li>本组件目前不提供数据迁移功能,如果你一开始的数据分表、分库不是动态的那么后续的库/表增加需要您自己手动去迁移数据</li>\n<li>本组件是针对efcore的扩展所以只要您的框架里面用到了efcore并且可以针对DbContextOptionsBuilder进行手动处理那么就可以支持(如 <a href=\"https://github.com/abpframework/abp\" target=\"_blank\" rel=\"noopener noreferrer\">abp vnext</a>)</li>\n</ol>\n</div>\n<h2 id=\"特性\"> 特性</h2>\n<ul>\n<li><strong>Code First</strong></li>\n</ul>\n<p>支持efcore的code first支持表结构的迁移自动化。</p>\n<ul>\n<li><strong>自定义路由</strong></li>\n</ul>\n<p>支持对数据分表/分库的自定义路由，可以满足几乎90%的业务分表/分库规则，并且支持外部传入配置</p>\n<ul>\n<li><strong>分片字段任意类型</strong></li>\n</ul>\n<p>支持分片字段为任意类型的字段比如按时间分片(支持 datetime,long,int...)</p>\n<ul>\n<li><strong>join、group</strong></li>\n</ul>\n<p>支持分片对象和非分片对象的join group by，并且支持分片对象和分片对象的join group by</p>\n<ul>\n<li><strong>高性能分页</strong></li>\n</ul>\n<p>具有极少数的客户端分片中间件下才有的流式聚合，和特定的高性能分页，具有低内存高性能O(n),并且支持顺序分页，反向分页，追加排序</p>\n<ul>\n<li><strong>手动路由</strong></li>\n</ul>\n<p>支持分片查询指定分片表，和断言分片表</p>\n<ul>\n<li><strong>批量操作</strong></li>\n</ul>\n<p>支持efcore生态下的所有批量操作组件</p>\n<ul>\n<li><strong>自动追踪</strong></li>\n</ul>\n<p>是efcore分片中间件下为数不多的支持自动追踪的</p>\n<ul>\n<li><strong>沉浸式编码</strong></li>\n</ul>\n<p>支持在编写数据库的crud的时候保证使用体验和efcore原生编码一样，无需学习成本</p>\n<ul>\n<li><strong>多数据库支持</strong></li>\n</ul>\n<p>只要是efcore2+支持的数据库sharding-core都是支持的</p>\n<p>别犹豫了，赶快上手吧</p>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-03T00:53:03.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "参数配置",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/params-confg/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/params-confg/",
      "content_html": "<h2 id=\"autotrackentity\"> AutoTrackEntity</h2>\n<p>sharding-core默认针对分表后的数据将不支持追踪,未分表的对象支持原生efcore的追踪规则,如果你的查询对象A是部分表的那么依旧符合原生使用efcore的追踪规则,针对分表对象B那么将不再支持追踪.</p>\n<h3 id=\"使用追踪\"> 使用追踪</h3>\n<p>你可以设置<code>AutoTrackEntity</code>为true</p>\n<div><pre><code>services<span>.</span><span><span>AddShardingConfigure</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>(</span>conn<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>Begin</span><span>(</span>o <span>=></span>\n                <span>{</span>\n                <span>}</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><p>那么所有的对象都将支持追踪。</p>\n<h3 id=\"不启用追踪\"> 不启用追踪</h3>\n<p><code>AutoTrackEntity</code>设置为true或者false都没什么关系,建议设置为true，因为有可能需要使用追踪</p>\n<div><pre><code> services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>DefaultShardingDbContext<span>></span></span></span><span>(</span>\n                    <span>(</span>conn<span>,</span> o<span>)</span> <span>=></span>\n                        o<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>.</span><span>UseQueryTrackingBehavior</span><span>(</span>QueryTrackingBehavior<span>.</span>NoTracking<span>)</span>\n                <span>)</span><span>.</span><span>Begin</span><span>(</span>o <span>=></span>\n                <span>{</span>\n                <span>}</span><span>)</span>\n                <span>.</span><span>AddShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseQueryTrackingBehavior</span><span>(</span>QueryTrackingBehavior<span>.</span>NoTracking<span>)</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><p>追加所有的创建<code>DbContext</code>的委托<code>.UseQueryTrackingBehavior(QueryTrackingBehavior.NoTracking)</code>那么所有的查询都将不再启用追踪除非手动调用<code>AsTracking</code></p>\n<div><p>注意</p>\n<p>因为<code>AutoTrackEntity</code>设置为false后如果不设置<code>DbContext</code>为<code>.UseQueryTrackingBehavior(QueryTrackingBehavior.NoTracking)</code>那么分表后的查询依然会走追踪只是程序无法追踪到，因为查询的原理会新创建n个<code>DbContext</code>但是这些<code>DbContext</code>进行查询的时候并没有使用<code>NoTracking</code>所以性能上还是会有一定的损失，<strong>总结就是<code>AutoTrackEntity</code>无脑设置为true</strong></p>\n</div>\n<h2 id=\"ensurecreatedwithoutshardingtable\"> EnsureCreatedWithOutShardingTable</h2>\n<p>这个属性的意思很好理解就是是否需要在启动的时候创建表，这边的创建表是除了分表的对象，其他对象都会直接创建对应的表，每次启动都会执行一下，如果您是使用<a href=\"/sharding-core-doc/adv/code-first/\">code-first</a>的那么这个值可以无视或者设置为false。</p>\n<h2 id=\"createshardingtableonstart\"> CreateShardingTableOnStart</h2>\n<p>这个熟悉的意思就是是否需要在启动的时候创建表，但是由于<code>efcore</code>并未提供关于表是否存在的判断，所以如果你将这个值设置为true,那么每次都会在启动的时候都会去执行创建表的方法，这样就会导致启动的时候如果有某些表过多那么就会导致启动速度变慢，可以再您未创建表的时候使用这个属性，创建完成后将这个属性设置为false，如果您是使用<a href=\"/sharding-core-doc/adv/code-first/\">code-first</a>的那么这个值可以无视或者设置为false。</p>\n<h2 id=\"ignorecreatetableerror\"> IgnoreCreateTableError</h2>\n<p><code>sharding-core</code>默认会在创建表失败后输出错误信息,但是输出的信息会被log记录所以为了log不记录这些信息，可以将这个值设置为true那么如果创建失败(已经存在表)框架将不会抛出对应的错误消息，如果您是使用<a href=\"/sharding-core-doc/adv/code-first/\">code-first</a>的那么这个值可以无视或者设置为false。</p>\n<h2 id=\"parallelquerymaxthreadcount\"> ParallelQueryMaxThreadCount</h2>\n<p>并发查询最大线程数,默认cpu核心数*2，因为分表/分库后的单次查询会涉及到N张表，N&gt;=1为了保证单次查询不会导致整个系统崩溃掉，所以这边提供了这个属性，可以保证涉及到跨库或者跨表的时候查询不会创建过多的<code>DbConnection</code></p>\n<h2 id=\"parallelquerytimeout\"> ParallelQueryTimeOut</h2>\n<p>并发查询超时时间,默认30秒,这个字段也是为了在分成多个线程查询后可能导致线程一致未返回结果，所以添加了这个字段在超时后可以取消掉现有的线程,防止无限制等待。</p>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2022-01-07T14:00:26.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "分表并且分库",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/sharding-all/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/sharding-all/",
      "content_html": "",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-03T00:53:03.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "分库",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/sharding-data-source/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/sharding-data-source/",
      "content_html": "",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-03T00:53:03.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "读写分离",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/read-write/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/read-write/",
      "content_html": "",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-03T00:53:03.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "分表",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/sharding-table/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/sharding-table/",
      "content_html": "",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-03T00:53:03.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "概念",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/terminology/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/terminology/",
      "content_html": "",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-03T00:53:03.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "x.3升级到x.4指南",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide-upgrade-3-4/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide-upgrade-3-4/",
      "content_html": "<h2 id=\"说明\"> 说明</h2>\n<p>如果您目前正在使用x.3.x.x希望可以升级到最新版本的x.4.x.x那么可以通过查看对比如下差异来选择是否升级</p>\n<h2 id=\"优点\"> 优点</h2>\n<ul>\n<li>x.4.x.x版本相较于x.3.x.x版本新增额外功能多配置,原先针对x.3.x.x版本如果是多租户下一个租户使用一个数据库链接那么所创建的对象必须要支持分库,才可以没办法动态切换默认数据库,并且额外所有表都需要支持分库,在x.4.x.x版本新增了多配置动态获取,保证了在单配置情况下还是和原先一样的情况下多配置下支持额外动态配置,分库隔离的情况下不需要针对所有对象进行分库处理操作。</li>\n<li>后续会对x.3.x.x版本进行bug修复,但是不会增加新功能,后续的新功能和优化都会在最新版上进行</li>\n<li>支持多租户下不同租户的不同数据库</li>\n</ul>\n<h2 id=\"注意点\"> 注意点</h2>\n<ul>\n<li>4版本和3版本的区别除了动态多配置外,还有启动时候的配置方式进行了改变。</li>\n<li><code>IVirtualDataSource&lt;TShardingDbContext&gt;</code>无法通过依赖注入获取,取而代之的是<code>IVirtualDataSourceManager&lt;TShardingDbContext&gt;</code></li>\n<li><code>IShardingDbContext</code>需要实现一个新方法可以通过<code>shardingDbContextExecutor</code>来进行实现</li>\n<li><code>IShardingComparer</code>无法通过依赖注入获取并且移除泛型接口</li>\n<li><code>IConnectionStringManager</code>移除泛型接口,并且不支持依赖注入,可以通过<code>IVirtualDataSource&lt;TShardingDbContext&gt;</code>来进行获取</li>\n<li><code>IShardingConnectionStringResolver</code>移除泛型接口,并且不支持依赖注入</li>\n<li><code>IReadWriteOptions&lt;TShardingDbContext&gt;</code>被移除</li>\n<li><code>IShardingDbContextOptionsBuilderConfig&lt;TShardingDbContext&gt;</code>被移除</li>\n</ul>\n<h2 id=\"原先startup\"> 原先startup</h2>\n<div><pre><code>services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>ShardingDefaultDbContext<span>></span></span></span><span>(</span><span>(</span>conn<span>,</span> o<span>)</span> <span>=></span>\n                    o<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>)</span>\n                <span>.</span><span>Begin</span><span>(</span>o <span>=></span>\n                <span>{</span>\n                    o<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                    o<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n\n                    o<span>.</span>ThrowIfQueryRouteNotMatch <span>=</span> <span>false</span><span>;</span>\n                    <span>//o.AddParallelTables(typeof(SysUserMod), typeof(SysUserSalary));</span>\n                <span>}</span><span>)</span>\n                <span>.</span><span>AddShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>)</span>\n                <span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"A\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBA;Integrated Security=True;\"</span><span>)</span>\n                <span>.</span><span>AddShardingDataSource</span><span>(</span>sp <span>=></span>\n                <span>{</span>\n                    <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span> <span>\"B\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBB;Integrated Security=True;\"</span> <span>}</span><span>,</span>\n                        <span>{</span> <span>\"C\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBC;Integrated Security=True;\"</span> <span>}</span><span>,</span>\n                    <span>}</span><span>;</span>\n                <span>}</span><span>)</span>\n                <span>.</span><span>AddShardingDataSourceRoute</span><span>(</span>o <span>=></span>\n                <span>{</span>\n                    o<span>.</span><span><span>AddShardingDatabaseRoute</span><span><span>&lt;</span>OrderAreaShardingVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span>\n                <span>.</span><span>AddShardingTableRoute</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserModVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserSalaryVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderCreateTimeVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogDayVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogWeekDateTimeVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogWeekTimeLongVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogYearDateTimeVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogMonthLongvirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogYearLongVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserModIntVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogDayLongVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>MultiShardingOrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddReadWriteSeparation</span><span>(</span>sp <span>=></span>\n                <span>{</span>\n                    <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> IEnumerable<span>&lt;</span><span>string</span><span>></span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span>\n                            <span>\"A\"</span><span>,</span> <span>new</span> <span>HashSet<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n                            <span>{</span>\n                                <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBB;Integrated Security=True;\"</span>\n                            <span>}</span>\n                        <span>}</span>\n                    <span>}</span><span>;</span>\n                <span>}</span><span>,</span>ReadStrategyEnum<span>.</span>Loop<span>,</span><span>defaultEnable</span><span>:</span> <span>false</span><span>,</span> <span>readConnStringGetStrategy</span><span>:</span>ReadConnStringGetStrategyEnum<span>.</span>LatestEveryTime<span>)</span>\n                <span>.</span><span>AddTableEnsureManager</span><span>(</span>sp<span>=></span><span>new</span> <span>SqlServerTableEnsureManager<span>&lt;</span>ShardingDefaultDbContext<span>></span></span><span>(</span><span>)</span><span>)</span>\n                <span>.</span><span>End</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br></div></div><h2 id=\"现在的startup\"> 现在的startup</h2>\n<div><pre><code>\n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>ShardingDefaultDbContext<span>></span></span></span><span>(</span><span>)</span>\n                <span>.</span><span>AddEntityConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    <span>//如果您使用code-first建议选择false</span>\n                    op<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                    <span>//如果您使用code-first建议修改为fsle</span>\n                    op<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n                    <span>//当无法获取路由时会返回默认值而不是报错</span>\n                    op<span>.</span>ThrowIfQueryRouteNotMatch <span>=</span> <span>false</span><span>;</span>\n                    <span>//这边设置了如果AddConfig没设置就是用这边的</span>\n                    <span>//op.UseShardingQuery((conStr, builder) =></span>\n                    <span>//{</span>\n                    <span>//    builder.UseSqlServer(conStr).UseLoggerFactory(efLogger);</span>\n                    <span>//});</span>\n                    <span>//op.UseShardingTransaction((connection, builder) =></span>\n                    <span>//{</span>\n                    <span>//    builder.UseSqlServer(connection).UseLoggerFactory(efLogger);</span>\n                    <span>//});</span>\n                    op<span>.</span><span><span>AddShardingDataSourceRoute</span><span><span>&lt;</span>OrderAreaShardingVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserModVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserSalaryVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderCreateTimeVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogDayVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogWeekDateTimeVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogWeekTimeLongVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogYearDateTimeVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogMonthLongvirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogYearLongVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserModIntVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogDayLongVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>MultiShardingOrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n\n                <span>}</span><span>)</span>\n                <span>.</span><span>AddConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span>ConfigId<span>=</span><span>\"c1\"</span><span>;</span>\n                    <span>//op.Priority = 1;</span>\n\n                    op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conStr<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n\n                    op<span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"A\"</span><span>,</span>\n                        <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBA;Integrated Security=True;\"</span><span>)</span><span>;</span>\n                    op<span>.</span><span>AddExtraDataSource</span><span>(</span>sp <span>=></span>\n                    <span>{</span>\n                        <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span> <span>\"B\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBB;Integrated Security=True;\"</span> <span>}</span><span>,</span>\n                        <span>{</span> <span>\"C\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBC;Integrated Security=True;\"</span> <span>}</span><span>,</span>\n                    <span>}</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>AddReadWriteSeparation</span><span>(</span>sp <span>=></span>\n                    <span>{</span>\n                        <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> IEnumerable<span>&lt;</span><span>string</span><span>></span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span>\n                            <span>\"A\"</span><span>,</span> <span>new</span> <span>HashSet<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n                            <span>{</span>\n                                <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBB;Integrated Security=True;\"</span>\n                            <span>}</span>\n                        <span>}</span>\n                    <span>}</span><span>;</span>\n                    <span>}</span><span>,</span> ReadStrategyEnum<span>.</span>Loop<span>,</span> <span>defaultEnable</span><span>:</span> <span>false</span><span>,</span> <span>readConnStringGetStrategy</span><span>:</span> ReadConnStringGetStrategyEnum<span>.</span>LatestEveryTime<span>)</span><span>;</span>\n                    op<span>.</span><span>ReplaceTableEnsureManager</span><span>(</span>sp <span>=></span> <span>new</span> <span>SqlServerTableEnsureManager<span>&lt;</span>ShardingDefaultDbContext<span>></span></span><span>(</span><span>)</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>EnsureConfig</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br></div></div><p><strong>总结</strong> 移除<code>AddShardingDbContext</code>委托参数,将分表分库路由添加新增到了<code>AddEntityConfig</code>,额外新增<code>AddConfig</code>额外多了一个必填字段ConfigId用于在多配置下进行获取,当然如果你是单配置的那么可以忽略,<code>EnsureConfig</code>表示为单个配置<code>EnsureMultiConfig</code>表示为多配置,目前Startup必须要配置一个<code>AddConfig</code></p>\n",
      "date_published": "2022-01-07T14:00:26.000Z",
      "date_modified": "2022-01-07T14:00:26.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "x.3升级到x.4指南"
      ]
    },
    {
      "title": "参数配置",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/params-confg/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/params-confg/",
      "content_html": "<h2 id=\"配置\"> 配置</h2>\n<div><pre><code> services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AddEntityConfig</span><span>(</span>op <span>=></span>\n            <span>{</span>\n                <span>//如果您使用code-first建议选择false</span>\n                op<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                <span>//如果您使用code-first建议修改为fsle</span>\n                op<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n                <span>//当无法获取路由时会返回默认值而不是报错</span>\n                op<span>.</span>ThrowIfQueryRouteNotMatch <span>=</span> <span>false</span><span>;</span>\n                <span>//如果创建表出错的话是否忽略,如果不忽略就会输出warning的日志</span>\n                op<span>.</span>IgnoreCreateTableError <span>=</span> <span>true</span><span>;</span>\n                <span>//是否缓存分库路由表达式缓存仅缓存单个操作</span>\n                <span>//sharding data source route filter expression compile cache</span>\n                op<span>.</span>EnableDataSourceRouteCompileCache <span>=</span> <span>null</span><span>;</span>\n                <span>//是否缓存分表路由表达式缓存仅缓存单个操作</span>\n                <span>//sharding table route filter expression compile cache</span>\n                op<span>.</span>EnableTableRouteCompileCache <span>=</span> <span>null</span><span>;</span>\n                <span>//如果找不到路由结果是否抛出异常还是选择返回默认值</span>\n                op<span>.</span>ThrowIfQueryRouteNotMatch <span>=</span> <span>false</span><span>;</span>\n                <span>//添加这个对象的字符串创建dbcontext 优先级低 优先采用AddConfig下的</span>\n                op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conStr<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>;</span>\n                <span>//添加这个对象的链接创建dbcontext 优先级低 优先采用AddConfig下的</span>\n                op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>;</span>\n                <span>//添加分库路由</span>\n                op<span>.</span><span><span>AddShardingDataSourceRoute</span><span><span>&lt;</span>xxx<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>//添加分表路由</span>\n                op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>xxx<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>.</span><span>AddConfig</span><span>(</span>op <span>=></span><span>//AddConfig必须存在一个</span>\n            <span>{</span>\n                <span>//当前配置的名称</span>\n                op<span>.</span>ConfigId <span>=</span> <span>\"a\"</span><span>;</span>\n                <span>//当前配置优先级</span>\n                op<span>.</span>Priority <span>=</span> <span>1</span><span>;</span>\n                <span>//当前配置链接模式</span>\n                op<span>.</span>ConnectionMode <span>=</span> ConnectionModeEnum<span>.</span>SYSTEM_AUTO<span>;</span>\n                <span>//当前配置最大连接数</span>\n                op<span>.</span>MaxQueryConnectionsLimit <span>=</span> <span>4</span><span>;</span>\n                <span>//同上配置</span>\n                op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conStr<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>;</span>\n                <span>//同上配置</span>\n                op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>;</span>\n                <span>//添加默认链接</span>\n                op<span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"ds0\"</span><span>,</span>\n                    <span>\"Data Source=localhost;Initial Catalog=xxxx;Integrated Security=True;\"</span><span>)</span><span>;</span>\n                <span>//添加额外数据源链接(分库下会用到)</span>\n                op<span>.</span><span>AddExtraDataSource</span><span>(</span>sp <span>=></span>\n                <span>{</span>\n                    <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span> <span>\"ds1\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=xxxx1;Integrated Security=True;\"</span> <span>}</span><span>,</span>\n                        <span>{</span> <span>\"ds2\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=xxxx2;Integrated Security=True;\"</span> <span>}</span><span>,</span>\n                    <span>}</span><span>;</span>\n                <span>}</span><span>)</span><span>;</span>\n                <span>//添加默认的比较器(guid在sqlserver下和c#下比较器排序行为不一致需要手动修复)</span>\n                op<span>.</span><span>ReplaceShardingComparer</span><span>(</span>sp<span>=></span><span>new</span> <span>CSharpLanguageShardingComparer</span><span>(</span><span>)</span><span>)</span><span>;</span>\n                <span>//添加表确认默认提供了sqlserver和mysql的如果有其他的请提交pr补充谢谢</span>\n                op<span>.</span><span>ReplaceTableEnsureManager</span><span>(</span>sp<span>=></span><span>new</span> <span>SqlServerTableEnsureManager<span>&lt;</span>MyDbContext<span>></span></span><span>(</span><span>)</span><span>)</span><span>;</span>\n                <span>//添加读写分离</span>\n                op<span>.</span><span>AddReadWriteSeparation</span><span>(</span>sp <span>=></span>\n                <span>{</span>\n                    <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> IEnumerable<span>&lt;</span><span>string</span><span>></span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span>\n                            <span>\"ds0\"</span><span>,</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n                            <span>{</span>\n                                <span>\"Data Source=localhost;Initial Catalog=xxxx0_1;Integrated Security=True;\"</span>\n                            <span>}</span>\n                        <span>}</span>\n                    <span>}</span><span>;</span>\n                <span>}</span><span>,</span> ReadStrategyEnum<span>.</span>Loop<span>,</span> <span>defaultEnable</span><span>:</span> <span>true</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>.</span><span>EnsureConfig</span><span>(</span>ShardingConfigurationStrategyEnum<span>.</span>ThrowIfNull<span>)</span><span>;</span><span>//单个配置后续不会增加了的 如果无法匹配会抛出异常</span>\n            <span>//.EnsureMultiConfig(ShardingConfigurationStrategyEnum.ThrowIfNull)//多个配置后续还会增加,使用时必须指定configId 如果无法匹配会抛出异常 还可以指定返回优先级最高的或者返回null 但是返回null的情况下sharding-core将无法正常运行</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br></div></div><h2 id=\"enabletableroutecompilecache\"> EnableTableRouteCompileCache</h2>\n<p>针对分表下的表达式编译,默认null\n针对单个结果的表达式进行编译缓存可以有效的提高性能</p>\n<h2 id=\"enabledatasourceroutecompilecache\"> EnableDataSourceRouteCompileCache</h2>\n<p>针对分库下的表达式编译,默认null\n针对单个结果的表达式进行编译缓存可以有效的提高性能</p>\n<h2 id=\"ensurecreatedwithoutshardingtable\"> EnsureCreatedWithOutShardingTable</h2>\n<p>这个属性的意思很好理解就是是否需要在启动的时候创建表，这边的创建表是除了分表的对象，其他对象都会直接创建对应的表，只有当数据库是空的前提下或者没有数据库的前提下会自动创建数据库和普通表，如果您是使用<a href=\"/sharding-core-doc/adv/code-first/\">code-first</a>的那么这个值可以无视或者设置为false。</p>\n<p>有库了不会建库，普通表(非分表的可以是分库的表但不能是分表的表)有任何一张存在库里了别的普通表都不会被创建</p>\n<div><p>注意</p>\n<p>!!!<strong>只有</strong>当数据库是空的前提下或者没有数据库的前提下会自动创建数据库和普通表!!!</p>\n<p>!!!<strong>只有</strong>当数据库是空的前提下或者没有数据库的前提下会自动创建数据库和普通表!!!</p>\n<p>!!!<strong>只有</strong>当数据库是空的前提下或者没有数据库的前提下会自动创建数据库和普通表!!!</p>\n</div>\n<h2 id=\"createshardingtableonstart\"> CreateShardingTableOnStart</h2>\n<p>这个属性的意思就是是否需要在启动的时候创建分表了的表，但是由于<code>efcore</code>并未提供关于表是否存在的判断，所以如果你将这个值设置为true,那么每次都会在启动的时候都会去执行创建表的方法，这样就会导致启动的时候如果有某些表过多那么就会导致启动速度变慢，可以再您未创建表的时候使用这个属性，创建完成后将这个属性设置为false，如果您是使用<a href=\"/sharding-core-doc/adv/code-first/\">code-first</a>的那么这个值可以无视或者设置为false。</p>\n<h2 id=\"ignorecreatetableerror\"> IgnoreCreateTableError</h2>\n<p><code>sharding-core</code>默认会在创建表失败后输出错误信息,但是输出的信息会被log记录所以为了log不记录这些信息，可以将这个值设置为true那么如果创建失败(已经存在表)框架将不会抛出对应的错误消息，如果您是使用<a href=\"/sharding-core-doc/adv/code-first/\">code-first</a>的那么这个值可以无视或者设置为false。</p>\n<h2 id=\"maxqueryconnectionslimit\"> MaxQueryConnectionsLimit</h2>\n<p>最大并发链接数，就是表示单次查询<code>sharding-core</code>允许使用的dbconnection，默认会加上1就是说如果你配置了<code>MaxQueryConnectionsLimit=10</code>那么实际<code>sharding-core</code>会在同一次查询中开启11条链接最多,为什么是11不是10因为<code>sharding-core</code>会默认开启一个链接用来进行空dbconnection的使用。如果不设置本参数那么默认是cpu线程数<code>Environment.ProcessorCount</code></p>\n<h2 id=\"connectionmode\"> ConnectionMode</h2>\n<p>链接模式,可以由用户自行指定，使用内存限制,和连接数限制或者系统自行选择最优</p>\n<p>链接模式，有三个可选项，分别是：</p>\n<h3 id=\"memory-strictly\"> MEMORY_STRICTLY</h3>\n<p>内存限制模式最小化内存聚合 流式聚合 同时会有多个链接</p>\n<p>MEMORY_STRICTLY的意思是最小化内存使用率，就是非一次性获取所有数据然后采用流式聚合</p>\n<h3 id=\"connection-strictly\"> CONNECTION_STRICTLY</h3>\n<p>连接数限制模式最小化并发连接数 内存聚合 连接数会有限制</p>\n<p>CONNECTION_STRICTLY的意思是最小化连接并发数，就是单次查询并发连接数为设置的连接数<code>MaxQueryConnectionsLimit</code>。因为有限制，所以无法一直挂起多个连接，数据的合并为内存聚合采用最小化内存方式进行优化，而不是无脑使用内存聚合</p>\n<h3 id=\"system-auto\"> SYSTEM_AUTO</h3>\n<p>系统自动选择内存还是流式聚合</p>\n<p>系统自行选择会根据用户的配置采取最小化连接数，但是如果遇到分页则会根据分页策略采取内存限制，因为skip过大会导致内存爆炸</p>\n<div><p>注意</p>\n<p>!!!如果用户手动设置ConnectionMode则按照用户设置的为准,之后判断本次查询skip是否大于UseMemoryLimitWhileSkip,如果是采用<code>MEMORY_STRICTLY</code>,之后才是系统动态设置根据<code>MaxQueryConnectionsLimit</code>来分配!!!\n!!!如果用户手动设置ConnectionMode则按照用户设置的为准,之后判断本次查询skip是否大于UseMemoryLimitWhileSkip,如果是采用<code>MEMORY_STRICTLY</code>,之后才是系统动态设置根据<code>MaxQueryConnectionsLimit</code>来分配!!!\n!!!如果用户手动设置ConnectionMode则按照用户设置的为准,之后判断本次查询skip是否大于UseMemoryLimitWhileSkip,如果是采用<code>MEMORY_STRICTLY</code>,之后才是系统动态设置根据<code>MaxQueryConnectionsLimit</code>来分配!!!</p>\n</div>\n<h2 id=\"replaceshardingcomparer\"> ReplaceShardingComparer</h2>\n<p>添加默认的比较器(guid在sqlserver下和c#下比较器排序行为不一致需要手动修复)</p>\n<h2 id=\"replacetableensuremanager\"> ReplaceTableEnsureManager</h2>\n<p>添加表确认默认提供了sqlserver和mysql的如果有其他的请提交pr补充谢谢</p>\n<h2 id=\"shardingconfigurationstrategyenum\"> ShardingConfigurationStrategyEnum</h2>\n<h3 id=\"throwifnull\"> ThrowIfNull</h3>\n<p>如果找到将抛出异常,单配置下无需管理(推荐、默认也是这个值)</p>\n<h3 id=\"returnnull\"> ReturnNull</h3>\n<p>如果找不到就返回null,如果返回null那么dbcontext将无法正常运行,所以如果设置返回null请一定要在创建dbcontext之前指定configId</p>\n<h3 id=\"returnhighpriority\"> ReturnHighPriority</h3>\n<p>当不指定或者找不到对应的当前虚拟数据源或者configId时将返回优先级最高的那个</p>\n<h2 id=\"addconfig\"> AddConfig</h2>\n<p>支持添加多个配置,每个配置可以指定自定义数据库,并且支持动态添加</p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2022-01-11T00:08:16.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "介绍",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/introduce/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/introduce/",
      "content_html": "<h2 id=\"重要重要重要\"> 重要重要重要</h2>\n<p>无论您是否是第一次使用请先仔细阅读<a href=\"/sharding-core-doc/important\">重要</a></p>\n<div><p>注意</p>\n<p>！！！重要重要重要！！！</p>\n<p>！！！重要重要重要！！！</p>\n<p>！！！重要重要重要！！！</p>\n</div>\n<p>ShardingCore是一款易用、简单、高性能、普适性，针对<a href=\"https://github.com/dotnet/efcore\" target=\"_blank\" rel=\"noopener noreferrer\">efcore</a>生态下的分表分库的扩展解决方案,支持efcore2+的所有版本,支持efcore2+的所有数据库、支持自定义路由、动态路由、高性能分页、读写分离的一款组件,一款零依赖第三方组件的扩展，如果您熟悉efcore的使用那么对于这个组件您只需要简单配置即可零成本开始使用。</p>\n<div><p>注意</p>\n<ol>\n<li>本组件仅仅只是针对efcore的一个扩展</li>\n<li>本组件基于目前分表分库下的最新、最高性能的原理来实现，实际使用中还需要结合业务设计合理的分片方式</li>\n<li>本组件目前不提供数据迁移功能,如果你一开始的数据分表、分库不是动态的那么后续的库/表增加需要您自己手动去迁移数据</li>\n<li>本组件是针对efcore的扩展所以只要您的框架里面用到了efcore并且可以针对DbContextOptionsBuilder进行手动处理那么就可以支持(如 <a href=\"https://github.com/abpframework/abp\" target=\"_blank\" rel=\"noopener noreferrer\">abp vnext</a>)</li>\n</ol>\n</div>\n<h2 id=\"特性\"> 特性</h2>\n<ul>\n<li><strong>Code First</strong></li>\n</ul>\n<p>支持efcore的code first支持表结构的迁移自动化。</p>\n<ul>\n<li><strong>自定义路由</strong></li>\n</ul>\n<p>支持对数据分表/分库的自定义路由，可以满足几乎90%的业务分表/分库规则，并且支持外部传入配置</p>\n<ul>\n<li><strong>默认路由</strong></li>\n</ul>\n<p>针对分表默认提供多种路由:int取模,string取模,long时间按年月周日分表,DateTime时间按年月周日分表，并且按时间分表支持自动创建对应的表无需手动处理</p>\n<ul>\n<li><strong>分片字段任意类型</strong></li>\n</ul>\n<p>支持分片字段为任意类型的字段比如按时间分片(支持 datetime,long,int...)</p>\n<ul>\n<li><strong>join、group</strong></li>\n</ul>\n<p>支持分片对象和非分片对象的join group by，并且支持分片对象和分片对象的join group by</p>\n<ul>\n<li><strong>高性能分页</strong></li>\n</ul>\n<p>具有极少数的客户端分片中间件下才有的流式聚合，和特定的高性能分页，具有低内存高性能O(n),并且支持顺序分页，反向分页，追加排序</p>\n<ul>\n<li><strong>手动路由</strong></li>\n</ul>\n<p>支持分片查询指定分片表，和断言分片表</p>\n<ul>\n<li><strong>批量操作</strong></li>\n</ul>\n<p>支持efcore生态下的所有批量操作组件</p>\n<ul>\n<li><strong>自动追踪</strong></li>\n</ul>\n<p>是efcore分片中间件下为数不多的支持自动追踪的</p>\n<ul>\n<li><strong>沉浸式编码</strong></li>\n</ul>\n<p>支持在编写数据库的crud的时候保证使用体验和efcore原生编码一样，无需学习成本</p>\n<ul>\n<li><strong>多字段分片</strong></li>\n</ul>\n<p>本框架支持查询时通过额外字段来进行快速索引</p>\n<ul>\n<li><strong>多数据库支持</strong></li>\n</ul>\n<p>只要是efcore2+支持的数据库sharding-core都是支持的</p>\n<ul>\n<li><strong>动态分库</strong></li>\n</ul>\n<p>支持动态分库对需要的对象进行动态分库添加</p>\n<ul>\n<li><strong>动态读写分离</strong></li>\n</ul>\n<p>针对其支持动态读写分离</p>\n<ul>\n<li><strong>动态多配置</strong></li>\n</ul>\n<p>支持动态多配置,并且支持动态多数据库类型(用户自行实现多个<code>IShardingRuntimeContext</code>即可)</p>\n<p>别犹豫了，赶快上手吧</p>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2022-07-06T04:55:30.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "快速上手",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/quick-start/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide%20copy/quick-start/",
      "content_html": "<h2 id=\"版本\"> 版本</h2>\n<p>sharding-core 目前为止以efcore版本号作为主版本，所以您会在nuget上看到2.x,3.x,5.x的版本,如果需要请安装最新版nuget上的efcore版本对应的sharding-core版本</p>\n<div><p>注意</p>\n<p>如果nuget上的sharding-core版本不适合您目前的efcore版本并且您目前不想升级对应的efcore版本，请自行下载程序进行源码编译替换成您所需要的efcore版本</p>\n</div>\n<h2 id=\"安装和启动\"> 安装和启动</h2>\n<div><pre><code><span># 请对应安装您需要的版本</span>\nPM<span>></span> Install-Package ShardingCore -Version LastVersion\n</code></pre>\n<div><span>1</span><br><span>2</span><br></div></div><h2 id=\"使用efcore\"> 使用efcore</h2>\n<ol>\n<li>首先我们创建一个空的控制台程序</li>\n</ol>\n<div><pre><code><span># 创建一个目录用于测试</span>\n<span>mkdir</span> EFCoreSharding\n\n<span># 进入创建的目录</span>\n<span>cd</span> EFCoreSharding\n\n<span># 创建一个空的控制台程序</span>\ndotnet new console\n\n<span># 添加efcore 测试我们采用sqlserver作为测试数据库，其他数据库用法一致</span>\ndotnet <span>add</span> package Microsoft.EntityFrameworkCore.SqlServer --version <span>5.0</span>.11\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><div><p>注意</p>\n<p>这边我们文档编写时控制台程序为net5.0，所以我们这边选择了efcore5的版本的最新版，具体请参考您自己的项目</p>\n</div>\n<ol start=\"2\">\n<li>创建订单对象<code>Order</code>：</li>\n</ol>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 订单表</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>Order</span>\n<span>{</span>\n    <span>/// &lt;summary></span>\n    <span>/// 订单Id</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>/// &lt;summary></span>\n    <span>/// 付款用户名</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span><span>string</span></span> Payer <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>/// &lt;summary></span>\n    <span>/// 付款金额分</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span><span>long</span></span> Money <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>/// &lt;summary></span>\n    <span>/// 创建时间</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span>DateTime</span> CreateTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>/// &lt;summary></span>\n    <span>/// 是否已删除</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span><span>bool</span></span> IsDelete <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br></div></div><ol start=\"3\">\n<li>创建efcore的dbcontext</li>\n</ol>\n<div><pre><code><span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>DbContext</span></span>\n<span>{</span>\n    <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span><span>:</span><span>base</span><span>(</span>options<span>)</span>\n    <span>{</span>\n        \n    <span>}</span>\n\n    <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n    <span>{</span>\n        <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n        modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>o <span>=></span>\n        <span>{</span>\n            o<span>.</span><span>HasKey</span><span>(</span>p <span>=></span> p<span>.</span>Id<span>)</span><span>;</span>\n            o<span>.</span><span>Property</span><span>(</span>p <span>=></span> p<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>40</span><span>)</span><span>.</span><span>HasComment</span><span>(</span><span>\"订单Id\"</span><span>)</span><span>;</span>\n            o<span>.</span><span>Property</span><span>(</span>p <span>=></span> p<span>.</span>Payer<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>.</span><span>HasComment</span><span>(</span><span>\"付款用户名\"</span><span>)</span><span>;</span>\n            o<span>.</span><span>Property</span><span>(</span>p <span>=></span> p<span>.</span>Money<span>)</span><span>.</span><span>HasComment</span><span>(</span><span>\"付款金额分\"</span><span>)</span><span>;</span>\n            o<span>.</span><span>Property</span><span>(</span>p <span>=></span> p<span>.</span>CreateTime<span>)</span><span>.</span><span>HasComment</span><span>(</span><span>\"创建时间\"</span><span>)</span><span>;</span>\n            o<span>.</span><span>Property</span><span>(</span>p <span>=></span> p<span>.</span>IsDelete<span>)</span><span>.</span><span>HasComment</span><span>(</span><span>\"是否已删除\"</span><span>)</span><span>;</span>\n            o<span>.</span><span>HasQueryFilter</span><span>(</span>p <span>=></span> p<span>.</span>IsDelete <span>==</span> <span>false</span><span>)</span><span>;</span>\n            o<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n        <span>}</span><span>)</span><span>;</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br></div></div><ol start=\"4\">\n<li>启动配置efcore并且插入对应的数据</li>\n</ol>\n<p>在<code>Program</code>的<code>Main</code>函数下添加如下代码</p>\n<div><pre><code><span>class</span> <span>Program</span>\n<span>{</span>\n    <span>static</span> <span><span>void</span></span> <span>Main</span><span>(</span><span><span>string</span><span>[</span><span>]</span></span> args<span>)</span>\n    <span>{</span>\n        <span>IServiceCollection</span> services <span>=</span> <span>new</span> <span>ServiceCollection</span><span>(</span><span>)</span><span>;</span>\n        services<span>.</span><span>AddLogging</span><span>(</span><span>)</span><span>;</span>\n        services<span>.</span><span><span>AddDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span>o <span>=></span> o<span>.</span><span>UseSqlServer</span><span>(</span><span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDB;Integrated Security=True;\"</span><span>)</span><span>)</span><span>;</span>\n        <span><span>var</span></span> buildServiceProvider <span>=</span> services<span>.</span><span>BuildServiceProvider</span><span>(</span><span>)</span><span>;</span>\n        <span>using</span> <span>(</span><span><span>var</span></span> scope <span>=</span> buildServiceProvider<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> myDbContext <span>=</span> scope<span>.</span>ServiceProvider<span>.</span><span><span>GetService</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n            <span>//如果不存在就创建数据库和对应的数据库表</span>\n            myDbContext<span>.</span>Database<span>.</span><span>EnsureCreated</span><span>(</span><span>)</span><span>;</span>\n\n            <span><span>var</span></span> now <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span><span>1</span><span>,</span><span>1</span><span>)</span><span>;</span>\n            <span><span>var</span></span> orders <span>=</span> Enumerable<span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span><span>10</span><span>)</span><span>.</span><span>Select</span><span>(</span><span>(</span>o<span>,</span>i<span>)</span><span>=></span><span>new</span> <span>Order</span><span>(</span><span>)</span>\n            <span>{</span>\n                Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                CreateTime <span>=</span> now<span>.</span><span>AddDays</span><span>(</span>i<span>)</span><span>,</span>\n                Payer <span>=</span> <span><span>$\"用户:</span><span><span>{</span><span>i</span><span>}</span></span><span>\"</span></span><span>,</span>\n                Money <span>=</span> i<span>*</span><span>100</span><span>,</span>\n                IsDelete <span>=</span> <span>false</span>\n            <span>}</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n            myDbContext<span>.</span><span>AddRange</span><span>(</span>orders<span>)</span><span>;</span>\n            myDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br></div></div><div><p>提示</p>\n<ol>\n<li>这边我们采用的是<code>myDbContext.Database.EnsureCreated();</code>方法可以保证第一次创建对应的表和库。</li>\n<li>并不是所有的efcore都需要按我这种写法,具体按您自己的原先的使用即可。</li>\n<li>程序运行后可以看到数据库和表被创建并且数据被插入到对应的数据库里面了。</li>\n</ol>\n</div>\n<h2 id=\"efcore升级到sharding-core\"> efcore升级到sharding-core</h2>\n<p>目前efcore的使用是单表单库的和实体对象是一对一的，我们将对此进行升级，添加sharding-core的支持，目前我们这边有两种方式可以配置<code>Order</code>支持分表分库：</p>\n<h3 id=\"添加sharding-core包\"> 添加sharding-core包</h3>\n<div><pre><code>dotnet <span>add</span> package ShardingCore --version <span>5.3</span>.1.19\n</code></pre>\n<div><span>1</span><br></div></div><div><p>提示</p>\n<p>根据项目自己选择sharding-core 2.x/3.x/5.x......的最新版本.</p>\n</div>\n<h3 id=\"删除掉原先的数据库\"> 删除掉原先的数据库</h3>\n<p>因为目前还没有涉及到code-first的用法所以目前我们先对其进行数据库的重建</p>\n<h3 id=\"虚拟路由配置-推荐\"> 虚拟路由配置(推荐)</h3>\n<p>首先我们针对当前已有的项目进行<code>Order</code>分表的配置,路由规则订单按Id取模</p>\n<ol>\n<li>创建分表路由<code>OrderVirtualTableRoute</code></li>\n</ol>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 创建虚拟路由</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>OrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n<span>{</span>\n    <span>public</span> <span>OrderVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n    <span>{</span>\n    <span>}</span>\n\n    <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n    <span>{</span>\n        builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        builder<span>.</span><span>AutoCreateTable</span><span>(</span><span>null</span><span>)</span><span>;</span>\n        builder<span>.</span><span>TableSeparator</span><span>(</span><span>\"_\"</span><span>)</span><span>;</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><div><p>提示</p>\n<ol>\n<li><code>ShardingProperty</code>必须指定,表示具体按什么字段进行分表</li>\n<li><code>AutoCreateTable</code>可选,表示是否需要在<strong>启动</strong>的时候建表:null表示根据全局配置,true:表示需要,false:表示不需要,默认null</li>\n<li><code>TableSeparator</code>可选,表示分表后缀和虚拟表名之间的分隔连接符,默认<code>_</code></li>\n<li><code>AbstractSimpleShardingModKeyStringVirtualTableRoute&lt;Order&gt;</code>由sharding-core提供的默认取模分表规则,其中2代表分表后尾巴有两位,3表示按3取模所以后缀为:00,01,02。因为最多2位所以可以最多到99,如果需要了解更多路由<a href=\"/sharding-core-doc/pages/defaultroute\">默认路由</a></li>\n</ol>\n</div>\n<h3 id=\"接口特性配置\"> 接口特性配置</h3>\n<p>除了路由配置您还可以使用接口和特性来实现</p>\n<ol>\n<li>让订单<code>Order</code>继承<code>IShardingTable</code></li>\n</ol>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 订单表</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>Order</span><span>:</span><span><span>IShardingTable</span></span>\n<span>{</span>\n  <span>//.....</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><ol start=\"2\">\n<li>对<code>Order</code>需要分表的字段进行分表字段特性添加(仅支持一个分表字段)</li>\n</ol>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 订单表</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>Order</span><span>:</span><span><span>IShardingTable</span></span>\n<span>{</span>\n  <span>/// &lt;summary></span>\n  <span>/// 订单Id</span>\n  <span>/// &lt;/summary></span>\n  <span>[</span>ShardingTableKey<span>]</span>\n  <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n  <span>//.....</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></div></div><ol start=\"3\">\n<li>创建分表路由<code>OrderVirtualTableRoute</code></li>\n</ol>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 创建虚拟路由</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>OrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n<span>{</span>\n    <span>public</span> <span>OrderVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n    <span>{</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><div><p>提示</p>\n<ol>\n<li><code>ShardingTableKey</code>特性表示对应的属性是需要被分表的字段,如：<code>Order</code>对象通过<code>Id</code>属性来进行分表</li>\n<li>按接口+特性分表我们发现虚拟路由里面将不需要配置对应的方法<code>Configure</code></li>\n<li>推荐使用第一种路由处配置对应的分表信息</li>\n</ol>\n</div>\n<h3 id=\"配置dbcontext\"> 配置dbcontext</h3>\n<p>替换<code>MyDbContext</code>的父类</p>\n<div><pre><code><span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span><span>IShardingTableDbContext</span></span>\n<span>{</span>\n    <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span><span>:</span><span>base</span><span>(</span>options<span>)</span>\n    <span>{</span>\n        \n    <span>}</span>\n    <span>//....</span>\n    <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><div><p>提示</p>\n<ol>\n<li><code>AbstractShardingDbContext</code>是系统默认实现了<code>IShardingDbContext</code>的抽象类,你也可以自行实现</li>\n<li><code>IShardingTableDbContext</code>继承该接口的<code>DbContext</code>表示需要实现分表功能,如果您只需要分库那么可以不继承该对象</li>\n</ol>\n</div>\n<h2 id=\"启动配置\"> 启动配置</h2>\n<p>介绍完两种配置后下面我们开始对程序进行</p>\n<p>目前sharding-core支持两种配置方式,两种配置方式一样</p>\n<ol>\n<li>通过<code>services.AddShardingDbContext&lt;MyDbContext&gt;()</code>,</li>\n<li>通过在原先的配置<code>services.AddDbContext&lt;MyDbContext&gt;()</code>后追加新的配置<code>services.AddShardingConfigure&lt;MyDbContext&gt;()</code>,</li>\n</ol>\n<div><p>提示</p>\n<ol>\n<li>两种配置方式一样,第一种是对第二种的封装而已,具体使用那种都可以按自己的需要</li>\n<li>原<code>AddDbContext</code>需要添加配置<code>UseSharding&lt;MyDbContext&gt;()</code></li>\n</ol>\n</div>\n<div><pre><code><span>class</span> <span>Program</span>\n<span>{</span>\n    <span>static</span> <span><span>void</span></span> <span>Main</span><span>(</span><span><span>string</span><span>[</span><span>]</span></span> args<span>)</span>\n    <span>{</span>\n        <span>IServiceCollection</span> services <span>=</span> <span>new</span> <span>ServiceCollection</span><span>(</span><span>)</span><span>;</span>\n        services<span>.</span><span>AddLogging</span><span>(</span><span>)</span><span>;</span>\n        <span>//原来的dbcontext配置</span>\n        services<span>.</span><span><span>AddDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span>o <span>=></span>\n            o<span>.</span><span>UseSqlServer</span><span>(</span><span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDB;Integrated Security=True;\"</span><span>)</span>\n                <span>.</span><span><span>UseSharding</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>//需要添加</span>\n            <span>)</span><span>;</span>\n        <span>//额外添加分片配置</span>\n        services<span>.</span><span><span>AddShardingConfigure</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>(</span>conn<span>,</span> builder<span>)</span> <span>=></span>\n            <span>{</span>\n                builder<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>.</span><span>Begin</span><span>(</span>o <span>=></span>\n            <span>{</span>\n                o<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                o<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n            <span>}</span><span>)</span><span>.</span><span>AddShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n            <span>{</span>\n                builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>.</span><span>AddDefaultDataSource</span><span>(</span>Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>.</span><span>ToString</span><span>(</span><span>\"n\"</span><span>)</span><span>,</span>\n                <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDB;Integrated Security=True;\"</span><span>)</span>\n            <span>.</span><span>AddShardingTableRoute</span><span>(</span>op <span>=></span>\n            <span>{</span>\n                op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>.</span><span>End</span><span>(</span><span>)</span><span>;</span>\n\n        <span><span>var</span></span> buildServiceProvider <span>=</span> services<span>.</span><span>BuildServiceProvider</span><span>(</span><span>)</span><span>;</span>\n        <span>//启动必备</span>\n        buildServiceProvider<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n        <span>using</span> <span>(</span><span><span>var</span></span> scope <span>=</span> buildServiceProvider<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> myDbContext <span>=</span> scope<span>.</span>ServiceProvider<span>.</span><span><span>GetService</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n            <span>//如果不存在就创建数据库和对应的数据库表</span>\n            <span>//myDbContext.Database.EnsureCreated();//注释掉不然会创建虚拟表，虚拟表其实没什么用</span>\n\n            <span><span>var</span></span> now <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span><span>1</span><span>,</span><span>1</span><span>)</span><span>;</span>\n            <span><span>var</span></span> orders <span>=</span> Enumerable<span>.</span><span>Range</span><span>(</span><span>0</span><span>,</span><span>10</span><span>)</span><span>.</span><span>Select</span><span>(</span><span>(</span>o<span>,</span>i<span>)</span><span>=></span><span>new</span> <span>Order</span><span>(</span><span>)</span>\n            <span>{</span>\n                Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                CreateTime <span>=</span> now<span>.</span><span>AddDays</span><span>(</span>i<span>)</span><span>,</span>\n                Payer <span>=</span> <span><span>$\"用户:</span><span><span>{</span><span>i</span><span>}</span></span><span>\"</span></span><span>,</span>\n                Money <span>=</span> i<span>*</span><span>100</span><span>,</span>\n                IsDelete <span>=</span> <span>false</span>\n            <span>}</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n            myDbContext<span>.</span><span>AddRange</span><span>(</span>orders<span>)</span><span>;</span>\n            myDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br></div></div><p>启动项目后我们可以看到程序会自动创建数据库和表结构，并且会按照我们设定的规则进行取模插入,并且逻辑表名<code>Order</code>将不会存在于数据库</p>\n<div><p>警告</p>\n<p>！！！如果您使用第二种配置,那么请对<code>services.AddDbContext&lt;MyDbContext&gt;()</code>配置内部使用的数据库连接字符串和后续的<code>AddDefaultDataSource</code>中添加的字符串一致不然会导致无法使用事务。</p>\n<p>！！！如果您使用第二种配置,那么请对<code>services.AddDbContext&lt;MyDbContext&gt;()</code>配置内部使用的数据库连接字符串和后续的<code>AddDefaultDataSource</code>中添加的字符串一致不然会导致无法使用事务。</p>\n<p>！！！如果您使用第二种配置,那么请对<code>services.AddDbContext&lt;MyDbContext&gt;()</code>配置内部使用的数据库连接字符串和后续的<code>AddDefaultDataSource</code>中添加的字符串一致不然会导致无法使用事务。</p>\n</div>\n<div><p>提示</p>\n<ol>\n<li>如果程序无法启动请确保一下几点，确认是否已经注入原生的efcore的DbContext,并且在原生的后续对DbContextOptions进行了<code>UseSharding&lt;MyDbContext&gt;()</code>配置</li>\n<li>是否配置了额外分片<code>AddShardingConfigure</code>(第一种配置可以忽略)，是否创建了通过字符串委托和链接委托</li>\n<li>default data source 的连接字符串是否和默认dbcontext创建的一致</li>\n<li>是否添加了分表路由<code>AddShardingTableRoute(op =&gt;{op.AddShardingTableRoute&lt;OrderVirtualTableRoute&gt;();})</code></li>\n<li>是否启动了分表启动器<code>buildServiceProvider.GetRequiredService&lt;IShardingBootstrapper&gt;().Start();</code></li>\n</ol>\n</div>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2022-01-07T14:00:26.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "x.5升级到x.6指南",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide-upgrade-5-6/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide-upgrade-5-6/",
      "content_html": "<h2 id=\"说明\"> 说明</h2>\n<p>如果您目前是处于比较低的版本建议一步一步升级上来,目前而言x.6版本有着很大的一个变动,基本上对于很多用户而言使用上会有差异</p>\n<h2 id=\"优点\"> 优点</h2>\n<ul>\n<li>对于原先的所有<code>ShardingCore</code>的版本是通过静态方法<code>ShardingContaner</code>来调用的，导致程序整个生命周期只有一个配置项,并且是静态的,就会导致系统对于同一个<code>DbContext</code>类型是没办法采用多种配置手段的,而且对于code-first而言的使用体验上也是欠佳的,而新版本将其整个框架只和一个分片运行上下文关联<code>IShardingRuntimeContext</code>而不是原先的<code>ShardingContaner</code></li>\n</ul>\n<h2 id=\"注意点\"> 注意点</h2>\n<ul>\n<li>6版本将不在依赖DbContextType,所以所有的原先依赖注入的泛型方法全部失效,并且无法注入，取而代之的是<code>IShardingRuntimeContext</code>,可以使用依赖注入来注入,也可以通过dbcontext获取,更可以用户赋值给静态属性,完全由用户定义</li>\n<li>之前所有的依赖注入获取的东西将全部由<code>IShardingRuntimeContext</code>提供</li>\n<li>因为整个<code>efcore</code>在<code>ShardingCore</code>中仅依赖<code>IShardingRuntimeContext</code>,所以不同<code>IShardingRuntimeContext</code>对efcore而言就是不同的配置,所以目前移除掉多配置(多租户模式),用户可以自行实现。</li>\n<li>原先Migrations迁移操作需要新建一个控制台程序,并且迁移后的更新数据库不支持分库数据库,所以为了用户的使用体验,进行了优化兼容升级</li>\n<li>原先的设计虚拟表，虚拟表管理者被移除,直接使用路由管理者管理路由,移除了物理表,虚拟表,虚拟表管理者这个概念</li>\n<li>启动后创建分表分库将由原先的配置改成手动调用,这样可以自己选择符合的实际</li>\n<li>默认使用efcore将不在依赖整个启动器,只需要依赖轻量级的上下文即可</li>\n</ul>\n<h2 id=\"原先startup\"> 原先startup</h2>\n<p>x.4.x.x-x.5.x.x版本</p>\n<div><pre><code>\n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>ShardingDefaultDbContext<span>></span></span></span><span>(</span><span>)</span>\n                <span>.</span><span>AddEntityConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    <span>//如果您使用code-first建议选择false</span>\n                    op<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                    <span>//如果您使用code-first建议修改为fsle</span>\n                    op<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n                    <span>//当无法获取路由时会返回默认值而不是报错</span>\n                    op<span>.</span>ThrowIfQueryRouteNotMatch <span>=</span> <span>false</span><span>;</span>\n                    <span>//这边设置了如果AddConfig没设置就是用这边的</span>\n                    <span>//op.UseShardingQuery((conStr, builder) =></span>\n                    <span>//{</span>\n                    <span>//    builder.UseSqlServer(conStr).UseLoggerFactory(efLogger);</span>\n                    <span>//});</span>\n                    <span>//op.UseShardingTransaction((connection, builder) =></span>\n                    <span>//{</span>\n                    <span>//    builder.UseSqlServer(connection).UseLoggerFactory(efLogger);</span>\n                    <span>//});</span>\n                    op<span>.</span><span><span>AddShardingDataSourceRoute</span><span><span>&lt;</span>OrderAreaShardingVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserModVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserSalaryVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderCreateTimeVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogDayVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogWeekDateTimeVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogWeekTimeLongVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogYearDateTimeVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogMonthLongvirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogYearLongVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserModIntVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogDayLongVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>MultiShardingOrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n\n                <span>}</span><span>)</span>\n                <span>.</span><span>AddConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span>ConfigId<span>=</span><span>\"c1\"</span><span>;</span>\n                    <span>//op.Priority = 1;</span>\n\n                    op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conStr<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n\n                    op<span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"A\"</span><span>,</span>\n                        <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBA;Integrated Security=True;\"</span><span>)</span><span>;</span>\n                    op<span>.</span><span>AddExtraDataSource</span><span>(</span>sp <span>=></span>\n                    <span>{</span>\n                        <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span> <span>\"B\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBB;Integrated Security=True;\"</span> <span>}</span><span>,</span>\n                        <span>{</span> <span>\"C\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBC;Integrated Security=True;\"</span> <span>}</span><span>,</span>\n                    <span>}</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>AddReadWriteSeparation</span><span>(</span>sp <span>=></span>\n                    <span>{</span>\n                        <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> IEnumerable<span>&lt;</span><span>string</span><span>></span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span>\n                            <span>\"A\"</span><span>,</span> <span>new</span> <span>HashSet<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n                            <span>{</span>\n                                <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBB;Integrated Security=True;\"</span>\n                            <span>}</span>\n                        <span>}</span>\n                    <span>}</span><span>;</span>\n                    <span>}</span><span>,</span> ReadStrategyEnum<span>.</span>Loop<span>,</span> <span>defaultEnable</span><span>:</span> <span>false</span><span>,</span> <span>readConnStringGetStrategy</span><span>:</span> ReadConnStringGetStrategyEnum<span>.</span>LatestEveryTime<span>)</span><span>;</span>\n                    op<span>.</span><span>ReplaceTableEnsureManager</span><span>(</span>sp <span>=></span> <span>new</span> <span>SqlServerTableEnsureManager<span>&lt;</span>ShardingDefaultDbContext<span>></span></span><span>(</span><span>)</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>EnsureConfig</span><span>(</span><span>)</span><span>;</span>\n\n\n\n                <span>//必须且必须在调用这个方法后才可以使用dbcontext</span>\n                app<span>.</span>ApplictaionServices<span>.</span><span><span>GetService</span><span><span>&lt;</span>IShardingBootStrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br></div></div><h2 id=\"现在的startup\"> 现在的startup</h2>\n<p>x.6.x.x+</p>\n<div><pre><code>\n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>ShardingDefaultDbContext<span>></span></span></span><span>(</span><span>)</span>\n                <span>.</span><span>UseRouteConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span><span><span>AddShardingDataSourceRoute</span><span><span>&lt;</span>OrderAreaShardingVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserModVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserSalaryVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderCreateTimeVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogDayVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogWeekDateTimeVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogWeekTimeLongVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogYearDateTimeVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogMonthLongvirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogYearLongVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserModIntVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>LogDayLongVirtualRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>MultiShardingOrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n\n                <span>}</span><span>)</span>\n                <span>.</span><span>UseConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    <span>//当无法获取路由时会返回默认值而不是报错</span>\n                    op<span>.</span>ThrowIfQueryRouteNotMatch <span>=</span> <span>false</span><span>;</span>\n                    <span>//忽略建表错误compensate table和table creator</span>\n                    op<span>.</span>IgnoreCreateTableError <span>=</span> <span>true</span><span>;</span>\n                    <span>//迁移时使用的并行线程数(分库有效)defaultShardingDbContext.Database.Migrate()</span>\n                    op<span>.</span>MigrationParallelCount <span>=</span> Environment<span>.</span>ProcessorCount<span>;</span>\n                    <span>//补偿表创建并行线程数 调用UseAutoTryCompensateTable有效</span>\n                    op<span>.</span>CompensateTableParallelCount <span>=</span> Environment<span>.</span>ProcessorCount<span>;</span>\n                    <span>//最大连接数限制</span>\n                    op<span>.</span>MaxQueryConnectionsLimit <span>=</span> Environment<span>.</span>ProcessorCount<span>;</span>\n                    <span>//链接模式系统默认</span>\n                    op<span>.</span>ConnectionMode <span>=</span> ConnectionModeEnum<span>.</span>SYSTEM_AUTO<span>;</span>\n                    <span>//如何通过字符串查询创建DbContext</span>\n                    op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conStr<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    <span>//如何通过事务创建DbContext</span>\n                    op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    <span>//添加默认数据源</span>\n                    op<span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"A\"</span><span>,</span>\n                        <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBA;Integrated Security=True;\"</span><span>)</span><span>;</span>\n                    <span>//添加额外数据源</span>\n                    op<span>.</span><span>AddExtraDataSource</span><span>(</span>sp <span>=></span>\n                    <span>{</span>\n                        <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span> <span>\"B\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBB;Integrated Security=True;\"</span> <span>}</span><span>,</span>\n                        <span>{</span> <span>\"C\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBC;Integrated Security=True;\"</span> <span>}</span><span>,</span>\n                    <span>}</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    <span>//添加读写分离</span>\n                    op<span>.</span><span>AddReadWriteSeparation</span><span>(</span>sp <span>=></span>\n                    <span>{</span>\n                        <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> IEnumerable<span>&lt;</span><span>string</span><span>></span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span>\n                            <span>\"A\"</span><span>,</span> <span>new</span> <span>HashSet<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n                            <span>{</span>\n                                <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBB;Integrated Security=True;\"</span>\n                            <span>}</span>\n                        <span>}</span>\n                    <span>}</span><span>;</span>\n                    <span>}</span><span>,</span> ReadStrategyEnum<span>.</span>Loop<span>,</span> <span>defaultEnable</span><span>:</span> <span>false</span><span>,</span> <span>readConnStringGetStrategy</span><span>:</span> ReadConnStringGetStrategyEnum<span>.</span>LatestEveryTime<span>)</span><span>;</span>\n                <span>}</span><span>)</span>\n                <span>.</span><span><span>ReplaceService</span><span><span>&lt;</span>ITableEnsureManager<span>,</span>SqlServerTableEnsureManager<span>></span></span></span><span>(</span><span>)</span>\n                <span>.</span><span>AddShardingCore</span><span>(</span><span>)</span><span>;</span>\n\n\n\n\n            <span>//启动ShardingCore创建表任务(不调用也可以使用ShardingCore)</span>\n            <span>//不调用会导致定时任务不会开启</span>\n            app<span>.</span>ApplictaionServices<span>.</span><span>UseAutoShardingCreate</span><span>(</span><span>)</span><span>;</span>\n            <span>//启动进行表补偿(不调用也可以使用ShardingCore)</span>\n            app<span>.</span>ApplictaionServices<span>.</span><span>UseAutoTryCompensateTable</span><span>(</span><span>)</span><span>;</span>\n\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br></div></div><h2 id=\"区别\"> 区别</h2>\n<table>\n<thead>\n<tr>\n<th>功能</th>\n<th>说明</th>\n<th>x.5</th>\n<th>x.6</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CreateShardingTableOnStart</td>\n<td>启动创建分表</td>\n<td>√</td>\n<td>UseAutoTryCompensateTable</td>\n</tr>\n<tr>\n<td>EnsureCreatedWithOutShardingTable</td>\n<td>创建库和非分表的表</td>\n<td>√</td>\n<td>UseAutoTryCompensateTable</td>\n</tr>\n<tr>\n<td>CreateDataBaseOnlyOnStart</td>\n<td>启动仅创建库</td>\n<td>√</td>\n<td>UseAutoTryCompensateTable</td>\n</tr>\n<tr>\n<td>IgnoreCreateTableError</td>\n<td>忽略建表错误</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>ThrowIfQueryRouteNotMatch</td>\n<td>无法匹配路由报错</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>ConfigId</td>\n<td>配置id</td>\n<td>√</td>\n<td>-</td>\n</tr>\n<tr>\n<td>Priority</td>\n<td>配置优先级</td>\n<td>√</td>\n<td>-</td>\n</tr>\n<tr>\n<td>MaxQueryConnectionsLimit</td>\n<td>最大连接数</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>ConnectionMode</td>\n<td>默认链接模式</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>AddShardingTableRoute</td>\n<td>添加分表路由</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>AddShardingDataSourceRoute</td>\n<td>添加分库路由</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>MigrationParallelCount</td>\n<td>迁移并行数</td>\n<td>-</td>\n<td>√</td>\n</tr>\n<tr>\n<td>CompensateTableParallelCount</td>\n<td>补偿表并行数</td>\n<td>-</td>\n<td>√</td>\n</tr>\n<tr>\n<td>UseShardingQuery</td>\n<td>连接字符串创建DbContextOptions</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>UseShardingTransaction</td>\n<td>连接创建DbContextOptions</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>AddDefaultDataSource</td>\n<td>默认数据源</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>AddExtraDataSource</td>\n<td>额外数据源</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>AddReadWriteSeparation</td>\n<td>读写分离</td>\n<td>√</td>\n<td>√</td>\n</tr>\n<tr>\n<td>ReplaceTableEnsureManager</td>\n<td>替换表确认</td>\n<td>√</td>\n<td>使用ReplaceService</td>\n</tr>\n<tr>\n<td>IShardingBootStrapper.Start()</td>\n<td>启动ShardingCore</td>\n<td>√</td>\n<td>-</td>\n</tr>\n<tr>\n<td>UseAutoShardingCreate</td>\n<td>启动定时任务建表</td>\n<td>包含在Start</td>\n<td>√</td>\n</tr>\n<tr>\n<td>UseAutoTryCompensateTable</td>\n<td>补偿表</td>\n<td>√</td>\n<td>√</td>\n</tr>\n</tbody>\n</table>\n<p><strong>总结</strong>\n对于AspNetCore的升级迁移其实目前来看并不算很大</p>\n<ul>\n<li>1.移除了多配置,因为目前配置随着<code>IShardingRuntimeContext</code>进行整个DbContext的贯穿所以多配置可以用户自定义</li>\n<li>2.依赖注入全部不能使用,之前所有的依赖注入将全部通过<code>IShardingRuntimeContext</code>获取,\n<code>IShardingRuntimeContext</code>的内部依赖注入如果非应用程序依赖注入将无法获取应用本身的注入服务,<code>IShardingRuntimeContext</code>如果按上述注入那么可以依赖注入获取,如果静态注入那么可以通过静态属性获取,当然也可以通过DbContext获取</li>\n<li>3.ShardingContainer移除自行实现</li>\n<li>4.迁移默认支持分库,并且不再需要新建控制台和<code>DesginTimeFactory</code>来实现</li>\n<li>5.所有的参数配置从<code>AddEntityConfig</code>/<code>UseRouteConfig</code>迁移到了 <code>AddConfig</code>/<code>UseConfig</code>处</li>\n<li>6.所有的ShardingCore提供的泛型接口全部转成非泛型接口,因为<code>IShardingRuntimeContext</code>本身和<code>DbContext</code>类型并没有太多关系</li>\n<li>7.移除<code>ShardingContainer</code>静态方法自行处理</li>\n<li>8.移除<code>IVirtualDataSourceManager</code>本身默认移除静态方式所以不再支持多配置,用户可以通过自定义多个<code>IShardingRuntimeContext</code>来实现多配置</li>\n<li>9.移除<code>IDataSource</code>的路由功能,拆分到<code>IDataSourceRouteManager</code>里面</li>\n<li>10.移除<code>IVirtualTableManager</code>由于之前架构设计过于复杂导致使用起来很复杂并且概念很多,这次索性直接移除虚拟表概念直接由路由提供,可以通过<code>ITableRouteManager</code>来代替使用</li>\n<li>11.移除<code>IVirtualTable</code>概念</li>\n<li>12.移除<code>IPhysicTable</code>概念,表信息由<code>IEntityMetadataManager</code>的<code>EntityMetadata</code>提供</li>\n<li>13.<code>VirtualTableName</code>概念改成<code>LogicTableName</code>就是原先的未分表的表名</li>\n<li>14.如果你是abp或者其他自定义的DbContext需要实现的接口GetDbContext参数进行了改变由原先的bool类型isParallelQuery变成了创建生成枚举</li>\n</ul>\n",
      "date_published": "2022-07-06T04:55:30.000Z",
      "date_modified": "2022-07-06T04:55:30.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "x.5升级到x.6指南"
      ]
    },
    {
      "title": "快速上手老鸟",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/quick-start-old-bird/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/quick-start-old-bird/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次demo源码：<a href=\"https://github.com/xuejmnet/ShardingCoreDocDemo/tree/main/EFCoreSharding\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreSharding</a></p>\n<h2 id=\"快速开始\"> 快速开始</h2>\n<p>5步实现按月分表,且支持自动化建表建库</p>\n<h3 id=\"第一步安装依赖\"> 第一步安装依赖</h3>\n<p><code>ShardingCore</code>版本表现形式为a.b.c.d,其中a表示<code>efcore</code>的版本号,b表示<code>ShardingCore</code>的主版本号,c表示<code>ShardingCore</code>次级版本号,d表示<code>ShardingCore</code>的修订版本号</p>\n<div><pre><code><span># 请对应安装您需要的版本</span>\nPM<span>></span> Install-Package ShardingCore\n<span># use sqlserver</span>\nPM<span>></span> Install-Package Microsoft.EntityFrameworkCore.SqlServer\n<span>#  use mysql</span>\n<span>#PM> Install-Package Pomelo.EntityFrameworkCore.MySql</span>\n<span># use other database driver,if efcore support</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h3 id=\"第二步创建查询对象\"> 第二步创建查询对象</h3>\n<p>查询对象</p>\n<div><pre><code>\n    <span>/// &lt;summary></span>\n    <span>/// order table</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span>class</span> <span>Order</span>\n    <span>{</span>\n        <span>/// &lt;summary></span>\n        <span>/// order Id</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// payer id</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>string</span></span> Payer <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// pay money cent</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>long</span></span> Money <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// area</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// order status</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>OrderStatusEnum</span> OrderStatus <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// CreationTime</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>DateTime</span> CreationTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>enum</span> <span>OrderStatusEnum</span>\n    <span>{</span>\n        NoPay<span>=</span><span>1</span><span>,</span>\n        Paying<span>=</span><span>2</span><span>,</span>\n        Payed<span>=</span><span>3</span><span>,</span>\n        PayFail<span>=</span><span>4</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br></div></div><h3 id=\"第三步创建dbcontext\"> 第三步创建dbcontext</h3>\n<p>dbcontext <code>AbstractShardingDbContext</code>和<code>IShardingTableDbContext</code>如果你是普通的DbContext那么就继承<code>AbstractShardingDbContext</code>需要分表就实现<code>IShardingTableDbContext</code>,如果只有分库可以不实现<code>IShardingTableDbContext</code>接口</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span><span>IShardingTableDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Payer<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>OrderStatus<span>)</span><span>.</span><span><span>HasConversion</span><span><span>&lt;</span><span>int</span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// empty impl if use sharding table</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div><h3 id=\"第四步添加分表路由\"> 第四步添加分表路由</h3>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 创建虚拟路由</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>OrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n<span>{</span>\n    <span>public</span> <span>OrderVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n    <span>{</span>\n    <span>}</span>\n\n    <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n    <span>{</span>\n        builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        builder<span>.</span><span>AutoCreateTable</span><span>(</span><span>null</span><span>)</span><span>;</span>\n        builder<span>.</span><span>TableSeparator</span><span>(</span><span>\"_\"</span><span>)</span><span>;</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><div><p>提示</p>\n<ol>\n<li><code>ShardingProperty</code>必须指定,表示具体按什么字段进行分表</li>\n<li><code>AutoCreateTable</code>可选,表示是否需要在<strong>启动</strong>的时候建表:null表示根据全局配置,true:表示需要,false:表示不需要,默认null</li>\n<li><code>TableSeparator</code>可选,表示分表后缀和虚拟表名之间的分隔连接符,默认<code>_</code></li>\n<li><code>AbstractSimpleShardingModKeyStringVirtualTableRoute&lt;Order&gt;</code>由sharding-core提供的默认取模分表规则,其中2代表分表后尾巴有两位,3表示按3取模所以后缀为:00,01,02。因为最多2位所以可以最多到99,如果需要了解更多路由<a href=\"/sharding-core-doc/pages/defaultroute\">默认路由</a></li>\n</ol>\n</div>\n<h3 id=\"第五步配置启动项\"> 第五步配置启动项</h3>\n<p>无论你是何种数据库只需要修改<code>AddDefaultDataSource</code>里面的链接字符串 请不要修改委托内部的UseXXX参数 <code>conStr</code> and <code>connection</code></p>\n<div><pre><code>\n        <span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>\n        <span>{</span>\n\n            <span>//额外添加分片配置</span>\n            services<span>.</span><span><span>AddShardingConfigure</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n                <span>.</span><span>AddEntityConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                    op<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n                    op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conn<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>conn<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span>ConfigId <span>=</span> <span>\"c1\"</span><span>;</span>\n                    op<span>.</span><span>AddDefaultDataSource</span><span>(</span>Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>.</span><span>ToString</span><span>(</span><span>\"n\"</span><span>)</span><span>,</span>\n                        <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingTableDB;Integrated Security=True;\"</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>EnsureConfig</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>env<span>.</span><span>IsDevelopment</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                app<span>.</span><span>UseDeveloperExceptionPage</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n            <span>// it's importment don't forget it</span>\n            app<span>.</span>ApplicationServices<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n            <span>// other configure....</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br></div></div><p>这样所有的配置就完成了你可以愉快地对Order表进行按月分表了</p>\n<div><pre><code><span>[</span><span><span>Route</span><span><span>(</span><span>\"api/[controller]\"</span><span>)</span></span></span><span>]</span>\n<span>public</span> <span>class</span> <span>ValuesController</span> <span>:</span> <span><span>Controller</span></span>\n<span>{</span>\n        <span>private</span> <span>readonly</span> <span>MyDbContext</span> _myDbContext<span>;</span>\n\n        <span>public</span> <span>ValuesController</span><span>(</span><span>MyDbContext</span> myDbContext<span>)</span>\n        <span>{</span>\n            _myDbContext <span>=</span> myDbContext<span>;</span>\n        <span>}</span>\n\n        <span>[</span><span><span>HttpGet</span></span><span>]</span>\n        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Get</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> order <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"2\"</span><span>)</span><span>;</span>\n            <span>return</span> <span>OK</span><span>(</span>order<span>)</span>\n        <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br></div></div><div><p>提示</p>\n<ol>\n<li>如果程序无法启动请确保一下几点，确认是否已经注入原生的efcore的DbContext,并且在原生的后续对DbContextOptions进行了<code>UseSharding&lt;MyDbContext&gt;()</code>配置</li>\n<li>是否配置了额外分片<code>AddShardingConfigure</code>(第一种配置可以忽略)，是否创建了通过字符串委托和链接委托</li>\n<li>default data source 的连接字符串是否和默认dbcontext创建的一致</li>\n<li>是否添加了分表路由<code>op.AddShardingTableRoute&lt;OrderVirtualTableRoute&gt;();</code></li>\n<li>是否启动了分表启动器<code>buildServiceProvider.GetRequiredService&lt;IShardingBootstrapper&gt;().Start();</code></li>\n</ol>\n</div>\n",
      "date_published": "2021-12-17T00:57:21.000Z",
      "date_modified": "2022-01-07T14:00:26.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "快速上手控制台",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/quick-start-console/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/quick-start-console/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次demo源码：<a href=\"https://github.com/xuejmnet/ShardingCoreDocDemo/tree/main/EFCoreSharding\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreSharding</a></p>\n<h2 id=\"快速开始\"> 快速开始</h2>\n<p>5步实现按月分表,且支持自动化建表建库</p>\n<h3 id=\"第一步安装依赖\"> 第一步安装依赖</h3>\n<p><code>ShardingCore</code>版本表现形式为a.b.c.d,其中a表示<code>efcore</code>的版本号,b表示<code>ShardingCore</code>的主版本号,c表示<code>ShardingCore</code>次级版本号,d表示<code>ShardingCore</code>的修订版本号</p>\n<div><pre><code><span># 请对应安装您需要的版本</span>\nPM<span>></span> Install-Package ShardingCore\n<span># use sqlserver</span>\nPM<span>></span> Install-Package Microsoft.EntityFrameworkCore.SqlServer\n<span>#  use mysql</span>\n<span>#PM> Install-Package Pomelo.EntityFrameworkCore.MySql</span>\n<span># use other database driver,if efcore support</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h3 id=\"第二步创建查询对象\"> 第二步创建查询对象</h3>\n<p>查询对象</p>\n<div><pre><code>\n    <span>/// &lt;summary></span>\n    <span>/// order table</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span>class</span> <span>Order</span>\n    <span>{</span>\n        <span>/// &lt;summary></span>\n        <span>/// order Id</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// payer id</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>string</span></span> Payer <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// pay money cent</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>long</span></span> Money <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// area</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// order status</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>OrderStatusEnum</span> OrderStatus <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// CreationTime</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>DateTime</span> CreationTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>enum</span> <span>OrderStatusEnum</span>\n    <span>{</span>\n        NoPay<span>=</span><span>1</span><span>,</span>\n        Paying<span>=</span><span>2</span><span>,</span>\n        Payed<span>=</span><span>3</span><span>,</span>\n        PayFail<span>=</span><span>4</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br></div></div><h3 id=\"第三步创建dbcontext\"> 第三步创建dbcontext</h3>\n<p>dbcontext <code>AbstractShardingDbContext</code>和<code>IShardingTableDbContext</code>如果你是普通的DbContext那么就继承<code>AbstractShardingDbContext</code>需要分表就实现<code>IShardingTableDbContext</code>,如果只有分库可以不实现<code>IShardingTableDbContext</code>接口</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span><span>IShardingTableDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Payer<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>OrderStatus<span>)</span><span>.</span><span><span>HasConversion</span><span><span>&lt;</span><span>int</span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// empty impl if use sharding table</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div><h3 id=\"第四步添加分表路由\"> 第四步添加分表路由</h3>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 创建虚拟路由</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>OrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n<span>{</span>\n    <span>public</span> <span>OrderVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n    <span>{</span>\n    <span>}</span>\n\n    <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n    <span>{</span>\n        builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        builder<span>.</span><span>AutoCreateTable</span><span>(</span><span>null</span><span>)</span><span>;</span>\n        builder<span>.</span><span>TableSeparator</span><span>(</span><span>\"_\"</span><span>)</span><span>;</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><div><p>提示</p>\n<ol>\n<li><code>ShardingProperty</code>必须指定,表示具体按什么字段进行分表</li>\n<li><code>AutoCreateTable</code>可选,表示是否需要在<strong>启动</strong>的时候建表:null表示根据全局配置,true:表示需要,false:表示不需要,默认null</li>\n<li><code>TableSeparator</code>可选,表示分表后缀和虚拟表名之间的分隔连接符,默认<code>_</code></li>\n<li><code>AbstractSimpleShardingModKeyStringVirtualTableRoute&lt;Order&gt;</code>由sharding-core提供的默认取模分表规则,其中2代表分表后尾巴有两位,3表示按3取模所以后缀为:00,01,02。因为最多2位所以可以最多到99,如果需要了解更多路由<a href=\"/sharding-core-doc/pages/defaultroute\">默认路由</a></li>\n</ol>\n</div>\n<h3 id=\"第五步配置启动项\"> 第五步配置启动项</h3>\n<p>无论你是何种数据库只需要修改<code>AddDefaultDataSource</code>里面的链接字符串 请不要修改委托内部的UseXXX参数 <code>conStr</code> and <code>connection</code></p>\n<div><pre><code>\n        <span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>\n        <span>{</span>\n\n            <span>//添加分片配置</span>\n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n                <span>.</span><span>AddEntityConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                    op<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n                    op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conn<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>conn<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span>ConfigId <span>=</span> <span>\"c1\"</span><span>;</span>\n                    op<span>.</span><span>AddDefaultDataSource</span><span>(</span>Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>.</span><span>ToString</span><span>(</span><span>\"n\"</span><span>)</span><span>,</span>\n                        <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingTableDB;Integrated Security=True;\"</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>EnsureConfig</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>env<span>.</span><span>IsDevelopment</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                app<span>.</span><span>UseDeveloperExceptionPage</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n            <span>// it's importment don't forget it</span>\n            app<span>.</span>ApplicationServices<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n            <span>// other configure....</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br></div></div><p>这样所有的配置就完成了你可以愉快地对Order表进行按月分表了</p>\n<div><pre><code><span>[</span><span><span>Route</span><span><span>(</span><span>\"api/[controller]\"</span><span>)</span></span></span><span>]</span>\n<span>public</span> <span>class</span> <span>ValuesController</span> <span>:</span> <span><span>Controller</span></span>\n<span>{</span>\n        <span>private</span> <span>readonly</span> <span>MyDbContext</span> _myDbContext<span>;</span>\n\n        <span>public</span> <span>ValuesController</span><span>(</span><span>MyDbContext</span> myDbContext<span>)</span>\n        <span>{</span>\n            _myDbContext <span>=</span> myDbContext<span>;</span>\n        <span>}</span>\n\n        <span>[</span><span><span>HttpGet</span></span><span>]</span>\n        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Get</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> order <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"2\"</span><span>)</span><span>;</span>\n            <span>return</span> <span>OK</span><span>(</span>order<span>)</span>\n        <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br></div></div><div><p>提示</p>\n<ol>\n<li>如果程序无法启动请确保一下几点，确认是否已经注入原生的efcore的DbContext,并且在原生的后续对DbContextOptions进行了<code>UseSharding&lt;MyDbContext&gt;()</code>配置</li>\n<li>目前<code>ShardingCore</code>提供了三种配置方式</li>\n</ol>\n<ul>\n<li>1.默认配置</li>\n</ul>\n<div><pre><code>services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br></div></div><p>这个配置包含了<code>AddDbContext</code>+<code>AddShardingConfigure</code></p>\n<ul>\n<li>2.额外配置</li>\n</ul>\n<div><pre><code>  <span>//原来的dbcontext配置</span>\n  services<span>.</span><span><span>AddDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span>DIExtension<span>.</span>UseDefaultSharding<span>&lt;</span>MyDbContext<span>></span><span>)</span><span>;</span>\n  <span>//额外添加分片配置</span>\n  services<span>.</span><span><span>AddShardingConfigure</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><ul>\n<li>3.字符串配置适合单配置的情况下</li>\n</ul>\n<div><pre><code>  <span>//原来的dbcontext配置</span>\n  services<span>.</span><span><span>AddDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span>options<span>=></span>options<span>.</span><span>UseSqlServer</span><span>(</span><span>\"连接字符串必须和AddConfig的DefaultDataSource一样\"</span><span>)</span><span>.</span><span><span>UseSharding</span><span><span>&lt;</span>TodoAppDbContext<span>></span></span></span><span>(</span><span>)</span><span>)</span><span>;</span><span>//UseSharding&lt;TodoAppDbContext>()必须要配置</span>\n  <span>//额外添加分片配置</span>\n  services<span>.</span><span><span>AddShardingConfigure</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><ol start=\"3\">\n<li>default data source 的连接字符串是否和默认dbcontext创建的一致</li>\n<li>是否添加了分表路由<code>op.AddShardingTableRoute&lt;OrderVirtualTableRoute&gt;();</code></li>\n<li>是否启动了分表启动器<code>buildServiceProvider.GetRequiredService&lt;IShardingBootstrapper&gt;().Start();</code></li>\n</ol>\n</div>\n",
      "date_published": "2022-07-06T04:55:13.000Z",
      "date_modified": "2022-07-06T04:55:13.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "重要",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/important/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/important/",
      "content_html": "<div><p>警告</p>\n<p>！！！升级如果不使用<code>app.ApplictaionServices.UseAutoShardingCreate()</code>将不会自动创建表任务请注意</p>\n<p>！！！升级如果不使用<code>app.ApplictaionServices.UseAutoShardingCreate()</code>将不会自动创建表任务请注意</p>\n<p>！！！升级如果不使用<code>app.ApplictaionServices.UseAutoShardingCreate()</code>将不会自动创建表任务请注意</p>\n</div>\n<h2 id=\"前言\"> 前言</h2>\n<p><code>ShardingCore</code>主旨是增加efcore，针对efcore的分片方面进行增强，并且不对efcore的业务代码进行侵入。不解决数据库层面的问题，编写复杂sql如果在sql层面是慢的那么<code>sharding-core</code>也是无能为力的.</p>\n<h2 id=\"版本\"> 版本</h2>\n<p><code>ShardingCore</code>版本格式为a.b.c.d</p>\n<ul>\n<li><strong>a</strong>表示<code>efcore</code>的版本号</li>\n<li><strong>b</strong>表示<code>ShardingCore</code>主要版本号</li>\n<li><strong>c</strong>表示<code>ShardingCore</code>小版本号</li>\n<li><strong>d</strong>表示<code>ShardingCore</code>修订版本号</li>\n</ul>\n<h2 id=\"常见问题\"> 常见问题</h2>\n<p>因为当前架构师在当前dbcontext作为壳运行,crud会创建真实的dbcontext依托在当前dbcontext上,所以当前dbcontext目前crud都是可以的没有问题,但是如果遇到需要获取track或者其他的一些处理就不应该在当前dbcontext上处理,应该通过内部的DbContextExecutor来获取内部的DbContext来进行处理</p>\n<h2 id=\"dbcontext构造函数问题\"> DbContext构造函数问题</h2>\n<p>请不要再DbContext构造函数内部调用会让model提前确定的方法比如</p>\n<div><pre><code>        public DefaultShardingDbContext(DbContextOptions&lt;DefaultShardingDbContext&gt; options) : base(options)\n        {\n            //切记不要在构造函数中使用会让模型提前创建的方法\n            //ChangeTracker.QueryTrackingBehavior = QueryTrackingBehavior.NoTracking;\n            //Database.SetCommandTimeout(30000);\n        }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"损耗\"> 损耗</h2>\n<p>1.未分片对象查询,<code>ShardingCore</code>在针对未分片对象的查询上面进行了优化,单次的查询仅<code>0.005ms</code>损耗,性能为原生efcore的97%;\n2.分片对象和原生efcore对象查询，在主键查询的情况下也就是只考虑<code>ShardingCore</code>损耗的情况下为单次<code>0.06ms</code>-<code>0.08ms</code>左右</p>\n<p>当数据为瓶颈时分片后可以提高的性能是线性提升的,在数据库未成为读取数据库瓶颈时,整个查询两者差距不大</p>\n<h2 id=\"缺点\"> 缺点</h2>\n<ul>\n<li>本库的缺点是比较消耗链接，针对<code>dbconnection</code>的消耗比一般的链接要高，但是可以通过启动时候配置<code>MaxQueryConnectionsLimit</code>字段来限制单次查询的<code>dbconnection</code>的消耗，从而可以让用户可以进行控制连接数.</li>\n<li>目前不支持分表对象的<code>Include</code>,也不建议你对分表对象进行include,如果你需要操作分表对象请选择join方式而不是include</li>\n<li>三方批处理对象需要获取真实<code>dbcontext</code>后才可以支持</li>\n<li>因为不支持<code>Include</code>所以没必要给sharding对象进行导航属性设置(不支持导航属性)</li>\n</ul>\n<h2 id=\"为什么不用union或者union-all\"> 为什么不用union或者union all</h2>\n<p>虽然union(all)在单表分表下面实现简单,支持的语句多但是性能随着表数量和表数据的增多性能逐渐下降更别说索引失效的场景,但是再多表join下面生成的sql将是不可控的，性能和索引将是一个大大的问题因为涉及到分表的多表不一定索引一直因为可能会出现数据偏向问题建立不同的所以结构导致索引失效不好优化、并且不支持分库等一系列问题</p>\n<h3 id=\"查询为读写分离支持追踪\"> 查询为读写分离支持追踪</h3>\n<p>如果本次查询是读写分离无论走的什么链接都支持对应对象的追踪</p>\n<h2 id=\"gethashcode\"> GetHashCode</h2>\n<p>c#的gethashcode并不能直接用来取模，因为c#的<code>GetHashCode</code>会在程序启动的生命周期内同一个字符串是一样的，但是如果程序关闭后在启动那么就会和之前的hashcode不一致,所以这边建议使用<code>sharding-core</code>提供的<code>ShardingCoreHelper.GetStringHashCode(shardingKeyStr)</code></p>\n<h2 id=\"group-by\"> Group By</h2>\n<p>如果使用group by那么为了保证程序正常执行会在group by下判断如果没有order字段会将所有的select属性加上去，如果有order by那么必须和group by的select字段一样数目,如果group by 对对应属性进行了<code>avg</code>操作那么请对该属性同样进行<code>count</code>操作</p>\n<h2 id=\"guid\"> GUID</h2>\n<p>如果您是sqlserver 并且在用guid排序那么为了和数据库guid排序一致请知悉,<code>sharding-core</code>默认会将guid转成sqlguid去比较来保证和数据库一致的排序表现,但是未提供<code>Nullable&lt;Guid&gt;</code>的排序正确判断,如果需要可自行实现,下面是一个案例,默认<code>ShardingCore</code>已处理<code>Guid</code>的情况</p>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// like this example</span>\n<span>/// &lt;/summary></span>\n<span>/// &lt;typeparam name=\"TShardingDbContext\">&lt;/typeparam></span>\n<span>public</span> <span>class</span> <span>SqlServerNullableGuidCSharpLanguageShardingComparer<span>&lt;</span>TShardingDbContext<span>></span></span><span>:</span><span><span>CSharpLanguageShardingComparer<span>&lt;</span>TShardingDbContext<span>></span></span></span> <span>where</span> <span>TShardingDbContext</span> <span>:</span> <span><span>DbContext</span><span>,</span> <span>IShardingDbContext</span></span>\n<span>{</span>\n        <span>public</span> <span>override</span> <span><span>int</span></span> <span>Compare</span><span>(</span><span>IComparable</span> x<span>,</span> <span>IComparable</span> y<span>,</span> <span><span>bool</span></span> asc<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>x <span>is</span> <span>XXType</span> xg <span>&amp;&amp;</span> y <span>is</span> <span>XXType</span> yg<span>)</span>\n            <span>{</span>\n                <span>return</span> <span>new</span> <span>XXFixedType</span><span>(</span>xg<span>)</span><span>.</span><span>SafeCompareToWith</span><span>(</span><span>new</span> <span>XXFixedType</span><span>(</span>yg<span>)</span><span>,</span> asc<span>)</span><span>;</span>\n            <span>}</span>\n            <span>return</span> <span>base</span><span>.</span><span>Compare</span><span>(</span>x<span>,</span> y<span>,</span> asc<span>)</span><span>;</span>\n        <span>}</span>\n<span>}</span>\n\n<span>//configure</span>\n<span>.</span><span>ReplaceShardingComparer</span><span>(</span>sp<span>=></span><span>new</span> <span>SqlServerNullableGuidCSharpLanguageShardingComparer<span>&lt;</span>DefaultShardingDbContext<span>></span></span><span>(</span><span>)</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><p><strong>注意:如果您使用的框架不是本框架,那么请确认他的分表聚合是否是内存聚合,如果是内存聚合请确保他会有正确的guid排序在数据库和内存之间</strong></p>\n<h2 id=\"自增id\"> 自增Id</h2>\n<p>如果您在efcore配置了整型为自增那么请不要对自增字段设置为sharding字段因为会导致分表数据没办法正确分表，因为自增字段只有在正确插入到数据库后才会知道具体的值，所以不可以吧自增字段设置为分表/分库字段</p>\n<h2 id=\"性能优化-已经弃用表达式构建条件无需缓存\"> 性能优化(已经弃用表达式构建条件无需缓存)</h2>\n<p>如果您对程序的性能有要求建议您针对每个路由开启表达式缓存，并且自行实现多表判断表达式缓存，系统默认会在你启用路由表达式缓存后针对单个表达式比较进行缓存提高10倍编译性能</p>\n<div><pre><code>\n    public class SysUserSalaryVirtualTableRoute:AbstractShardingOperatorVirtualTableRoute&lt;SysUserSalary,int&gt;\n    {\n        //开启路由表达式缓存\n        public override bool? EnableRouteParseCompileCache =&gt; true;\n\n        //.....\n    }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><p>如果您需要使用一下方法需要注意</p>\n<h2 id=\"ensurecreated-建议使用migrate\"> EnsureCreated (建议使用migrate)</h2>\n<p><code>DbContext.Database.EnsureCreated()</code>如果您需要使用这个接口请自行实现<code>IMigrationsSqlGenerator</code></p>\n<h2 id=\"时间分表\"> 时间分表</h2>\n<p>如果您是时间分表的那么请一定要阅读<a href=\"/sharding-core-doc/adv/pagination\">高性能分页</a></p>\n",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2022-07-06T04:55:30.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "重要"
      ]
    },
    {
      "title": "快速上手AspNetCore",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/quick-start-aspnetcore/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/quick-start-aspnetcore/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次demo源码：<a href=\"https://github.com/xuejmnet/ShardingCoreDocDemo/tree/main/EFCoreSharding\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreSharding</a></p>\n<h2 id=\"快速开始\"> 快速开始</h2>\n<p>5步实现按月分表,且支持自动化建表建库</p>\n<h3 id=\"第一步安装依赖\"> 第一步安装依赖</h3>\n<p><code>ShardingCore</code>版本表现形式为a.b.c.d,其中a表示<code>efcore</code>的版本号,b表示<code>ShardingCore</code>的主版本号,c表示<code>ShardingCore</code>次级版本号,d表示<code>ShardingCore</code>的修订版本号</p>\n<div><pre><code><span># 请对应安装您需要的版本</span>\nPM<span>></span> Install-Package ShardingCore\n<span># use sqlserver</span>\nPM<span>></span> Install-Package Microsoft.EntityFrameworkCore.SqlServer\n<span>#  use mysql</span>\n<span>#PM> Install-Package Pomelo.EntityFrameworkCore.MySql</span>\n<span># use other database driver,if efcore support</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h3 id=\"第二步创建查询对象\"> 第二步创建查询对象</h3>\n<p>查询对象</p>\n<div><pre><code>\n    <span>/// &lt;summary></span>\n    <span>/// order table</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span>class</span> <span>Order</span>\n    <span>{</span>\n        <span>/// &lt;summary></span>\n        <span>/// order Id</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// payer id</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>string</span></span> Payer <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// pay money cent</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>long</span></span> Money <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// area</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// order status</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>OrderStatusEnum</span> OrderStatus <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// CreationTime</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>DateTime</span> CreationTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>enum</span> <span>OrderStatusEnum</span>\n    <span>{</span>\n        NoPay<span>=</span><span>1</span><span>,</span>\n        Paying<span>=</span><span>2</span><span>,</span>\n        Payed<span>=</span><span>3</span><span>,</span>\n        PayFail<span>=</span><span>4</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br></div></div><h3 id=\"第三步创建dbcontext\"> 第三步创建dbcontext</h3>\n<p>dbcontext <code>AbstractShardingDbContext</code>和<code>IShardingTableDbContext</code>如果你是普通的DbContext那么就继承<code>AbstractShardingDbContext</code>需要分表就实现<code>IShardingTableDbContext</code>,如果只有分库可以不实现<code>IShardingTableDbContext</code>接口</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span><span>IShardingTableDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Payer<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>OrderStatus<span>)</span><span>.</span><span><span>HasConversion</span><span><span>&lt;</span><span>int</span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// empty impl if use sharding table</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div><h3 id=\"第四步添加分表路由\"> 第四步添加分表路由</h3>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 创建虚拟路由</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>OrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n<span>{</span>\n    <span>public</span> <span>OrderVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n    <span>{</span>\n    <span>}</span>\n\n    <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n    <span>{</span>\n        builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        builder<span>.</span><span>AutoCreateTable</span><span>(</span><span>null</span><span>)</span><span>;</span>\n        builder<span>.</span><span>TableSeparator</span><span>(</span><span>\"_\"</span><span>)</span><span>;</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><div><p>提示</p>\n<ol>\n<li><code>ShardingProperty</code>必须指定,表示具体按什么字段进行分表</li>\n<li><code>AutoCreateTable</code>可选,表示是否需要在<strong>启动</strong>的时候建表:null表示根据全局配置,true:表示需要,false:表示不需要,默认null</li>\n<li><code>TableSeparator</code>可选,表示分表后缀和虚拟表名之间的分隔连接符,默认<code>_</code></li>\n<li><code>AbstractSimpleShardingModKeyStringVirtualTableRoute&lt;Order&gt;</code>由sharding-core提供的默认取模分表规则,其中2代表分表后尾巴有两位,3表示按3取模所以后缀为:00,01,02。因为最多2位所以可以最多到99,如果需要了解更多路由<a href=\"/sharding-core-doc/pages/defaultroute\">默认路由</a></li>\n</ol>\n</div>\n<h3 id=\"第五步配置启动项\"> 第五步配置启动项</h3>\n<p>无论你是何种数据库只需要修改<code>AddDefaultDataSource</code>里面的链接字符串 请不要修改委托内部的UseXXX参数 <code>conStr</code> and <code>connection</code></p>\n<div><pre><code>\n        <span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>\n        <span>{</span>\n\n            <span>//添加分片配置</span>\n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n                <span>.</span><span>UseRouteConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddConfig</span><span>(</span><span>(</span>sp<span>,</span>op<span>)</span> <span>=></span>\n                <span>{</span>\n                    \n                    op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conn<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>conn<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>AddDefaultDataSource</span><span>(</span>Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>.</span><span>ToString</span><span>(</span><span>\"n\"</span><span>)</span><span>,</span>\n                        <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingTableDB;Integrated Security=True;\"</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddShardingCore</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>env<span>.</span><span>IsDevelopment</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                app<span>.</span><span>UseDeveloperExceptionPage</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n            \n            <span>//not required, enable job auto create table 非必须 启用自动创建表的任务 </span>\n            app<span>.</span>ApplicationServices<span>.</span><span>UseAutoShardingCreate</span><span>(</span><span>)</span><span>;</span>\n            <span>//not required, enable check table missing and auto create,非必须  启动检查缺少的表并且创建</span>\n            app<span>.</span>ApplicationServices<span>.</span><span>UseAutoTryCompensateTable</span><span>(</span><span>)</span><span>;</span>\n            <span>// other configure....</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br></div></div><p>这样所有的配置就完成了你可以愉快地对Order表进行按月分表了</p>\n<div><pre><code><span>[</span><span><span>Route</span><span><span>(</span><span>\"api/[controller]\"</span><span>)</span></span></span><span>]</span>\n<span>public</span> <span>class</span> <span>ValuesController</span> <span>:</span> <span><span>Controller</span></span>\n<span>{</span>\n        <span>private</span> <span>readonly</span> <span>MyDbContext</span> _myDbContext<span>;</span>\n\n        <span>public</span> <span>ValuesController</span><span>(</span><span>MyDbContext</span> myDbContext<span>)</span>\n        <span>{</span>\n            _myDbContext <span>=</span> myDbContext<span>;</span>\n        <span>}</span>\n\n        <span>[</span><span><span>HttpGet</span></span><span>]</span>\n        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Get</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> order <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"2\"</span><span>)</span><span>;</span>\n            <span>return</span> <span>OK</span><span>(</span>order<span>)</span>\n        <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br></div></div><div><p>提示</p>\n<ol>\n<li>如果程序无法启动请确保一下几点，确认是否已经注入原生的efcore的DbContext,并且在原生的后续对DbContextOptions进行了<code>UseSharding&lt;MyDbContext&gt;()</code>配置</li>\n<li>目前<code>ShardingCore</code>提供了三种配置方式</li>\n</ol>\n<ul>\n<li>1.默认配置</li>\n</ul>\n<div><pre><code>services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br></div></div><p>这个配置包含了<code>AddDbContext</code>+<code>AddShardingConfigure</code></p>\n<ul>\n<li>2.额外配置</li>\n</ul>\n<div><pre><code>  <span>//原来的dbcontext配置</span>\n  services<span>.</span><span><span>AddDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span>ShardingCoreExtension<span>.</span>UseDefaultSharding<span>&lt;</span>MyDbContext<span>></span><span>)</span><span>;</span>\n  <span>//额外添加分片配置</span>\n  services<span>.</span><span><span>AddShardingConfigure</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><ul>\n<li>3.字符串配置适合单配置的情况下</li>\n</ul>\n<div><pre><code>  <span>//原来的dbcontext配置</span>\n  services<span>.</span><span><span>AddDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span>options<span>=></span>options<span>.</span><span>UseSqlServer</span><span>(</span><span>\"连接字符串必须和AddConfig的DefaultDataSource一样\"</span><span>)</span><span>.</span><span><span>UseSharding</span><span><span>&lt;</span>TodoAppDbContext<span>></span></span></span><span>(</span><span>)</span><span>)</span><span>;</span><span>//UseSharding&lt;TodoAppDbContext>()必须要配置</span>\n  <span>//额外添加分片配置</span>\n  services<span>.</span><span><span>AddShardingConfigure</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><ol start=\"3\">\n<li>default data source 的连接字符串是否和默认dbcontext创建的一致</li>\n<li>是否添加了分表路由<code>op.AddShardingTableRoute&lt;OrderVirtualTableRoute&gt;();</code></li>\n</ol>\n</div>\n",
      "date_published": "2022-07-06T04:55:13.000Z",
      "date_modified": "2022-07-06T04:55:13.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "快速上手",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/quick-start/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/quick-start/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次demo源码：<a href=\"https://github.com/xuejmnet/ShardingCoreDocDemo/tree/main/EFCoreSharding\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreSharding</a></p>\n<h2 id=\"快速开始\"> 快速开始</h2>\n<p>5步实现按月分表,且支持自动化建表建库</p>\n<h3 id=\"第一步安装依赖\"> 第一步安装依赖</h3>\n<p><code>ShardingCore</code>版本表现形式为a.b.c.d,其中a表示<code>efcore</code>的版本号,b表示<code>ShardingCore</code>的主版本号,c表示<code>ShardingCore</code>次级版本号,d表示<code>ShardingCore</code>的修订版本号</p>\n<div><pre><code><span># 请对应安装您需要的版本</span>\nPM<span>></span> Install-Package ShardingCore\n<span># use sqlserver</span>\nPM<span>></span> Install-Package Microsoft.EntityFrameworkCore.SqlServer\n<span>#  use mysql</span>\n<span>#PM> Install-Package Pomelo.EntityFrameworkCore.MySql</span>\n<span># use other database driver,if efcore support</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h3 id=\"第二步创建查询对象\"> 第二步创建查询对象</h3>\n<p>查询对象</p>\n<div><pre><code>\n    <span>/// &lt;summary></span>\n    <span>/// order table</span>\n    <span>/// &lt;/summary></span>\n    <span>public</span> <span>class</span> <span>Order</span>\n    <span>{</span>\n        <span>/// &lt;summary></span>\n        <span>/// order Id</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// payer id</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>string</span></span> Payer <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// pay money cent</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>long</span></span> Money <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// area</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// order status</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>OrderStatusEnum</span> OrderStatus <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// CreationTime</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>DateTime</span> CreationTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>enum</span> <span>OrderStatusEnum</span>\n    <span>{</span>\n        NoPay<span>=</span><span>1</span><span>,</span>\n        Paying<span>=</span><span>2</span><span>,</span>\n        Payed<span>=</span><span>3</span><span>,</span>\n        PayFail<span>=</span><span>4</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br></div></div><h3 id=\"第三步创建dbcontext\"> 第三步创建dbcontext</h3>\n<p>dbcontext <code>AbstractShardingDbContext</code>和<code>IShardingTableDbContext</code>如果你是普通的DbContext那么就继承<code>AbstractShardingDbContext</code>需要分表就实现<code>IShardingTableDbContext</code>,如果只有分库可以不实现<code>IShardingTableDbContext</code>接口</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span><span>IShardingTableDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Payer<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>OrderStatus<span>)</span><span>.</span><span><span>HasConversion</span><span><span>&lt;</span><span>int</span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>/// &lt;summary></span>\n        <span>/// empty impl if use sharding table</span>\n        <span>/// &lt;/summary></span>\n        <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br></div></div><h3 id=\"第四步添加分表路由\"> 第四步添加分表路由</h3>\n<div><pre><code><span>/// &lt;summary></span>\n<span>/// 创建虚拟路由</span>\n<span>/// &lt;/summary></span>\n<span>public</span> <span>class</span> <span>OrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n<span>{</span>\n    <span>public</span> <span>OrderVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n    <span>{</span>\n    <span>}</span>\n\n    <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n    <span>{</span>\n        builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        builder<span>.</span><span>AutoCreateTable</span><span>(</span><span>null</span><span>)</span><span>;</span>\n        builder<span>.</span><span>TableSeparator</span><span>(</span><span>\"_\"</span><span>)</span><span>;</span>\n    <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><div><p>提示</p>\n<ol>\n<li><code>ShardingProperty</code>必须指定,表示具体按什么字段进行分表</li>\n<li><code>AutoCreateTable</code>可选,表示是否需要在<strong>启动</strong>的时候建表:null表示根据全局配置,true:表示需要,false:表示不需要,默认null</li>\n<li><code>TableSeparator</code>可选,表示分表后缀和虚拟表名之间的分隔连接符,默认<code>_</code></li>\n<li><code>AbstractSimpleShardingModKeyStringVirtualTableRoute&lt;Order&gt;</code>由sharding-core提供的默认取模分表规则,其中2代表分表后尾巴有两位,3表示按3取模所以后缀为:00,01,02。因为最多2位所以可以最多到99,如果需要了解更多路由<a href=\"/sharding-core-doc/pages/defaultroute\">默认路由</a></li>\n</ol>\n</div>\n<h3 id=\"第五步配置启动项\"> 第五步配置启动项</h3>\n<p>无论你是何种数据库只需要修改<code>AddDefaultDataSource</code>里面的链接字符串 请不要修改委托内部的UseXXX参数 <code>conStr</code> and <code>connection</code></p>\n<div><pre><code>\n        <span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>\n        <span>{</span>\n\n            <span>//添加分片配置</span>\n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n                <span>.</span><span>AddEntityConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                    op<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n                    op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conn<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>conn<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conn<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>AddConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span>ConfigId <span>=</span> <span>\"c1\"</span><span>;</span>\n                    op<span>.</span><span>AddDefaultDataSource</span><span>(</span>Guid<span>.</span><span>NewGuid</span><span>(</span><span>)</span><span>.</span><span>ToString</span><span>(</span><span>\"n\"</span><span>)</span><span>,</span>\n                        <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingTableDB;Integrated Security=True;\"</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>EnsureConfig</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>env<span>.</span><span>IsDevelopment</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                app<span>.</span><span>UseDeveloperExceptionPage</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n            <span>// it's importment don't forget it</span>\n            app<span>.</span>ApplicationServices<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n            <span>// other configure....</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br></div></div><p>这样所有的配置就完成了你可以愉快地对Order表进行按月分表了</p>\n<div><pre><code><span>[</span><span><span>Route</span><span><span>(</span><span>\"api/[controller]\"</span><span>)</span></span></span><span>]</span>\n<span>public</span> <span>class</span> <span>ValuesController</span> <span>:</span> <span><span>Controller</span></span>\n<span>{</span>\n        <span>private</span> <span>readonly</span> <span>MyDbContext</span> _myDbContext<span>;</span>\n\n        <span>public</span> <span>ValuesController</span><span>(</span><span>MyDbContext</span> myDbContext<span>)</span>\n        <span>{</span>\n            _myDbContext <span>=</span> myDbContext<span>;</span>\n        <span>}</span>\n\n        <span>[</span><span><span>HttpGet</span></span><span>]</span>\n        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Get</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> order <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"2\"</span><span>)</span><span>;</span>\n            <span>return</span> <span>OK</span><span>(</span>order<span>)</span>\n        <span>}</span>\n<span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br></div></div><div><p>提示</p>\n<ol>\n<li>如果程序无法启动请确保一下几点，确认是否已经注入原生的efcore的DbContext,并且在原生的后续对DbContextOptions进行了<code>UseSharding&lt;MyDbContext&gt;()</code>配置</li>\n<li>目前<code>ShardingCore</code>提供了三种配置方式</li>\n</ol>\n<ul>\n<li>1.默认配置</li>\n</ul>\n<div><pre><code>services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br></div></div><p>这个配置包含了<code>AddDbContext</code>+<code>AddShardingConfigure</code></p>\n<ul>\n<li>2.额外配置</li>\n</ul>\n<div><pre><code>  <span>//原来的dbcontext配置</span>\n  services<span>.</span><span><span>AddDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span>DIExtension<span>.</span>UseDefaultSharding<span>&lt;</span>MyDbContext<span>></span><span>)</span><span>;</span>\n  <span>//额外添加分片配置</span>\n  services<span>.</span><span><span>AddShardingConfigure</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><ul>\n<li>3.字符串配置适合单配置的情况下</li>\n</ul>\n<div><pre><code>  <span>//原来的dbcontext配置</span>\n  services<span>.</span><span><span>AddDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span>options<span>=></span>options<span>.</span><span>UseSqlServer</span><span>(</span><span>\"连接字符串必须和AddConfig的DefaultDataSource一样\"</span><span>)</span><span>.</span><span><span>UseSharding</span><span><span>&lt;</span>TodoAppDbContext<span>></span></span></span><span>(</span><span>)</span><span>)</span><span>;</span><span>//UseSharding&lt;TodoAppDbContext>()必须要配置</span>\n  <span>//额外添加分片配置</span>\n  services<span>.</span><span><span>AddShardingConfigure</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><ol start=\"3\">\n<li>default data source 的连接字符串是否和默认dbcontext创建的一致</li>\n<li>是否添加了分表路由<code>op.AddShardingTableRoute&lt;OrderVirtualTableRoute&gt;();</code></li>\n<li>是否启动了分表启动器<code>buildServiceProvider.GetRequiredService&lt;IShardingBootstrapper&gt;().Start();</code></li>\n</ol>\n</div>\n",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2022-01-08T06:45:39.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "Custom Layout",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/layout/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/layout/",
      "content_html": "<p>You can use slots with markdown and component support to custom page layout.</p>\n<div><p>注意</p>\n<p>This is just a demo, you should add styles according to your own needs.</p>\n\n\n</div>\n<template #page-top><p>Page top content</p>\n</template><template #page-bottom><p>Page bottom content</p>\n</template><template #content-top><p>Content top content</p>\n</template><template #content-bottom><p>Content bottom content</p>\n</template><template #navbar-start><p>Navbar start content</p>\n</template><template #navbar-center><p>Navbar center content</p>\n</template><template #navbar-end><p>Navbar end content</p>\n</template><template #sidebar-top><p>Sidebar top content</p>\n</template><template #sidebar-center><p>Sidebar center content</p>\n</template><template #sidebar-bottom><p>Sidebar bottom content</p>\n</template><p>For details, see <a href=\"https://vuepress-theme-hope.github.io/guide/layout/custom/\" target=\"_blank\" rel=\"noopener noreferrer\">Custom layout</a>.</p>\n",
      "date_published": "2021-11-02T08:39:31.000Z",
      "date_modified": "2021-11-02T08:39:31.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": []
    },
    {
      "title": "FirstOrDefault",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/query/first-or-default/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/query/first-or-default/",
      "content_html": "",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-03T00:53:03.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "查询"
      ]
    },
    {
      "title": "查询注意事项",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/query-notes/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/query-notes/",
      "content_html": "<h2 id=\"查询\"> 查询</h2>\n<h3 id=\"未分片对象查询\"> 未分片对象查询</h3>\n<p>如果本次查询对象不是分片(分表或者分库)的那么本次查询将交由原生efcore执行,而不是sharding-core接管,具体执行会在当前<code>DbContext</code>内部的<code>ShardingDbContextExecutor</code>属性内创建一个默认数据源名称的<code>DbContext</code>,这个<code>DbContext</code>内部模型对象映射到表上面都是原生表名称</p>\n<div><pre><code><span><span>var</span></span> order <span>=</span><span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>Id<span>==</span> <span>232398109278351360</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br></div></div><p><code>_myDbContext</code>在执行期间发现<code>Order</code>既不是分表也不是分库那么会将当前查询表达式通过创建一个空映射的DbContext来进行处理,所以如果你是原生的查询那么都将是支持的包括追踪</p>\n<h3 id=\"查询分片对象\"> 查询分片对象</h3>\n<p>如果本次查询仅有分片对象情况下,查询执行器将判断当前查询路由是否跨表是否跨库,如果不跨表并且不跨库如果满足这两点那么将进行一下判断</p>\n<p>1.追踪查询\n满足本次查询没有分表(<strong>仅分库</strong>)或者有分表的情况下所有的<code>tail</code>都一样并且所有的查询对象都需要是分表的，那么本次查询将交由efcore原生查询,生成的<code>DbContext</code>将分片对象映射到对应的分表对象上\n2.非追踪查询\n仅需满足不跨表和不跨库即可交由efcore原生查询</p>\n<h3 id=\"查询对象存在分片和为分片\"> 查询对象存在分片和为分片</h3>\n<p>将交由sharding-core查询聚合且返回对象如果是DbContext的model的对象类型那么将会进行手动track</p>\n<h3 id=\"未跟踪查询\"> 未跟踪查询</h3>\n<p>如果你是未跟踪查询那么除了sharding对象的include不要使用,其他基本上无需考虑</p>\n<div><p>注意</p>\n<p>！！！如果查询对象是sharding对象那么请不要进行include操作,包括主表未分片子表分片。\n！！！如果查询对象是sharding对象那么请不要进行include操作,包括主表未分片子表分片。\n！！！如果查询对象是sharding对象那么请不要进行include操作,包括主表未分片子表分片。</p>\n</div>\n<img src=\"/sharding-core-doc/query-process.png\">",
      "date_published": "2021-12-30T04:41:43.000Z",
      "date_modified": "2021-12-30T05:16:03.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "查询注意事项"
      ]
    },
    {
      "title": "Project home",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/home/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/home/",
      "content_html": "<p>This is an example of a normal homepage. You can place your main content here.</p>\n<p>To use this layout, you need to set <code>home: true</code> in the page front matter.</p>\n<p>For related descriptions of configuration items, please see <a href=\"https://vuepress-theme-hope.github.io/guide/layout/home/\" target=\"_blank\" rel=\"noopener noreferrer\">Project HomePage Layout Config</a>.</p>\n",
      "date_published": "2021-11-02T08:39:31.000Z",
      "date_modified": "2021-11-02T08:39:31.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": []
    },
    {
      "title": "分组查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/query/group-by-query/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/query/group-by-query/",
      "content_html": "<h2 id=\"支持group\"> 支持group</h2>\n<div><pre><code>    <span><span>var</span></span> ids <span>=</span> <span>new</span><span>[</span><span>]</span> <span>{</span><span>\"200\"</span><span>,</span> <span>\"300\"</span><span>}</span><span>;</span>\n            <span><span>var</span></span> dateOfMonths <span>=</span> <span>new</span><span>[</span><span>]</span> <span>{</span><span>202111</span><span>,</span> <span>202110</span><span>}</span><span>;</span>\n            <span><span>var</span></span> <span>group</span> <span>=</span> <span>await</span> <span>(</span><span>from</span> u <span>in</span> _virtualDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUserSalary<span>></span></span></span><span>(</span><span>)</span>\n                    <span>.</span><span>Where</span><span>(</span>o <span>=></span> ids<span>.</span><span>Contains</span><span>(</span>o<span>.</span>UserId<span>)</span> <span>&amp;&amp;</span> dateOfMonths<span>.</span><span>Contains</span><span>(</span>o<span>.</span>DateOfMonth<span>)</span><span>)</span>\n                <span>group</span> u <span>by</span> <span>new</span>\n                <span>{</span>\n                    UId <span>=</span> u<span>.</span>UserId\n                <span>}</span>\n                <span>into</span> g\n                <span>select</span> <span>new</span>\n                <span>{</span>\n                    GroupUserId <span>=</span> g<span>.</span>Key<span>.</span>UId<span>,</span>\n                    Count <span>=</span> g<span>.</span><span>Count</span><span>(</span><span>)</span><span>,</span>\n                    TotalSalary <span>=</span> g<span>.</span><span>Sum</span><span>(</span>o <span>=></span> o<span>.</span>Salary<span>)</span><span>,</span>\n                    AvgSalary <span>=</span> g<span>.</span><span>Average</span><span>(</span>o <span>=></span> o<span>.</span>Salary<span>)</span><span>,</span>\n                    AvgSalaryDecimal <span>=</span> g<span>.</span><span>Average</span><span>(</span>o <span>=></span> o<span>.</span>SalaryDecimal<span>)</span><span>,</span>\n                    MinSalary <span>=</span> g<span>.</span><span>Min</span><span>(</span>o <span>=></span> o<span>.</span>Salary<span>)</span><span>,</span>\n                    MaxSalary <span>=</span> g<span>.</span><span>Max</span><span>(</span>o <span>=></span> o<span>.</span>Salary<span>)</span>\n                <span>}</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><table>\n<thead>\n<tr>\n<th>聚合函数</th>\n<th>是否支持</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>Count</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>Sum</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>Max</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>Min</td>\n<td>支持</td>\n</tr>\n<tr>\n<td>Average</td>\n<td>支持</td>\n</tr>\n</tbody>\n</table>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-15T08:23:36.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "查询"
      ]
    },
    {
      "title": "Intro Page",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/intro/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/intro/",
      "content_html": "<h1 id=\"intro-page\"> Intro Page</h1>\n<p>Place your introducation and profile here.</p>\n",
      "date_published": "2021-11-02T08:39:31.000Z",
      "date_modified": "2021-11-02T08:39:31.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": []
    },
    {
      "title": "组合查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/query/multi-entity-query/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/query/multi-entity-query/",
      "content_html": "<h2 id=\"组合查询\"> 组合查询</h2>\n<p>默认不推荐<code>include</code>，分表对象+分表、分表对象+分表对象都是在本框架内被支持的，支持的形式为join, 默认推荐join组合而不是include</p>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-15T08:23:36.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "查询"
      ]
    },
    {
      "title": "事务中查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/query/query-in-transaction/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/query/query-in-transaction/",
      "content_html": "<h2 id=\"事务中查询block\"> 事务中查询block</h2>\n<p>当我们开启事务的时候如果涉及到跨表查询,那么sharding-core的做法是这样的</p>\n<ol>\n<li>因为同一个connection不能有多个结果集并行获取(除非sqlserver开始MARS)(MultipleActive Result Set),所以sharding-core默认所有数据库都不支持MARS,这个前提下那么涉及跨表操作就需要开始多个链接来进行并行查询+内存串行聚合。所以如果开启了事务不是同一个链接session的前提下，另一个链接是无法读取到事务内的数据结果，如果出现全表扫描的情况下可能会出现死锁,所以在事务内部建议使用with(nolock)，具体做法</li>\n</ol>\n<div><pre><code></code></pre>\n<div></div></div><p><strong>注意</strong>最好的做法是尽可能的短事务,不要再事务开启后,数据增删改后未提交事务的情况下进行跨表查询，所以只要保证尽可能短的事务就可以了</p>\n",
      "date_published": "2021-11-11T02:54:25.000Z",
      "date_modified": "2021-11-11T02:54:25.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "查询"
      ]
    },
    {
      "title": "单对象查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/query/single-entity-query/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/query/single-entity-query/",
      "content_html": "<h2 id=\"单表查询\"> 单表查询</h2>\n<p>和efcore原生查询没有任何区别,支持未分表下的所有操作</p>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-15T08:23:36.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "查询"
      ]
    },
    {
      "title": "概念",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/terminology/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/guide/terminology/",
      "content_html": "<p><code>sharding-core</code>框架是一款分表分库组件,一款将efcore的一个dbcontext一个对象一张表扩展成了一个dbcontext一个对象多张表对应多个dbcontext,一款基于表达式解析，具有高性能路由的分表分库框架。</p>\n<h2 id=\"全局\"> 全局</h2>\n<h3 id=\"shelldbcontext壳dbcontext\"> ShellDbContext壳DbContext</h3>\n<p>用户和业务系统交互,单并不是正真执行得DbContext</p>\n<h3 id=\"ishardingruntimecontext\"> IShardingRuntimeContext</h3>\n<p><code>IShardingRuntimeContext</code>让<code>DbContext</code>支持<code>Sharding</code>功能的上下文,用于构建出不同的<code>DbContextOptions</code>使用不同的<code>IShardingRuntimeContext</code>那么就可以让<code>DbContext</code>支持不同的<code>Sharding</code>,并且一下所有配置都由<code>IShardingRuntimeContext</code>获取,而不是依赖注入,<code>IShardingRuntimeContext</code>可以由依赖注入获取也可以用户自行保存譬如:静态属性</p>\n<div><pre><code>  <span><span>var</span></span> shardingRuntimeContext <span>=</span> <span>new</span> <span>ShardingRuntimeBuilder<span>&lt;</span>DefaultShardingDbContext<span>></span></span><span>(</span><span>)</span>\n                    <span>.</span><span>UseRouteConfig</span><span>(</span>o <span>=></span>\n                    <span>{</span>\n                        o<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserLogByMonthRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                        o<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserModVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                         o<span>.</span><span><span>AddShardingDataSourceRoute</span><span><span>&lt;</span>SysUserModVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>.</span><span>UseConfig</span><span>(</span>o <span>=></span>\n                    <span>{</span> \n                        o<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conStr<span>,</span>builder<span>)</span><span>=></span>\n                        <span>{</span>\n                            builder<span>.</span><span>UseMySql</span><span>(</span>conStr<span>,</span> <span>new</span> <span>MySqlServerVersion</span><span>(</span><span>new</span> <span>Version</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span>\n                        <span>}</span><span>)</span><span>;</span>\n                        o<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                        <span>{</span>\n                            builder\n                                <span>.</span><span>UseMySql</span><span>(</span>connection<span>,</span> <span>new</span> <span>MySqlServerVersion</span><span>(</span><span>new</span> <span>Version</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span>\n                        <span>}</span><span>)</span><span>;</span>\n                        o<span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"ds0\"</span><span>,</span> <span>\"server=127.0.0.1;port=3306;database=dbdbd0;userid=root;password=root;\"</span><span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>.</span><span><span>ReplaceService</span><span><span>&lt;</span>ITableEnsureManager<span>,</span>MySqlTableEnsureManager<span>></span></span></span><span>(</span><span>)</span>\n                    <span>.</span><span>Build</span><span>(</span>sp<span>)</span><span>;</span><span>//sp为依赖注入的应用程序的依赖注入服务的提供者</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div><h2 id=\"以下所有服务由ishardingruntimecontext获取\"> 以下所有服务由IShardingRuntimeContext获取</h2>\n<h3 id=\"ishardingprovider\"> IShardingProvider</h3>\n<p><code>IShardingProvider</code>对应配置信息获取如果配置时传入应用<code>IServiceProvider</code>那么也可以通过本接口获取应用的注入服务</p>\n<div><pre><code>shardingRuntimeContext<span>.</span><span>GetShardingProvider</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br></div></div><h3 id=\"ishardingrouteconfigoptions\"> IShardingRouteConfigOptions</h3>\n<p><code>IShardingRouteConfigOptions</code>路由表的启动配置</p>\n<div><pre><code>shardingRuntimeContext<span>.</span><span>GetShardingRouteConfigOptions</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br></div></div><h3 id=\"idbcontextcreator\"> IDbContextCreator</h3>\n<p><code>IDbContextCreator</code>DbContext创建者如果是通过依赖注入使用的ShardingCore和DbContext那么不需要管,否则需要重写</p>\n<div><pre><code>shardingRuntimeContext<span>.</span><span>GetDbContextCreator</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br></div></div><h3 id=\"ientitymetadatamanager\"> IEntityMetadataManager</h3>\n<p><code>IEntityMetadataManager管理对象数据，将对象数据分表和分库的对象进行存储管理， 可以区分对象是否分表是否分库，并且可以获取对应的对象类型元数据</code>EntityMetadata`,所有类型的对象都可以被获取只要是DbContext所依赖的</p>\n<div><pre><code>shardingRuntimeContext<span>.</span><span>GetEntityMetadataManager</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br></div></div><h3 id=\"entitymetadata\"> EntityMetadata</h3>\n<p><code>EntityMetadata</code>对象类型元数据，是针对分表分库对象的数据解析后的存储，通过对象类型元数据可以获取到对象的类型和对应的<code>虚拟表名</code>(不带后缀的表名)，<code>表主键</code>，是否分表是否分库，包括分表he分库的对应字段属性信息</p>\n<div><pre><code><span>IEntityMetadataManager</span> entityMetadataManager<span>=</span><span>..</span><span>..</span><span>.</span><span>;</span>\nentityMetadataManager<span>.</span><span>TryGet</span><span>(</span>EntityType<span>)</span><span>;</span>\nentityMetadataManager<span>.</span><span><span>TryGet</span><span><span>&lt;</span>TEntity<span>></span></span></span><span>(</span>TEntity<span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br></div></div><h3 id=\"ivirtualdatasource\"> IVirtualDataSource</h3>\n<p><code>IVirtualDataSource</code>当前上下文的虚拟数据源,记录着除了默认数据源外的额外数据源链接信息</p>\n<div><pre><code>shardingRuntimeContext<span>.</span><span>GetVirtualDataSource</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br></div></div><h3 id=\"idatasourceroutemanager\"> IDataSourceRouteManager</h3>\n<p><code>IDataSourceRouteManager</code>分库路由管理者,可以根据对象进行分库选择路由</p>\n<div><pre><code>shardingRuntimeContext<span>.</span><span>GetDataSourceRouteManager</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br></div></div><h3 id=\"itableroutemanager\"> ITableRouteManager</h3>\n<p><code>ITableRouteManager</code>分表路由管理者,可以根据对象进行分表选择路由</p>\n<div><pre><code>shardingRuntimeContext<span>.</span><span>GetTableRouteManager</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br></div></div><h3 id=\"datasourcename\"> DataSourceName</h3>\n<p>数据源名称，默认针对<code>ShardingCore</code>每个链接都对应其自己的数据源，都有属于自己的数据源名称和数据源的链接。无论是否分表数据源名称都会有，只不过因为仅分表状态下只链接单个数据库，所以数据源名称在整个框架下只有一个，所以如果您是分表那么数据源名称可以随便添加，因为默认的数据源名称有且只有一个。</p>\n<div><pre><code><span>//配置</span>\n<span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"ds0\"</span><span>,</span><span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBxx0;Integrated Security=True;\"</span><span>)</span><span>;</span>\n<span>.</span><span>AddExtraDataSource</span><span>(</span>sp <span>=></span>\n<span>{</span>\n    <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span><span>(</span><span>)</span>\n    <span>{</span>\n        <span>{</span><span>\"ds1\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBxx1;Integrated Security=True;\"</span><span>}</span><span>,</span>\n        <span>{</span><span>\"ds2\"</span><span>,</span> <span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBxx2;Integrated Security=True;\"</span><span>}</span><span>,</span>\n    <span>}</span><span>;</span>\n<span>}</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br></div></div><p>通过上面我们可以看到我们其实分了三个数据库分别是<code>ds0</code>,<code>ds1</code>,<code>ds2</code>,使用分表的时候需要注意，仅分表对象才会进入分表，其他所有没有分表路由的对象将全部走DefaultDataSourceName数据库。</p>\n<h3 id=\"ishardingtablecreator\"> IShardingTableCreator</h3>\n<p>分表对象创建,可以创建对应的分表指定对应的表后缀即可</p>\n<div><pre><code><span>//直接获取</span>\nShardingContainer<span>.</span><span><span>GetService</span><span><span>&lt;</span>IShardingTableCreator<span>&lt;</span>TShardingDbContext<span>></span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n<span>//通过非泛型方法获取</span>\n<span>(</span>IShardingTableCreator<span>)</span>ShardingContainer<span>.</span><span>GetService</span><span>(</span><span>typeof</span><span>(</span><span>IShardingTableCreator<span>&lt;</span><span>></span></span><span>)</span><span>.</span><span>GetGenericType0</span><span>(</span>shardingDbContext<span>.</span><span>GetType</span><span>(</span><span>)</span><span>)</span><span>)</span><span>;</span>\n\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br></div></div><h2 id=\"分库概念\"> 分库概念</h2>\n<h3 id=\"idatasourceroutemanager-2\"> IDataSourceRouteManager</h3>\n<p><code>IDataSourceRouteManager</code>分库路由管理者,如果您的对象是一个分库对象，那么分库对象必须实现一个虚拟数据源路由<code>IVirtualDataSourceRoute</code>，\n虚拟数据源路由的作用是用来对分库对象进行路由，告诉框架程序应该如何对分库对象进行路由去对应的数据源里面</p>\n<div><pre><code><span>//首先获取IDataSourceRouteManager</span>\n<span>IDataSourceRouteManager</span> dataSourceRouteManager<span>=</span><span>..</span><span>..</span><span>.</span><span>;</span>\n<span>//获取路由</span>\ndataSourceRouteManager<span>.</span><span>GetRoute</span><span>(</span>EntityType<span>)</span><span>;</span>\n\n<span>//直接路由</span>\ndataSourceRouteManager<span>.</span><span>RouteTo</span><span>(</span><span>..</span><span>..</span><span>.</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><h2 id=\"分表\"> 分表</h2>\n<ul>\n<li>[Tail]\n尾巴、后缀物理表的后缀</li>\n<li>[TableSeparator]\n尾巴前缀虚拟表和物理表的后缀中间的字符</li>\n<li>[物理表]\n顾名思义就是数据库对应的实际表信息,表名(TableName+ TableSeparator+ Tail)比如:SysUser_2021,这边<code>SysUser</code>就是原本未分表时候的映射到数据库的物理表名称，后续的下划线<code>_</code>表示<code>TableSeparator</code>,<code>2021</code>表示后缀<code>Tail</code></li>\n</ul>\n<p>框架内部所有的分表名称规则都是按照(TableName+ TableSeparator+ Tail)来创建的</p>\n<h3 id=\"itableroutemanager-2\"> ITableRouteManager</h3>\n<p><code>ITableRouteManager</code>分表路由管理者，因为对象和数据库表之间的关系从原先的一对一变成了一对一分表路由所以我们一个对象会对应一个分表路由，分表路由里面有对应表的所有分表后缀</p>\n<div><pre><code><span>//获取分表路由管理者</span>\n<span>ITableRouteManager</span> tableRouteManager<span>=</span><span>..</span><span>..</span>\ntableRouteManager<span>.</span><span>GetRoute</span><span>(</span>EntityType<span>)</span><span>;</span>\n\n<span>//直接路由</span>\ntableRouteManager<span>.</span><span>RouteTo</span><span>(</span><span>..</span><span>..</span><span>.</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h3 id=\"ivirtualtableroute\"> IVirtualTableRoute</h3>\n<p><code>IVirtualTableRoute</code>虚拟表路由，针对对象如果我们需要对其进行分表，那么我么你必须要重写分表的路由，分表路由会告诉程序我们的这个sql执行是该如何找寻对应的实际表，而不用用户手动去指定对应的表，每一个虚拟表都会拥有一个虚拟表路由</p>\n<div><pre><code><span>//首先获取分表管理者</span>\n<span>ITableRouteManager</span> tableRouteManager<span>=</span><span>..</span><span>.</span><span>;</span>\n<span>//通过分表路由管理者获取分表路由</span>\ntableRouteManager<span>.</span><span>GetRoute</span><span>(</span>EntityType<span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div>",
      "date_published": "2021-11-03T00:33:21.000Z",
      "date_modified": "2022-07-06T04:55:30.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "常见的问题",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/question/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/question/",
      "content_html": "<h3 id=\"使用外键报错\"> 使用外键报错</h3>\n<p>这边建议您在使用外键的时候如果是主表也是分表的情况下最好的情况就是取消外键</p>\n<p><a href=\"https://github.com/xuejmnet/sharding-core/blob/main/samples/Sample.Migrations/RemoveForeignKeyMigrationsModelDiffer.cs\" target=\"_blank\" rel=\"noopener noreferrer\">移除外键的方法</a></p>\n<h3 id=\"没有自动建表\"> 没有自动建表</h3>\n<p>为什么我继承了默认的按时间分表,并且对<code>AutoCreateTableByTime</code>返回了true，但是还是没有建表呢？</p>\n<ul>\n<li>首先确定是否是iis是否设置了休眠(默认就是休眠的20分钟)</li>\n<li>然后查询数据库链接账号是否拥有权限建表</li>\n<li>最后查询各个路由建表的时间节点对应的日志<a href=\"/sharding-core-doc/sharding-route/default-route/#abstractsimpleshardingweekkeydatetimevirtualtableroute\">默认路由创建节点</a></li>\n<li>如果没有可以选择开启DoLogError错误日志会输出详细错误</li>\n</ul>\n<h3 id=\"我不想在默认的时间点建表\"> 我不想在默认的时间点建表</h3>\n<ul>\n<li>修改对应的cron表达式返回<code>GetCronExpressions()</code></li>\n<li>并且重写<code>IncrementMinutes</code>值</li>\n</ul>\n<p>原理:会在对应的cron表达式时间节点后添加<code>IncrementMinutes</code>分钟时间,然后算出对应的<code>tail</code>如果不重写<code>IncrementMinutes</code>会导致时间节点还是当前时间导致没办法创建表</p>\n",
      "date_published": "2021-11-03T14:36:42.000Z",
      "date_modified": "2021-12-15T03:42:43.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "常见的问题"
      ]
    },
    {
      "title": "注意事项",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/read-write/note/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/read-write/note/",
      "content_html": "<h2 id=\"读写分离需要注意的事项\"> 读写分离需要注意的事项</h2>\n<p>默认如果你的项目使用了读写分离,那么在efcore层面需要注意的问题有两点</p>\n<h3 id=\"追踪\"> 追踪</h3>\n<p>是否需要追踪:这是一个很严肃的问题,使用读写分离并且开启读写分离的情况下查询都会走读库,并且读库的链接和写库的不一样那么自然而然的无法使用同一个dbconnection所以没有办法合理使用同一个dbcontext就没办法使用追踪\n所以可以选择默认关闭使用读写分离,在需要时进行开启</p>\n<div><pre><code>.AddReadWriteSeparation(sp =&gt;\n                {\n                    return new Dictionary&lt;string, IEnumerable&lt;string&gt;&gt;()\n                    {\n                        {\n                            &quot;A&quot;, new HashSet&lt;string&gt;()\n                            {\n                                &quot;Data Source=localhost;Initial Catalog=ShardingCoreDBB;Integrated Security=True;&quot;\n                            }\n                        }\n                    };\n                },ReadStrategyEnum.Loop,defaultEnable: false, readConnStringGetStrategy:ReadConnStringGetStrategyEnum.LatestEveryTime)\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></div></div><p><code>defaultEnable</code>:表示默认创建的dbcontext是走的读库还是写库，如果你需要实现追踪那么可以先将这个值设置为false,然后再需要的时候通过如下代码来进行切换或者使用scope范围方式</p>\n<div><pre><code>    <span>//切换到从数据库</span>\n    _virtualDbContext<span>.</span><span>ReadWriteSeparationReadOnly</span><span>(</span><span>)</span><span>;</span>\n    <span>//切换到主数据库</span>\n    _virtualDbContext<span>.</span><span>ReadWriteSeparationWriteOnly</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><p>或者通过实现中间件middleware或者actionfilter来实现范围</p>\n<div><pre><code>\n            <span>using</span> <span>(</span>_shardingReadWriteManager<span>.</span><span><span>CreateScope</span><span><span>&lt;</span>ShardingDefaultDbContext<span>></span></span></span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                <span>//设置为走读写分离，100为默认的优先级如果你在配置的时候没有生效</span>\n                _shardingReadWriteManager<span>.</span><span><span>GetCurrent</span><span><span>&lt;</span>ShardingDefaultDbContext<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>SetReadWriteSeparation</span><span>(</span><span>100</span><span>,</span> <span>true</span><span>)</span><span>;</span>\n                    <span><span>var</span></span> areaB <span>=</span> <span>await</span> _virtualDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Area <span>==</span> <span>\"B\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div>",
      "date_published": "2021-12-29T02:58:20.000Z",
      "date_modified": "2021-12-29T02:58:20.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "读写分离"
      ]
    },
    {
      "title": "读写分离",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/read-write/configure/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/read-write/configure/",
      "content_html": "<h2 id=\"介绍\"> 介绍</h2>\n<p>简单介绍下目前<code>ShardingCore</code>框架支持一主多从的读写分离架构,具体的数据库实现可以通过百度等搜索引擎查询具体的配置,sqlserver主要通过发布订阅 always on mysql主要通过bin log订阅伪装slave节点等</p>\n<p>假设目前我们又两个数据源A，B这两个数据源分别拥有A有A1，A2两个从库，B拥有B1一个从库，那么假设在这种情况下我们应该如何进行配置呢</p>\n<h2 id=\"配置读写分离\"> 配置读写分离</h2>\n<div><pre><code><span>.</span><span>AddReadWriteSeparation</span><span>(</span>sp <span>=></span>\n                <span>{</span>\n                    <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> IEnumerable<span>&lt;</span><span>string</span><span>></span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span><span>\"A\"</span><span>,</span><span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span><span>{</span><span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBA1;Integrated Security=True;\"</span><span>,</span><span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBA2;Integrated Security=True;\"</span><span>}</span><span>}</span><span>,</span>\n                        <span>{</span><span>\"B\"</span><span>,</span><span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span><span>{</span><span>\"Data Source=localhost;Initial Catalog=ShardingCoreDBB1;Integrated Security=True;\"</span><span>}</span><span>}</span>\n                    <span>}</span><span>;</span>\n                <span>}</span><span>,</span>ReadStrategyEnum<span>.</span>Loop<span>,</span><span>defaultEnable</span><span>:</span><span>true</span><span>,</span><span>defaultPriority</span><span>:</span><span>10</span><span>,</span>ReadConnStringGetStrategyEnum<span>.</span>LatestFirstTime<span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><p>这样我们就配置好了针对A数据源从数据库A1，A2针对B数据源B1从库</p>\n<h2 id=\"参数说明\"> 参数说明</h2>\n<h3 id=\"readstrategyenum\"> ReadStrategyEnum</h3>\n<h4 id=\"readstrategyenum-loop\"> ReadStrategyEnum.Loop</h4>\n<p>表示同一个数据源的从库链接读取策略为轮询一个接一个公平读取,（可以设置同一个链接多次就是所谓的权重）</p>\n<h4 id=\"readstrategyenum-random\"> ReadStrategyEnum.Random</h4>\n<p>表示针对同一个数据源获取链接采用随机策略,（可以设置同一个链接多次就是所谓的权重）</p>\n<h3 id=\"defaultenable\"> defaultEnable</h3>\n<p>表示是否默认读操作走读数据库true:表示默认读取查询操作走从库，false表示默认读取查询操作还是走主库</p>\n<p>如果全局设置为true/false后想要修改当前dbcontext可以通过</p>\n<div><pre><code>    <span>//切换到从数据库</span>\n    _virtualDbContext<span>.</span><span>ReadWriteSeparationReadOnly</span><span>(</span><span>)</span><span>;</span>\n    <span>//切换到主数据库</span>\n    _virtualDbContext<span>.</span><span>ReadWriteSeparationWriteOnly</span><span>(</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><p>以上两个扩展将无法作用于写入操作，写入操作永远只会走主库而非从库</p>\n<p>除了通过dbcontext上的属性也支持通过scope创建</p>\n<div><pre><code>            <span>using</span> <span>(</span>_shardingReadWriteManager<span>.</span><span><span>CreateScope</span><span><span>&lt;</span>ShardingDefaultDbContext<span>></span></span></span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                _shardingReadWriteManager<span>.</span><span><span>GetCurrent</span><span><span>&lt;</span>ShardingDefaultDbContext<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>SetReadWriteSeparation</span><span>(</span><span>100</span><span>,</span> <span>true</span><span>)</span><span>;</span>\n                <span>using</span> <span>(</span>_shardingRouteManager<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n                <span>{</span>\n                    _shardingRouteManager<span>.</span>Current<span>.</span><span><span>TryCreateOrAddMustDataSource</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>\"A\"</span><span>)</span><span>;</span>\n                    <span><span>var</span></span> areaB <span>=</span> <span>await</span> _virtualDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Area <span>==</span> <span>\"B\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n                    Assert<span>.</span><span>NotNull</span><span>(</span>areaB<span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br></div></div><p>被<code>_shardingReadWriteManager.CreateScope</code>包括的内部查询将使用对应的读写分离优先级和是否启用来判断，通过依赖注入<code>ServiceProvider.GetSerivce&lt;IShardingReadWriteManager&gt;()</code>来获取</p>\n<h3 id=\"defaultpriority\"> defaultPriority</h3>\n<p>表示默认的读写分离优先级，先判断优先级在判断高优先级是否启用来确定dbcontext是否启用读写分离</p>\n<h3 id=\"readconnstringgetstrategyenum\"> ReadConnStringGetStrategyEnum</h3>\n<h4 id=\"readconnstringgetstrategyenum-latestfirsttime\"> ReadConnStringGetStrategyEnum.LatestFirstTime</h4>\n<p>表示针对同一个dbcontext只取一次从库链接，保证同一个dbcontext下的从库链接都是一样的，不会出现说查询主表数据存在但是第二次查询可能走的是其他从库导致明细表不存在等问题，所以建议大部分情况下使用LatestFirstTime</p>\n<h4 id=\"readconnstringgetstrategyenum-latesteverytime\"> ReadConnStringGetStrategyEnum.LatestEveryTime</h4>\n<p>表示每一次查询都是获取一次从库，但是可能会出现比如page的两次操作count+list结果和实际获取的不一致等情况，大部分情况下不会出现问题只是有可能会出现这种情况</p>\n",
      "date_published": "2021-11-14T15:10:44.000Z",
      "date_modified": "2021-12-30T04:41:43.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "读写分离"
      ]
    },
    {
      "title": "删除",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-all/delete/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-all/delete/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingAll\" target=\"_blank\" rel=\"noopener noreferrer\">SqlServerShardingAll</a></p>\n<h2 id=\"删除数据\"> 删除数据</h2>\n<p>增删改查除了查询稍微在分表+排序的情况下需要注意其实其他操作和efcore基本上一致</p>\n<p>删除也是</p>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Delete</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"9\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            _myDbContext<span>.</span><span>Remove</span><span>(</span>sysUser<span>)</span><span>;</span>\n            <span><span>var</span></span> i <span>=</span> <span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><p>控制台我们可以看到对应的执行sql</p>\n<div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      DELETE FROM <span>[</span>SysUser_00<span>]</span>\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p0<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div>",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2021-11-07T06:26:04.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "项目主页",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/",
      "content_html": "<br/>\n<p align=\"center\">\n<div>\n<p><a href=\"https://www.nuget.org/packages/ShardingCore\" target=\"_blank\"><img src=\"https://img.shields.io/nuget/v/ShardingCore.svg?style=flat-square\" alt=\"nuget\"></a>\n<a href=\"https://www.nuget.org/stats/packages/ShardingCore?groupby=Version\" target=\"_blank\"><img src=\"https://img.shields.io/nuget/dt/ShardingCore.svg?style=flat-square\" alt=\"nuget\"></a>\n<a href=\"https://github.com/xuejmnet/sharding-core/blob/main/LICENSE\" target=\"_blank\"><img src=\"https://img.shields.io/badge/license-Apache 2-blue\" alt=\"license\"></a></p>\n</div>\n</p>\n<h2 id=\"🔔交流qq群\"> 🔔交流QQ群</h2>\n<div>\n<img src=\"/sharding-core-doc/join-qq-group.jpg\" alt=\"群号: 771630778\" style=\"width:200px;\">\n<h4 id=\"shardingcore官方qq群-771630778\"> ShardingCore官方QQ群: 771630778</h4>\n</div>\n<br/>\n<h2 id=\"许可证\"> 许可证</h2>\n<p><a href=\"https://github.com/xuejmnet/sharding-core/blob/main/LICENSE\" target=\"_blank\" rel=\"noopener noreferrer\">Apache-2.0 License</a></p>\n<h2 id=\"文档主题\"> 文档主题</h2>\n<p><a href=\"https://vuepress-theme-hope.github.io/\" target=\"_blank\" rel=\"noopener noreferrer\">vuepress-theme-hope</a></p>\n",
      "date_published": "2021-11-02T08:39:31.000Z",
      "date_modified": "2021-12-08T01:08:41.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": []
    },
    {
      "title": "初始化",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-all/init/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-all/init/",
      "content_html": "<h2 id=\"介绍\"> 介绍</h2>\n<div><p>分库分表介绍</p>\n<ol>\n<li><code>sharding-core</code>支持自定义分库,流式聚合,支持同表join,数据源并非分表的笛卡尔积而是交集,比如我分库的对象和不分库的对象join结果只会查询不分库对象对应的数据源</li>\n<li>分库下的分布式事务(支持业务逻辑导致的事务出错可以回滚),网络情况下的事务出错直接忽略除非是第一个提交的事务,第二个数据源提交的事务开始就直接忽略异常。</li>\n</ol>\n</div>\n<h2 id=\"demo\"> Demo</h2>\n<p>本次分库的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingAll\" target=\"_blank\" rel=\"noopener noreferrer\">SqlServerShardingAll</a></p>\n<h2 id=\"分表使用\"> 分表使用</h2>\n<p>先拟定一个场景目前有用户表<code>SysUser</code>和订单表<code>Order</code>，用户我们按用户区域进行分库按用户Id取模分表,订单我们按用户区域分库按订单时间分表</p>\n<p>首先创建一个空的aspnetcore web api。</p>\n<h3 id=\"安装shardingcore\"> 安装ShardingCore</h3>\n<div><pre><code><span># 请对应安装您需要的版本</span>\nPM<span>></span> Install-Package ShardingCore\n<span># 请对应数据库版本</span>\nPM<span>></span> Install-Package Microsoft.EntityFrameworkCore.SqlServer\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><h3 id=\"创建对象\"> 创建对象</h3>\n<div><pre><code>    <span>public</span> <span>enum</span> <span>OrderStatusEnum</span>\n    <span>{</span>\n        NoPay<span>=</span><span>1</span><span>,</span>\n        Paying<span>=</span><span>2</span><span>,</span>\n        Payed<span>=</span><span>3</span><span>,</span>\n        PayFail<span>=</span><span>4</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>Order</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Payer <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>long</span></span> Money <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>OrderStatusEnum</span> OrderStatus <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>DateTime</span> CreationTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>SysUser</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br></div></div><h3 id=\"创建dbcontext\"> 创建DbContext</h3>\n<p>这样我们就创建好了三张表，接下来我们创建我们的<code>DbContext</code>,因为需要分表所以我们需要实现<code>IShardingTableDbContext</code>接口</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span><span>IShardingTableDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Payer<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>OrderStatus<span>)</span><span>.</span><span><span>HasConversion</span><span><span>&lt;</span><span>int</span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Name<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>SysUser<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br></div></div><div><p>自定义标题</p>\n<ol>\n<li>构造函数必须是<code>DbContextOptions&lt;MyDbContext&gt;</code>或者<code>DbContextOptions</code></li>\n<li><code>OnModelCreating</code>并不是说分表必须要这样，而是你原先efcore怎么使用就怎么使用，efcore配置对象有两种一种是<code>DbSet</code>+<code>Attribute</code>,另外一种是<code>OnModelCreating</code>+<code>ModelBuilder</code>,你可以选择你原先在用的任何一种</li>\n<li><code>AbstractShardingDbContext</code>这个对象是可以不继承的，但是如果要使用分表分库你必须实现<code>IShardingTableDbContext</code>这个接口,因为这个接口实现起来都是一样的所以默认你只需要继承<code>AbstractShardingDbContext</code>就可以了</li>\n<li><code>IShardingTableDbContext</code>这个接口在你需要支持分表的情况下需要加，如果您只是分库那么就不需要添加这个接口</li>\n</ol>\n</div>\n<h3 id=\"创建虚拟路由\"> 创建虚拟路由</h3>\n<ol>\n<li>订单表按用户区域分库,因为分库系统并没有给我提供默认的分库路由,所以需要我们自行实现,我们先假设我们的数据源为A,B,C三个数据源,\n再按订单时间分表</li>\n<li>用户按区域分库,在按用户Id取模</li>\n</ol>\n<div><pre><code>    <span>//订单分库路由</span>\n    <span>public</span> <span>class</span> <span>OrderVirtualDataSourceRoute</span> <span>:</span> <span><span>AbstractShardingOperatorVirtualDataSourceRoute<span>&lt;</span>Order<span>,</span> <span>string</span><span>></span></span></span>\n    <span>{</span>\n        <span>private</span> <span>readonly</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> _dataSources <span>=</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>\"A\"</span><span>,</span> <span>\"B\"</span><span>,</span> <span>\"C\"</span>\n        <span>}</span><span>;</span>\n        <span>protected</span> <span>override</span> <span><span>string</span></span> <span>ConvertToShardingKey</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> shardingKey<span>?.</span><span>ToString</span><span>(</span><span>)</span> <span>??</span> <span>string</span><span>.</span>Empty<span>;</span>\n        <span>}</span>\n        <span>//我们设置区域就是数据库</span>\n        <span>public</span> <span>override</span> <span><span>string</span></span> <span>ShardingKeyToDataSourceName</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> <span>ConvertToShardingKey</span><span>(</span>shardingKey<span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> <span>GetAllDataSourceNames</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> _dataSources<span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AddDataSourceName</span><span>(</span><span><span>string</span></span> dataSourceName<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>_dataSources<span>.</span><span>Any</span><span>(</span>o <span>=></span> o <span>==</span> dataSourceName<span>)</span><span>)</span>\n                <span>return</span> <span>false</span><span>;</span>\n            _dataSources<span>.</span><span>Add</span><span>(</span>dataSourceName<span>)</span><span>;</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>string</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n\n            <span><span>var</span></span> t <span>=</span> <span>ShardingKeyToDataSourceName</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                    <span>{</span>\n                        <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                    <span>}</span>\n            <span>}</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataDataSourceBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>//订单分表路由</span>\n    <span>public</span> <span>class</span> <span>OrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>CreationTime<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>//用户区域分库</span>\n    <span>public</span> <span>class</span> <span>SysUserVirtualDataSourceRoute</span> <span>:</span> <span><span>AbstractShardingOperatorVirtualDataSourceRoute<span>&lt;</span>SysUser<span>,</span> <span>string</span><span>></span></span></span>\n    <span>{</span>\n        <span>private</span> <span>readonly</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> _dataSources <span>=</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>\"A\"</span><span>,</span> <span>\"B\"</span><span>,</span> <span>\"C\"</span>\n        <span>}</span><span>;</span>\n        <span>protected</span> <span>override</span> <span><span>string</span></span> <span>ConvertToShardingKey</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> shardingKey<span>?.</span><span>ToString</span><span>(</span><span>)</span> <span>??</span> <span>string</span><span>.</span>Empty<span>;</span>\n        <span>}</span>\n        <span>//我们设置区域就是数据库</span>\n        <span>public</span> <span>override</span> <span><span>string</span></span> <span>ShardingKeyToDataSourceName</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> <span>ConvertToShardingKey</span><span>(</span>shardingKey<span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> <span>GetAllDataSourceNames</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> _dataSources<span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AddDataSourceName</span><span>(</span><span><span>string</span></span> dataSourceName<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>_dataSources<span>.</span><span>Any</span><span>(</span>o <span>=></span> o <span>==</span> dataSourceName<span>)</span><span>)</span>\n                <span>return</span> <span>false</span><span>;</span>\n            _dataSources<span>.</span><span>Add</span><span>(</span>dataSourceName<span>)</span><span>;</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>string</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n\n            <span><span>var</span></span> t <span>=</span> <span>ShardingKeyToDataSourceName</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataDataSourceBuilder<span>&lt;</span>SysUser<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>//用户Id取模</span>\n    \n    <span>public</span> <span>class</span> <span>SysUserVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>SysUser<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>SysUserVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>SysUser<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br><span>111</span><br><span>112</span><br><span>113</span><br><span>114</span><br><span>115</span><br><span>116</span><br><span>117</span><br><span>118</span><br><span>119</span><br><span>120</span><br><span>121</span><br><span>122</span><br><span>123</span><br><span>124</span><br></div></div><div><p>注意</p>\n<p>因为分库提供默认路由所以需要用户自行实现<code>AbstractShardingOperatorVirtualDataSourceRoute</code>抽象,分表有默认抽象路由但是如果无法满足需求可以自定义实现<code>AbstractShardingOperatorVirtualTableRoute</code>抽象</p>\n</div>\n<h3 id=\"startup配置\"> Startup配置</h3>\n<p><code>ConfigureServices(IServiceCollection services)</code>配置</p>\n<div><pre><code>        <span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>\n        <span>{</span>\n\n            services<span>.</span><span>AddControllers</span><span>(</span><span>)</span><span>;</span>\n            \n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n                <span>.</span><span>AddEntityConfig</span><span>(</span>o <span>=></span>\n                <span>{</span>\n                    o<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                    o<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n                    o<span>.</span><span><span>AddShardingDataSourceRoute</span><span><span>&lt;</span>OrderVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    o<span>.</span><span><span>AddShardingDataSourceRoute</span><span><span>&lt;</span>SysUserVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    o<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    o<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span>\n                <span>.</span><span>AddConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span>ConfigId <span>=</span> <span>\"c1\"</span><span>;</span>\n                    op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conStr<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>ReplaceTableEnsureManager</span><span>(</span>sp <span>=></span> <span>new</span> <span>SqlServerTableEnsureManager<span>&lt;</span>MyDbContext<span>></span></span><span>(</span><span>)</span><span>)</span><span>;</span>\n                    op<span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"A\"</span><span>,</span>\n                     <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDataSourceTableDBA;Integrated Security=True;\"</span><span>)</span><span>;</span>\n                    op<span>.</span><span>AddExtraDataSource</span><span>(</span>sp <span>=></span>\n                    <span>{</span>\n                        <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span>\n                            <span>\"B\"</span><span>,</span><span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDataSourceTableDBB;Integrated Security=True;\"</span>\n                        <span>}</span><span>,</span>\n                        <span>{</span>\n                            <span>\"C\"</span><span>,</span><span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDataSourceTableDBC;Integrated Security=True;\"</span>\n                        <span>}</span><span>,</span>\n                    <span>}</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>EnsureConfig</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br></div></div><div><p>重要</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n</div>\n<p>新建一个扩展方法用来初始化ShardingCore和初始化种子数据</p>\n<div><pre><code>   \n    <span>public</span> <span>static</span> <span>class</span> <span>StartupExtension</span>\n    <span>{</span>\n        <span>public</span> <span>static</span> <span><span>void</span></span> <span>UseShardingCore</span><span>(</span><span>this</span> <span>IApplicationBuilder</span> app<span>)</span>\n        <span>{</span>\n            app<span>.</span>ApplicationServices<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>public</span> <span>static</span> <span><span>void</span></span> <span>InitSeed</span><span>(</span><span>this</span> <span>IApplicationBuilder</span> app<span>)</span>\n        <span>{</span>\n            <span>using</span> <span>(</span><span><span>var</span></span> serviceScope <span>=</span> app<span>.</span>ApplicationServices<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                <span><span>var</span></span> myDbContext <span>=</span> serviceScope<span>.</span>ServiceProvider<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>if</span> <span>(</span><span>!</span>myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Any</span><span>(</span><span>)</span><span>)</span>\n                <span>{</span>\n                    <span><span>string</span><span>[</span><span>]</span></span> areas <span>=</span> <span>new</span> <span><span>string</span><span>[</span><span>]</span></span> <span>{</span><span>\"A\"</span><span>,</span><span>\"B\"</span><span>,</span><span>\"C\"</span> <span>}</span><span>;</span>\n                    <span>List<span>&lt;</span>SysUser<span>></span></span> users <span>=</span> <span>new</span> <span>List<span>&lt;</span>SysUser<span>></span></span><span>(</span><span>10</span><span>)</span><span>;</span>\n                    <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>100</span><span>;</span> i<span>++</span><span>)</span>\n                    <span>{</span>\n                        <span><span>var</span></span> uer<span>=</span><span>new</span> <span>SysUser</span><span>(</span><span>)</span>\n                        <span>{</span>\n                            Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                            Name <span>=</span> <span><span>$\"MyName</span><span><span>{</span><span>i</span><span>}</span></span><span>\"</span></span><span>,</span>\n                            Area <span>=</span> areas<span>[</span><span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>Next</span><span>(</span><span>0</span><span>,</span><span>3</span><span>)</span><span>]</span>\n                        <span>}</span><span>;</span>\n                        users<span>.</span><span>Add</span><span>(</span>uer<span>)</span><span>;</span>\n                    <span>}</span>\n                    <span>List<span>&lt;</span>Order<span>></span></span> orders <span>=</span> <span>new</span> <span>List<span>&lt;</span>Order<span>></span></span><span>(</span><span>300</span><span>)</span><span>;</span>\n                    <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>,</span> <span>3</span><span>,</span> <span>3</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n                    <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>300</span><span>;</span> i<span>++</span><span>)</span>\n                    <span>{</span>\n                        <span><span>var</span></span> sysUser <span>=</span> users<span>[</span>i <span>%</span> <span>100</span><span>]</span><span>;</span>\n                        <span><span>var</span></span> order <span>=</span> <span>new</span> <span>Order</span><span>(</span><span>)</span>\n                        <span>{</span>\n                            Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                            Payer <span>=</span> sysUser<span>.</span>Id<span>,</span>\n                            Money <span>=</span> <span>100</span><span>+</span><span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>Next</span><span>(</span><span>100</span><span>,</span><span>3000</span><span>)</span><span>,</span>\n                            OrderStatus <span>=</span> <span>(</span>OrderStatusEnum<span>)</span><span>(</span>i <span>%</span> <span>4</span> <span>+</span> <span>1</span><span>)</span><span>,</span>\n                            Area <span>=</span> sysUser<span>.</span>Area<span>,</span>\n                            CreationTime <span>=</span> begin<span>.</span><span>AddDays</span><span>(</span>i<span>)</span>\n                        <span>}</span><span>;</span>\n                        orders<span>.</span><span>Add</span><span>(</span>order<span>)</span><span>;</span>\n                    <span>}</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>users<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>orders<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br></div></div><p><code>Configure(IApplicationBuilder app, IWebHostEnvironment env)</code>配置</p>\n<div><pre><code>        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>env<span>.</span><span>IsDevelopment</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                app<span>.</span><span>UseDeveloperExceptionPage</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n            <span>//初始化ShardingCore</span>\n            app<span>.</span><span>UseShardingCore</span><span>(</span><span>)</span><span>;</span>\n            app<span>.</span><span>UseRouting</span><span>(</span><span>)</span><span>;</span>\n\n            app<span>.</span><span>UseAuthorization</span><span>(</span><span>)</span><span>;</span>\n\n            app<span>.</span><span>UseEndpoints</span><span>(</span>endpoints <span>=></span>\n            <span>{</span>\n                endpoints<span>.</span><span>MapControllers</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            <span>//初始化种子数据</span>\n            app<span>.</span><span>InitSeed</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><h3 id=\"efcore日志-可选\"> efcore日志(可选)</h3>\n<p>这边为了方便我们观察efcore的执行sql语句我们这边建议对efcore添加日志\n<code>Startup</code>添加静态数据</p>\n<div><pre><code>        <span>public</span> <span>static</span> <span>readonly</span> <span>ILoggerFactory</span> efLogger <span>=</span> LoggerFactory<span>.</span><span>Create</span><span>(</span>builder <span>=></span>\n        <span>{</span>\n            builder<span>.</span><span>AddFilter</span><span>(</span><span>(</span>category<span>,</span> level<span>)</span> <span>=></span> category <span>==</span> DbLoggerCategory<span>.</span>Database<span>.</span>Command<span>.</span>Name <span>&amp;&amp;</span> level <span>==</span> LogLevel<span>.</span>Information<span>)</span><span>.</span><span>AddConsole</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><p>在所有<code>builder.UseSqlServer(conStr);</code></p>\n<p>都改成<code>builder.UseSqlServer(conStr).UseLoggerFactory(efLogger);</code></p>\n<p>启动后我们将可以看到数据库和表会被自动创建，并且会将种子数据进行插入到内部供我们可以查询测试</p>\n<img src=\"/sharding-core-doc/sharding-data-source-table.png\">",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2022-02-09T08:52:58.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "修改",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-all/update/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-all/update/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分库的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingAll\" target=\"_blank\" rel=\"noopener noreferrer\">SqlServerShardingAll</a></p>\n<h2 id=\"自动追踪修改\"> 自动追踪修改</h2>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Update</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            sysUser<span>.</span>Name <span>=</span> <span>\"new name\"</span><span>;</span>\n            <span><span>var</span></span> i<span>=</span><span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>13ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p1<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      UPDATE <span>[</span>SysUser_01<span>]</span> SET <span>[</span>Name<span>]</span> <span>=</span> @p0\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p1<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"非自动追踪修改\"> 非自动追踪修改</h2>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Update1</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsNoTracking</span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            sysUser<span>.</span>Name <span>=</span> <span>\"new name\"</span><span>;</span>\n            _myDbContext<span>.</span><span>Update</span><span>(</span>sysUser<span>)</span><span>;</span>\n            <span><span>var</span></span> i <span>=</span> <span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p2<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p1<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      UPDATE <span>[</span>SysUser_01<span>]</span> SET <span>[</span>Area<span>]</span> <span>=</span> @p0, <span>[</span>Name<span>]</span> <span>=</span> @p1\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p2<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><div><p>结论</p>\n<p>追踪情况下sharding-core依然可以对结果进行修改，修改的字段是被修改过后的字段</p>\n<p>非追踪情况下sharding-croe也支持查询修改，但是修改的字段是全字段</p>\n</div>\n",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2021-11-07T06:26:04.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "删除",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-data-source/delete/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-data-source/delete/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingDataSource\" target=\"_blank\" rel=\"noopener noreferrer\">SqlServerShardingDataSource</a></p>\n<h2 id=\"删除数据\"> 删除数据</h2>\n<p>增删改查除了查询稍微在分表+排序的情况下需要注意其实其他操作和efcore基本上一致</p>\n<p>删除也是</p>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Delete</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"9\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            _myDbContext<span>.</span><span>Remove</span><span>(</span>sysUser<span>)</span><span>;</span>\n            <span><span>var</span></span> i <span>=</span> <span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><p>控制台我们可以看到对应的执行sql</p>\n<div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>12ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      DELETE FROM <span>[</span>SysUser<span>]</span>\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p0<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div>",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2021-11-07T06:26:04.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-all/query/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-all/query/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分库的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingAll\" target=\"_blank\" rel=\"noopener noreferrer\">SqlServerShardingAll</a></p>\n<h2 id=\"单对象简单查询\"> 单对象简单查询</h2>\n<p>对<code>SysUser</code>和<code>Order</code>进行查询</p>\n<div><pre><code><span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Query</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span><span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>Id<span>==</span><span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> sysUserA1 <span>=</span><span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>Id<span>==</span><span>\"1\"</span><span>&amp;&amp;</span>o<span>.</span>Area<span>==</span><span>\"A\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> dateTime <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span><span>3</span><span>,</span><span>5</span><span>)</span><span>;</span>\n            <span><span>var</span></span> order <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>>=</span> dateTime<span>)</span><span>.</span><span>OrderBy</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> orderIdOne <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"3\"</span><span>)</span><span>;</span>\n\n\n            <span><span>var</span></span> sysUsers <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id<span>==</span><span>\"6\"</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n\n            <span>return</span> <span>Ok</span><span>(</span><span>new</span> <span><span>object</span><span>[</span><span>]</span></span>\n            <span>{</span>\n                sysUser<span>,</span>\n                order<span>,</span>\n                orderIdOne<span>,</span>\n                sysUsers\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"C\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"63\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"63\"</span><span>,</span><span>\"money\"</span><span>:</span><span>1292</span><span>,</span><span>\"area\"</span><span>:</span><span>\"C\"</span><span>,</span><span>\"orderStatus\"</span><span>:</span><span>4</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-05T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"money\"</span><span>:</span><span>2975</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"orderStatus\"</span><span>:</span><span>4</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-01-04T03:03:03\"</span><span>}</span><span>,</span><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"C\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>}</span><span>]</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>、\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>    \n      <span>..</span><span>..</span><span>..</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br></div></div><p>因为查询脚本是在太多了部分没用到索引所以会全库+全表，这边就用第一个查询来进行分析,具体你可以通过demo例子进行处理,首先我们先确定下我们是按<code>Area</code>区域进行分库的，所以在没有这个字段的时候可以明确知道程序会查询3个数据库,会打开三个链接，虽然是三个链接但是每个链接因为分表关键字Id可以索引所以只会查询每个库的自身的表，</p>\n<p>第二个查询结果可以很明显看到有了分库索引后只选择其中一个库而不是所有的库,并且因为加了分表索引，所以只会有一个表而不是所有的表</p>\n<h2 id=\"join\"> join</h2>\n<h3 id=\"分库join分库\"> 分库join分库</h3>\n<ol>\n<li>无索引</li>\n</ol>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>QueryJoin</span><span>(</span><span>)</span>\n        <span>{</span>\n           <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>3</span><span>,</span> <span>2</span><span>)</span><span>;</span>\n           <span><span>var</span></span> end <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>5</span><span>,</span> <span>9</span><span>)</span><span>;</span>\n           <span><span>var</span></span> sql1 <span>=</span> <span>from</span> user <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id <span>==</span> <span>\"6\"</span><span>)</span>\n               <span>join</span> order <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>>=</span>begin<span>&amp;&amp;</span>o<span>.</span>CreationTime<span>&lt;=</span>end<span>)</span>\n                   <span>on</span> user<span>.</span>Id equals order<span>.</span>Payer\n               <span>select</span> <span>new</span>\n               <span>{</span>\n                   user<span>.</span>Id<span>,</span>\n                   user<span>.</span>Name<span>,</span>\n                   user<span>.</span>Area<span>,</span>\n                   OrderId <span>=</span> order<span>.</span>Id<span>,</span>\n                   order<span>.</span>Payer<span>,</span>\n                   order<span>.</span>CreationTime\n               <span>}</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span><span>await</span> sql1<span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"C\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"101\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-04-12T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"106\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-04-17T03:03:03\"</span><span>}</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>17ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>24ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>21ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>22ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>16ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>17ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>17ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>61ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>110ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>64ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br><span>111</span><br><span>112</span><br><span>113</span><br><span>114</span><br><span>115</span><br><span>116</span><br><span>117</span><br><span>118</span><br><span>119</span><br><span>120</span><br><span>121</span><br><span>122</span><br><span>123</span><br><span>124</span><br><span>125</span><br><span>126</span><br><span>127</span><br><span>128</span><br><span>129</span><br><span>130</span><br><span>131</span><br><span>132</span><br><span>133</span><br><span>134</span><br><span>135</span><br><span>136</span><br><span>137</span><br><span>138</span><br><span>139</span><br><span>140</span><br><span>141</span><br><span>142</span><br><span>143</span><br><span>144</span><br><span>145</span><br><span>146</span><br><span>147</span><br><span>148</span><br><span>149</span><br><span>150</span><br><span>151</span><br><span>152</span><br><span>153</span><br><span>154</span><br><span>155</span><br><span>156</span><br><span>157</span><br><span>158</span><br><span>159</span><br><span>160</span><br><span>161</span><br><span>162</span><br><span>163</span><br><span>164</span><br><span>165</span><br><span>166</span><br><span>167</span><br><span>168</span><br><span>169</span><br><span>170</span><br><span>171</span><br><span>172</span><br><span>173</span><br><span>174</span><br><span>175</span><br><span>176</span><br><span>177</span><br><span>178</span><br><span>179</span><br><span>180</span><br></div></div><p>一共开了18个链接,无法索引数据库3个,月份3,4,5月3张表,userid 1或者 6两张表一共是3<em>3</em>2=18个链接,因为是并行的而且使用完成后马上释放所以性能还是很高的</p>\n<ol start=\"2\">\n<li>有索引<code>Area</code>就是索引</li>\n</ol>\n<div><pre><code>\n        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>QueryJoin2</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>3</span><span>,</span> <span>2</span><span>)</span><span>;</span>\n            <span><span>var</span></span> end <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>4</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n            <span><span>var</span></span> sql1 <span>=</span> <span>from</span> user <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> <span>(</span>o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id <span>==</span> <span>\"6\"</span><span>)</span><span>&amp;&amp;</span>o<span>.</span>Area<span>==</span><span>\"A\"</span><span>)</span>\n                <span>join</span> order <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>CreationTime <span>>=</span> begin <span>&amp;&amp;</span> o<span>.</span>CreationTime <span>&lt;=</span> end<span>)</span>\n                    <span>on</span> user<span>.</span>Id equals order<span>.</span>Payer\n                <span>select</span> <span>new</span>\n                <span>{</span>\n                    user<span>.</span>Id<span>,</span>\n                    user<span>.</span>Name<span>,</span>\n                    user<span>.</span>Area<span>,</span>\n                    OrderId <span>=</span> order<span>.</span>Id<span>,</span>\n                    order<span>.</span>Payer<span>,</span>\n                    order<span>.</span>CreationTime\n                <span>}</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span><span>await</span> sql1<span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"106\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-04-17T03:03:03\"</span><span>}</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>51ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>12ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>18ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>16ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>52ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>52ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br></div></div><p>因为附带了索引，所以本次查询只需要月份3张表+userid两张表+A区域的一个库所以是3<em>2</em>1=6个链接</p>\n<div><p>注意</p>\n<ol>\n<li>如果本次查询涉及<code>跨表</code>或者<code>跨库</code>并且查询附带<code>order by</code>那么order by的字段必须包含在返回结果里面.(聚合函数除外：count,any,sum......)</li>\n<li>应该尽可能避免分库join分库,如果实在需要join那么也应该尽可能指定某一张表或者分表的数目尽可能小。(因为分表后如果a1,a2 join b1,b2那么就会有2个结果相互组合,路由结果越多性能越低，会生成各自datasourcename的交集,并且对各自的库下的表join会生成笛卡尔积)</li>\n</ol>\n</div>\n<h3 id=\"查询接口支持\"> 查询接口支持</h3>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>Method</th>\n<th><a href=\"https://github.com/xuejmnet/sharding-core/blob/main/test/ShardingCore.Test50/ShardingTest.cs\" target=\"_blank\" rel=\"noopener noreferrer\">Unit Test</a></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>第一条</td>\n<td>FindAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>获取集合</td>\n<td>ToListAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>第一条</td>\n<td>FirstOrDefaultAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>最大</td>\n<td>MaxAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>最小</td>\n<td>MinAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>是否存在</td>\n<td>AnyAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>数目</td>\n<td>CountAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>数目</td>\n<td>LongCountAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>求和</td>\n<td>SumAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>平均</td>\n<td>AverageAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>包含</td>\n<td>ContainsAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>分组</td>\n<td>GroupByAsync</td>\n<td>yes</td>\n</tr>\n</tbody>\n</table>\n<div><p>注意</p>\n<p>并不是说因为你的字段值是ABC所以我们需要将数据源定义成A、B、C,这边是因为方便通用,一般原则上我们定义为ds0,ds1,ds2，至于<code>Area</code>如何转成<code>ds0</code>,<code>ds1</code>,<code>ds2</code>那么就需要你自己去实现，比如你有一个[A..Z]的数组，数组下标就是对应的<code>ds</code>后面数字那么你就可以自己实现路由，并且还可以支持大于小于等于</p>\n</div>\n",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2021-11-07T06:26:04.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "初始化",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-data-source/init/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-data-source/init/",
      "content_html": "<h2 id=\"介绍\"> 介绍</h2>\n<div><p>分库介绍</p>\n<ol>\n<li><code>sharding-core</code>支持自定义分库,流式聚合,支持同表join,数据源并非分表的笛卡尔积而是交集,比如我分库的对象和不分库的对象join结果只会查询不分库对象对应的数据源</li>\n<li>分库下的分布式事务(支持业务逻辑导致的事务出错可以回滚),网络情况下的事务出错直接忽略除非是第一个提交的事务,第二个数据源提交的事务开始就直接忽略异常。</li>\n</ol>\n</div>\n<h2 id=\"demo\"> Demo</h2>\n<p>本次分库的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingDataSource\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreShardingDataSource</a></p>\n<h2 id=\"分表使用\"> 分表使用</h2>\n<p>先拟定一个场景目前有用户表<code>SysUser</code>和订单表<code>Order</code>，用户我们按用户区域进行分库，订单我们按用户区域分库</p>\n<p>首先创建一个空的aspnetcore web api。</p>\n<h3 id=\"安装shardingcore\"> 安装ShardingCore</h3>\n<div><pre><code><span># 请对应安装您需要的版本</span>\nPM<span>></span> Install-Package ShardingCore\n<span># 请对应数据库版本</span>\nPM<span>></span> Install-Package Microsoft.EntityFrameworkCore.SqlServer\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><h3 id=\"创建对象\"> 创建对象</h3>\n<div><pre><code>    <span>public</span> <span>enum</span> <span>OrderStatusEnum</span>\n    <span>{</span>\n        NoPay<span>=</span><span>1</span><span>,</span>\n        Paying<span>=</span><span>2</span><span>,</span>\n        Payed<span>=</span><span>3</span><span>,</span>\n        PayFail<span>=</span><span>4</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>Order</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Payer <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>long</span></span> Money <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>OrderStatusEnum</span> OrderStatus <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>DateTime</span> CreationTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>SysUser</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br></div></div><h3 id=\"创建dbcontext\"> 创建DbContext</h3>\n<p>这样我们就创建好了三张表，接下来我们创建我们的<code>DbContext</code>,因为不需要分表所以我们并不需要继承<code>IShardingTableDbContext</code>接口</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Payer<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>OrderStatus<span>)</span><span>.</span><span><span>HasConversion</span><span><span>&lt;</span><span>int</span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Name<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>SysUser<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br></div></div><div><p>自定义标题</p>\n<ol>\n<li>构造函数必须是<code>DbContextOptions&lt;MyDbContext&gt;</code>或者<code>DbContextOptions</code></li>\n<li><code>OnModelCreating</code>并不是说分表必须要这样，而是你原先efcore怎么使用就怎么使用，efcore配置对象有两种一种是<code>DbSet</code>+<code>Attribute</code>,另外一种是<code>OnModelCreating</code>+<code>ModelBuilder</code>,你可以选择你原先在用的任何一种</li>\n<li><code>AbstractShardingDbContext</code>这个对象是可以不继承的，但是如果要使用分表分库你必须实现<code>IShardingTableDbContext</code>这个接口,因为这个接口实现起来都是一样的所以默认你只需要继承<code>AbstractShardingDbContext</code>就可以了</li>\n</ol>\n</div>\n<h3 id=\"创建虚拟路由\"> 创建虚拟路由</h3>\n<ol>\n<li>订单表按用户区域分库,因为分库系统并没有给我提供默认的分库路由,所以需要我们自行实现,我们先假设我们的数据源为A,B,C三个数据源</li>\n</ol>\n<div><pre><code>\n    \n    <span>public</span> <span>class</span> <span>OrderVirtualDataSourceRoute</span><span>:</span><span><span>AbstractShardingOperatorVirtualDataSourceRoute<span>&lt;</span>Order<span>,</span><span>string</span><span>></span></span></span>\n    <span>{</span>\n        <span>private</span> <span>readonly</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> _dataSources<span>=</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>\"A\"</span><span>,</span> <span>\"B\"</span><span>,</span> <span>\"C\"</span>\n        <span>}</span><span>;</span>\n        <span>protected</span> <span>override</span> <span><span>string</span></span> <span>ConvertToShardingKey</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> shardingKey<span>?.</span><span>ToString</span><span>(</span><span>)</span> <span>??</span> <span>string</span><span>.</span>Empty<span>;</span>\n        <span>}</span>\n        <span>//我们设置区域就是数据库</span>\n        <span>public</span> <span>override</span> <span><span>string</span></span> <span>ShardingKeyToDataSourceName</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> <span>ConvertToShardingKey</span><span>(</span>shardingKey<span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> <span>GetAllDataSourceNames</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> _dataSources<span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AddDataSourceName</span><span>(</span><span><span>string</span></span> dataSourceName<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>_dataSources<span>.</span><span>Any</span><span>(</span>o <span>=></span> o <span>==</span> dataSourceName<span>)</span><span>)</span>\n                <span>return</span> <span>false</span><span>;</span>\n             _dataSources<span>.</span><span>Add</span><span>(</span>dataSourceName<span>)</span><span>;</span>\n             <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>string</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n\n            <span><span>var</span></span> t <span>=</span> <span>ShardingKeyToDataSourceName</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataDataSourceBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>SysUserVirtualDataSourceRoute</span> <span>:</span> <span><span>AbstractShardingOperatorVirtualDataSourceRoute<span>&lt;</span>SysUser<span>,</span> <span>string</span><span>></span></span></span>\n    <span>{</span>\n        <span>private</span> <span>readonly</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> _dataSources <span>=</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>\"A\"</span><span>,</span> <span>\"B\"</span><span>,</span> <span>\"C\"</span>\n        <span>}</span><span>;</span>\n        <span>protected</span> <span>override</span> <span><span>string</span></span> <span>ConvertToShardingKey</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> shardingKey<span>?.</span><span>ToString</span><span>(</span><span>)</span> <span>??</span> <span>string</span><span>.</span>Empty<span>;</span>\n        <span>}</span>\n        <span>//我们设置区域就是数据库</span>\n        <span>public</span> <span>override</span> <span><span>string</span></span> <span>ShardingKeyToDataSourceName</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> <span>ConvertToShardingKey</span><span>(</span>shardingKey<span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> <span>GetAllDataSourceNames</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> _dataSources<span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AddDataSourceName</span><span>(</span><span><span>string</span></span> dataSourceName<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>_dataSources<span>.</span><span>Any</span><span>(</span>o <span>=></span> o <span>==</span> dataSourceName<span>)</span><span>)</span>\n                <span>return</span> <span>false</span><span>;</span>\n            _dataSources<span>.</span><span>Add</span><span>(</span>dataSourceName<span>)</span><span>;</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>string</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n\n            <span><span>var</span></span> t <span>=</span> <span>ShardingKeyToDataSourceName</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataDataSourceBuilder<span>&lt;</span>SysUser<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br></div></div><div><p>注意</p>\n<p>因为分库提供默认路由所以需要用户自行实现<code>AbstractShardingOperatorVirtualDataSourceRoute</code>抽象</p>\n</div>\n<h3 id=\"startup配置\"> Startup配置</h3>\n<p><code>ConfigureServices(IServiceCollection services)</code>配置</p>\n<div><pre><code>        <span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>\n        <span>{</span>\n\n            services<span>.</span><span>AddControllers</span><span>(</span><span>)</span><span>;</span>\n            \n                services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span>\n                <span>.</span><span>AddEntityConfig</span><span>(</span>o <span>=></span>\n                <span>{</span>\n                    o<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                    o<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n                    o<span>.</span><span><span>AddShardingDataSourceRoute</span><span><span>&lt;</span>OrderVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                    o<span>.</span><span><span>AddShardingDataSourceRoute</span><span><span>&lt;</span>SysUserVirtualDataSourceRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span>\n                <span>.</span><span>AddConfig</span><span>(</span>op <span>=></span>\n                <span>{</span>\n                    op<span>.</span>ConfigId <span>=</span> <span>\"c1\"</span><span>;</span>\n                    op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conStr<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                    <span>{</span>\n                        builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    op<span>.</span><span>ReplaceTableEnsureManager</span><span>(</span>sp <span>=></span> <span>new</span> <span>SqlServerTableEnsureManager<span>&lt;</span>MyDbContext<span>></span></span><span>(</span><span>)</span><span>)</span><span>;</span>\n                    op<span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"A\"</span><span>,</span>\n                    <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDataSourceDBA;Integrated Security=True;\"</span><span>)</span><span>;</span>\n                    op<span>.</span><span>AddExtraDataSource</span><span>(</span>sp <span>=></span>\n                    <span>{</span>\n                        <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> <span>string</span><span>></span></span><span>(</span><span>)</span>\n                        <span>{</span>\n                            <span>{</span>\n                                <span>\"B\"</span><span>,</span>\n                                <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDataSourceDBB;Integrated Security=True;\"</span>\n                            <span>}</span><span>,</span>\n                            <span>{</span>\n                                <span>\"C\"</span><span>,</span>\n                                <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingDataSourceDBC;Integrated Security=True;\"</span>\n                            <span>}</span><span>,</span>\n                        <span>}</span><span>;</span>\n                    <span>}</span><span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>.</span><span>EnsureConfig</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br></div></div><div><p>重要</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n</div>\n<p>新建一个扩展方法用来初始化ShardingCore和初始化种子数据</p>\n<div><pre><code>   \n    <span>public</span> <span>static</span> <span>class</span> <span>StartupExtension</span>\n    <span>{</span>\n        <span>public</span> <span>static</span> <span><span>void</span></span> <span>UseShardingCore</span><span>(</span><span>this</span> <span>IApplicationBuilder</span> app<span>)</span>\n        <span>{</span>\n            app<span>.</span>ApplicationServices<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>public</span> <span>static</span> <span><span>void</span></span> <span>InitSeed</span><span>(</span><span>this</span> <span>IApplicationBuilder</span> app<span>)</span>\n        <span>{</span>\n            <span>using</span> <span>(</span><span><span>var</span></span> serviceScope <span>=</span> app<span>.</span>ApplicationServices<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                <span><span>var</span></span> myDbContext <span>=</span> serviceScope<span>.</span>ServiceProvider<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>if</span> <span>(</span><span>!</span>myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Any</span><span>(</span><span>)</span><span>)</span>\n                <span>{</span>\n                    <span><span>string</span><span>[</span><span>]</span></span> areas <span>=</span> <span>new</span> <span><span>string</span><span>[</span><span>]</span></span> <span>{</span><span>\"A\"</span><span>,</span><span>\"B\"</span><span>,</span><span>\"C\"</span> <span>}</span><span>;</span>\n                    <span>List<span>&lt;</span>SysUser<span>></span></span> users <span>=</span> <span>new</span> <span>List<span>&lt;</span>SysUser<span>></span></span><span>(</span><span>10</span><span>)</span><span>;</span>\n                    <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>10</span><span>;</span> i<span>++</span><span>)</span>\n                    <span>{</span>\n                        <span><span>var</span></span> uer<span>=</span><span>new</span> <span>SysUser</span><span>(</span><span>)</span>\n                        <span>{</span>\n                            Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                            Name <span>=</span> <span><span>$\"MyName</span><span><span>{</span><span>i</span><span>}</span></span><span>\"</span></span><span>,</span>\n                            Area <span>=</span> areas<span>[</span>i <span>%</span> <span>3</span><span>]</span>\n                        <span>}</span><span>;</span>\n                        users<span>.</span><span>Add</span><span>(</span>uer<span>)</span><span>;</span>\n                    <span>}</span>\n                    <span>List<span>&lt;</span>Order<span>></span></span> orders <span>=</span> <span>new</span> <span>List<span>&lt;</span>Order<span>></span></span><span>(</span><span>300</span><span>)</span><span>;</span>\n                    <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>,</span> <span>3</span><span>,</span> <span>3</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n                    <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>300</span><span>;</span> i<span>++</span><span>)</span>\n                    <span>{</span>\n\n                        <span><span>var</span></span> order <span>=</span> <span>new</span> <span>Order</span><span>(</span><span>)</span>\n                        <span>{</span>\n                            Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                            Payer <span>=</span> <span><span>$\"</span><span><span>{</span><span>i <span>%</span> <span>10</span></span><span>}</span></span><span>\"</span></span><span>,</span>\n                            Money <span>=</span> <span>100</span><span>+</span><span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>Next</span><span>(</span><span>100</span><span>,</span><span>3000</span><span>)</span><span>,</span>\n                            OrderStatus <span>=</span> <span>(</span>OrderStatusEnum<span>)</span><span>(</span>i <span>%</span> <span>4</span> <span>+</span> <span>1</span><span>)</span><span>,</span>\n                            Area <span>=</span> areas<span>[</span>i <span>%</span> <span>3</span><span>]</span><span>,</span>\n                            CreationTime <span>=</span> begin<span>.</span><span>AddDays</span><span>(</span>i<span>)</span>\n                        <span>}</span><span>;</span>\n                        orders<span>.</span><span>Add</span><span>(</span>order<span>)</span><span>;</span>\n                    <span>}</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>users<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>orders<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br></div></div><p><code>Configure(IApplicationBuilder app, IWebHostEnvironment env)</code>配置</p>\n<div><pre><code>        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>env<span>.</span><span>IsDevelopment</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                app<span>.</span><span>UseDeveloperExceptionPage</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n            <span>//初始化ShardingCore</span>\n            app<span>.</span><span>UseShardingCore</span><span>(</span><span>)</span><span>;</span>\n            app<span>.</span><span>UseRouting</span><span>(</span><span>)</span><span>;</span>\n\n            app<span>.</span><span>UseAuthorization</span><span>(</span><span>)</span><span>;</span>\n\n            app<span>.</span><span>UseEndpoints</span><span>(</span>endpoints <span>=></span>\n            <span>{</span>\n                endpoints<span>.</span><span>MapControllers</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            <span>//初始化种子数据</span>\n            app<span>.</span><span>InitSeed</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><h3 id=\"efcore日志-可选\"> efcore日志(可选)</h3>\n<p>这边为了方便我们观察efcore的执行sql语句我们这边建议对efcore添加日志\n<code>Startup</code>添加静态数据</p>\n<div><pre><code>        <span>public</span> <span>static</span> <span>readonly</span> <span>ILoggerFactory</span> efLogger <span>=</span> LoggerFactory<span>.</span><span>Create</span><span>(</span>builder <span>=></span>\n        <span>{</span>\n            builder<span>.</span><span>AddFilter</span><span>(</span><span>(</span>category<span>,</span> level<span>)</span> <span>=></span> category <span>==</span> DbLoggerCategory<span>.</span>Database<span>.</span>Command<span>.</span>Name <span>&amp;&amp;</span> level <span>==</span> LogLevel<span>.</span>Information<span>)</span><span>.</span><span>AddConsole</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><p>在所有<code>builder.UseSqlServer(conStr);</code></p>\n<p>都改成<code>builder.UseSqlServer(conStr).UseLoggerFactory(efLogger);</code></p>\n<p>启动后我们将可以看到数据库和表会被自动创建，并且会将种子数据进行插入到内部供我们可以查询测试</p>\n<img src=\"/sharding-core-doc/sharding-data-source.png\">",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2022-01-08T06:45:39.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-data-source/query/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-data-source/query/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分库的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingDataSource\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreShardingDataSource</a></p>\n<h2 id=\"单对象简单查询\"> 单对象简单查询</h2>\n<p>对<code>SysUser</code>和<code>Order</code>进行查询</p>\n<div><pre><code><span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Query</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span><span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>Id<span>==</span><span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> dateTime <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span><span>3</span><span>,</span><span>5</span><span>)</span><span>;</span>\n            <span><span>var</span></span> order <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>>=</span> dateTime<span>)</span><span>.</span><span>OrderBy</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> orderIdOne <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"3\"</span><span>)</span><span>;</span>\n\n\n            <span><span>var</span></span> sysUsers <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id<span>==</span><span>\"6\"</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n\n            <span>return</span> <span>Ok</span><span>(</span><span>new</span> <span><span>object</span><span>[</span><span>]</span></span>\n            <span>{</span>\n                sysUser<span>,</span>\n                order<span>,</span>\n                orderIdOne<span>,</span>\n                sysUsers\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"63\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"money\"</span><span>:</span><span>1271</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderStatus\"</span><span>:</span><span>4</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-05T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"money\"</span><span>:</span><span>2484</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderStatus\"</span><span>:</span><span>4</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-01-04T03:03:03\"</span><span>}</span><span>,</span><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>}</span><span>]</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>8ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>3ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br></div></div><h2 id=\"join\"> join</h2>\n<h3 id=\"分库join分库\"> 分库join分库</h3>\n<ol>\n<li>无索引</li>\n</ol>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>QueryJoin</span><span>(</span><span>)</span>\n        <span>{</span>\n           <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>3</span><span>,</span> <span>2</span><span>)</span><span>;</span>\n           <span><span>var</span></span> end <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>4</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n           <span><span>var</span></span> sql1 <span>=</span> <span>from</span> user <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id <span>==</span> <span>\"6\"</span><span>)</span>\n               <span>join</span> order <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>>=</span>begin<span>&amp;&amp;</span>o<span>.</span>CreationTime<span>&lt;=</span>end<span>)</span>\n                   <span>on</span> user<span>.</span>Id equals order<span>.</span>Payer\n               <span>select</span> <span>new</span>\n               <span>{</span>\n                   user<span>.</span>Id<span>,</span>\n                   user<span>.</span>Name<span>,</span>\n                   user<span>.</span>Area<span>,</span>\n                   OrderId <span>=</span> order<span>.</span>Id<span>,</span>\n                   order<span>.</span>Payer<span>,</span>\n                   order<span>.</span>CreationTime\n               <span>}</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span><span>await</span> sql1<span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"61\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-03T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"71\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-13T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"81\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-23T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"91\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-04-02T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"66\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-08T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"76\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-18T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"86\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-28T03:03:03\"</span><span>}</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>3ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>3ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br></div></div><ol start=\"2\">\n<li>有索引<code>Area</code>就是索引</li>\n</ol>\n<div><pre><code>\n        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>QueryJoin2</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>3</span><span>,</span> <span>2</span><span>)</span><span>;</span>\n            <span><span>var</span></span> end <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>4</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n            <span><span>var</span></span> sql1 <span>=</span> <span>from</span> user <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> <span>(</span>o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id <span>==</span> <span>\"6\"</span><span>)</span><span>&amp;&amp;</span>o<span>.</span>Area<span>==</span><span>\"A\"</span><span>)</span>\n                <span>join</span> order <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>CreationTime <span>>=</span> begin <span>&amp;&amp;</span> o<span>.</span>CreationTime <span>&lt;=</span> end<span>)</span>\n                    <span>on</span> user<span>.</span>Id equals order<span>.</span>Payer\n                <span>select</span> <span>new</span>\n                <span>{</span>\n                    user<span>.</span>Id<span>,</span>\n                    user<span>.</span>Name<span>,</span>\n                    user<span>.</span>Area<span>,</span>\n                    OrderId <span>=</span> order<span>.</span>Id<span>,</span>\n                    order<span>.</span>Payer<span>,</span>\n                    order<span>.</span>CreationTime\n                <span>}</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span><span>await</span> sql1<span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"66\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-08T03:03:03\"</span><span>}</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>17ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span> AND <span>(</span><span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span> <span>=</span> <span>'A'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br></div></div><div><p>注意</p>\n<ol>\n<li>如果本次查询涉及<code>跨表</code>或者<code>跨库</code>并且查询附带<code>order by</code>那么order by的字段必须包含在返回结果里面.(聚合函数除外：count,any,sum......)</li>\n<li>应该尽可能避免分库join分库,如果实在需要join那么也应该尽可能指定某一张表或者分表的数目尽可能小。(因为分表后如果a1,a2 join b1,b2那么就会有2个结果相互组合,路由结果越多性能越低，会生成各自datasourcename的交集(并不是和分表一样的笛卡尔积))</li>\n</ol>\n</div>\n<h3 id=\"查询接口支持\"> 查询接口支持</h3>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>Method</th>\n<th><a href=\"https://github.com/xuejmnet/sharding-core/blob/main/test/ShardingCore.Test50/ShardingTest.cs\" target=\"_blank\" rel=\"noopener noreferrer\">Unit Test</a></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>第一条</td>\n<td>FindAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>获取集合</td>\n<td>ToListAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>第一条</td>\n<td>FirstOrDefaultAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>最大</td>\n<td>MaxAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>最小</td>\n<td>MinAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>是否存在</td>\n<td>AnyAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>数目</td>\n<td>CountAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>数目</td>\n<td>LongCountAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>求和</td>\n<td>SumAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>平均</td>\n<td>AverageAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>包含</td>\n<td>ContainsAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>分组</td>\n<td>GroupByAsync</td>\n<td>yes</td>\n</tr>\n</tbody>\n</table>\n<div><p>注意</p>\n<p>并不是说因为你的字段值是ABC所以我们需要将数据源定义成A、B、C,这边是因为方便通用,一般原则上我们定义为ds0,ds1,ds2，至于<code>Area</code>如何转成<code>ds0</code>,<code>ds1</code>,<code>ds2</code>那么就需要你自己去实现，比如你有一个[A..Z]的数组，数组下标就是对应的<code>ds</code>后面数字那么你就可以自己实现路由，并且还可以支持大于小于等于</p>\n</div>\n",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2021-11-07T03:49:21.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "修改",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-data-source/update/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-data-source/update/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingDataSource\" target=\"_blank\" rel=\"noopener noreferrer\">SqlServerShardingDataSource</a></p>\n<h2 id=\"自动追踪修改\"> 自动追踪修改</h2>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Update</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            sysUser<span>.</span>Name <span>=</span> <span>\"new name\"</span><span>;</span>\n            <span><span>var</span></span> i<span>=</span><span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>13ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p1<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      UPDATE <span>[</span>SysUser<span>]</span> SET <span>[</span>Name<span>]</span> <span>=</span> @p0\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p1<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"非自动追踪修改\"> 非自动追踪修改</h2>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Update1</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsNoTracking</span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            sysUser<span>.</span>Name <span>=</span> <span>\"new name\"</span><span>;</span>\n            _myDbContext<span>.</span><span>Update</span><span>(</span>sysUser<span>)</span><span>;</span>\n            <span><span>var</span></span> i <span>=</span> <span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p2<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p1<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      UPDATE <span>[</span>SysUser<span>]</span> SET <span>[</span>Area<span>]</span> <span>=</span> @p0, <span>[</span>Name<span>]</span> <span>=</span> @p1\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p2<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><div><p>结论</p>\n<p>追踪情况下sharding-core依然可以对结果进行修改，修改的字段是被修改过后的字段</p>\n<p>非追踪情况下sharding-croe也支持查询修改，但是修改的字段是全字段</p>\n</div>\n",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2021-11-07T06:26:04.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "手动路由",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-route/manual-route/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-route/manual-route/",
      "content_html": "<h2 id=\"背景\"> 背景</h2>\n<p>分表字段不一定在where条件里，但是需要进行自定表的查询,典型场景： 租户,很多时候租户Id分表,会存在于请求头或者请求体中,来确保后续的所有查询都需要走对应的分表，再比如多语言,可能我们会对语言进行分表,但是只会在请求时指定语言而不会将语言加入查询条件,甚至语言这个字段都不存在数据库中。</p>\n<h2 id=\"如何实现\"> 如何实现</h2>\n<ol>\n<li>对应后缀表启用<code>提示路由</code></li>\n</ol>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>SysUserModVirtualTableRoute</span> <span>:</span> <span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>SysUserMod<span>></span></span></span>\n    <span>{</span>\n        <span>/// &lt;summary></span>\n        <span>/// 开启提示路由</span>\n        <span>/// &lt;/summary></span>\n        <span>protected</span> <span>override</span> <span><span>bool</span></span> EnableHintRoute <span>=></span> <span>true</span><span>;</span>\n        <span>/// &lt;summary></span>\n        <span>/// 开启断言路由 如果不需要断言那么可以选择不开启提示路由[EnableHintRoute]必须开启</span>\n        <span>/// &lt;/summary></span>\n        <span>protected</span> <span>override</span> <span><span>bool</span></span> EnableAssertRoute <span>=></span> <span>true</span><span>;</span>\n\n        <span>public</span> <span>SysUserModVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n        <span>{</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><ol>\n<li>依赖注入<code>IShardingRouteManager</code>，并且开启<code>CreateScope</code>,<code>TryCreateOrAddMustTail&lt;SysUserMod&gt;(&quot;00&quot;,&quot;01&quot;)</code></li>\n</ol>\n<div><pre><code>\n        <span>private</span> <span>readonly</span> <span>DefaultShardingDbContext</span> _defaultTableDbContext<span>;</span>\n        <span>private</span> <span>readonly</span> <span>IShardingRouteManager</span> _shardingRouteManager<span>;</span>\n\n        <span>public</span> <span>ValuesController</span><span>(</span><span>DefaultShardingDbContext</span> defaultTableDbContext<span>,</span> <span>IShardingRouteManager</span> shardingRouteManager<span>)</span>\n        <span>{</span>\n            _defaultTableDbContext <span>=</span> defaultTableDbContext<span>;</span>\n            _shardingRouteManager <span>=</span> shardingRouteManager<span>;</span>\n        <span>}</span>\n\n\n            <span>using</span> <span>(</span>_shardingRouteManager<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                _shardingRouteManager<span>.</span>Current<span>.</span><span><span>TryCreateOrAddMustTail</span><span><span>&lt;</span>SysUserMod<span>></span></span></span><span>(</span><span>\"00\"</span><span>,</span><span>\"01\"</span><span>)</span><span>;</span>\n                <span>//_shardingRouteManager.Current.TryCreateOrAddHintTail&lt;SysUserMod>(\"00\", \"01\");</span>\n                <span>//_shardingRouteManager.Current.TryCreateOrAddAssertTail&lt;SysUserMod>();</span>\n\n                <span><span>var</span></span> mod00s <span>=</span> <span>await</span> _defaultTableDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUserMod<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Skip</span><span>(</span><span>10</span><span>)</span><span>.</span><span>Take</span><span>(</span><span>11</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><p>所有在<code>CreateScope</code>内部的<code>SysUserMod</code>的查询都将只会走指定的表也就是[&quot;00&quot;,&quot;01&quot;],可以针对<code>Middleware</code>,<code>ActionFilter</code>处进行使用来达到租户的模式</p>\n<h2 id=\"路由过滤器\"> 路由过滤器</h2>\n<p>假设我们对单次查询返回的路由不满意需要配置,比如如果单次查询大于10个结果那么我们只需要返回前5个,这个操作该如何实现呢，</p>\n<ol>\n<li>路由后置过滤器，通过路由的重写</li>\n</ol>\n<div><pre><code>\n        <span>protected</span> <span>override</span> <span>List<span>&lt;</span>IPhysicTable<span>></span></span> <span>AfterPhysicTableFilter</span><span>(</span><span>List<span>&lt;</span>IPhysicTable<span>></span></span> allPhysicTables<span>,</span> <span>List<span>&lt;</span>IPhysicTable<span>></span></span> filterPhysicTables<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>filterPhysicTables<span>.</span>Count <span>>=</span> <span>10</span><span>)</span>\n            <span>{</span>\n                <span>//throw new Exception ....</span>\n                <span>return</span> filterPhysicTables<span>.</span><span>Take</span><span>(</span><span>5</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n\n            <span>return</span> filterPhysicTables<span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>通过这个后置过滤我们可以轻轻松松的完成对查询的控制,但是这个是全局的等于说写了那么所有的该对象的路由都要进行这种操作,所以下面就有了第二种方式<code>断言路由</code>\n2. 断言路由,所谓的断言路由其实就是提示路由下的一种所以如果我们需要使用断言路由就要进行对<code>提示路由</code>的开启</p>\n<div><pre><code>\n        <span>/// &lt;summary></span>\n        <span>/// 开启提示路由</span>\n        <span>/// &lt;/summary></span>\n        <span>protected</span> <span>override</span> <span><span>bool</span></span> EnableHintRoute <span>=></span> <span>true</span><span>;</span>\n        <span>/// &lt;summary></span>\n        <span>/// 开启断言路由 如果不需要断言那么可以选择不开启提示路由[EnableHintRoute]必须开启</span>\n        <span>/// &lt;/summary></span>\n        <span>protected</span> <span>override</span> <span><span>bool</span></span> EnableAssertRoute <span>=></span> <span>true</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br></div></div><p>如何使用断言路由，首先我们需要创建一个对应的路由断言</p>\n<div><pre><code>\n        <span>public</span> <span>class</span> <span>TestRouteAssert</span><span>:</span><span><span>ITableRouteAssert<span>&lt;</span>SysUserMod<span>></span></span></span>\n        <span>{</span>\n            <span>public</span> <span><span>void</span></span> <span>Assert</span><span>(</span><span>List<span>&lt;</span>IPhysicTable<span>></span></span> allPhysicTables<span>,</span> <span>List<span>&lt;</span>IPhysicTable<span>></span></span> resultPhysicTables<span>)</span>\n            <span>{</span>\n\n                <span>if</span> <span>(</span>resultPhysicTables<span>.</span>Count <span>>=</span> <span>10</span><span>)</span>\n                <span>{</span>\n                    <span>//throw new Exception ....</span>\n                    resultPhysicTables<span>=</span>resultPhysicTables<span>.</span><span>Take</span><span>(</span><span>5</span><span>)</span><span>.</span><span>ToList</span><span>(</span><span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br></div></div><div><pre><code>\n            <span>using</span> <span>(</span>_shardingRouteManager<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                _shardingRouteManager<span>.</span>Current<span>.</span><span><span>TryCreateOrAddAssertTail</span><span><span>&lt;</span>SysUserMod<span>></span></span></span><span>(</span><span>new</span> <span>TestRouteAssert</span><span>(</span><span>)</span><span>)</span><span>;</span>\n\n                <span><span>var</span></span> mod00s <span>=</span> <span>await</span> _defaultTableDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUserMod<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Skip</span><span>(</span><span>10</span><span>)</span><span>.</span><span>Take</span><span>(</span><span>11</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><p>这样我们就做到了和全局路由过滤器一样的效果但是是可以自定义的。</p>\n<h2 id=\"musttail\"> MustTail</h2>\n<p>强制路由,使用强制路由<code>_shardingRouteManager.Current.TryCreateOrAddMustTail&lt;SysUserMod&gt;(&quot;00&quot;,&quot;01&quot;);</code>将无视断言路由和路由过滤器。</p>\n<h2 id=\"hinttail\"> HintTail</h2>\n<p>提示路由,使用方式和强制路由一样<code>_shardingRouteManager.Current.TryCreateOrAddHintTail&lt;SysUserMod&gt;(&quot;00&quot;, &quot;01&quot;);</code>区别就是强制走提示路由后还需要在进行断言路由的判断</p>\n<h2 id=\"asserttail\"> AssertTail</h2>\n<p>断言路由用来进行断言判断和筛选查询过滤结果</p>\n<div><p>路由的顺序</p>\n<ol>\n<li>开启提示路由?开启判断有强制直接走强制，没强制就判断是否有提示有提示就走提示，走完提示在判断是否开启断言，开启了就再走断言，如果都没有就走普通</li>\n<li>开启了提示路由和断言路由，并且没有强制路由和提示路由，仅仅只有断言路由那么就是先走自动过滤筛选表，然后走全局过滤，最后走断言路由</li>\n</ol>\n</div>\n<p><strong>注意具体的流程可以参考源码<a href=\"https://github.com/xuejmnet/sharding-core/blob/main/src/ShardingCore/Core/VirtualRoutes/TableRoutes/Abstractions/AbstractShardingFilterVirtualTableRoute.cs\" target=\"_blank\" rel=\"noopener noreferrer\">AbstractShardingFilterVirtualTableRoute</a> 或者<a href=\"https://github.com/xuejmnet/sharding-core/blob/main/src/ShardingCore/Core/VirtualRoutes/DataSourceRoutes/Abstractions/AbstractShardingFilterVirtualDataSourceRoute.cs\" target=\"_blank\" rel=\"noopener noreferrer\">AbstractShardingFilterVirtualDataSourceRoute</a></strong></p>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-12T14:37:19.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "路由"
      ]
    },
    {
      "title": "自定义路由",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-route/customer-route/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-route/customer-route/",
      "content_html": "<h2 id=\"条件在右\"> 条件在右</h2>\n<p>首先我们需要明确一个点就是where后面的条件影响了你对整体路由的一个判断<code>column</code>为分表字段，<code>value</code>为条件</p>\n<ol>\n<li>\n<p><code>column = value</code>，通过计算value可以清楚的知道我们应该查询哪张表</p>\n</li>\n<li>\n<p><code>column &gt; value</code>,在按时间分表的情况通过比较表后缀可以得知表达式<code>&gt;</code>能够过滤的表</p>\n</li>\n<li>\n<p><code>value &lt; column</code>,看着和2一样但是解析的时候确是天差地别,因为我们无法通过<code>&gt;</code>来判断,必须通过<code>&lt;</code>来判断</p>\n</li>\n<li>\n<p><code>value.contains(column)</code>,需要解析成 <code>value[0] = column or value[1] = column or value[2] = column ......</code></p>\n</li>\n</ol>\n<p>框架为了方便用户编写路由已经针对上述所有的情况进行了优化，所有的<code>column</code> 和 <code>value</code>的比较都会将<code>column</code>置于左边，将<code>value</code>置于右边，我们叫做<code>condition on right</code>，并且将所有的<code>contains</code>转换成<code>=</code>，用户可以专心编写路由</p>\n<h2 id=\"abstractshardingoperatorvirtualtableroute\"> AbstractShardingOperatorVirtualTableRoute</h2>\n<p>所有分表的路由的基类,继承这个基类可以很轻松的实现自定义路由</p>\n<h2 id=\"abstractshardingoperatorvirtualdatasourceroute\"> AbstractShardingOperatorVirtualDataSourceRoute</h2>\n<p>所有分库的路由的基类,继承这个基类可以很轻松的实现自定义路由</p>\n<h2 id=\"一致性哈希路由\"> 一致性哈希路由</h2>\n<p>一致性哈希路由的简单实现版本又叫做大数取模分段，在取模的基础上实现了添加单张表后可以将数据迁移做到最小化。\n就是在原先的哈希取模的上面进行再次分段来保证不会再增加一个基数的情况下需要大范围的迁移数据，直接上代码</p>\n<div><pre><code>            <span><span>var</span></span> stringHashCode <span>=</span> ShardingCoreHelper<span>.</span><span>GetStringHashCode</span><span>(</span><span>\"123\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> hashCode <span>=</span> stringHashCode <span>%</span> <span>10000</span><span>;</span>\n            <span>if</span> <span>(</span>hashCode <span>>=</span> <span>0</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>3000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"A\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>3001</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>6000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"B\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>6001</span> <span>&amp;&amp;</span> hashCode <span>&lt;</span> <span>10000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"C\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span>\n                <span>throw</span> <span>new</span> <span>InvalidOperationException</span><span>(</span><span><span>$\"cant calc hash route hash code:[</span><span><span>{</span><span>stringHashCode</span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><p>这应该是一个最最最简单的是个人都能看得懂的路由了，将hashcode进行取模10000，得到0-9999，将其分成[0-3000],[3001-6000],[6001-9999]三段的概率大概是3、3、4相对很平均，那么还是遇到了上面我们所说的一个问题，如果我们现在需要加一个基数呢，首先修改路由</p>\n<div><pre><code>            <span><span>var</span></span> stringHashCode <span>=</span> ShardingCoreHelper<span>.</span><span>GetStringHashCode</span><span>(</span><span>\"123\"</span><span>)</span><span>;</span>\n            <span><span>var</span></span> hashCode <span>=</span> stringHashCode <span>%</span> <span>10000</span><span>;</span>\n            <span>if</span> <span>(</span>hashCode <span>>=</span> <span>0</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>3000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"A\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>3001</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>6000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"B\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>6001</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>8000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"D\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>8001</span> <span>&amp;&amp;</span> hashCode <span>&lt;</span> <span>10000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"C\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span>\n                <span>throw</span> <span>new</span> <span>InvalidOperationException</span><span>(</span><span><span>$\"cant calc hash route hash code:[</span><span><span>{</span><span>stringHashCode</span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div><p>我们这边增加了一个基数针对[6001-9999]分段进行了数据切分，并且将[8001-9999]区间内的表后缀没变，实际上我们仅仅只需要修改五分之一的数据那么就可以完美的做到数据迁移，并且均匀分布数据,后续如果需要再次增加一台只需要针对'A'或者'B'进行2分那么就可以逐步增加基数来缓解压力，且数据迁移的数量随着基数的增加响应的需要迁移的数据百分比逐步的减少，最坏的情况是增加一倍的基数需要迁移50%的数据，相比较之前的最好情况迁移50%的数据来说十分划算，而且路由规则简单易写是个人就能写出来。</p>\n<h2 id=\"编写一致性哈希路由\"> 编写一致性哈希路由</h2>\n<p>那么我们如何在sharding-core里面编写这个路由规则呢</p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>OrderHashRangeVirtualTableRoute</span><span>:</span><span><span>AbstractShardingOperatorVirtualTableRoute<span>&lt;</span>Order<span>,</span><span>string</span><span>></span></span></span>\n    <span>{</span>\n        <span>//如何将sharding key的value转换成对应的值</span>\n        <span>protected</span> <span>override</span> <span><span>string</span></span> <span>ConvertToShardingKey</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span>return</span> shardingKey<span>.</span><span>ToString</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>//如何将sharding key的value转换成对应的表后缀</span>\n        <span>public</span> <span>override</span> <span><span>string</span></span> <span>ShardingKeyToTail</span><span>(</span><span><span>object</span></span> shardingKey<span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> stringHashCode <span>=</span> ShardingCoreHelper<span>.</span><span>GetStringHashCode</span><span>(</span><span>ConvertToShardingKey</span><span>(</span>shardingKey<span>)</span><span>)</span><span>;</span>\n            <span><span>var</span></span> hashCode <span>=</span> stringHashCode <span>%</span> <span>10000</span><span>;</span>\n            <span>if</span> <span>(</span>hashCode <span>>=</span> <span>0</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>3000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"A\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>3001</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>6000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"B\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span> <span>if</span> <span>(</span>hashCode <span>>=</span> <span>6001</span> <span>&amp;&amp;</span> hashCode <span>&lt;=</span> <span>10000</span><span>)</span>\n            <span>{</span>\n                <span>return</span> <span>\"C\"</span><span>;</span>\n            <span>}</span>\n            <span>else</span>\n                <span>throw</span> <span>new</span> <span>InvalidOperationException</span><span>(</span><span><span>$\"cant calc hash route hash code:[</span><span><span>{</span><span>stringHashCode</span><span>}</span></span><span>]\"</span></span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>//返回目前已经有的所有Order表后缀</span>\n        <span>public</span> <span>override</span> <span>List<span>&lt;</span><span>string</span><span>></span></span> <span>GetAllTails</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n            <span>{</span>\n                <span>\"A\"</span><span>,</span> <span>\"B\"</span><span>,</span> <span>\"C\"</span>\n            <span>}</span><span>;</span>\n        <span>}</span>\n\n        <span>//如何过滤后缀(已经实现了condition on right)用户无需关心条件位置和如何解析条件逻辑判断，也不需要用户考虑and 还是or</span>\n        <span>protected</span> <span>override</span> <span>Expression<span>&lt;</span>Func<span>&lt;</span><span>string</span><span>,</span> <span>bool</span><span>></span><span>></span></span> <span>GetRouteToFilter</span><span>(</span><span><span>string</span></span> shardingKey<span>,</span> <span>ShardingOperatorEnum</span> shardingOperator<span>)</span>\n        <span>{</span>\n            <span>//因为hash路由仅支持等于所以仅仅只需要写等于的情况</span>\n            <span><span>var</span></span> t <span>=</span> <span>ShardingKeyToTail</span><span>(</span>shardingKey<span>)</span><span>;</span>\n            <span>switch</span> <span>(</span>shardingOperator<span>)</span>\n            <span>{</span>\n                <span>case</span> ShardingOperatorEnum<span>.</span>Equal<span>:</span> <span>return</span> tail <span>=></span> tail <span>==</span> t<span>;</span>\n                <span>default</span><span>:</span>\n                <span>{</span>\n                    <span>return</span> tail <span>=></span> <span>true</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br></div></div><p><strong>具体的原理如果不清楚可以参考博客<a href=\"https://www.cnblogs.com/xuejiaming/p/15383899.html\" target=\"_blank\" rel=\"noopener noreferrer\">如何自定义路由</a></strong></p>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2021-11-12T14:44:02.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "路由"
      ]
    },
    {
      "title": "删除",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-table/delete/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-table/delete/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingTable\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreShardingTable</a></p>\n<h2 id=\"删除数据\"> 删除数据</h2>\n<p>增删改查除了查询稍微在分表+排序的情况下需要注意其实其他操作和efcore基本上一致</p>\n<p>删除也是</p>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Delete</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"9\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            _myDbContext<span>.</span><span>Remove</span><span>(</span>sysUser<span>)</span><span>;</span>\n            <span><span>var</span></span> i <span>=</span> <span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><p>控制台我们可以看到对应的执行sql</p>\n<div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>12ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      DELETE FROM <span>[</span>SysUser<span>]</span>\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p0<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div>",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2021-11-07T03:49:21.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "初始化",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-table/init/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-table/init/",
      "content_html": "<h2 id=\"介绍\"> 介绍</h2>\n<div><p>分表介绍</p>\n<ol>\n<li><code>sharding-core</code>支持自定义分表,流式聚合,多表join</li>\n<li>虽然框架已经将分表封装的用户毫无感知了,但是也是需要使用者有部分分表的概念的了解</li>\n<li>我们把表A分成A1,A2,A3这三张表,如果你在数据库里还是看到了表A那么就说明程序是不正确的,表A在分表后其实不应该存在了(大部分情况下)</li>\n<li><code>IShardingTableDbContext</code>这个接口在你需要支持分表的情况下需要加，如果您只是分库那么就不需要添加这个接口</li>\n</ol>\n</div>\n<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingTable\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreShardingTable</a></p>\n<h2 id=\"分表使用\"> 分表使用</h2>\n<p>先拟定一个场景目前有用户表<code>SysUser</code>和订单表<code>Order</code>,再添加一个<code>Setting</code>配置表，用户我们按用户id进行取模分表，订单我们按时间月进行分表,配置表我们部分表\n首先创建一个空的aspnetcore web api。</p>\n<h3 id=\"安装shardingcore\"> 安装ShardingCore</h3>\n<div><pre><code><span># 请对应安装您需要的版本</span>\nPM<span>></span> Install-Package ShardingCore\n<span># 请对应数据库版本</span>\nPM<span>></span> Install-Package Microsoft.EntityFrameworkCore.SqlServer\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><h3 id=\"创建对象\"> 创建对象</h3>\n<div><pre><code>    <span>public</span> <span>enum</span> <span>OrderStatusEnum</span>\n    <span>{</span>\n        NoPay<span>=</span><span>1</span><span>,</span>\n        Paying<span>=</span><span>2</span><span>,</span>\n        Payed<span>=</span><span>3</span><span>,</span>\n        PayFail<span>=</span><span>4</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>Order</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Payer <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>long</span></span> Money <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>OrderStatusEnum</span> OrderStatus <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span>DateTime</span> CreationTime <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>SysUser</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Id <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> SettingCode <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Area <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n    <span>public</span> <span>class</span> <span>Setting</span>\n    <span>{</span>\n        <span>public</span> <span><span>string</span></span> Code <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n        <span>public</span> <span><span>string</span></span> Name <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br></div></div><h3 id=\"创建dbcontext\"> 创建DbContext</h3>\n<p>这样我们就创建好了三张表，接下来我们创建我们的<code>DbContext</code></p>\n<div><pre><code>\n    <span>public</span> <span>class</span> <span>MyDbContext</span><span>:</span><span><span>AbstractShardingDbContext</span><span>,</span><span>IShardingTableDbContext</span></span>\n    <span>{</span>\n        <span>public</span> <span>MyDbContext</span><span>(</span><span>DbContextOptions<span>&lt;</span>MyDbContext<span>></span></span> options<span>)</span> <span>:</span> <span>base</span><span>(</span>options<span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>protected</span> <span>override</span> <span><span>void</span></span> <span>OnModelCreating</span><span>(</span><span>ModelBuilder</span> modelBuilder<span>)</span>\n        <span>{</span>\n            <span>base</span><span>.</span><span>OnModelCreating</span><span>(</span>modelBuilder<span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Payer<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>OrderStatus<span>)</span><span>.</span><span><span>HasConversion</span><span><span>&lt;</span><span>int</span><span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Order<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Name<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Area<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>SettingCode<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>SysUser<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            modelBuilder<span>.</span><span><span>Entity</span><span><span>&lt;</span>Setting<span>></span></span></span><span>(</span>entity <span>=></span>\n            <span>{</span>\n                entity<span>.</span><span>HasKey</span><span>(</span>o <span>=></span> o<span>.</span>Code<span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o <span>=></span> o<span>.</span>Code<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>Property</span><span>(</span>o<span>=></span>o<span>.</span>Name<span>)</span><span>.</span><span>IsRequired</span><span>(</span><span>)</span><span>.</span><span>IsUnicode</span><span>(</span><span>false</span><span>)</span><span>.</span><span>HasMaxLength</span><span>(</span><span>50</span><span>)</span><span>;</span>\n                entity<span>.</span><span>ToTable</span><span>(</span><span>nameof</span><span>(</span>Setting<span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n\n        <span>public</span> <span>IRouteTail</span> RouteTail <span>{</span> <span>get</span><span>;</span> <span>set</span><span>;</span> <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br></div></div><div><p>自定义标题</p>\n<ol>\n<li>构造函数必须是<code>DbContextOptions&lt;MyDbContext&gt;</code>或者<code>DbContextOptions</code></li>\n<li><code>OnModelCreating</code>并不是说分表必须要这样，而是你原先efcore怎么使用就怎么使用，efcore配置对象有两种一种是<code>DbSet</code>+<code>Attribute</code>,另外一种是<code>OnModelCreating</code>+<code>ModelBuilder</code>,你可以选择你原先在用的任何一种</li>\n<li><code>AbstractShardingDbContext</code>这个对象是可以不继承的，但是如果要使用分表分库你必须实现<code>IShardingTableDbContext</code>这个接口,因为这个接口实现起来都是一样的所以默认你只需要继承<code>AbstractShardingDbContext</code>就可以了</li>\n<li><code>IShardingTableDbContext</code>这个接口在你需要支持分表的情况下需要加，如果您只是分库那么就不需要添加这个接口</li>\n</ol>\n</div>\n<h3 id=\"创建虚拟路由\"> 创建虚拟路由</h3>\n<ol>\n<li>订单表按月分表,这边我们把订单从2021年1月份开始到现在具体</li>\n</ol>\n<div><pre><code>\n    <span>//创建时间按月分表</span>\n    <span>public</span> <span>class</span> <span>OrderVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute<span>&lt;</span>Order<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>//注意一定要配置或者采用接口+标签也是可以的</span>\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>Order<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>CreationTime<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n    <span>//用户Id取模3分表</span>\n    <span>public</span> <span>class</span> <span>SysUserVirtualTableRoute</span><span>:</span><span><span>AbstractSimpleShardingModKeyStringVirtualTableRoute<span>&lt;</span>SysUser<span>></span></span></span>\n    <span>{</span>\n        <span>public</span> <span>SysUserVirtualTableRoute</span><span>(</span><span>)</span> <span>:</span> <span>base</span><span>(</span><span>2</span><span>,</span> <span>3</span><span>)</span>\n        <span>{</span>\n        <span>}</span>\n\n        <span>public</span> <span>override</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>EntityMetadataTableBuilder<span>&lt;</span>SysUser<span>></span></span> builder<span>)</span>\n        <span>{</span>\n            builder<span>.</span><span>ShardingProperty</span><span>(</span>o <span>=></span> o<span>.</span>Id<span>)</span><span>;</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br></div></div><h3 id=\"startup配置\"> Startup配置</h3>\n<p><code>ConfigureServices(IServiceCollection services)</code>配置</p>\n<div><pre><code>        <span>public</span> <span><span>void</span></span> <span>ConfigureServices</span><span>(</span><span>IServiceCollection</span> services<span>)</span>\n        <span>{</span>\n\n            services<span>.</span><span>AddControllers</span><span>(</span><span>)</span><span>;</span>\n            <span>//添加一下代码</span>\n            services<span>.</span><span><span>AddShardingDbContext</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AddEntityConfig</span><span>(</span>op <span>=></span>\n            <span>{</span>\n                <span>//如果您使用code-first建议选择false</span>\n                op<span>.</span>CreateShardingTableOnStart <span>=</span> <span>true</span><span>;</span>\n                <span>//如果您使用code-first建议修改为fsle</span>\n                op<span>.</span>EnsureCreatedWithOutShardingTable <span>=</span> <span>true</span><span>;</span>\n                <span>//当无法获取路由时会返回默认值而不是报错</span>\n                op<span>.</span>ThrowIfQueryRouteNotMatch <span>=</span> <span>false</span><span>;</span>\n                op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>SysUserVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>OrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                op<span>.</span><span><span>AddShardingTableRoute</span><span><span>&lt;</span>MultiShardingOrderVirtualTableRoute<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>.</span><span>AddConfig</span><span>(</span>op <span>=></span>\n            <span>{</span>\n                op<span>.</span>ConfigId <span>=</span> <span>\"a\"</span><span>;</span>\n                op<span>.</span><span>UseShardingQuery</span><span>(</span><span>(</span>conStr<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>conStr<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>;</span>\n                op<span>.</span><span>UseShardingTransaction</span><span>(</span><span>(</span>connection<span>,</span> builder<span>)</span> <span>=></span>\n                <span>{</span>\n                    builder<span>.</span><span>UseSqlServer</span><span>(</span>connection<span>)</span><span>.</span><span>UseLoggerFactory</span><span>(</span>efLogger<span>)</span><span>;</span>\n                <span>}</span><span>)</span><span>;</span>\n                op<span>.</span><span>AddDefaultDataSource</span><span>(</span><span>\"ds0\"</span><span>,</span>\n                    <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingTableDB;Integrated Security=True;\"</span><span>)</span><span>;</span>\n                op<span>.</span><span>AddReadWriteSeparation</span><span>(</span>sp <span>=></span>\n                <span>{</span>\n                    <span>return</span> <span>new</span> <span>Dictionary<span>&lt;</span><span>string</span><span>,</span> IEnumerable<span>&lt;</span><span>string</span><span>></span><span>></span></span><span>(</span><span>)</span>\n                    <span>{</span>\n                        <span>{</span>\n                            <span>\"ds0\"</span><span>,</span> <span>new</span> <span>List<span>&lt;</span><span>string</span><span>></span></span><span>(</span><span>)</span>\n                            <span>{</span>\n                                <span>\"Data Source=localhost;Initial Catalog=EFCoreShardingTableDB;Integrated Security=True;\"</span>\n                            <span>}</span>\n                        <span>}</span>\n                    <span>}</span><span>;</span>\n                <span>}</span><span>,</span> ReadStrategyEnum<span>.</span>Loop<span>,</span> <span>defaultEnable</span><span>:</span> <span>true</span><span>)</span><span>;</span>\n                op<span>.</span><span>ReplaceTableEnsureManager</span><span>(</span>sp<span>=></span><span>new</span> <span>SqlServerTableEnsureManager<span>&lt;</span>MyDbContext<span>></span></span><span>(</span><span>)</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>.</span><span>EnsureConfig</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br></div></div><div><p>重要</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n<p>!!!<code>MyDbContext</code>请勿注册成单例、<code>ServiceLifetime.Singleton</code>!!!</p>\n</div>\n<p>新建一个扩展方法用来初始化ShardingCore和初始化种子数据</p>\n<div><pre><code>    <span>public</span> <span>static</span> <span>class</span> <span>StartupExtension</span>\n    <span>{</span>\n        <span>public</span> <span>static</span> <span><span>void</span></span> <span>UseShardingCore</span><span>(</span><span>this</span> <span>IApplicationBuilder</span> app<span>)</span>\n        <span>{</span>\n            app<span>.</span>ApplicationServices<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>IShardingBootstrapper<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Start</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>public</span> <span>static</span> <span><span>void</span></span> <span>InitSeed</span><span>(</span><span>this</span> <span>IApplicationBuilder</span> app<span>)</span>\n        <span>{</span>\n            <span>using</span> <span>(</span><span><span>var</span></span> serviceScope <span>=</span> app<span>.</span>ApplicationServices<span>.</span><span>CreateScope</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                <span><span>var</span></span> myDbContext <span>=</span> serviceScope<span>.</span>ServiceProvider<span>.</span><span><span>GetRequiredService</span><span><span>&lt;</span>MyDbContext<span>></span></span></span><span>(</span><span>)</span><span>;</span>\n                <span>if</span> <span>(</span><span>!</span>myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Setting<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Any</span><span>(</span><span>)</span><span>)</span>\n                <span>{</span>\n                    <span>List<span>&lt;</span>Setting<span>></span></span> settings <span>=</span> <span>new</span> <span>List<span>&lt;</span>Setting<span>></span></span><span>(</span><span>3</span><span>)</span><span>;</span>\n                    settings<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Setting</span><span>(</span><span>)</span>\n                    <span>{</span>\n                        Code <span>=</span> <span>\"Admin\"</span><span>,</span>\n                        Name <span>=</span> <span>\"AdminName\"</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    settings<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Setting</span><span>(</span><span>)</span>\n                    <span>{</span>\n                        Code <span>=</span> <span>\"User\"</span><span>,</span>\n                        Name <span>=</span> <span>\"UserName\"</span>\n                    <span>}</span><span>)</span><span>;</span>\n                    settings<span>.</span><span>Add</span><span>(</span><span>new</span> <span>Setting</span><span>(</span><span>)</span>\n                    <span>{</span>\n                        Code <span>=</span> <span>\"SuperAdmin\"</span><span>,</span>\n                        Name <span>=</span> <span>\"SuperAdminName\"</span>\n                    <span>}</span><span>)</span><span>;</span>\n\n                    <span>List<span>&lt;</span>SysUser<span>></span></span> users <span>=</span> <span>new</span> <span>List<span>&lt;</span>SysUser<span>></span></span><span>(</span><span>10</span><span>)</span><span>;</span>\n                    <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>10</span><span>;</span> i<span>++</span><span>)</span>\n                    <span>{</span>\n                        <span><span>var</span></span> uer<span>=</span><span>new</span> <span>SysUser</span><span>(</span><span>)</span>\n                        <span>{</span>\n                            Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                            Name <span>=</span> <span><span>$\"MyName</span><span><span>{</span><span>i</span><span>}</span></span><span>\"</span></span><span>,</span>\n                            SettingCode <span>=</span> settings<span>[</span>i <span>%</span> <span>3</span><span>]</span><span>.</span>Code\n                        <span>}</span><span>;</span>\n                        users<span>.</span><span>Add</span><span>(</span>uer<span>)</span><span>;</span>\n                    <span>}</span>\n                    <span>List<span>&lt;</span>Order<span>></span></span> orders <span>=</span> <span>new</span> <span>List<span>&lt;</span>Order<span>></span></span><span>(</span><span>300</span><span>)</span><span>;</span>\n                    <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>,</span> <span>3</span><span>,</span> <span>3</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n                    <span>for</span> <span>(</span><span><span>int</span></span> i <span>=</span> <span>0</span><span>;</span> i <span>&lt;</span> <span>300</span><span>;</span> i<span>++</span><span>)</span>\n                    <span>{</span>\n\n                        <span><span>var</span></span> order <span>=</span> <span>new</span> <span>Order</span><span>(</span><span>)</span>\n                        <span>{</span>\n                            Id <span>=</span> i<span>.</span><span>ToString</span><span>(</span><span>)</span><span>,</span>\n                            Payer <span>=</span> <span><span>$\"</span><span><span>{</span><span>i <span>%</span> <span>10</span></span><span>}</span></span><span>\"</span></span><span>,</span>\n                            Money <span>=</span> <span>100</span><span>+</span><span>new</span> <span>Random</span><span>(</span><span>)</span><span>.</span><span>Next</span><span>(</span><span>100</span><span>,</span><span>3000</span><span>)</span><span>,</span>\n                            OrderStatus <span>=</span> <span>(</span>OrderStatusEnum<span>)</span><span>(</span>i <span>%</span> <span>4</span> <span>+</span> <span>1</span><span>)</span><span>,</span>\n                            CreationTime <span>=</span> begin<span>.</span><span>AddDays</span><span>(</span>i<span>)</span>\n                        <span>}</span><span>;</span>\n                        orders<span>.</span><span>Add</span><span>(</span>order<span>)</span><span>;</span>\n                    <span>}</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>settings<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>users<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>AddRange</span><span>(</span>orders<span>)</span><span>;</span>\n                    myDbContext<span>.</span><span>SaveChanges</span><span>(</span><span>)</span><span>;</span>\n                <span>}</span>\n            <span>}</span>\n        <span>}</span>\n    <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br></div></div><p><code>Configure(IApplicationBuilder app, IWebHostEnvironment env)</code>配置</p>\n<div><pre><code>        <span>public</span> <span><span>void</span></span> <span>Configure</span><span>(</span><span>IApplicationBuilder</span> app<span>,</span> <span>IWebHostEnvironment</span> env<span>)</span>\n        <span>{</span>\n            <span>if</span> <span>(</span>env<span>.</span><span>IsDevelopment</span><span>(</span><span>)</span><span>)</span>\n            <span>{</span>\n                app<span>.</span><span>UseDeveloperExceptionPage</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span>\n            <span>//初始化ShardingCore</span>\n            app<span>.</span><span>UseShardingCore</span><span>(</span><span>)</span><span>;</span>\n            app<span>.</span><span>UseRouting</span><span>(</span><span>)</span><span>;</span>\n\n            app<span>.</span><span>UseAuthorization</span><span>(</span><span>)</span><span>;</span>\n\n            app<span>.</span><span>UseEndpoints</span><span>(</span>endpoints <span>=></span>\n            <span>{</span>\n                endpoints<span>.</span><span>MapControllers</span><span>(</span><span>)</span><span>;</span>\n            <span>}</span><span>)</span><span>;</span>\n            <span>//初始化种子数据</span>\n            app<span>.</span><span>InitSeed</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><h3 id=\"efcore日志-可选\"> efcore日志(可选)</h3>\n<p>这边为了方便我们观察efcore的执行sql语句我们这边建议对efcore添加日志</p>\n<p><code>Startup</code>添加静态数据</p>\n<div><pre><code>        <span>public</span> <span>static</span> <span>readonly</span> <span>ILoggerFactory</span> efLogger <span>=</span> LoggerFactory<span>.</span><span>Create</span><span>(</span>builder <span>=></span>\n        <span>{</span>\n            builder<span>.</span><span>AddFilter</span><span>(</span><span>(</span>category<span>,</span> level<span>)</span> <span>=></span> category <span>==</span> DbLoggerCategory<span>.</span>Database<span>.</span>Command<span>.</span>Name <span>&amp;&amp;</span> level <span>==</span> LogLevel<span>.</span>Information<span>)</span><span>.</span><span>AddConsole</span><span>(</span><span>)</span><span>;</span>\n        <span>}</span><span>)</span><span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br></div></div><p>在所有<code>builder.UseSqlServer(conStr);</code></p>\n<p>都改成<code>builder.UseSqlServer(conStr).UseLoggerFactory(efLogger);</code></p>\n<p>启动后我们将可以看到数据库和表会被自动创建，并且会将种子数据进行插入到内部供我们可以查询测试</p>\n<img src=\"/sharding-core-doc/sharding-table.png\">\n",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2022-01-25T02:13:37.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "查询",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-table/query/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-table/query/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingTable\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreShardingTable</a></p>\n<h2 id=\"单对象简单查询\"> 单对象简单查询</h2>\n<p>对<code>SysUser</code>和<code>Order</code>进行查询</p>\n<div><pre><code><span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Query</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span><span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>Id<span>==</span><span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> dateTime <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span><span>3</span><span>,</span><span>5</span><span>)</span><span>;</span>\n            <span><span>var</span></span> order <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>>=</span> dateTime<span>)</span><span>.</span><span>OrderBy</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            <span><span>var</span></span> orderIdOne <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"3\"</span><span>)</span><span>;</span>\n\n\n            <span><span>var</span></span> sysUsers <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id<span>==</span><span>\"6\"</span><span>)</span><span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>;</span>\n\n            <span>return</span> <span>Ok</span><span>(</span><span>new</span> <span><span>object</span><span>[</span><span>]</span></span>\n            <span>{</span>\n                sysUser<span>,</span>\n                order<span>,</span>\n                orderIdOne<span>,</span>\n                sysUsers\n            <span>}</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"63\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"money\"</span><span>:</span><span>2407</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderStatus\"</span><span>:</span><span>4</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-05T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"3\"</span><span>,</span><span>\"money\"</span><span>:</span><span>974</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"orderStatus\"</span><span>:</span><span>4</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-01-04T03:03:03\"</span><span>}</span><span>,</span><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>}</span><span>]</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'1'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>6ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202111<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>25ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>21ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>13ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202106<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>9ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202107<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>11ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202109<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>23ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202108<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>5ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>47ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__dateTime_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202110<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__dateTime_0\n      ORDER BY <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202110<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202109<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202105<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202108<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202107<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202111<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202102<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202101<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202106<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT TOP<span>(</span><span>1</span><span>)</span> <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Money<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>OrderStatus<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n      FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n      WHERE <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>'3'</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>1ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br><span>97</span><br><span>98</span><br><span>99</span><br><span>100</span><br><span>101</span><br><span>102</span><br><span>103</span><br><span>104</span><br><span>105</span><br><span>106</span><br><span>107</span><br><span>108</span><br><span>109</span><br><span>110</span><br><span>111</span><br><span>112</span><br><span>113</span><br><span>114</span><br><span>115</span><br><span>116</span><br><span>117</span><br><span>118</span><br><span>119</span><br><span>120</span><br><span>121</span><br><span>122</span><br><span>123</span><br><span>124</span><br></div></div><h2 id=\"join\"> join</h2>\n<h3 id=\"分表join不分表\"> 分表join不分表</h3>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>QueryJoin1</span><span>(</span><span>)</span>\n        <span>{</span>\n           <span><span>var</span></span> sql<span>=</span> <span>from</span> user <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id <span>==</span> <span>\"6\"</span><span>)</span>\n                <span>join</span> setting <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Setting<span>></span></span></span><span>(</span><span>)</span>\n                    <span>on</span> user<span>.</span>SettingCode equals setting<span>.</span>Code\n                <span>select</span> <span>new</span>\n                <span>{</span>\n                    user<span>.</span>Id<span>,</span>\n                    user<span>.</span>Name<span>,</span>\n                    user<span>.</span>Area<span>,</span>\n                    user<span>.</span>SettingCode<span>,</span>\n                    SettingName<span>=</span>setting<span>.</span>Name<span>,</span>\n                <span>}</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>\n              <span>await</span> sql<span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"settingName\"</span><span>:</span><span>\"UserName\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"settingName\"</span><span>:</span><span>\"AdminName\"</span><span>}</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>, <span>[</span>s0<span>]</span>.<span>[</span>Name<span>]</span> AS <span>[</span>SettingName<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>[</span>Setting<span>]</span> AS <span>[</span>s0<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span> <span>=</span> <span>[</span>s0<span>]</span>.<span>[</span>Code<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>2ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>, <span>[</span>s0<span>]</span>.<span>[</span>Name<span>]</span> AS <span>[</span>SettingName<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>[</span>Setting<span>]</span> AS <span>[</span>s0<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span> <span>=</span> <span>[</span>s0<span>]</span>.<span>[</span>Code<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br></div></div><h3 id=\"分表join分表\"> 分表join分表</h3>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>QueryJoin2</span><span>(</span><span>)</span>\n        <span>{</span>\n           <span><span>var</span></span> begin <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>3</span><span>,</span> <span>2</span><span>)</span><span>;</span>\n           <span><span>var</span></span> end <span>=</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>4</span><span>,</span> <span>3</span><span>)</span><span>;</span>\n           <span><span>var</span></span> sql1 <span>=</span> <span>from</span> user <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span> <span>||</span> o<span>.</span>Id <span>==</span> <span>\"6\"</span><span>)</span>\n               <span>join</span> order <span>in</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>Order<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o<span>=></span>o<span>.</span>CreationTime<span>>=</span>begin<span>&amp;&amp;</span>o<span>.</span>CreationTime<span>&lt;=</span>end<span>)</span>\n                   <span>on</span> user<span>.</span>Id equals order<span>.</span>Payer\n               <span>select</span> <span>new</span>\n               <span>{</span>\n                   user<span>.</span>Id<span>,</span>\n                   user<span>.</span>Name<span>,</span>\n                   user<span>.</span>Area<span>,</span>\n                   user<span>.</span>SettingCode<span>,</span>\n                   OrderId <span>=</span> order<span>.</span>Id<span>,</span>\n                   order<span>.</span>Payer<span>,</span>\n                   order<span>.</span>CreationTime\n               <span>}</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span><span>await</span> sql1<span>.</span><span>ToListAsync</span><span>(</span><span>)</span><span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br></div></div><p>结果</p>\n<div><pre><code><span>[</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"61\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-03T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"71\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-13T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"81\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-23T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName1\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"B\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"User\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"91\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"1\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-04-02T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"66\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-08T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"76\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-18T03:03:03\"</span><span>}</span><span>,</span><span>{</span><span>\"id\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"name\"</span><span>:</span><span>\"MyName6\"</span><span>,</span><span>\"area\"</span><span>:</span><span>\"A\"</span><span>,</span><span>\"settingCode\"</span><span>:</span><span>\"Admin\"</span><span>,</span><span>\"orderId\"</span><span>:</span><span>\"86\"</span><span>,</span><span>\"payer\"</span><span>:</span><span>\"6\"</span><span>,</span><span>\"creationTime\"</span><span>:</span><span>\"2021-03-28T03:03:03\"</span><span>}</span><span>]</span>\n</code></pre>\n<div><span>1</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>21ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>54ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_00<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>12ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202104<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\ninfo: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>20ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@__begin_0<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span>, @__end_1<span>=</span><span>'?'</span> <span>(</span>DbType <span>=</span> DateTime2<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SELECT <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Name<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>Area<span>]</span>, <span>[</span>s<span>]</span>.<span>[</span>SettingCode<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Id<span>]</span> AS <span>[</span>OrderId<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>, <span>[</span>t<span>]</span>.<span>[</span>CreationTime<span>]</span>\n      FROM <span>[</span>SysUser_01<span>]</span> AS <span>[</span>s<span>]</span>\n      INNER JOIN <span>(</span>\n          SELECT <span>[</span>o<span>]</span>.<span>[</span>Id<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span>, <span>[</span>o<span>]</span>.<span>[</span>Payer<span>]</span>\n          FROM <span>[</span>Order_202103<span>]</span> AS <span>[</span>o<span>]</span>\n          WHERE <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>>=</span> @__begin_0<span>)</span> AND <span>(</span><span>[</span>o<span>]</span>.<span>[</span>CreationTime<span>]</span> <span>&lt;=</span> @__end_1<span>)</span>\n      <span>)</span> AS <span>[</span>t<span>]</span> ON <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> <span>=</span> <span>[</span>t<span>]</span>.<span>[</span>Payer<span>]</span>\n      WHERE <span>[</span>s<span>]</span>.<span>[</span>Id<span>]</span> IN <span>(</span><span>'1'</span>, <span>'6'</span><span>)</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br></div></div><div><p>注意</p>\n<ol>\n<li>如果本次查询涉及<code>跨表</code>或者<code>跨库</code>并且查询附带<code>order by</code>那么order by的字段必须包含在返回结果里面.(聚合函数除外：count,any,sum......)</li>\n<li>应该尽可能避免分表join分表,如果实在需要join那么也应该尽可能指定某一张表或者分表的数目尽可能小。(因为分表后如果a1,a2 join b1,b2那么就会有4个结果相互组合,路由结果越多性能越低，会生成笛卡尔积)</li>\n</ol>\n</div>\n<h3 id=\"查询接口支持\"> 查询接口支持</h3>\n<table>\n<thead>\n<tr>\n<th>方法</th>\n<th>Method</th>\n<th><a href=\"https://github.com/xuejmnet/sharding-core/blob/main/test/ShardingCore.Test50/ShardingTest.cs\" target=\"_blank\" rel=\"noopener noreferrer\">Unit Test</a></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>第一条</td>\n<td>FindAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>获取集合</td>\n<td>ToListAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>第一条</td>\n<td>FirstOrDefaultAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>最大</td>\n<td>MaxAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>最小</td>\n<td>MinAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>是否存在</td>\n<td>AnyAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>数目</td>\n<td>CountAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>数目</td>\n<td>LongCountAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>求和</td>\n<td>SumAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>平均</td>\n<td>AverageAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>包含</td>\n<td>ContainsAsync</td>\n<td>yes</td>\n</tr>\n<tr>\n<td>分组</td>\n<td>GroupByAsync</td>\n<td>yes</td>\n</tr>\n</tbody>\n</table>\n",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2021-11-07T03:49:21.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "修改",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-table/update/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-table/update/",
      "content_html": "<h2 id=\"demo\"> Demo</h2>\n<p>本次分表的demo源码：<a href=\"https://github.com/xuejmnet/sharding-core/tree/main/samples/Sample.SqlServerShardingTable\" target=\"_blank\" rel=\"noopener noreferrer\">EFCoreShardingTable</a></p>\n<h2 id=\"自动追踪修改\"> 自动追踪修改</h2>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Update</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            sysUser<span>.</span>Name <span>=</span> <span>\"new name\"</span><span>;</span>\n            <span><span>var</span></span> i<span>=</span><span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>13ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p1<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      UPDATE <span>[</span>SysUser_01<span>]</span> SET <span>[</span>Name<span>]</span> <span>=</span> @p0\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p1<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><h2 id=\"非自动追踪修改\"> 非自动追踪修改</h2>\n<div><pre><code>        <span>public</span> <span>async</span> <span>Task<span>&lt;</span>IActionResult<span>></span></span> <span>Update1</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span><span>var</span></span> sysUser <span>=</span> <span>await</span> _myDbContext<span>.</span><span><span>Set</span><span><span>&lt;</span>SysUser<span>></span></span></span><span>(</span><span>)</span><span>.</span><span>AsNoTracking</span><span>(</span><span>)</span><span>.</span><span>Where</span><span>(</span>o <span>=></span> o<span>.</span>Id <span>==</span> <span>\"1\"</span><span>)</span><span>.</span><span>FirstOrDefaultAsync</span><span>(</span><span>)</span><span>;</span>\n            sysUser<span>.</span>Name <span>=</span> <span>\"new name\"</span><span>;</span>\n            _myDbContext<span>.</span><span>Update</span><span>(</span>sysUser<span>)</span><span>;</span>\n            <span><span>var</span></span> i <span>=</span> <span>await</span> _myDbContext<span>.</span><span>SaveChangesAsync</span><span>(</span><span>)</span><span>;</span>\n            <span>return</span> <span>Ok</span><span>(</span>i<span>)</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><div><pre><code>info: Microsoft.EntityFrameworkCore.Database.Command<span>[</span><span>20101</span><span>]</span>\n      Executed DbCommand <span>(</span>12ms<span>)</span> <span>[</span>Parameters<span>=</span><span>[</span>@p3<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p0<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p1<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span>, @p2<span>=</span><span>'?'</span> <span>(</span>Size <span>=</span> <span>50</span><span>)</span> <span>(</span>DbType <span>=</span> AnsiString<span>)</span><span>]</span>, <span>CommandType</span><span>=</span><span>'Text'</span>, <span>CommandTimeout</span><span>=</span><span>'30'</span><span>]</span>\n      SET NOCOUNT ON<span>;</span>\n      UPDATE <span>[</span>SysUser_01<span>]</span> SET <span>[</span>Area<span>]</span> <span>=</span> @p0, <span>[</span>Name<span>]</span> <span>=</span> @p1, <span>[</span>SettingCode<span>]</span> <span>=</span> @p2\n      WHERE <span>[</span>Id<span>]</span> <span>=</span> @p3<span>;</span>\n      SELECT @@ROWCOUNT<span>;</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br></div></div><div><p>结论</p>\n<p>追踪情况下sharding-core依然可以对结果进行修改，修改的字段是被修改过后的字段</p>\n<p>非追踪情况下sharding-croe也支持查询修改，但是修改的字段是全字段</p>\n</div>\n",
      "date_published": "2021-11-04T15:30:56.000Z",
      "date_modified": "2021-11-07T03:49:21.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "使用指南"
      ]
    },
    {
      "title": "默认路由",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-route/default-route/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/sharding-route/default-route/",
      "content_html": "<div><p>注意</p>\n<p>!!!默认xxxKeyLong的路由代表分片时间是毫秒的意思,需要自行判断你生成的long和<code>ShardingCoreHelper.ConvertDateTimeToLong(DateTime.Now)</code>是否一样!!!\n!!!默认xxxKeyLong的路由代表分片时间是毫秒的意思,需要自行判断你生成的long和<code>ShardingCoreHelper.ConvertDateTimeToLong(DateTime.Now)</code>是否一样!!!\n!!!默认xxxKeyLong的路由代表分片时间是毫秒的意思,需要自行判断你生成的long和<code>ShardingCoreHelper.ConvertDateTimeToLong(DateTime.Now)</code>是否一样!!!</p>\n</div>\n<h2 id=\"默认路由\"> 默认路由</h2>\n<p>分库提供了默认的路由分表则需要自己去实现,具体实现可以参考分库</p>\n<table>\n<thead>\n<tr>\n<th>抽象abstract</th>\n<th>路由规则</th>\n<th>tail</th>\n<th>索引</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>AbstractSimpleShardingModKeyIntVirtualTableRoute</td>\n<td>取模</td>\n<td>0,1,2...</td>\n<td><code>=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingModKeyStringVirtualTableRoute</td>\n<td>取模</td>\n<td>0,1,2...</td>\n<td><code>=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingDayKeyDateTimeVirtualTableRoute</td>\n<td>按时间</td>\n<td>yyyyMMdd</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingDayKeyLongVirtualTableRoute</td>\n<td>按时间戳</td>\n<td>yyyyMMdd</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingWeekKeyDateTimeVirtualTableRoute</td>\n<td>按时间</td>\n<td>yyyyMMdd_dd</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingWeekKeyLongVirtualTableRoute</td>\n<td>按时间戳</td>\n<td>yyyyMMdd_dd</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute</td>\n<td>按时间</td>\n<td>yyyyMM</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingMonthKeyLongVirtualTableRoute</td>\n<td>按时间戳</td>\n<td>yyyyMM</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingYearKeyDateTimeVirtualTableRoute</td>\n<td>按时间</td>\n<td>yyyy</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n<tr>\n<td>AbstractSimpleShardingYearKeyLongVirtualTableRoute</td>\n<td>按时间戳</td>\n<td>yyyy</td>\n<td><code>&gt;,&gt;=,&lt;,&lt;=,=,contains</code></td>\n</tr>\n</tbody>\n</table>\n<p>注:<code>contains</code>表示为<code>o=&gt;ids.contains(o.shardingkey)</code>\n注:使用默认的按时间分表的路由规则会让你重写一个GetBeginTime的方法这个方法必须使用静态值如:new DateTime(2021,1,1)不可以用动态值比如DateTime.Now因为每次重新启动都会调用该方法动态情况下会导致每次都不一致</p>\n<h2 id=\"索引\"> 索引</h2>\n<p>所谓的索引就是支持的表达式比如支持分表字段等于某个值，那么框架就会针对这个值进行解析出对应的数据库分表应该是哪个,并且支持组合<code>and</code>、<code>or</code>。\n默认提供的分表路由里面已经实现了所谓的路由，如果你的查询是包含对应的路由那么框架可以大大减小数据库链接的开启。有助于程序的高性能。</p>\n<p>假设我们是按id取模，那么如果你有指定的id对应值进行查询，我们就可以直接进行对分表/分库下进行数据源和表的定位，保证查询的高效。</p>\n<h3 id=\"abstractsimpleshardingmodkeyintvirtualtableroute\"> AbstractSimpleShardingModKeyIntVirtualTableRoute</h3>\n<p>该路由为简单的取模hash路由,分表字段是<code>int</code>类型,接受3个参数，第一个参数表示后缀的位数,第二位表示取模的基数，第三位是取模后缀不足的左补字符.</p>\n<p>AbstractSimpleShardingModKeyIntVirtualTableRoute(3,6,'0')那么就是<code>000</code>、<code>001</code>、<code>002</code>、<code>003</code>、<code>004</code>、<code>005</code></p>\n<h3 id=\"abstractsimpleshardingmodkeystringvirtualtableroute\"> AbstractSimpleShardingModKeyStringVirtualTableRoute</h3>\n<p>该路由为简单的取模hash路由,分表字段是<code>string</code>类型,接受3个参数，第一个参数表示后缀的位数,第二位表示取模的基数，第三位是取模后缀不足的左补字符.</p>\n<p>AbstractSimpleShardingModKeyStringVirtualTableRoute(3,6,'0')那么就是<code>000</code>、<code>001</code>、<code>002</code>、<code>003</code>、<code>004</code>、<code>005</code></p>\n<h3 id=\"abstractsimpleshardingdaykeydatetimevirtualtableroute\"> AbstractSimpleShardingDayKeyDateTimeVirtualTableRoute</h3>\n<p>该路由为简单的按天分表路由,支持分表字段是<code>DateTime</code>,分表后的后缀为<code>yyyyMMdd</code>.</p>\n<h3 id=\"abstractsimpleshardingdaykeylongvirtualtableroute\"> AbstractSimpleShardingDayKeyLongVirtualTableRoute</h3>\n<p>该路由为简单的按天分表路由,支持分表字段是<code>long</code>,分表后的后缀为<code>yyyyMMdd</code>.</p>\n<div><pre><code>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>//注意必须返回固定时间,不然每次启动时间都会变动</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>//启动自动建表</span>\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AutoCreateTableByTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>注意按天分表的路由自动建表的执行顺序为:</p>\n<ol>\n<li>每天的23:59:00分,&quot;0 59 23 * * ?&quot;</li>\n<li>每天的00:00:00分,&quot;0 0 0 * * ?&quot;</li>\n<li>每天的00:01:00分,&quot;0 1 0 * * ?&quot;</li>\n</ol>\n<p>分别会在这三个时间节点进行表的创建和数据表的动态添加,通过时间往后拨<code>IncrementMinutes</code>分钟来创建对应的表tail</p>\n<h3 id=\"abstractsimpleshardingweekkeydatetimevirtualtableroute\"> AbstractSimpleShardingWeekKeyDateTimeVirtualTableRoute</h3>\n<p>该路由为简单的按周分表路由,支持分表字段是<code>DateTime</code>,分表后的后缀为<code>yyyyMMdd_dd</code>.</p>\n<h3 id=\"abstractsimpleshardingweekkeylongvirtualtableroute\"> AbstractSimpleShardingWeekKeyLongVirtualTableRoute</h3>\n<p>该路由为简单的按周分表路由,支持分表字段是<code>long</code>,分表后的后缀为<code>yyyyMMdd_dd</code>.</p>\n<div><pre><code>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>//注意必须返回固定时间,不然每次启动时间都会变动</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>//启动自动建表</span>\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AutoCreateTableByTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>注意按周分表的路由自动建表的执行顺序为:</p>\n<ol>\n<li>每次周末的23:59:00分,&quot;0 59 23 ? * 1&quot;</li>\n<li>每次周一的00:00:00分,&quot;0 0 0 ? * 2&quot;</li>\n<li>每次周一的00:01:00分,&quot;0 1 0 ? * 2&quot;</li>\n</ol>\n<p>分别会在这三个时间节点进行表的创建和数据表的动态添加,通过时间往后拨<code>IncrementMinutes</code>分钟来创建对应的表tail</p>\n<h3 id=\"abstractsimpleshardingmonthkeydatetimevirtualtableroute\"> AbstractSimpleShardingMonthKeyDateTimeVirtualTableRoute</h3>\n<p>该路由为简单的按月分表路由,支持分表字段是<code>DateTime</code>,分表后的后缀为<code>yyyyMM</code>.</p>\n<h3 id=\"abstractsimpleshardingmonthkeylongvirtualtableroute\"> AbstractSimpleShardingMonthKeyLongVirtualTableRoute</h3>\n<p>该路由为简单的按月分表路由,支持分表字段是<code>long</code>,分表后的后缀为<code>yyyyMM</code>.</p>\n<div><pre><code>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>//注意必须返回固定时间,不然每次启动时间都会变动</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>//启动自动建表</span>\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AutoCreateTableByTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>注意按月分表的路由自动建表的执行顺序为:</p>\n<ol>\n<li>每月的28、29、30、31日的23:59:00分,&quot;0 59 23 28,29,30,31 * ?&quot;</li>\n<li>每月的1日的00:00:00分,&quot;0 0 0 1 * ?&quot;</li>\n<li>每月的1日的00:01:00分,&quot;0 1 0 1 * ?&quot;</li>\n</ol>\n<p>分别会在这三个时间节点进行表的创建和数据表的动态添加,通过时间往后拨<code>IncrementMinutes</code>分钟来创建对应的表tail</p>\n<h3 id=\"abstractsimpleshardingyearkeydatetimevirtualtableroute\"> AbstractSimpleShardingYearKeyDateTimeVirtualTableRoute</h3>\n<p>该路由为简单的按年分表路由,支持分表字段是<code>DateTime</code>,分表后的后缀为<code>yyyy</code>.</p>\n<h3 id=\"abstractsimpleshardingyearkeylongvirtualtableroute\"> AbstractSimpleShardingYearKeyLongVirtualTableRoute</h3>\n<p>该路由为简单的按年分表路由,支持分表字段是<code>long</code>,分表后的后缀为<code>yyyy</code>.</p>\n<div><pre><code>\n        <span>public</span> <span>override</span> <span>DateTime</span> <span>GetBeginTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>//注意必须返回固定时间,不然每次启动时间都会变动</span>\n            <span>return</span> <span>new</span> <span>DateTime</span><span>(</span><span>2021</span><span>,</span> <span>1</span><span>,</span> <span>1</span><span>)</span><span>;</span>\n        <span>}</span>\n        <span>//启动自动建表</span>\n        <span>public</span> <span>override</span> <span><span>bool</span></span> <span>AutoCreateTableByTime</span><span>(</span><span>)</span>\n        <span>{</span>\n            <span>return</span> <span>true</span><span>;</span>\n        <span>}</span>\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>注意按年分表的路由自动建表的执行顺序为:</p>\n<ol>\n<li>每年的31日的23:59:00分,&quot;0 59 23 31 12 ?&quot;</li>\n<li>每年的1日的00:00:00分,&quot;0 0 0 1 1 ?&quot;</li>\n<li>每年的1日的00:01:00分,&quot;0 1 0 1 1 ?&quot;</li>\n</ol>\n<p>分别会在这三个时间节点进行表的创建和数据表的动态添加,通过时间往后拨<code>IncrementMinutes</code>分钟来创建对应的表tail</p>\n<p><strong>注意：所有的定时任务都可以设置为false,并且可以使用自身的定时任务来实现动态的创建表和添加表后缀</strong></p>\n<h2 id=\"时间分表的定时信息\"> 时间分表的定时信息</h2>\n<p>为了保证可以让程序卡点发布还能正确创建对应的表信息和知道现有的表,所以存在三个节点进行创建表。\n但是可能会出现重复创建表的信息，也会出现表没创建的其他原因导致程序执行失败，所以这边对其进行了日志的过滤用户可以再使用默认的时间分表的情况下选择重写<code>ShowErrorLog</code>属性来输出任务执行时候的建表异常信息。</p>\n<div><p>注意</p>\n<p>！！！重写<code>GetCronExpressions()</code>方法后,请一定要重写<code>IncrementMinutes</code>值！！！</p>\n<p>！！！重写<code>GetCronExpressions()</code>方法后,请一定要重写<code>IncrementMinutes</code>值！！！</p>\n<p>！！！重写<code>GetCronExpressions()</code>方法后,请一定要重写<code>IncrementMinutes</code>值！！！</p>\n</div>\n",
      "date_published": "2021-11-03T00:53:03.000Z",
      "date_modified": "2022-04-22T01:33:07.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "路由"
      ]
    },
    {
      "title": "单元测试覆盖率",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/unit-test-coverage/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/unit-test-coverage/",
      "content_html": "<img src=\"/sharding-core-doc/unit-test-coverage.png\">",
      "date_published": "2021-11-30T01:40:55.000Z",
      "date_modified": "2022-01-11T02:51:27.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "单元测试覆盖率"
      ]
    },
    {
      "title": "多租户",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/tenant/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/tenant/",
      "content_html": "<h2 id=\"背景\"> 背景</h2>\n<p>因为之前有小伙伴在使用<code>ShardingCore</code>的时候问过我是否可以利用ShardingCore的分库功能实现多租户呢，我的回答是可以的，但是需要针对分库对象进行路由的编写，相当于我一个项目需要实现多租户所有的表都需要实现分库才可以，那么这个在实际应用中将是不切实际的，所以虽然分库可以用来进行多租户但是一般没人会真的这样操作，那么就没有办法在ShardingCore使用合理的多租户外加分表分库了吗，针对这个问题<code>ShardingCore</code>在新的版本x.4.x.x+中进行了实现,<a href=\"https://www.cnblogs.com/xuejiaming/p/15782298.html\" target=\"_blank\" rel=\"noopener noreferrer\">博客</a></p>\n<h2 id=\"功能\"> 功能</h2>\n<p><code>ShardingCore</code>x.4.x.x+版本中具体实现了哪些功能呢</p>\n<ul>\n<li>多配置支持,可以针对每个租户或者这个配置进行单独的分表分库读写分离的链接配置</li>\n<li>多数据库配置，支持多配置下每个配置都可以拥有自己的数据库来进行分表分库读写分离</li>\n<li>动态多配置，支持动态添加多配置(目前不支持动态删减多配置,后续会支持如果有需要)</li>\n</ul>\n<h2 id=\"场景\"> 场景</h2>\n<p>假设我们有这么一个多租户系统，这个系统在我们创建好账号后会分配给我们一个单独的数据库和对应的表信息,之后用户可以利用这个租户配置信息进行操作处理</p>\n<h2 id=\"首先我们创建一个aspnetcore的项目\"> 首先我们创建一个AspNetCore的项目</h2>\n<p><img src=\"https://img2020.cnblogs.com/blog/1346660/202201/1346660-20220109204747170-1484976526.png\" alt=\"\" />\n这边才用的.Net6版本的webapi</p>\n<h2 id=\"添加依赖\"> 添加依赖</h2>\n<p><img src=\"https://img2020.cnblogs.com/blog/1346660/202201/1346660-20220110135052157-537177258.png\" alt=\"\" /></p>\n<p>这边我们添加了三个包,分别是<code>ShardingCore</code>,<code>Microsoft.EntityFrameworkCore.SqlServer</code>,<code>Pomelo.EntityFrameworkCore.MySql</code>,其中<code>ShardingCore</code>用的是预览版的如果不勾选那么将无法显示出来,为什么我们需要添加额外的两个数据库驱动呢,原因是因为我们需要在不同的租户下实现不同的数据库的配置,比如租户A和我们签订的协议里面有说明系统使用开源数据库,或者希望使用Linux平台那么可以针对租户A进行配置<code>MySql</code>或者<code>PgSql</code>,租户B是资深软粉说需要使用<code>MSSQL</code>那么就可以针对其配置<code>MSSQL</code>.一般情况下我们可能不会出现多数据库的情况但是为了照顾到特殊情况我们这边也针对这种情况进行了支持。</p>\n<h2 id=\"公共用户存储\"> 公共用户存储</h2>\n<p>首先在我还没有创建租户的时候是不存在数据库的所以我的数据自然而然不会存在当前租户下,这边我们采用的是存储到其他数据库中,假设我们使用一个公共的数据库作为用户系统.</p>\n<h3 id=\"创建用户系统\"> 创建用户系统</h3>\n<p>创建系统用户和创建系统用户在数据库内的映射关系</p>\n<div><pre><code>    public class SysUser\n    {\n        public string Id { get; set; }\n        public string Name { get; set; }\n        public string Password { get; set; }\n        public DateTime CreationTime { get; set; }\n        public bool IsDeleted { get; set; }\n    }\n    public class SysUserMap:IEntityTypeConfiguration&lt;SysUser&gt;\n    {\n        public void Configure(EntityTypeBuilder&lt;SysUser&gt; builder)\n        {\n            builder.HasKey(o =&gt; o.Id);\n            builder.Property(o =&gt; o.Id).IsRequired().IsUnicode(false).HasMaxLength(50);\n            builder.Property(o =&gt; o.Name).IsRequired().HasMaxLength(50);\n            builder.Property(o =&gt; o.Password).IsRequired().IsUnicode(false).HasMaxLength(50);\n            builder.HasQueryFilter(o =&gt; o.IsDeleted == false);\n            builder.ToTable(nameof(SysUser));\n        }\n    }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br></div></div><p>创建这个数据库该有的配置信息表，便于后期启动后重建</p>\n<div><pre><code>    public class SysUserTenantConfig\n    {\n        public string Id { get; set; }\n        public string UserId { get; set; }\n        /// &lt;summary&gt;\n        /// 添加ShardingCore配置的Json包\n        /// &lt;/summary&gt;\n        public string ConfigJson { get; set; }\n        public DateTime CreationTime { get; set; }\n        public bool IsDeleted { get; set; }\n    }\n    public class SysUserTenantConfigMap:IEntityTypeConfiguration&lt;SysUserTenantConfig&gt;\n    {\n        public void Configure(EntityTypeBuilder&lt;SysUserTenantConfig&gt; builder)\n        {\n            builder.HasKey(o =&gt; o.Id);\n            builder.Property(o =&gt; o.Id).IsRequired().IsUnicode(false).HasMaxLength(50);\n            builder.Property(o =&gt; o.UserId).IsRequired().IsUnicode(false).HasMaxLength(50);\n            builder.Property(o =&gt; o.ConfigJson).IsRequired().HasMaxLength(2000);\n            builder.HasQueryFilter(o =&gt; o.IsDeleted == false);\n            builder.ToTable(nameof(SysUserTenantConfig));\n        }\n    }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br></div></div><p>创建对应的系统用户存储DbContext</p>\n<div><pre><code>\n    public class IdentityDbContext:DbContext\n    {\n        public IdentityDbContext(DbContextOptions&lt;IdentityDbContext&gt; options):base(options)\n        {\n            \n        }\n\n        protected override void OnModelCreating(ModelBuilder modelBuilder)\n        {\n            base.OnModelCreating(modelBuilder);\n            modelBuilder.ApplyConfiguration(new SysUserMap());\n            modelBuilder.ApplyConfiguration(new SysUserTenantConfigMap());\n        }\n    }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br></div></div><h3 id=\"创建一个租户的dbcontext\"> 创建一个租户的DbContext</h3>\n<div><pre><code>    public class TenantDbContext:AbstractShardingDbContext,IShardingTableDbContext\n    {\n        public TenantDbContext(DbContextOptions&lt;TenantDbContext&gt; options) : base(options)\n        {\n        }\n\n        public IRouteTail RouteTail { get; set; }\n    }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><p>目前我们先定义好后续进行编写内部的租户代码</p>\n<h3 id=\"创建动态租户参数\"> 创建动态租户参数</h3>\n<p>动态租户分片配置信息在<code>ShardingCore</code>只需要实现<code>IVirtualDataSourceConfigurationParams&lt;TShardingDbContext&gt;</code>接口,但是这个接口有很多参数需要填写,所以这边框架针对这个接口进行了默认参数的抽象类<code>AbstractVirtualDataSourceConfigurationParams&lt;TShardingDbContext&gt;</code>。\n这边我们针对配置参数进行配置采用新建一个配置json的对象</p>\n<div><pre><code>    public class ShardingTenantOptions\n    {\n        public  string ConfigId { get; set;}\n        public  int Priority { get; set;}\n        public  string DefaultDataSourceName { get; set;}\n        public  string DefaultConnectionString { get; set;}\n        public DbTypeEnum DbType { get; set; }\n    }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br></div></div><p>参数里面配置了当前数据库,这边比较简单我们就暂时使用单表分库的模式来实现,目前暂时不对每个租户分库进行演示。之后并且编写<code>SqlServer</code>和<code>MySql</code>的配置支持</p>\n<div><pre><code>\n    public class SqlShardingConfiguration : AbstractVirtualDataSourceConfigurationParams&lt;TenantDbContext&gt;\n    {\n        private static readonly ILoggerFactory efLogger = LoggerFactory.Create(builder =&gt;\n        {\n            builder.AddFilter((category, level) =&gt; category == DbLoggerCategory.Database.Command.Name &amp;&amp; level == LogLevel.Information).AddConsole();\n        });\n        public override string ConfigId { get; }\n        public override int Priority { get; }\n        public override string DefaultDataSourceName { get; }\n        public override string DefaultConnectionString { get; }\n        public override ITableEnsureManager TableEnsureManager { get; }\n\n        private readonly DbTypeEnum _dbType;\n        public SqlShardingConfiguration(ShardingTenantOptions options)\n        {\n            ConfigId = options.ConfigId;\n            Priority = options.Priority;\n            DefaultDataSourceName = options.DefaultDataSourceName;\n            DefaultConnectionString = options.DefaultConnectionString;\n            _dbType = options.DbType;\n            //用来快速判断是否存在数据库中的表\n            if (_dbType == DbTypeEnum.MSSQL)\n            {\n                TableEnsureManager = new SqlServerTableEnsureManager&lt;TenantDbContext&gt;();\n            }\n            else if (_dbType == DbTypeEnum.MYSQL)\n            {\n                TableEnsureManager = new MySqlTableEnsureManager&lt;TenantDbContext&gt;();\n            }\n            else\n            {\n                throw new NotImplementedException();\n            }\n        }\n        public override DbContextOptionsBuilder UseDbContextOptionsBuilder(string connectionString,\n            DbContextOptionsBuilder dbContextOptionsBuilder)\n        {\n            switch (_dbType)\n            {\n                case DbTypeEnum.MSSQL:\n                    {\n                        dbContextOptionsBuilder.UseSqlServer(connectionString).UseLoggerFactory(efLogger);\n                    }\n                    break;\n                case DbTypeEnum.MYSQL:\n                    {\n                        dbContextOptionsBuilder.UseMySql(connectionString, new MySqlServerVersion(new Version())).UseLoggerFactory(efLogger);\n                    }\n                    break;\n                default: throw new NotImplementedException();\n            }\n            return dbContextOptionsBuilder;\n        }\n\n        public override DbContextOptionsBuilder UseDbContextOptionsBuilder(DbConnection dbConnection,\n            DbContextOptionsBuilder dbContextOptionsBuilder)\n        {\n            switch (_dbType)\n            {\n                case DbTypeEnum.MSSQL:\n                {\n                    dbContextOptionsBuilder.UseSqlServer(dbConnection).UseLoggerFactory(efLogger);\n                    }\n                    break;\n                case DbTypeEnum.MYSQL:\n                {\n                    dbContextOptionsBuilder.UseMySql(dbConnection, new MySqlServerVersion(new Version())).UseLoggerFactory(efLogger);\n                    }\n                    break;\n                default: throw new NotImplementedException();\n            }\n            return dbContextOptionsBuilder;\n        }\n    }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br></div></div><h3 id=\"编写用户注册接口\"> 编写用户注册接口</h3>\n<div><pre><code>\n    [Route(&quot;api/[controller]/[action]&quot;)]\n    [ApiController]\n    [AllowAnonymous]\n    public class PassportController:ControllerBase\n    {\n        private readonly IdentityDbContext _identityDbContext;\n\n        public PassportController(IdentityDbContext identityDbContext)\n        {\n            _identityDbContext = identityDbContext;\n        }\n        [HttpPost]\n        public async Task&lt;IActionResult&gt; Register(RegisterRequest request)\n        {\n            if (await _identityDbContext.Set&lt;SysUser&gt;().AnyAsync(o =&gt; o.Name == request.Name))\n                return BadRequest(&quot;user not exists&quot;);\n            var sysUser = new SysUser()\n            {\n                Id = Guid.NewGuid().ToString(&quot;n&quot;),\n                Name = request.Name,\n                Password = request.Password,\n                CreationTime=DateTime.Now\n            };\n            var shardingTenantOptions = new ShardingTenantOptions()\n            {\n                ConfigId = sysUser.Id,\n                Priority = new Random().Next(1,10),\n                DbType = request.DbType,\n                DefaultDataSourceName = &quot;ds0&quot;,\n                DefaultConnectionString = GetDefaultString(request.DbType,sysUser.Id)\n            };\n            var sysUserTenantConfig = new SysUserTenantConfig()\n            {\n                Id = Guid.NewGuid().ToString(&quot;n&quot;),\n                UserId = sysUser.Id,\n                CreationTime = DateTime.Now,\n                ConfigJson = JsonConvert.SerializeObject(shardingTenantOptions)\n            };\n            await _identityDbContext.AddAsync(sysUser);\n            await _identityDbContext.AddAsync(sysUserTenantConfig);\n            await _identityDbContext.SaveChangesAsync();\n            //注册完成后进行配置生成\n            DynamicShardingHelper.DynamicAppendVirtualDataSourceConfig(new SqlShardingConfiguration(shardingTenantOptions));\n            return Ok();\n        }\n        [HttpPost]\n        public async Task&lt;IActionResult&gt; Login(LoginRequest request)\n        {\n            var sysUser = await _identityDbContext.Set&lt;SysUser&gt;().FirstOrDefaultAsync(o=&gt;o.Name==request.Name&amp;&amp;o.Password==request.Password);\n            if (sysUser == null)\n                return BadRequest(&quot;name or password error&quot;);\n\n            //秘钥，就是标头，这里用Hmacsha256算法，需要256bit的密钥\n            var securityKey = new SigningCredentials(new SymmetricSecurityKey(Encoding.ASCII.GetBytes(&quot;123123!@#!@#123123&quot;)), SecurityAlgorithms.HmacSha256);\n            //Claim，JwtRegisteredClaimNames中预定义了好多种默认的参数名，也可以像下面的Guid一样自己定义键名.\n            //ClaimTypes也预定义了好多类型如role、email、name。Role用于赋予权限，不同的角色可以访问不同的接口\n            //相当于有效载荷\n            var claims = new Claim[] {\n                new Claim(JwtRegisteredClaimNames.Iss,&quot;https://localhost:5000&quot;),\n                new Claim(JwtRegisteredClaimNames.Aud,&quot;api&quot;),\n                new Claim(&quot;id&quot;,Guid.NewGuid().ToString(&quot;n&quot;)),\n                new Claim(&quot;uid&quot;,sysUser.Id),\n            };\n            SecurityToken securityToken = new JwtSecurityToken(\n                signingCredentials: securityKey,\n                expires: DateTime.Now.AddHours(2),//过期时间\n                claims: claims\n            );\n            var token = new JwtSecurityTokenHandler().WriteToken(securityToken);\n            return Ok(token);\n        }\n\n        private string GetDefaultString(DbTypeEnum dbType, string userId)\n        {\n            switch (dbType)\n            {\n                case DbTypeEnum.MSSQL: return $&quot;Data Source=localhost;Initial Catalog=DB{userId};Integrated Security=True;&quot;;\n                case DbTypeEnum.MYSQL: return $&quot;server=127.0.0.1;port=3306;database=DB{userId};userid=root;password=L6yBtV6qNENrwBy7;&quot;;\n                default: throw new NotImplementedException();\n            }\n        }\n    }\n    \n    public class RegisterRequest\n    {\n        public string Name { get; set; }\n        public string Password { get; set; }\n        public DbTypeEnum DbType { get; set; }\n    }\n\n    public class LoginRequest\n    {\n        public string Name { get; set; }\n        public string Password { get; set; }\n    }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br><span>74</span><br><span>75</span><br><span>76</span><br><span>77</span><br><span>78</span><br><span>79</span><br><span>80</span><br><span>81</span><br><span>82</span><br><span>83</span><br><span>84</span><br><span>85</span><br><span>86</span><br><span>87</span><br><span>88</span><br><span>89</span><br><span>90</span><br><span>91</span><br><span>92</span><br><span>93</span><br><span>94</span><br><span>95</span><br><span>96</span><br></div></div><p>简单来说明一下,这边我们采用的是用户的id作为租户id,将租户id作为数据库配置,来支持多配置模式。到此为止我们的用户系统就已经完成了是不是十分的简单仅仅几段代码,用户这边注册完成后将会创建对应的数据库和对应的表,如果你是分表的那么将会自动创建对应的数据库表等信息。</p>\n<h2 id=\"租户系统\"> 租户系统</h2>\n<p>租户系统我们做一个订单的简单演示,使用订单id取模,取模取5来进行分表操作</p>\n<h3 id=\"新增租户系统的订单信息\"> 新增租户系统的订单信息</h3>\n<div><pre><code>    public class Order\n    {\n        public string Id { get; set; }\n        public string Name { get; set; }\n        public DateTime CreationTime { get; set; }\n        public bool IsDeleted { get; set; }\n    }\n    public class OrderMap:IEntityTypeConfiguration&lt;Order&gt;\n    {\n        public void Configure(EntityTypeBuilder&lt;Order&gt; builder)\n        {\n            builder.HasKey(o =&gt; o.Id);\n            builder.Property(o =&gt; o.Id).IsRequired().IsUnicode(false).HasMaxLength(50);\n            builder.Property(o =&gt; o.Name).IsRequired().HasMaxLength(100);\n            builder.HasQueryFilter(o =&gt; o.IsDeleted == false);\n            builder.ToTable(nameof(Order));\n        }\n    }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br></div></div><h3 id=\"新增订单路由\"> 新增订单路由</h3>\n<div><pre><code>public class OrderVirtualTableRoute:AbstractSimpleShardingModKeyStringVirtualTableRoute&lt;Order&gt;\n{\n      public OrderVirtualTableRoute() : base(2, 5)\n      {\n      }\n\n      public override void Configure(EntityMetadataTableBuilder&lt;Order&gt; builder)\n      {\n          builder.ShardingProperty(o =&gt; o.Id);\n      }\n}\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br></div></div><p>简单的字符串取模</p>\n<h3 id=\"添加租户中间件\"> 添加租户中间件</h3>\n<p>添加租户中间件,在系统中如果使用多配置那么就必须要指定本次创建的dbcontext使用的是哪个配置</p>\n<div><pre><code>\n    public class TenantSelectMiddleware\n    {\n        private readonly RequestDelegate _next;\n        private readonly IVirtualDataSourceManager&lt;TenantDbContext&gt; _virtualDataSourceManager;\n\n        public TenantSelectMiddleware(RequestDelegate next, IVirtualDataSourceManager&lt;TenantDbContext&gt; virtualDataSourceManager)\n        {\n            _next = next;\n            _virtualDataSourceManager = virtualDataSourceManager;\n        }\n\n        public async Task Invoke(HttpContext context)\n        {\n\n            if (context.Request.Path.ToString().StartsWith(&quot;/api/tenant&quot;, StringComparison.CurrentCultureIgnoreCase))\n            {\n                if (!context.User.Identity.IsAuthenticated)\n                {\n                    await DoUnAuthorized(context, &quot;not found tenant id&quot;);\n                    return;\n                }\n\n                var tenantId = context.User.Claims.FirstOrDefault((o) =&gt; o.Type == &quot;uid&quot;)?.Value;\n                if (string.IsNullOrWhiteSpace(tenantId))\n                {\n                    await DoUnAuthorized(context, &quot;not found tenant id&quot;);\n                    return;\n                }\n\n                using (_virtualDataSourceManager.CreateScope(tenantId))\n                {\n                    await _next(context);\n                }\n            }\n            else\n            {\n                await _next(context);\n            }\n        }\n\n        private async Task DoUnAuthorized(HttpContext context, string msg)\n        {\n            context.Response.StatusCode = 403;\n            await context.Response.WriteAsync(msg);\n        }\n    }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br></div></div><p>该中间件拦截<code>/api/tenant</code>路径下的所有请求并且针对这些请求添加对应的租户信息</p>\n<h3 id=\"配置租户扩展初始化数据\"> 配置租户扩展初始化数据</h3>\n<div><pre><code>\n    public static class TenantExtension\n    {\n        public static void InitTenant(this IServiceProvider serviceProvider)\n        {\n            using (var scope = serviceProvider.CreateScope())\n            {\n                var identityDbContext = scope.ServiceProvider.GetRequiredService&lt;IdentityDbContext&gt;();\n                identityDbContext.Database.EnsureCreated();\n                var sysUserTenantConfigs = identityDbContext.Set&lt;SysUserTenantConfig&gt;().ToList();\n                if (sysUserTenantConfigs.Any())\n                {\n                    foreach (var sysUserTenantConfig in sysUserTenantConfigs)\n                    {\n                        var shardingTenantOptions = JsonConvert.DeserializeObject&lt;ShardingTenantOptions&gt;(sysUserTenantConfig.ConfigJson);\n                        DynamicShardingHelper.DynamicAppendVirtualDataSourceConfig(\n                            new SqlShardingConfiguration(shardingTenantOptions));\n                    }\n                }\n            }\n        }\n    }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br></div></div><p>这边因为我们针对租户信息进行了初始化而不是硬编码,所以需要一个在启动的时候对租户信息进行动态添加</p>\n<h3 id=\"配置多租户\"> 配置多租户</h3>\n<p>启动配置<code>Startup</code></p>\n<div><pre><code>\nvar builder = WebApplication.CreateBuilder(args);\n\n// Add services to the container.\n\nbuilder.Services.AddControllers();\nbuilder.Services.AddAuthentication();\n#region 用户系统配置\n\nbuilder.Services.AddDbContext&lt;IdentityDbContext&gt;(o =&gt;\n    o.UseSqlServer(&quot;Data Source=localhost;Initial Catalog=IdDb;Integrated Security=True;&quot;));\n//生成密钥\nvar keyByteArray = Encoding.ASCII.GetBytes(&quot;123123!@#!@#123123&quot;);\nvar signingKey = new SymmetricSecurityKey(keyByteArray);\n//认证参数\nbuilder.Services.AddAuthentication(&quot;Bearer&quot;)\n    .AddJwtBearer(o =&gt;\n    {\n        o.TokenValidationParameters = new TokenValidationParameters\n        {\n            ValidateIssuerSigningKey = true,\n            IssuerSigningKey = signingKey,\n            ValidateIssuer = true,\n            ValidIssuer = &quot;https://localhost:5000&quot;,\n            ValidateAudience = true,\n            ValidAudience = &quot;api&quot;,\n            ValidateLifetime = true,\n            ClockSkew = TimeSpan.Zero,\n            RequireExpirationTime = true,\n        };\n    });\n#endregion\n#region 配置ShardingCore\nbuilder.Services.AddShardingDbContext&lt;TenantDbContext&gt;()\n    .AddEntityConfig(op =&gt;\n    {\n        op.CreateShardingTableOnStart = true;\n        op.EnsureCreatedWithOutShardingTable = true;\n        op.AddShardingTableRoute&lt;OrderVirtualTableRoute&gt;();\n    })\n    .AddConfig(op =&gt;\n    {\n        //默认配置一个\n        op.ConfigId = $&quot;test_{Guid.NewGuid():n}&quot;;\n        op.Priority = 99999;\n        op.AddDefaultDataSource(&quot;ds0&quot;, &quot;Data Source=localhost;Initial Catalog=TestTenantDb;Integrated Security=True;&quot;);\n        op.UseShardingQuery((conStr, b) =&gt;\n        {\n            b.UseSqlServer(conStr);\n        });\n        op.UseShardingTransaction((conn, b) =&gt;\n        {\n            b.UseSqlServer(conn);\n        });\n    }).EnsureMultiConfig(ShardingConfigurationStrategyEnum.ThrowIfNull);\n\n#endregion\n\nvar app = builder.Build();\n\n// Configure the HTTP request pipeline.\napp.Services.GetRequiredService&lt;IShardingBootstrapper&gt;().Start();\n//初始化启动配置租户信息\napp.Services.InitTenant();\napp.UseAuthorization();\napp.UseAuthorization();\n//在认证后启用租户选择中间件\napp.UseMiddleware&lt;TenantSelectMiddleware&gt;();\n\napp.MapControllers();\n\napp.Run();\n\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br><span>39</span><br><span>40</span><br><span>41</span><br><span>42</span><br><span>43</span><br><span>44</span><br><span>45</span><br><span>46</span><br><span>47</span><br><span>48</span><br><span>49</span><br><span>50</span><br><span>51</span><br><span>52</span><br><span>53</span><br><span>54</span><br><span>55</span><br><span>56</span><br><span>57</span><br><span>58</span><br><span>59</span><br><span>60</span><br><span>61</span><br><span>62</span><br><span>63</span><br><span>64</span><br><span>65</span><br><span>66</span><br><span>67</span><br><span>68</span><br><span>69</span><br><span>70</span><br><span>71</span><br><span>72</span><br><span>73</span><br></div></div><h3 id=\"编写租户操作\"> 编写租户操作</h3>\n<div><pre><code>\n    [Route(&quot;api/tenant/[controller]/[action]&quot;)]\n    [ApiController]\n    [Authorize(AuthenticationSchemes = &quot;Bearer&quot;)]\n    public class TenantController : ControllerBase\n    {\n        private readonly TenantDbContext _tenantDbContext;\n\n        public TenantController(TenantDbContext tenantDbContext)\n        {\n            _tenantDbContext = tenantDbContext;\n        }\n        public async Task&lt;IActionResult&gt; AddOrder()\n        {\n            var order = new Order()\n            {\n                Id = Guid.NewGuid().ToString(&quot;n&quot;),\n                CreationTime = DateTime.Now,\n                Name = new Random().Next(1,100)+&quot;_name&quot;\n            };\n            await _tenantDbContext.AddAsync(order);\n            await _tenantDbContext.SaveChangesAsync();\n            return Ok(order.Id);\n        }\n        public async Task&lt;IActionResult&gt; UpdateOrder([FromQuery]string id)\n        {\n            var order =await _tenantDbContext.Set&lt;Order&gt;().FirstOrDefaultAsync(o=&gt;o.Id==id);\n            if (order == null) return BadRequest();\n            order.Name = new Random().Next(1, 100) + &quot;_name&quot;;\n            await _tenantDbContext.SaveChangesAsync();\n            return Ok(order.Id);\n        }\n        public async Task&lt;IActionResult&gt; GetOrders()\n        {\n            var orders =await _tenantDbContext.Set&lt;Order&gt;().ToListAsync();\n            return Ok(orders);\n        }\n    }\n</code></pre>\n<div><span>1</span><br><span>2</span><br><span>3</span><br><span>4</span><br><span>5</span><br><span>6</span><br><span>7</span><br><span>8</span><br><span>9</span><br><span>10</span><br><span>11</span><br><span>12</span><br><span>13</span><br><span>14</span><br><span>15</span><br><span>16</span><br><span>17</span><br><span>18</span><br><span>19</span><br><span>20</span><br><span>21</span><br><span>22</span><br><span>23</span><br><span>24</span><br><span>25</span><br><span>26</span><br><span>27</span><br><span>28</span><br><span>29</span><br><span>30</span><br><span>31</span><br><span>32</span><br><span>33</span><br><span>34</span><br><span>35</span><br><span>36</span><br><span>37</span><br><span>38</span><br></div></div><h2 id=\"启动项目\"> 启动项目</h2>\n<p>这边我们基本上已经配置好我们所需要的之后我们就可以直接启动项目了\n<img src=\"https://img2020.cnblogs.com/blog/1346660/202201/1346660-20220110213028837-1684806586.png\" alt=\"\" /></p>\n<p>这边我们通过接口注册了一个TenantA的用户并且选择了使用MSSQL,这边成就帮我们自动生成好了对应的数据库表结构\n接下来我么再注册一个TenantB用户选择MySql\n<img src=\"https://img2020.cnblogs.com/blog/1346660/202201/1346660-20220110213234665-1363047961.png\" alt=\"\" /></p>\n<p>通过截图我们可以看到<code>ShardingCore</code>也是为我们创建好了对应的数据库和对应的表信息</p>\n<h2 id=\"登录租户\"> 登录租户</h2>\n<p>首先我们登录</p>\n<p>TenantA用户token</p>\n<div><pre><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL2xvY2FsaG9zdDo1MDAwIiwiYXVkIjoiYXBpIiwiaWQiOiJkNGMwZjZiNzI5MzE0M2VlYWM0Yjg3NzUwYzE4MWUzOSIsInVpZCI6ImMxMWRkZjFmNTY0MjQwZjc5YTQzNTEzZGMwNmVjZGMxIiwiZXhwIjoxNjQxODI4ODQ0fQ.zJefwnmcIEZm-kizlN7DhwTRgGxiCg52Esa8QmHiEKY\n</code></pre>\n<div><span>1</span><br></div></div><p>TenantB用户token</p>\n<div><pre><code>eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJodHRwczovL2xvY2FsaG9zdDo1MDAwIiwiYXVkIjoiYXBpIiwiaWQiOiIwNzY4NzUwMmVjYzY0NTMyOGFkNTcwZDRkYjMwNDI3MSIsInVpZCI6ImVkODg4YTc3MzAwYTQ4NjZhYmUyNWY2MTE1NmEwZTQzIiwiZXhwIjoxNjQxODI4ODgxfQ.cL0d010jdXLXNGT8M0wsRMqn3VeIxFnV0keM0H3SPzo\n</code></pre>\n<div><span>1</span><br></div></div><p>接下来我们分别对两个租户进行交叉处理</p>\n<h3 id=\"addorder\"> AddOrder</h3>\n<p>租户A插入一个订单,订单Id：<code>aef6905f512a4f72baac5f149ef32d21</code>\n<img src=\"https://img2020.cnblogs.com/blog/1346660/202201/1346660-20220110214024317-2049319166.png\" alt=\"\" /></p>\n<p>TenantB用户也插入一个订单,订单id:<code>450f5dd0e82442eca33dfcf3d57fafa3</code>\n<img src=\"https://img2020.cnblogs.com/blog/1346660/202201/1346660-20220110214159011-2067776275.png\" alt=\"\" />\n两个用户处理\n<img src=\"https://img2020.cnblogs.com/blog/1346660/202201/1346660-20220110214520461-1662296101.png\" alt=\"\" /></p>\n<p>通过日志打印明显能够感觉出来两者是区分了不同的数据库</p>\n<h3 id=\"updateorder\"> UpdateOrder</h3>\n<p><img src=\"https://img2020.cnblogs.com/blog/1346660/202201/1346660-20220110214426755-139567743.png\" alt=\"\" /></p>\n<h3 id=\"getorders\"> GetOrders</h3>\n<p><img src=\"https://img2020.cnblogs.com/blog/1346660/202201/1346660-20220110214805352-462848018.png\" alt=\"\" /></p>\n<h2 id=\"总结\"> 总结</h2>\n<p>通过上述功能的演示相信很多小伙伴应该已经知道他具体的运作流程了,通过配置多个租户信息,在<code>ShardingCore</code>上实现多配置,动态配置,来保证在多租户模式下的分表分库读写分离依然可以使用,并且拥有跟好的适泛性。\n如果你需要开发一个大型程序,领导上来就是分库分表,那么在以前大概率是会花费非常多的精力在处理分片这件事情上,而最终项目是否可以做完并且使用还是一个巨大的问题,但是现在不一样了,毕竟<code>ShardingCore</code>之前并没有一款非常好用的分片组件在.net上,并且拥有非常完美的orm作为支持，基本上重来没有一个框架说多租户模式是可以选择数据库的,之前市面上所有的多租户你只能选择一种数据库,目前.Net在开源的状态下我相信会有越来越好的组件框架诞生,毕竟这么好的语言如果配上丰富的生态那将是所有.Neter的福音。</p>\n",
      "image": "https://img2020.cnblogs.com/blog/1346660/202201/1346660-20220109204747170-1484976526.png",
      "date_published": "2022-01-11T00:08:16.000Z",
      "date_modified": "2022-01-11T00:08:16.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": [
        "多租户"
      ]
    },
    {
      "title": "Slide page",
      "url": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/slides/",
      "id": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/slides/",
      "content_html": "\n<i>Not supported content</i>",
      "image": "https://vuepress-theme-hope-demo.mrhope.site/sharding-core-doc/logo.svg",
      "date_published": "2021-11-02T08:39:31.000Z",
      "date_modified": "2021-11-02T08:39:31.000Z",
      "authors": [
        {
          "name": "xuejiaming"
        }
      ],
      "tags": []
    }
  ]
}